<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Manage Blog Article</title>
        <script type="text/javascript" src="/static/typeahead/0.10.2/typeahead.bundle.js">//</script>
        <script type="text/javascript" src="/static/js/jquery.fileupload.js">//</script>
        <script type="text/javascript" src="/static/js/jquery.milton-upload.js">//</script>
        <style>
            #images-container .thumbnail {
                min-height: 240px;
            }
        </style>
    </head>
    <body>
        <form action="" method="POST" class="form-horizontal article-form" role="form">
            <div id="manageReward" class="MainContent tabbable">
                <div class="clearfix">
                    <div class="pull-right">
                        <button class="btn btn-sm btn-primary" type="submit">Save changes</button>
                        <button class="btn btn-sm btn-default Cancel" type="button">Cancel</button>
                    </div>
                    <ul class="TabNav nav nav-tabs tab-bricky pull-left">
                        <li class=""><a href="#details" data-toggle="tab">Details</a></li>
                        <li class=""><a href="#bodyCopy" data-toggle="tab">Content</a></li>
                        <li class=""><a href="#images" data-toggle="tab">Images</a></li>
                    </ul>
                </div>
                <div class="tab-content">
                    <div class="tab-pane" id="details">
                        <div class="form-group">
                            <label class="control-label col-md-3" for="title">Title</label>
                            <div class="col-md-8">
                                <input type="text" id="title" name="title" value="$!page.title" placeholder="" class="required form-control" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3" for="themeSiteId">Category</label>
                            <div class="col-md-8">
                                <select name="category" id="category" class="form-control">
                                    <option value="">[None]</option>
                                    #foreach($cat in $page.parent.categories)
                                    $formatter.option($cat, $cat, $page.category)
                                    #end
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3" for="tags">Featured</label>
                            <div class="col-md-8">
                                <label>
                                    $formatter.checkbox("featured", $page.featured ) 
                                    Make this a featured article, so it is more prominent
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3" for="tags">Tags</label>
                            <div class="col-md-8">
                                #set ($selectedTags = "")
                                #set ($selectedTag = "")
                                #foreach($tag in $page.tags)
                                    #if ($page.isSelectedTag($tag))
                                        #set ($selectedTag = $tag)
                                        #if ($selectedTags != "")
                                            #set ($selectedTags = $selectedTags + "," + $selectedTag)
                                        #else
                                            #set ($selectedTags = $selectedTag)
                                        #end
                                    #end
                                #end
                                <!--
                                <input type="text" id="tags" value="$selectedTags" name="tags2" class="form-control" />
                                -->
                                <script type="text/javascript">
                                    var tags = [];
                                    #foreach($tag in $page.tags)
                                        tags.push('$tag');
                                    #end

                                    $('#tags').tagsinput({
                                        typeahead: {
                                            source: function () {
                                                return tags;
                                            }
                                        }
                                    });
                                </script>
                                #foreach($tag in $page.tags)
                                <label>
                                    $formatter.checkbox(null, "tags", $page.isSelectedTag($tag), $tag )
                                    $tag
                                </label>
                                #end
                            </div>
                        </div>                        
                        <div class="form-group">
                            <label class="control-label col-md-3" for="articleDate">Article Date</label>
                            <div class="col-sm-5">
                                <div class='input-group'>
                                    <input type="text" id="articleDate" name="articleDate" placeholder="Start date" data-format="DD/MM/YYYY" value="$!page.articleDate" class="form-control date-picker" />
                                    <span class="input-group-addon">
                                        <a href="#articleDate" data-role="date-picker-trigger">
                                            <i class="fa fa-calendar"></i>
                                        </a>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3" for="notes">Brief</label>
                            <div class="col-md-8">
                                <textarea cols="100" id="brief" name="brief" rows="10" placeholder="" class="htmleditor toolbar-Lite">$!page.brief</textarea>
                            </div>
                        </div>                        
                        <div class="clearfix"></div>
                    </div>

                    <div class="tab-pane" id="bodyCopy">
                        <textarea class="htmleditor" cols="100" name="body" rows="20" placeholder="">$!page.body</textarea>                        
                    </div>

                    <div class="tab-pane" id="images">
                        <button class="btn btn-sm btn-success" data-toggle="modal" data-target="#addImageModal">
                            <i class="fa fa-plus"></i> Add image
                        </button>

                        <hr/>

                        <div class="table-responsive" id="images-container">
                            <div class="row">
                                #foreach($i in $page.images)
                                <div class="col-md-3">
                                    <div class="thumbnail">                                        
                                        <img src="$i.href/alt-150-150.png" class="img-responsive" />
                                        <div class="caption">
                                            <a href="$i.href" target="_blank"><h4>$i.name</h4></a>

                                            <a class="pull-right btn btn-danger image-delete" href="$i.href">
                                                <span class="glyphicon glyphicon-remove"></span>
                                            </a>                                            

                                            <span class="label label-default">
                                                #if( $i.orientation )
                                                $i.orientation
                                                #else
                                                Default
                                                #end
                                            </span>
                                            <div class="clearfix"></div>
                                        </div>

                                    </div>
                                </div>
                                #end                                
                            </div>
                        </div>                        
                    </div>                    
                </div>
            </div>
        </form>

        <div id="addImageModal" class="modal fade">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Add new image</h4>
                </div>
                <div class="modal-body">
                    <form action="$page.href" method="POST" class="form-horizontal">
                        <input type="hidden" name="hash" />
                        <div class="form-group">
                            <div class="errorHandler alert alert-danger no-display pageMessage">.</div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label" for="newTagName">Upload</label>
                            <div class="col-sm-9">
                                <div class="btn-upload" id='upload-image'></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label" for="newTagName">File name</label>
                            <div class="col-sm-9">
                                <input type="text" name="fileName" class="form-control required" required="true" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label" for="newTagName">Orientation</label>
                            <div class="col-sm-9">
                                <select name="orientation" class="form-control">
                                    <option value="">Default</option>
                                    <option value="square">Square</option>
                                    <option value="vertical">Vertical</option>
                                    <option value="horizontal">Horizontal</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary btn-sm" data-type="form-submit">Save image</button>
                </div>
        </div>        

        <script type="text/javascript">
            Bob.onDOMReady(function() {
                $(".article-form").forms({
                    callback: function(resp, form) {
                        flog("Done", form, resp);
                        if (resp.nextHref) {
                            window.location = resp.nextHref;
                        }
                    }
                });
                initHtmlEditors();

                var addImageModal = $("#addImageModal");
                addImageModal.find("form").forms({
                    callback: function() {
                        $("#images-container").reloadFragment();
                    }
                });
                $('#upload-image').mupload({
                    buttonText: '<i class="clip-folder"></i> Upload image',
                    url: window.location.pathname,
                    useJsonPut: false,
                    oncomplete: function(data, name, href) {
                        flog('oncomplete:', data.result, name, href);
                        addImageModal.find("input[name=hash]").val(data.result.data.file); // the hash of the "file" file input that was uploaded
                        addImageModal.find("input[name=fileName]").val(name);
                        flog("set", addImageModal.find("input[name=fileName]"));
                    }
                });
                $("#images-container").on("click", ".image-delete", function(e) {
                    e.preventDefault();
                    var href = $(e.target).closest("a").attr("href");
                    flog("delete image", $(e.target), href);
                    confirmDelete(href, getFileName(href), function() {
                        $("#images-container").reloadFragment();
                    });
                });
            });
        </script>
    </body>
</html>