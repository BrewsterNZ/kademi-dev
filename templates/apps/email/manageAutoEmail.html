<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>$view.title</title>
        <link href="manageAutoEmail.css" rel="stylesheet" type="text/css" />
        <link href="manageEmail.css" rel="stylesheet" type="text/css" />
        <script type="text/javascript" src="/static/js/jquery.fileupload.js">//</script>
        <script type="text/javascript" src="/static/js/jquery.milton-upload.js">//</script>
        <script type="text/javascript" src="manageAutoEmail.js">//</script>
        <script type="text/javascript" src="manageEmail.js">//</script>
    </head>
    <body class="manageAutoEmail">
        <form name="frmDetails" action="." method="post" class="form-horizontal">
            <div class="pull-right page-action">
                <button class="btn btn-sm btn-primary" type="submit">Save changes</button>
                <button class="btn btn-sm btn-info btn-sent-test" type="button">Send Test</button>
            </div>

            <div class="tabbable">
                <ul class="nav nav-tabs tab-bricky">
                    <li><a data-toggle="tab" href="#general">General</a></li>
                    <li><a data-toggle="tab" href="#triggers">Triggers</a></li>
                    <li><a data-toggle="tab" href="#action">Actions</a></li>
                    <li><a data-toggle="tab" href="#recipients">Recipients</a></li>
                    <li><a data-toggle="tab" href="#history">History</a></li>
                </ul>
                <div class="tab-content">
                    <!-- Start content of General tab -->
                    <div id="general" class="tab-pane">
                        <div class="form-group">
                            <label class="control-label col-md-3 col-lg-2" for="title">Trigger name</label>
                            <div class="col-md-8 col-lg-4">
                                <input type="text" name="title" id="title" value="$!page.title" placeholder="" class="required form-control" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-lg-2" for="enabled">Enabled</label>
                            <div class="col-md-8 col-lg-4">
                                $formatter.checkbox("enabled", "enabled", $page.enabled)<br />
                                <small>This auto email will only be sent if enabled</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-lg-2" for="notes">Notes<small>These notes are for internal purposes only.</small></label>
                            <div class="col-md-8 col-lg-4">
                                <textarea cols="100" name="notes" id="notes" rows="10" placeholder="" class="form-control">$!page.notes</textarea>
                            </div>
                        </div>
                    </div>
                    <!-- End content of General tab -->

                    <!-- Start content of Triggers tab -->
                    <div id="triggers" class="tab-pane">
                        <div class="row">
                            #set($mapOfTriggerTypes = $page.emailTriggerTypes)  
                            <div class="col-md-9">
                                <div class="form-group">
                                    <label class="control-label col-md-4" for="eventId">Event type</label>
                                    <div class="col-md-8">

                                        <select id="eventId" name="eventId" class="form-control">
                                            <option value="-">[Choose]</option>
                                            #foreach($eventId in $mapOfTriggerTypes.keySet())
                                            $formatter.option($eventId, $eventId, $page.trigger.eventId)
                                            #end
                                        </select>
                                    </div>
                                </div>
                                #foreach($eventId in $mapOfTriggerTypes.keySet())
                                #set($triggerType = $mapOfTriggerTypes.get($eventId))
                                #foreach($optionCode in $triggerType.keySet())
                                <div class="form-group event-type $eventId" style="display: none">
                                    <label class="control-label col-md-4" for="$optionCode">$page.triggerOptionLabel($eventId, $optionCode)</label>
                                    <div class="col-md-8">
                                        $triggerType.get($optionCode).toHtml($optionCode, $page.triggerOptionValue($optionCode) )
                                    </div>
                                </div>
                                #end
                                #end
                                <div class="form-group">
                                    <label class="control-label col-md-4" for="createTimerEnabled">Enable event delay</label>
                                    <div class="col-md-8">
                                        $formatter.checkbox("createTimerEnabled", "createTimerEnabled", $page.createTimerEnabled)
                                        <div class="panel-toggled" data-toggled="display" data-actor="#createTimerEnabled">                                            
                                            <p>
                                                You can set a timer so the event is only fired after a delay. This can be used to send reminder emails a week or so later, for example. Any conditional rules are applied after the delay
                                            </p>
                                            <div class="clearfix">
                                                <div class="input-group pull-left">
                                                    <span class="input-group-addon">Fire the next event after:</span>
                                                    <input type="text" class="text-center form-control" value="$!page.job.timerMultiple" name="timerMultiple" />
                                                    <div class="input-group-btn">
                                                        <button data-toggle="dropdown" class="btn btn-default dropdown-toggle timer-unit" type="button">$!page.job.timerUnit <span class="caret"></span></button>
                                                        <ul role="menu" class="dropdown-menu pull-right timer-units">
                                                            #foreach($unit in $page.timerUnits)
                                                            <li><a href="#">$unit</a></li>
                                                            #end                                                            
                                                        </ul>
                                                    </div>       
                                                    <input type="hidden" name="timerUnitName" class="timer-unit" value="$!page.job.timerUnit"/>
                                                </div>
                                            </div> 
                                            <br/>   
                                            <a class="btn btn-info" href="timerTriggers.html">View Queued triggers</a>
                                        </div>                                          
                                    </div>
                                </div>

                                <hr/>

                                <div class="form-group">
                                    <label class="control-label col-md-4" for="conditionScriptXml">Advanced</label>
                                    <div class="col-md-8">
                                        <p>You can enter XML rules below, the trigger will only fire if this evaluates to true</p>
                                        <textarea name="conditionScriptXml" id="conditionScriptXml" class="form-control" rows="5">$!page.job.conditionScriptXml</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End content of Triggers tab -->

                    <!-- Start content of Actions tab -->
                    <div id="action" class="tab-pane">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <i class="clip-chk">$formatter.checkbox("emailEnabled", "emailEnabled", $page.emailEnabled)</i>
                                <label for="emailEnabled">Send an email</label>
                            </div>
                            <div class="panel-body panel-toggled" data-toggled="display" data-actor="#emailEnabled">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="control-label col-md-4" for="themeSiteId">Website</label>
                                            <div class="col-md-8">
                                                <select name="themeSiteId" id="themeSiteId" class="form-control">
                                                    $formatter.option("", "[Please select]", $page.themeSiteId)
                                                    #foreach($website in $page.organisation.websites)
                                                    $formatter.option($website.id, $website.name, $page.themeSiteId)
                                                    #end
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-md-4" for="subject">Email subject</label>
                                            <div class="col-md-8">
                                                <input type="text" name="subject" id="subject" value="$!page.subject" placeholder="Enter the email subject here" class="form-control" />
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-md-4" for="fromAddress">Email from address</label>
                                            <div class="col-md-8">
                                                <input type="text" name="fromAddress" id="fromAddress" value="$!page.fromAddress" placeholder="admin@mybusinessname.com" class="email form-control" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="add-attachment btn-upload"></div>
                                        <div class="article-wrapper article-sm showed-action attachments-list">
                                            #foreach($att in $page.job.attachments)
                                            <article>
                                                <span class="article-name">
                                                    <a target="_blank" href="/_hashes/files/$att.attachmentHash">$att.attachmentFilename</a>
                                                </span>
                                                <aside class="article-action">
                                                    <a class="btn btn-sm btn-xs btn-danger btn-delete-attachment" href="$att.attachmentFilename" title="Remove"><i class="clip-minus-circle"></i></a>
                                                </aside>
                                            </article>
                                            #end
                                        </div>
                                    </div>
                                </div>
                                <textarea class="htmleditor" cols="100" name="html" placeholder="">$!page.html</textarea>
                            </div>
                        </div>

                        <div class="panel panel-default"> <!-- start add to group -->
                            <div class="panel-heading">
                                <i class="clip-chk">$formatter.checkbox("addToGroupEnabled", "addToGroupEnabled", $page.addToGroupEnabled)</i>
                                <label for="addToGroupEnabled">Add to a group</label>
                            </div>
                            <div class="panel-body panel-toggled" data-toggled="display" data-actor="#addToGroupEnabled">
                                <p>When this trigger fires add the user to a selected group.</p>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="control-label col-md-4" for="groupToJoin">Group to join</label>
                                            <div class="col-md-8">
                                                <select name="groupToJoinName" id="groupToJoin" class="form-control">
                                                    $formatter.option( "", "[Please select]", $page.job.groupToJoin.name )
                                                    #foreach($group in $page.organisation.groups)
                                                    $formatter.option( $group.name, $group.name, $page.job.groupToJoin.name )
                                                    #end
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- End add to group -->

                        <div class="panel panel-default"> <!-- start remove from group -->
                            <div class="panel-heading">
                                <i class="clip-chk">$formatter.checkbox("removeFromGroupEnabled", "removeFromGroupEnabled", $page.removeFromGroupEnabled)</i>
                                <label for="removeFromGroupEnabled">Remove from a group</label>
                            </div>
                            <div class="panel-body panel-toggled" data-toggled="display" data-actor="#removeFromGroupEnabled">
                                <p>When this trigger fires remove the user from a selected group.</p>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="control-label col-md-4" for="removeFromGroup">Group to remove from</label>
                                            <div class="col-md-8">
                                                <select name="removeFromGroupName" id="removeFromGroup" class="form-control">
                                                    $formatter.option( "", "[Please select]", $page.job.removeFromGroup.name )
                                                    #foreach($group in $page.organisation.groups)
                                                    $formatter.option( $group.name, $group.name, $page.job.groupToJoin.name )
                                                    #end
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- End remove from group -->

                        <div class="panel panel-default"> <!-- start reward -->
                            <div class="panel-heading">
                                <i class="clip-chk">$formatter.checkbox("rewardEnabled", "rewardEnabled", $page.job.rewardEnabled)</i>
                                <label for="rewardEnabled">Grant rewards</label>
                            </div>
                            <div class="panel-body panel-toggled" data-toggled="display" data-actor="#rewardEnabled">
                                <p>When this trigger fires grant the user a number of rewards or points.</p>                                
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="control-label col-md-4" for="groupToJoin">Reward to grant</label>
                                            <div class="col-md-8">
                                                <select name="reward" id="reward" class="form-control">
                                                    $formatter.option( "", "[Please select]", $page.job.reward.name )
                                                    #foreach($reward in $page.allRewards)
                                                    $formatter.option( $reward, $reward, $page.job.reward.name )
                                                    #end
                                                </select>
                                            </div>
                                        </div>                                       
                                    </div> <!-- end row -->
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="control-label col-md-4" for="groupToJoin">No. rewards/points</label>
                                            <div class="col-md-8">
                                                <input type="text" name="numRewards" id="numRewards" value="$!page.job.numRewards" class="form-control" />
                                            </div>
                                        </div>
                                    </div> <!-- end row -->
                                </div>                                
                            </div>
                        </div> <!-- End reward --> 
                        
                        <div class="panel panel-default"> <!-- start activate alert -->
                            <div class="panel-heading">
                                <i class="clip-chk">$formatter.checkbox("activateAlertEnabled", "activateAlertEnabled", $page.job.activateAlertEnabled)</i>
                                <label for="activateAlertEnabled">Actviate alert</label>
                            </div>
                            <div class="panel-body panel-toggled" data-toggled="display" data-actor="#activateAlertEnabled">
                                <p>Activate a dashboard alert for this user.</p>                                
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="control-label col-md-2" for="alert">Alert to activate</label>
                                            <div class="col-md-10">
                                                <select name="alert" id="alert" class="form-control">
                                                    $formatter.option( "", "[Please select]", $page.job.alert.id )
                                                    #foreach($alert in $page.allAlerts)
                                                    $formatter.option( $alert.id, $alert.textDescription, $page.job.alert.id )
                                                    #end
                                                </select>
                                            </div>
                                        </div>                                       
                                    </div> <!-- end row -->
                                </div>                                                               
                            </div>
                        </div> <!-- End actviate alert -->
                        
                    </div> <!-- End content of Actions tab -->


                    <div id="recipients" class="tab-pane"> <!-- Start content of Recipients tab -->
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <i class="clip-chk">$formatter.checkbox("includeUser", "includeUser", $page.trigger.includeUser, "true")</i>
                                <label for="includeUser">Include the user that cause the event</label>
                            </div>
                            <div class="panel-body">
                                <button class="btn btn-sm btn-success btn-add-group" data-toggle="modal" data-target="#modal-choose-group"><i class="fa fa-plus"></i> Add recipient groups</button>
                                <hr class="hr-sm" />
                                <div class="blocks-wrapper recipient">
                                    #foreach($g in $page.groupRecipients)
                                    <span class="block $g.name">
                                        <span class="block-name">$g.name</span>
                                        #if( $page.status == "Draft" )
                                        <a class="btn btn-xs btn-danger btn-remove-role" href="$g.name" title="Remove this role"><i class="clip-minus-circle "></i></a>
                                        #end
                                    </span>
                                    #end
                                </div>
                                <p>&nbsp;</p>
                                <button class="btn btn-sm btn-success btn-add-group" data-toggle="modal" data-target="#modal-choose-group"><i class="fa fa-plus"></i> Add excluded groups</button>
                                <hr class="hr-sm" />
                                <div class="blocks-wrapper excluded">
                                    #foreach($g in $page.excludedGroups)
                                    <span class="block $g.name">
                                        <span class="block-name">$g.name</span>
                                        #if( $page.status == "Draft" )
                                        <a class="btn btn-xs btn-danger btn-remove-role" href="$g.name" title="Remove this role"><i class="clip-minus-circle "></i></a>
                                        #end
                                    </span>
                                    #end
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <i class="clip-chk"><input type="checkbox" id="showAdvanced" /></i>
                                <label for="showAdvanced">Advanced</label>
                            </div>
                            <div class="panel-body panel-toggled" data-toggled="display" data-actor="#showAdvanced">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p>You can enter XML rules below, to filter out potential recipients</p>
                                        <textarea name="filterScriptXml" class="form-control" rows="20">$!page.job.filterScriptXml</textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Available Rules</h5>
                                        <div class="rules">
                                            <ul>
                                                <li>
                                                    <h6>Expression types</h6>
                                                    <ul>
                                                        <li>
                                                            <b>const</b>: Constants, eg <br/>&lt;const type='Integer'&gt;1&lt;/const&gt;
                                                        </li>
                                                        <li>
                                                            <b>comparison</b>:
                                                            Compare 2 expressions, Eg
                                                            <br/>
                                                            &lt;comparison operator='EQUALS'&gt;<br/>
                                                            &lt;const type='Integer'&gt;1&lt;/const&gt;<br/>
                                                            &lt;const type='Integer'&gt;1&lt;/const&gt;<br/>
                                                            &lt;/comparison&gt;<br/>
                                                        </li>
                                                        <li>
                                                            <b>app-prop</b>: a property from an application. See below for a full list of app-id's and prop-name's. Eg:
                                                            <br/>
                                                            &lt;app-prop app-id='userApp' prop-name='firstName' /&gt;
                                                        </li>
                                                    </ul>
                                                </li>
                                                #foreach( $app in $applicationManager.getPropertyProviderApps($rootFolder) )
                                                <li>
                                                    <h6>$app.instanceId</h6>
                                                    <ul>
                                                        #foreach( $expr in $app.allProperties )
                                                        <li>
                                                            <b>$expr.name</b>:
                                                            $expr.description
                                                        </li>
                                                        #end
                                                    </ul>
                                                </li>
                                                #end
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End content of Recipients tab -->

                    <!-- Start content of History tab -->
                    <div id="history" class="tab-pane">
                        <p class="well">
                            <button type="button" class="refresh-history btn btn-success pull-right">Refresh</button>
                            Emails sent by this trigger over the last 7 days.
                            <br/>
                        </p>                        
                        <div class="table-responsive" id="history-table">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Status</th>                                        
                                        <th>Subject</th>
                                        <th>Recipient</th>
                                        <th>Address</th>
                                        <th>Status Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    #foreach($item in $page.history)
                                    <tr>
                                        <td class="icon" title="$!email.status">
                                            #if($email.sendStatus == "c" )
                                            <i class="fa fa-check-circle text-success"></i>                                            
                                            #else
                                            <i class="fa fa-exclamation-circle text-muted"></i>
                                            #end
                                        </td>                                        
                                        <td>
                                            <abbr title="EmailItemID: $item.id">
                                                $item.statusText
                                            </abbr>
                                            #if( $item.sendStatus == "r" )
                                            <small>( retry at $nextRetry )</small>
                                            #elseif( $item.sendStatus == "p" )
                                            #if( $item.numAttempts )
                                            <small>( $item.numAttempts attempts )</small>
                                            #end
                                            #elseif( $item.sendStatus == "f" )
                                            <small>( $item.numAttempts attempts; last error $item.lastAttempt.status )</small>
                                            #end
                                        </td>

                                        <td>$item.subject</td>
                                        <td>$item.recipient.formattedName</td>
                                        <td>$item.recipientAddress</td>
                                        <td>
                                            <abbr class="pull-right timeago" title="$formatter.formatDateISO8601($item.sendStatusDate)">$item.sendStatusDate</abbr>
                                        </td>
                                    </tr>
                                    #end
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- End content of History tab -->
                </div>
            </div>
        </form>

        <div id="modal-choose-group" class="modal modal-sm fade" aria-hidden="true" tabindex="-1">
            <div class="modal-header">
                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>
                <h4 class="modal-title">Choose groups</h4>
            </div>
            <div class="modal-body">
                <p>
                    Choose whether a groups should be a recipient, excluded, or to not care about. When a group is excluded then members of that group will not receive the email, even if they are in a recipient group
                </p>
                <div class="table-responsive">
                    <table id="table-groups" class="table table-striped table-hover table-condensed">
                        <thead>
                            <tr>
                                <th>Group</th>
                                <th colspan='3'></th>
                            </tr>
                        </thead>
                        <tbody>
                            #foreach($g in $page.allGroups)
                            <tr>
                                <td>$g.name</td>

                                #set($name = $g.name)
                                <td>
                                    #set($id = $name + "-recip")
                                    $formatter.radio($id, $name, $page.isSelected($g), "recipient" )
                                    <label for="$id">Recipient</label>
                                </td>
                                <td>
                                    #set($id = $name + "-excluded")
                                    $formatter.radio($id, $name, $page.isExcluded($g), "excluded" )
                                    <label for="$id">Excluded</label>
                                </td>
                                <td>
                                    #set($id = $name + "-none")
                                    $formatter.radio($id, $name, false, "none" )
                                    <label for="$id">Don't care</label>
                                </td>
                            </tr>
                            #end
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" data-dismiss="modal" type="button">Close</button>
            </div>
        </div>

        <script type="text/javascript">
            Bob.onDOMReady(function() {
                initManageAutoEmail();
                $(".refresh-history").click(function(e) {
                    e.preventDefault();
                    $("#history-table").reloadFragment();
                });
                $(".timer-units li").click(function(e) {
                    e.preventDefault();
                    var unit = $(e.target).text();
                    $(".timer-unit").text(unit).val(unit);
                });
                jQuery("abbr.timeago").timeago();
            });
        </script>
    </body>
</html>
