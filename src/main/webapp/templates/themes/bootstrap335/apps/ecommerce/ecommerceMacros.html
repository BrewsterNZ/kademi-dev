<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title></title>
    </head>
    <body>
        #macro(rightSidebar $store)
            #script()
                <script>
                    var shopStore = page.find(templatingContext.store.href);
                    var productsSearch = shopStore.searchProducts(null, null, 0, 100, 'product', false);
                    var lastViewedCookie = http.request.getCookie('viewed-products');
                    if (lastViewedCookie) {
                        lastViewedCookie = decodeURIComponent(lastViewedCookie.value);
                    }
                    lastViewedCookie = ',' + lastViewedCookie + ',';
                    var recentlyAdded = [];
                    var lastViewed = [];

                    for (var i = 0; i < productsSearch.hits.hits.length; i++) {
                        var product = productsSearch.hits.hits[i];
                        var productId = ',' + product.fields.product.value + ',';

                        if (i < 2) {
                            recentlyAdded.push(product);
                        }

                        if (lastViewedCookie.indexOf(productId) !== -1 && lastViewed.length <= 2) {
                            lastViewed.push(product);
                        }
                    }

                    if (lastViewed.length > 0) {
                        lastViewed.sort(function (a, b) {
                            var productAId = ',' + a.fields.product.value + ',';
                            var productBId = ',' + b.fields.product.value + ',';

                            return lastViewedCookie.indexOf(productAId) - lastViewedCookie.indexOf(productBId);
                        });
                    }

                    templatingContext.lastViewed = lastViewed;
                    templatingContext.recentlyAdded = recentlyAdded;
                </script>
            #end

            <div class="list-group" id="categories-list">
                <a href="#" class="list-group-item active">
                    Categories
                </a>
                #set ($categories = $page.find($store.href).children.ofType.category)
                #foreach($cat in $categories)
                    <a href="$cat.href" class="list-group-item">$cat.title</a>
                #end
            </div>
            <div id="recently-added">
                <h4><b>Recently Added</b></h4>
                #foreach($p in $recentlyAdded)
                    #set($bg = "/theme/img/photo_holder.png")
                    #if( $p.fields.primaryImageId.value )
                        #set($bg = $store.href + "$p.fields.tags.value/$p.fields.product.value/$p.fields.primaryImageId.value")
                    #end
                    <div class="media">
                        <div class="media-left">
                            <a href="/$store.name/$p.fields.tags.value/$p.fields.product.value">
                                <img class="media-object" src="/theme/img/blank.gif" style="background-image: url($bg)" />
                            </a>
                        </div>
                        <div class="media-body">
                            <p class="product-title">$!p.fields.title.value</p>
                            <p class="lead"><b class="text-primary">$$p.fields.finalCost.value</b></p>
                        </div>
                    </div>
                #end
            </div>

            <div id="last-viewed">
                <h4><b>Last Viewed</b></h4>
                #foreach($p in $lastViewed)
                    #set($bg = "/theme/img/photo_holder.png")
                    #if( $p.fields.primaryImageId.value )
                        #set($bg = $store.href + "$p.fields.tags.value/$p.fields.product.value/$p.fields.primaryImageId.value")
                    #end
                    <div class="media">
                        <div class="media-left">
                            <a href="/$store.name/$p.fields.tags.value/$p.fields.product.value">
                                <img class="media-object" src="/theme/img/blank.gif" style="background-image: url($bg)" />
                            </a>
                        </div>
                        <div class="media-body">
                            <p class="product-title">$!p.fields.title.value</p>
                            <p class="lead"><b class="text-primary">$$p.fields.finalCost.value</b></p>
                        </div>
                    </div>
                #end
            </div>

            <script type="text/javascript">
                $(function () {
                    onWindowStopResize(function () {
                        $('#recently-added .product-title').dotdotdot({
                            height: 20
                        });

                        $('#last-viewed .product-title').dotdotdot({
                            height: 20
                        });
                    });
                });
            </script>
        #end

        #macro (renderProductItem $p $store $isRelated)
            #set ($cls = "col-sm-6 col-md-4")
            #if ($isRelated)
                #set ($cls = "col-sm-6 col-md-3")
            #end

            <div class="$cls product-item">
                <div class="thumbnail product">
                    #set($bg = "/theme/img/photo_holder.png")
                    #if( $p.fields.primaryImageId.value )
                        #set($bg = "/$store.name/$p.fields.tags.value/$p.fields.product.value/$p.fields.primaryImageId.value")
                    #end
                    <span class="product-image-wrapper">
                        <a href="/$store.name/$p.fields.tags.value/$p.fields.product.value">
                            <span style="background-image: url($bg)" class="product-image"></span>
                        </a>
                    </span>
                    <div class="caption">
                        <h3 class="product-title" title="$p.fields.title.value"><a href="/$store.name/$p.fields.tags.value/$p.fields.product.value">$p.fields.title.value</a></h3>
                        <span class="product-price label">$$p.fields.finalCost.value</span>
                        <p class="product-content">$!p.fields.content.value</p>
                        <div class="product-actions">
                            <a href="/$store.name/$p.fields.tags.value/$p.fields.product.value" class="btn btn-default btn-sm" role="button">View</a>
                            <a href="/$store.name/$p.fields.tags.value/$p.fields.product.value" class="btn btn-primary btn-sm btn-add-to-cart" role="button">Add to Cart</a>
                        </div>
                    </div>
                </div>
            </div>
        #end
    </body>
</html>