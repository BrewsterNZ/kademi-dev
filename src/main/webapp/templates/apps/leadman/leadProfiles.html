<html xmlns="http://www.w3.org/1999/xhtml">
    #parse("/theme/masterTemplate.html")
    <head>
        #@themeHeader( "Search contacts" )
        <script src="/static/reload-fragment/1.0.1/jquery.reload-fragment-1.0.1.js" type="text/javascript" >//</script>
        #end
    </head>
    <body class='add-container'>
        #@themeBody()

        #parse("/theme/apps/leadman/includes.html")
        #parse("/theme/apps/leadman/leadManIncludes.html")

        <div class="row">
            <div class="col-lg-12">
                <div class="row">
                    <div class="col-lg-6">
                        <p class="search-user">
                            <input type="text" id="user-query" class="form-control" placeholder="Search for user here" value="" />
                        </p>
                    </div>
                    <div class="col-lg-6">
                        <div class="btn-group pull-right">
                            <a href="#" class="btn btn-success btn-add-user"><i class="fa fa-user-plus"></i> Add a new contact</a>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-12" id="searchResults">
                        #if( $page.searchResults.isEmpty() )
                        <p class="lead">No results matched the search</p>
                        #else
                        <ul class="list-group">
                            #foreach($p in $page.searchResults)
                            <li class="list-group-item">
                                <div class="media">
                                    <div class="media-left">
                                        <div class="avatar avatar-away">
                                            <img alt="..." src="/theme/apps/leadman/user-placeholder.png" class="img img-circle" style="width: 100px" />
                                            <i class="avatar avatar-busy"></i>
                                        </div>
                                    </div>
                                    <div class="media-body" style="padding-left: 20px; position: relative">
                                        <h3 class="media-heading">
                                            <a href="$p.fields.userName.value">
                                                $formatter.htmlEncode($p.fields.firstName.value)
                                                $formatter.htmlEncode($p.fields.surName.value)
                                            </a>

                                            <small class="pull-right">Last contact: 2 hours ago</small>
                                        </h3>
                                        <p>
                                            <i aria-hidden="true" class="fa fa-map-marker"></i>
                                            #if( $p.fields.email.value )
                                             $p.fields.email.value
                                            #end

                                            #if( $p.fields.phone.value )
                                            , $p.fields.phone.value
                                            #end
                                        </p>

                                        #set( $leads = $page.leads($p.fields.userName.value) )
                                        #if( $leads.size() > 0 )
                                        <p>$leads.size() leads in progress</p>
                                        #else
                                        <p>
                                            <i>No leads in progress</i>
                                        </p>
                                        #end

                                        <div class="text-muted leadContactMethods">
                                            <a href="mailto:$lead.profile.email" class="text-muted">
                                                <em aria-hidden="true" class="fa fa-envelope"></em>
                                            </a>
                                            #if( $p.fields.phone.value )
                                            <a href="tel:$p.fields.phone.value" class="text-muted">
                                                <em aria-hidden="true" class="fa fa-mobile"></em>
                                            </a>
                                            #end
                                            <a href="javascript:void(0)" class="text-muted">
                                                <i aria-hidden="true" class="fa fa-twitter"></i>
                                            </a>
                                            <a href="javascript:void(0)" class="text-muted">
                                                <i aria-hidden="true" class="fa fa-facebook"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            #end
                        </ul>
                        #end
                    </div> <!-- End results table -->
                </div>
            </div>
            <div class="col-lg-3" id="aggregationsContainer">
                #if( $page.aggregations )
                <table class="table">
                    #foreach($agg in $page.aggregations )
                    #showAggregation($agg)
                    #end
                </table>
                #end
            </div> <!-- end aggregations -->

        </div>

        #createModals()

        <script type="text/javascript" src="/static/uri/1.15.1/URI.js">//</script>
        <script type="text/javascript">
            $(function () {
                initSearchUser();
            });

            function initSearchUser() {
                $('#user-query').keyup(function () {
                    typewatch(function () {
                        flog('do search');
                        doSearch();
                    }, 500);
                });
                $('#search-group').change(function () {
                    doSearch();
                });
            }

            function doSearch() {
                var query = $('#user-query').val();
                var groupName = $('#search-group').val();
                flog('doSearch', query, groupName);
                var uri = URI(window.location);
                uri.setSearch('q', query);
                uri.setSearch('g', groupName);
                flog('doSearch', uri.toString());
                var newHref = uri.toString();
                window.history.pushState('', newHref, newHref);
                Msg.info('Searching...', 50000);
                $.ajax({
                    type: 'GET',
                    url: newHref,
                    success: function (data) {
                        Msg.info('Search complete', 5000);
                        flog('success', data);
                        var newDom = $(data);
                        var $fragment = newDom.find('#searchResults');
                        $('#searchResults').replaceWith($fragment);
                        $('abbr.timeago').timeago();
                    },
                    error: function (resp) {
                        Msg.error('An error occured doing the user search. Please check your internet connection and try again');
                    }
                });
            }
        </script>
        #end
    </body>
</html>