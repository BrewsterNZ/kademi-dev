<html xmlns="http://www.w3.org/1999/xhtml">
    #parse("/theme/masterTemplate.html")
    <head>
        #@themeHeader( "View profile $page.profile.formattedName" )
        <script src="/static/reload-fragment/1.0.1/jquery.reload-fragment-1.0.1.js" type="text/javascript" >//</script>
        <link rel="stylesheet" href="/static/timeline/timeline.css">
            #end
    </head>
    <body class='add-container'>
        #@themeBody()

        #parse("/theme/apps/leadman/includes.html")
        #parse("/theme/apps/leadman/leadManIncludes.html")

        <div class="">
            <div style="background:url(/images/profile.jpg) center center; background-size:cover;" class="unwrap">
                <div class="container container-lg p-lg">
                    <div class="pull-right">

                        <div class="btn-group">
                            <a class="btn btn-primary btn-lg createProfileLead">Create a new lead</a>
                        </div>
                    </div>
                    <div class="media mt-lg">
                        <div class="media-left media-middle"><a href=""><img src="/images/user/02.jpg" class="media-object thumb96 img-circle"></a></div>
                        <div class="media-body text-white">
                            <h2 class="mv-lg media-heading">$page.title</h2>
                        </div>
                    </div>
                    <div class="text-right text-white pb-lg">
                        <p class="m0"><strong>Average lead score 87%</strong></p>
                        <p class="m0"><strong>Total deals value: $50k</strong></p>
                    </div>
                </div>
            </div>
            <div class="container container-lg">
                <div class="row">
                    <div class="col-lg-3">
                        <div class="panel">
                            <div class="panel-body">
                                <h6><span><em class="fa fa-twitter mr"></em>@jdoe</span></h6>
                                <h6><span class="mr"><em class="fa fa-clock-o mr"></em>10:05 PM</span><span class="mr"><em class="fa fa-calendar mr"></em>10/11/15</span><span class="mr"><em class="fa fa-map-marker mr"></em>BA</span></h6>
                                <h6><span><em class="fa fa-eye mr"></em>10 feb at 10:00 AM</span></h6>
                            </div>
                        </div>
                        <div class="panel">
                            <div class="panel-heading no-shadow">
                                <a class="btn btn-success createNote pull-right" href="$page.href">
                                    <span class="fa fa-plus"></span>
                                </a>
                                Recent contacts
                            </div>
                            <div class="panel-body">
                                #set( $notes = $page.notes )
                                #if( $notes.size() > 0 )
                                <ul class="list-block">
                                    #foreach($note in $page.notes)
                                    <li class="media">
                                        <div class="pull-left">
                                            <div class="point-pin"><a href=""><img src="/images/user/05.jpg" alt="Image" class="media-object img-circle thumb32"></a>
                                                <div class="point point-success point-lg"></div>
                                            </div>
                                        </div>
                                        <div class="media-body">
                                            <div class="media-heading">
                                                <p>
                                                    <a href="/users/$note.createdBy.name">$note.createdBy.formattedName</a>

                                                    #if( $note.inbound )
                                                    <small class="text-muted fa fa-arrow-left"></small>
                                                    <small class="text-muted fa fa-${note.icon}"></small>
                                                    #else
                                                    <small class="text-muted fa fa-${note.icon}"></small>
                                                    <small class="text-muted fa fa-arrow-right"></small>
                                                    #end

                                                </p>

                                                <p>
                                                    $note.notes
                                                </p>
                                            </div>
                                        </div>
                                    </li>
                                    #end
                                </ul>
                                #else
                                <p>
                                    <span class="label label-warning">No contact with the lead yet</span>
                                </p>
                                #end
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-9">
                        <div class="panel">
                            <div class="panel-body">
                                <ul role="tablist" class="nav nav-tabs">
                                    <li role="presentation" class="active"><a href="#activity" aria-controls="activity" role="tab" data-toggle="tab">Activity</a></li>
                                    <li role="presentation"><a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">Profile</a></li>
                                    <li role="presentation"><a href="#leads" aria-controls="leads" role="tab" data-toggle="tab">Leads</a></li>
                                </ul>
                                <div class="tab-content">
                                    <div id="activity" role="tabpanel" class="tab-pane fade in active">
                                        <div class="row">
                                            <div class="">
                                                #showTimeline($page.timelineItems)
                                            </div>
                                        </div>
                                    </div>
                                    <div id="profile" role="tabpanel" class="tab-pane fade">
                                        <h4 class="page-header">Contact information</h4>
                                        <div class="row">
                                            <form method="post" action="$page.href" class="form-horizontal" id="leadDetails">
                                                <div class="modal-body">
                                                    #set( $p = $page.leadProfile )
                                                    <div class="form-group">
                                                        <label class="control-label col-md-2" for="nickName">Customer</label>
                                                        <div class="col-md-3">
                                                            <input type="text" name="nickName" id="nickName" class="form-control" placeholder="nickName" value="$!p.nickName" />
                                                        </div>
                                                        <div class="col-md-3">
                                                            <input type="text" name="firstName" id="firstName" class="form-control" placeholder="First name" value="$!p.firstName" />
                                                        </div>
                                                        <div class="col-md-4">
                                                            <input type="text" name="surName" id="surName" class="form-control" placeholder="Surname" value="$!p.surName" />
                                                        </div>
                                                    </div>

                                                    <div class="form-group">
                                                        <label class="control-label col-md-2" for="newUserEmail">Contact</label>
                                                        <div class="col-md-5">
                                                            <input type="text" name="email" id="email" class="form-control" placeholder="Email" value="$!p.email" />
                                                        </div>
                                                        <div class="col-md-5">
                                                            <input type="text" name="phone" id="phone" class="form-control" placeholder="Phone" value="$!p.phone" />
                                                        </div>
                                                    </div>

                                                    <div class="form-group">
                                                        <label class="control-label col-md-2" for="notes">Notes</label>
                                                        <div class="col-md-10">
                                                            <textarea name="notes" class="form-control" style="height: 100px">$!page.description</textarea>
                                                        </div>
                                                    </div>

                                                    <div class="form-group">
                                                        <div class="col-md-10 col-md-offset-2">
                                                            <button class="btn btn-sm btn-default" type="reset">Reset</button>

                                                            <button class="btn btn-primary" type="submit">Save details</button>

                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    <div id="leads" role="tabpanel" class="tab-pane fade">
                                        <table class="table table-striped">
                                            <thead>
                                                <th>Lead</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Amount</th>
                                                <th>Assigned to</th>
                                            </thead>
                                            <tbody>
                                                #foreach($lead in $page.leads)
                                                <tr>
                                                    <td>
                                                        <a href="/leads/$lead.id/">
                                                            $lead.description
                                                        </a>
                                                    </td>
                                                    <td>
                                                        #if( $lead.cancelled )
                                                        <span class="fa fa-remove text-danger"></span>
                                                        Cancelled <abbr title="$formatter.formatDateISO8601($lead.closedDate)" class="timeago">$lead.closedDate</abbr>
                                                        #elseif( $lead.closedDate )
                                                        <span class="fa fa-check text-success"></span>
                                                        Sale completed <abbr title="$formatter.formatDateISO8601($lead.closedDate)" class="timeago">$lead.closedDate</abbr>
                                                        #else
                                                        <span class="fa fa-clock-o text-muted"></span>
                                                        In progress
                                                        #end
                                                    </td>
                                                    <td>
                                                        <abbr title="$formatter.formatDateISO8601($lead.createDate)" class="timeago">$lead.createDate</abbr>
                                                    </td>
                                                    <td>$lead.dealAmount</td>
                                                    <td>
                                                        #if( $lead.assignedTo )
                                                        $lead.assignedTo.formattedName
                                                        #else
                                                        Not assigned
                                                        #end
                                                    </td>
                                                </tr>
                                                #end
                                            </tbody>
                                        </table>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="fw-boxed">
            <div class="panel panel-default">

            </div>
        </div>


        <hr/>



        <div class="modal fade" id="newTaskModal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="">Create a task</h4>
                    </div>
                    <form method="post" action="$page.href" class="form-horizontal">
                        <div class="modal-body">

                            <div class="form-group">
                                <label class="control-label col-md-3" for="dueDate">dueDate</label>
                                <div class="col-md-9">
                                    <input type="text" name="dueDate" id="dueDate" class="required form-control" placeholder="dueDate" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3" for="taskDescription">taskDescription</label>
                                <div class="col-md-9">
                                    <input type="text" name="taskDescription" id="taskDescription" class="required form-control" placeholder="taskDescription" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3" for="taskDescription">Reminder</label>
                                <div class="col-md-9">
                                    <select name="reminderDays">
                                        <option value="">No reminder</option>
                                        <option value="0">On the due date</option>
                                        <option value="-1">Day earlier</option>
                                        <option value="-7">Week earlier</option>
                                        <option value="1">Day after</option>
                                        <option value="7">Week after</option>
                                    </select>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>

                            <button class="btn btn-primary" type="submit">Create and view</button>
                        </div>
                    </form>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div>

        <div class="modal fade" id="closeDealModal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="">Deal closed successfully</h4>
                    </div>
                    <form method="post" action="$page.href" class="form-horizontal">
                        <input type="hidden" name="closeDeal"/>
                        <div class="modal-body">

                            <div class="form-group">
                                <label class="control-label col-md-3" for="closedDate">Closed Date</label>
                                <div class="col-md-9">
                                    <input type="text" name="closedDate" id="closedDate" class="required form-control" placeholder="closedDate" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3" for="dealAmount">Sale amount</label>
                                <div class="col-md-9">
                                    <input type="text" name="dealAmount" id="dealAmount" class="required form-control" placeholder="dealAmount" />
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-default" data-dismiss="modal" type="button">Exit</button>

                            <button class="btn btn-success" type="submit">Mark deal as closed</button>
                        </div>
                    </form>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div>

        <div class="modal fade" id="cancelDealModal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="">Deal closed successfully</h4>
                    </div>
                    <form method="post" action="$page.href" class="form-horizontal">
                        <input type="hidden" name="closeDeal"/>
                        <div class="modal-body">
                            <p>Cancel this lead if you are sure it will not go ahead. The lead will be marked as closed without a sale.</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-default" data-dismiss="modal" type="button">Exit</button>

                            <button class="btn btn-primary" type="submit">Cancel this lead</button>
                        </div>
                    </form>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div>

        <div class="modal fade" id="newLeadProfileModal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="">Enter a new lead</h4>
                    </div>
                    <form method="post" action="$page.href" class="form-horizontal">
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="control-label col-md-3" for="funnel">Lead type</label>
                                <div class="col-md-9">
                                    <select name="funnel" class="form-control">
                                        #foreach($entry in $page.find("/leads").funnels.entrySet())
                                        <option value="$entry.key">$entry.value.title</option>
                                        #end
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3" for="notes">Notes</label>
                                <div class="col-md-9">
                                    <textarea name="notes" class="form-control" style="height: 200px"></textarea>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>

                            <button class="btn btn-primary" type="submit">Create and view</button>
                        </div>
                    </form>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div>

        #createModals()

        <script type="text/javascript">
            $(function () {
                var form = $("#leadDetails");
                $('abbr.timeago').timeago();
                form.forms({
                    callback: function (resp) {
                        Msg.info('Saved');
                        reloadTable();
                    }
                });
                var closeDealModal = $("#closeDealModal");
                closeDealModal.find("form").forms({
                    callback: function (resp) {
                        Msg.info('Deal marked as closed');
                        //window.location.reload();
                    }
                });
                var cancelDealModal = $("#cancelDealModal");
                cancelDealModal.find("form").forms({
                    callback: function (resp) {
                        Msg.info('Lead cancelled');
                        //window.location.reload();
                    }
                });
                $("#assignToMenu").on("click", "a", function (e) {
                    e.preventDefault();
                    var name = $(e.target).attr("href");
                    assignTo(name);
                });
                initNewProfileLeadForm();
            });
            function reloadTable() {
                $("#tasksTableBody").reloadFragment({
                    whenComplete: function () {
                        $('abbr.timeago').timeago();
                    }
                });
            }

            function assignTo(name) {
                $.ajax({
                    type: 'POST',
                    url: window.location.pathname,
                    data: {
                        assignToName: name
                    },
                    dataType: 'json',
                    success: function (resp) {
                        if (resp && resp.status) {
                            Msg.info("Assigned");
                            $("#assignedBlock").reloadFragment();
                        } else {
                            Msg.error("Sorry, we couldnt change the assignment");
                        }
                    },
                    error: function (resp) {
                        flog('error', resp);
                        Msg.error('Sorry couldnt set the visibility ' + resp);
                    }
                });
            }

            function initNewProfileLeadForm() {
                var modal = $('#newLeadProfileModal');
                var form = modal.find('form');

                $(".createProfileLead").click(function (e) {
                    flog("click");
                    e.preventDefault();
                    var funnelName = $(e.target).closest("a").attr("href");
                    form.find("select").val(funnelName);
                    modal.modal("show");
                });

                form.forms({
                    callback: function (resp) {
                        flog('done new user', resp);
                        if (resp.nextHref) {
                            window.location.href = resp.nextHref;
                        }
                        Msg.info('Saved');
                        modal.modal("hide");
                    }
                });
            }
        </script>
        #end
    </body>
</html>