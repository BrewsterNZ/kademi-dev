<html xmlns="http://www.w3.org/1999/xhtml">
    #parse("/theme/masterTemplate.html")
    <head>
        #@themeHeader( "View lead" )
        <link rel="stylesheet" href="/static/timeline/timeline.css">
            #end
    </head>
    <body class='add-container'>
        #@themeBody()

        <div class="">
            <div style="background:url(/theme/images/infiniti-bg.jpg) center center; background-size:cover; height: 160px" class="unwrap">
                <div class="container container-lg p-lg">
                    <div class="pull-right">

                        #if( $page.completed)
                        #if( $page.cancelled)
                        <div class="alert alert-warning">
                            <p class="lead">
                                <span class="fa fa-remove"></span>
                                Lead cancelled <abbr title="$formatter.formatDateISO8601($page.closedDate)" class="timeago">$page.closedDate</abbr>
                            </p>
                        </div>
                        #else
                        <div class="alert alert-success">
                            <p class="lead">
                                <span class="fa fa-check"></span>
                                Lead closed <abbr title="$formatter.formatDateISO8601($page.closedDate)" class="timeago">$page.closedDate</abbr>
                            </p>
                        </div>
                        #end
                        #else
                        <div class="btn-group mb-sm mr dropdown">
                            <button id="assignedBlock" class="btn btn-lg dropdown-toggle btn-info" data-toggle="dropdown" type="button" aria-haspopup="true" aria-expanded="false" >
                                <span>
                                    #if( $page.assignedTo )
                                    Assigned to: $!page.assignedTo.firstName $!page.assignedTo.surName
                                    #else
                                    Not assigned
                                    #end
                                </span>
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" id="assignToMenu" role="menu">
                                <li><a href="$user.name">Assign to me</a></li>
                                <li><a href="">Clear</a></li>
                                <li role="separator" class="divider"></li>
                                #foreach($user in $page.find("/leads").teamMembers)
                                <li><a href="$user.name">$user.name</a></li>
                                #end
                            </ul>
                        </div>

                        <div class="btn-group">
                            <button class="btn btn-primary btn-lg" data-target="#newTaskModal" data-toggle="modal">Add new Task</button>

                            <button class="btn btn-lg btn-warning" data-toggle="modal" data-target="#cancelDealModal">
                                <span class="fa fa-remove"></span>
                                Cancel
                            </button>

                            <button class="btn btn-lg btn-success" data-toggle="modal" data-target="#closeDealModal">
                                <span class="fa fa-dollar"></span>
                                Close deal
                            </button>
                        </div>
                        #end
                    </div>
                    <div class="media mt-lg">
                        <div class="media-left media-middle"><a href=""><img src="/theme/images/user/02.jpg" class="media-object thumb96 img-circle"></a></div>
                        <div class="media-body text-white">
                            <h2 class="mv-lg media-heading">
                                #if( $page.profile )
                                <a href="/custs/$page.profile.name" style="color: white">$page.customerDescription</a>
                                #else
                                No contact profile
                                #end
                            </h2>
                            <button type="button" class="btn btn-info btn-xs mr-sm"> <em class="fa fa-twitter fa-fw"></em></button>
                            <button type="button" class="btn btn-primary btn-xs mr-sm"> <em class="fa fa-facebook fa-fw"></em></button>
                            <button type="button" class="btn btn-danger btn-xs"> <em class="fa fa-google-plus fa-fw"></em></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container container-lg">
                <div class="row">
                    <div class="col-lg-3">
                        <div class="panel">
                            <div class="panel-heading no-shadow">
                                <a class="btn btn-success createNote pull-right" href="$page.href">
                                    <span class="fa fa-plus"></span>
                                </a>
                                Recent contacts
                            </div>
                            <div class="panel-body">
                                #set( $notes = $page.notes )
                                #if( $notes.size() > 0 )
                                <ul class="list-block">
                                    #foreach($note in $page.notes)
                                    <li class="media">
                                        <div class="pull-left">
                                            <div class="point-pin"><a href=""><img src="/theme/images/user/05.jpg" alt="Image" class="media-object img-circle thumb32"></a>
                                                <div class="point point-success point-lg"></div>
                                            </div>
                                        </div>
                                        <div class="media-body">
                                            <div class="media-heading">
                                                <p>
                                                    <a href="/users/$note.createdBy.name">$note.createdBy.formattedName</a>

                                                    #if( $note.inbound )
                                                    <small class="text-muted fa fa-arrow-left"></small>
                                                    <small class="text-muted fa fa-${note.icon}"></small>
                                                    #else
                                                    <small class="text-muted fa fa-${note.icon}"></small>
                                                    <small class="text-muted fa fa-arrow-right"></small>
                                                    #end

                                                </p>

                                                <p>
                                                    $note.notes
                                                </p>
                                            </div>
                                        </div>
                                    </li>
                                    #end
                                </ul>
                                #else
                                <p>
                                    <span class="label label-warning">No contact with the lead yet</span>
                                </p>
                                #end
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-9">
                        <div class="panel">
                            <div class="panel-body">
                                <ul role="tablist" class="nav nav-tabs">
                                    <li role="presentation" class="active"><a href="#details" aria-controls="details" role="tab" data-toggle="tab">Details</a></li>
                                    <li role="presentation"><a href="#activity" aria-controls="activity" role="tab" data-toggle="tab">Activity</a></li>
                                    <li role="presentation"><a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">Profile</a></li>
                                    <li role="presentation"><a href="#tasks" aria-controls="tasks" role="tab" data-toggle="tab">Tasks</a></li>
                                </ul>
                                <div class="tab-content">
                                    <div id="details" role="tabpanel" class="tab-pane fade active in">

                                        <textarea id="description" class="form-control" name="description" style="height: 400px">$!page.description</textarea>
                                    </div>

                                    <div id="activity" role="tabpanel" class="tab-pane fade">
                                        #showTimeline($page.timelineItems)
                                    </div>
                                    <div id="profile" role="tabpanel" class="tab-pane fade">
                                        <h4 class="page-header">Contact information</h4>
                                        <div class="row">
                                            <form method="post" action="$page.href" class="form-horizontal" id="leadDetails">
                                                <div class="modal-body">
                                                    #set( $p = $page.leadProfile )
                                                    <div class="form-group">
                                                        <label class="control-label col-md-2" for="nickName">Customer</label>
                                                        <div class="col-md-3">
                                                            <input type="text" name="nickName" id="nickName" class="form-control" placeholder="nickName" value="$!p.nickName" />
                                                        </div>
                                                        <div class="col-md-3">
                                                            <input type="text" name="firstName" id="firstName" class="form-control" placeholder="First name" value="$!p.firstName" />
                                                        </div>
                                                        <div class="col-md-4">
                                                            <input type="text" name="surName" id="surName" class="form-control" placeholder="Surname" value="$!p.surName" />
                                                        </div>
                                                    </div>

                                                    <div class="form-group">
                                                        <label class="control-label col-md-2" for="newUserEmail">Contact</label>
                                                        <div class="col-md-5">
                                                            <input type="text" name="email" id="email" class="form-control" placeholder="Email" value="$!p.email" />
                                                        </div>
                                                        <div class="col-md-5">
                                                            <input type="text" name="phone" id="phone" class="form-control" placeholder="Phone" value="$!p.phone" />
                                                        </div>
                                                    </div>

                                                    <div class="form-group">
                                                        <label class="control-label col-md-2" for="notes">Notes</label>
                                                        <div class="col-md-10">
                                                            <textarea name="notes" class="form-control" style="height: 100px">$!page.description</textarea>
                                                        </div>
                                                    </div>


                                                    #if( $page.completed)
                                                    #else
                                                    <div class="form-group">
                                                        <div class="col-md-10 col-md-offset-10">
                                                            <button class="btn btn-sm btn-default" type="reset">Reset</button>

                                                            <button class="btn btn-primary" type="submit">Save details</button>

                                                        </div>
                                                    </div>
                                                    #end
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    <div id="tasks" role="tabpanel" class="tab-pane fade">
                                        <div class="task-item-list">
                                            <div id="accordion" role="tablist" aria-multiselectable="true" class="panel-group">
                                                <div class="panel panel-default">
                                                    #foreach($task in $page.children)
                                                    <div id="headingOne" role="tab" class="panel-heading">
                                                        <h4 class="panel-title clearfix task-item">
                                                            <div class="pull-left"><span class="inline checkbox c-checkbox">
                                                                    <label>
                                                                        <input type="checkbox"><span class="fa fa-check"></span>
                                                                    </label></span></div>
                                                            <div class="pull-left">
                                                                <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                                                    <span class="task-title">$task.title</span>
                                                                </a>
                                                            </div>
                                                            <div class="pull-left"><span class="task-edit fa fa-pencil"></span></div>
                                                            <div class="pull-right"><span class="close"><em class="fa fa-times"></em></span></div>
                                                        </h4>
                                                    </div>
                                                    <div id="collapseOne" role="tabpanel" aria-labelledby="headingOne" class="panel-collapse collapse in">
                                                        <div class="panel-body">
                                                            #if( $task.is("open") )
                                                            <div class="btn-group pull-right">
                                                                <button class="btn btn-danger btn-lg" title="Cancel task">
                                                                    <span class="fa fa-remove"></span>
                                                                </button>
                                                                <button class="btn btn-success btn-lg" title="Mark task as completed">
                                                                    <span class="fa fa-check"></span>
                                                                </button>
                                                            </div>
                                                            #end
                                                            Due in <abbr title="$formatter.formatDateISO8601($task.dueDate)" class="timeago">$task.dueDate</abbr>
                                                            -
                                                            $task.taskDescription
                                                        </div>
                                                    </div>
                                                    #end
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="fw-boxed">
            <div class="panel panel-default">

            </div>
        </div>


        <hr/>



        <div class="modal fade" id="newTaskModal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="">Create a task</h4>
                    </div>
                    <form method="post" action="$page.href" class="form-horizontal">
                        <div class="modal-body">

                            <div class="form-group">
                                <label class="control-label col-md-3" for="dueDate">Task Due</label>
                                <div class="col-md-9">
                                    <input type="text" name="dueDate" id="dueDate" class="required form-control" placeholder="dueDate" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3" for="taskDescription">Todo</label>
                                <div class="col-md-9">
                                    <input type="text" name="taskDescription" id="taskDescription" class="required form-control" placeholder="taskDescription" />
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>

                            <button class="btn btn-primary" type="submit">Create and view</button>
                        </div>
                    </form>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div>

        <div class="modal fade" id="closeDealModal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="">Deal closed successfully</h4>
                    </div>
                    <form method="post" action="$page.href" class="form-horizontal">
                        <input type="hidden" name="closeDeal"/>
                        <div class="modal-body">

                            <div class="form-group">
                                <label class="control-label col-md-3" for="closedDate">Closed Date</label>
                                <div class="col-md-9">
                                    <input type="text" name="closedDate" id="closedDate" class="required form-control" placeholder="closedDate" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3" for="dealAmount">Sale amount</label>
                                <div class="col-md-9">
                                    <input type="text" name="dealAmount" id="dealAmount" class="required form-control" placeholder="dealAmount" />
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-default" data-dismiss="modal" type="button">Exit</button>

                            <button class="btn btn-success" type="submit">Mark deal as closed</button>
                        </div>
                    </form>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div>

        <div class="modal fade" id="cancelDealModal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="">Deal closed successfully</h4>
                    </div>
                    <form method="post" action="$page.href" class="form-horizontal">
                        <input type="hidden" name="closeDeal"/>
                        <div class="modal-body">
                            <p>Cancel this lead if you are sure it will not go ahead. The lead will be marked as closed without a sale.</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-default" data-dismiss="modal" type="button">Exit</button>

                            <button class="btn btn-primary" type="submit">Cancel this lead</button>
                        </div>
                    </form>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div>

        #createModals()

        <script type="text/javascript">
            $(function () {
                var form = $("#leadDetails");
                form.forms({
                    callback: function (resp) {
                        Msg.info('Saved');
                        reloadTable();
                    }
                });
                var closeDealModal = $("#closeDealModal");
                closeDealModal.find("form").forms({
                    callback: function (resp) {
                        Msg.info('Deal marked as closed');
                        //window.location.reload();
                    }
                });
                var cancelDealModal = $("#cancelDealModal");
                cancelDealModal.find("form").forms({
                    callback: function (resp) {
                        Msg.info('Lead cancelled');
                        //window.location.reload();
                    }
                });
                $("#assignToMenu").on("click", "a", function (e) {
                    e.preventDefault();
                    var name = $(e.target).attr("href");
                    assignTo(name);
                });
                $("body").on("change", ".dealValue", function (e) {
                    var val = $(e.target).val();
                    setDealAmount(val);
                });
                $("body").on("change", "#description", function (e) {
                    var val = $(e.target).val();
                    setLeadDescription(val);
                });

            });
            function reloadTable() {
                $("#tasksTableBody").reloadFragment({
                    whenComplete: function () {
                        $('abbr.timeago').timeago();
                    }
                });
            }

            function assignTo(name) {
                $.ajax({
                    type: 'POST',
                    url: window.location.pathname,
                    data: {
                        assignToName: name
                    },
                    dataType: 'json',
                    success: function (resp) {
                        if (resp && resp.status) {
                            Msg.info("Assigned");
                            $("#assignedBlock").reloadFragment();
                        } else {
                            Msg.error("Sorry, we couldnt change the assignment");
                        }
                    },
                    error: function (resp) {
                        flog('error', resp);
                        Msg.error('Sorry couldnt set the visibility ' + resp);
                    }
                });
            }

            function setDealAmount(val) {
                $.ajax({
                    type: 'POST',
                    url: window.location.pathname,
                    data: {
                        dealAmount : val
                    },
                    dataType: 'json',
                    success: function (resp) {
                        if (resp && resp.status) {
                            Msg.info("Updated");
                        } else {
                            Msg.error("Sorry, we couldnt change the deal amount");
                        }
                    },
                    error: function (resp) {
                        flog('error', resp);
                        Msg.error('Sorry couldnt set the visibility ' + resp);
                    }
                });
            }

            function setLeadDescription(val) {
                $.ajax({
                    type: 'POST',
                    url: window.location.pathname,
                    data: {
                        description : val
                    },
                    dataType: 'json',
                    success: function (resp) {
                        if (resp && resp.status) {
                            Msg.info("Updated");
                        } else {
                            Msg.error("Sorry, we couldnt change the description");
                        }
                    },
                    error: function (resp) {
                        flog('error', resp);
                        Msg.error('Sorry couldnt set the visibility ' + resp);
                    }
                });
            }

        </script>
        #end
    </body>
</html>