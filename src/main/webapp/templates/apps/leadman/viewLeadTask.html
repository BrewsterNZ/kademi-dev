<html xmlns="http://www.w3.org/1999/xhtml">
    #parse("/theme/masterTemplate.html")
    <head>
        #@themeHeader( "View lead" )
        <script src="/static/reload-fragment/1.0.1/jquery.reload-fragment-1.0.1.js" type="text/javascript" >//</script>
        #end
    </head>
    <body class='add-container'>
        #@themeBody()

        <div class="app-view-header">
            <div class="btn-group mb-sm mr dropdown pull-right">
                <button id="assignedBlock" class="btn btn-lg dropdown-toggle btn-info" data-toggle="dropdown" type="button" aria-haspopup="true" aria-expanded="false" >
                    <span>
                        #if( $page.assignedTo )
                        Assigned to: $page.assignedTo.name
                        #else
                        Not assigned
                        #end
                    </span>
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" id="assignToMenu" role="menu">
                    <li><a href="$user.name">Assign to me</a></li>
                    <li><a href="">Clear</a></li>
                    <li role="separator" class="divider"></li>
                    #foreach($user in $page.parent.teamMembers)
                    <li><a href="$user.name">$user.name</a></li>
                    #end
                </ul>
            </div>
            Task: $page.taskDescription
        </div>

        #if( $page.assignedTo )
        <p class="lead">Assigned to: $!page.assignedTo.formattedName()</p>
        #else
        <p class="lead">Not assigned</p>
        #end
        <p class="lead">Lead: <a href="../">$page.leadProfile.formattedName()</a></p>
        <hr/>


        <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#newReminderModal">
            Create reminder
        </button>

        <h2>Reminders - $page.children.size()</h2>
        <table class="table table-responsive table-striped">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Due date</th>
                </tr>
            </thead>
            <tbody id="remindersTableBody">
                #foreach($reminder in $page.children)
                <tr>
                    <td>$reminder.dueDate</td>
                </tr>
                #end
            </tbody>
        </table>

        <div class="modal fade" id="newReminderModal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="">Create a task</h4>
                    </div>
                    <form method="post" action="$page.href" class="form-horizontal">
                        <input type="hidden" name="newReminder"  />
                        <div class="modal-body">

                            <div class="form-group">
                                <label class="control-label col-md-3" for="dueDate">dueDate</label>
                                <div class="col-md-9">
                                    <input type="text" name="dueDate" id="dueDate" class="required form-control" placeholder="dueDate" />
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>

                            <button class="btn btn-primary" type="submit">Create and view</button>
                        </div>
                    </form>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div>

        <script type="text/javascript">
            $(function () {
                var modal = $('#newReminderModal');
                var form = modal.find('form');

                form.forms({
                    callback: function (resp) {
                        Msg.info('Saved');
                        $("#remindersTableBody").reloadFragment();
                    }
                });


               $("#assignToMenu").on("click", "a", function (e) {
                    e.preventDefault();
                    var name = $(e.target).attr("href");
                    assignTo(name);
                });

            });
            function assignTo(name) {
                $.ajax({
                    type: 'POST',
                    url: window.location.pathname,
                    data: {
                        assignToName: name
                    },
                    dataType: 'json',
                    success: function (resp) {
                        if (resp && resp.status) {
                            Msg.info("Assigned");
                            $("#assignedBlock").reloadFragment();
                        } else {
                            Msg.error("Sorry, we couldnt change the assignment");
                        }
                    },
                    error: function (resp) {
                        flog('error', resp);
                        Msg.error('Sorry couldnt set the visibility ' + resp);
                    }
                });
            }
        </script>
        #end
    </body>
</html>