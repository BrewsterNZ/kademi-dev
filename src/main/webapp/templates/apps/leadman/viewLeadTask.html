<html xmlns="http://www.w3.org/1999/xhtml">
    #parse("/theme/masterTemplate.html")
    <head>
        #@themeHeader( "View lead" )
        <script src="/static/reload-fragment/1.0.1/jquery.reload-fragment-1.0.1.js" type="text/javascript" >//</script>
        #end
    </head>
    <body class='add-container'>
        #@themeBody()

        <div class="app-view-header">
            <div class="btn-group mb-sm mr dropdown pull-right">
                <button id="assignedBlock" class="btn btn-lg dropdown-toggle btn-info" data-toggle="dropdown" type="button" aria-haspopup="true" aria-expanded="false" >
                    <span>
                        #if( $page.assignedTo )
                        Assigned to: $page.assignedTo.name
                        #else
                        Not assigned
                        #end
                    </span>
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" id="assignToMenu" role="menu">
                    <li><a href="$user.name">Assign to me</a></li>
                    <li><a href="">Clear</a></li>
                    <li role="separator" class="divider"></li>
                    #foreach($user in $page.parent.teamMembers)
                    <li><a href="$user.name">$user.name</a></li>
                    #end
                </ul>
            </div>
            Task: $page.taskDescription
        </div>

        #if( $page.assignedTo )
        <p class="lead">Assigned to: $!page.assignedTo.formattedName()</p>
        #else
        <p class="lead">Not assigned</p>
        #end
        <p class="lead">Lead: <a href="../">$page.leadProfile.formattedName()</a></p>
        <hr/>



        <script type="text/javascript">
            $(function () {
               $("#assignToMenu").on("click", "a", function (e) {
                    e.preventDefault();
                    var name = $(e.target).attr("href");
                    assignTo(name);
                });

            });
            function assignTo(name) {
                $.ajax({
                    type: 'POST',
                    url: window.location.pathname,
                    data: {
                        assignToName: name
                    },
                    dataType: 'json',
                    success: function (resp) {
                        if (resp && resp.status) {
                            Msg.info("Assigned");
                            $("#assignedBlock").reloadFragment();
                        } else {
                            Msg.error("Sorry, we couldnt change the assignment");
                        }
                    },
                    error: function (resp) {
                        flog('error', resp);
                        Msg.error('Sorry couldnt set the visibility ' + resp);
                    }
                });
            }
        </script>
        #end
    </body>
</html>