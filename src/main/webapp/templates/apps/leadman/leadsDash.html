<div class="">
    <p class='lead'>Leads</p>
    #set( $leadsPage = $page.find("/leads") )

    <div class="row">
        <div class="col-lg-6">
            <div class="input-group" id="voucher-query-container">
                <input type="text" id="leadQuery" name="q" class="form-control" placeholder="Search for a lead" />
            </div>
        </div>
        <div class="col-lg-6">
            <div class="btn-group">
                <button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown">
                    <i class="fa fa-user-plus"></i> Create a lead
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu">
                    #foreach($funnel in $leadsPage.funnels)
                    <li class="presentation" role="menuitem"><a href="$funnel.name" class="createLead">$funnel.name - $!funnel.title</a></li>
                    #end
                </ul>
            </div>
        </div>
    </div>

    #set( $tasks = $leadsPage.tasks )
    #set( $tasks = $leadsPage.allTasks )
    tasks - $tasks.size()
    #if( $tasks.size() > 0 )
    <div class="table-responsive">
        <table id="" class="table table-striped table-hover" style="width: 100%">
            <colgroup>
                <col width="" />
            </colgroup>
            <thead>
                <tr>
                    <th>Task</th>
                </tr>
            </thead>
            <tbody id="leadsBody">
                #foreach($task in $tasks)
                <tr>
                    <td><a href='/leads/$task.relatedLead.id/$task.id/'>$task.taskDescription</a></td>
                </tr>
                #end
            </tbody>
        </table>
    </div>
    #end



    #set( $leads = $leadsPage.search($params.q) )

    #if( $leads.size() > 0 )
    <div class="table-responsive">
        <table id="" class="table table-striped table-hover" style="width: 100%">
            <colgroup>
                <col width="" />
                <col width="" />
                <col width="" />
                <col width="" />
                <col width="" />
                <col width="280px" />
            </colgroup>
            <thead>
                <tr>
                    <th>Last reached goal</th>
                    <th>Next goal</th>
                    <th>Profile</th>
                    <th>Date</th>
                    <th>By</th>
                    <th class="action"></th>
                </tr>
            </thead>
            <tbody id="leadsBody">
                #foreach($lead in $leads)
                <tr>
                    <td><a href='/leads/$lead.id'>$lead.lastAttainedGoal</a></td>
                    <td><a href='/leads/$lead.id'>$lead.currentGoal</a></td>
                    <td>$!lead.profile.email</td>
                    <td>$!lead.assignedToProfile.email</td>
                    <td>$lead.createDate</td>
                </tr>
                #end
            </tbody>
        </table>
    </div>
    #end
</div>

#parse("/theme/apps/leadman/newLeadModal.html")

<script type="text/javascript">
    $(function () {
        $('abbr.timeago').timeago();
        initNewUserForm();
        $('#leadQuery').keyup(function () {
            typewatch(function () {
                flog('do search');
                doLeadSearch($('#leadQuery').val());
            }, 500);
        });

        function doLeadSearch(q) {
            var href = window.location.pathname + "?q=" + q
            $("#leadsBody").reloadFragment({
                url: href,
                whenComplete: function () {
                    window.history.pushState("", href, href);
                    $('abbr.timeago').timeago();
                }
            });
        }
    });
</script>

