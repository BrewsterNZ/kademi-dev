<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>$view.title</title>
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/r/bs/dt-1.10.9,r-1.0.7/datatables.min.css"/>
        <script type="text/javascript" src="https://cdn.datatables.net/r/bs/dt-1.10.9,r-1.0.7/datatables.min.js">//</script>
    </head>
    <body>
        <div class="">
            <p>
                <a href="#" class="btn btn-sm btn-success" data-toggle="modal" data-target="#addWebsiteModal" ><i class="fa fa-plus"></i> Create new invoice</a>
                <!--<a href="invoiceWinners.csv" class="btn btn-sm btn-success pull-right" ><i class="fa fa-download"></i> Winners CSV</a>-->
            </p>

            <div class="modal fade" id="addWebsiteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="myModalLabel">Add new invoice</h4>
                        </div>
                        <div class="modal-body">
                            <form class="form-horizontal" method="POST" action=".">
                                <div class="form-group">
                                    <label for="invoiceTitle" class="col-sm-3 control-label">Invoice Title</label>
                                    <div class="col-sm-8">
                                        <input type="text" class="form-control required" required="true" id="invoiceTitle" name="invoiceTitle" />
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="invoiceWebsite" class="col-sm-3 control-label">Website</label>
                                    <div class="col-sm-8">
                                        <select id="invoiceWebsite" name="invoiceWebsite" class="form-control">
                                            #foreach($website in $page.organisation.websites())
                                                <option value="$website.name">$website.name</option>
                                            #end
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="invoiceBidType" class="col-sm-3 control-label">Invoice Type</label>
                                    <div class="col-sm-8">
                                        <select name="invoiceBidType" class="form-control">
                                            #foreach($st in $page.invoiceTypesMap.entrySet())
                                    $formatter.option($st.key, $st.value, null)
                                    #end
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="invoiceStartDate" class="col-sm-3 control-label">Start Date</label>
                                    <div class="col-sm-8">
                                        <input type='text' class="form-control date required" id="invoiceStartDate" name="invoiceStartDate" style="cursor:pointer;"/>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="invoiceEndDate" class="col-sm-3 control-label">End Date</label>
                                    <div class="col-sm-8">
                                        <input type='text' class="form-control date required" id="invoiceEndDate" name="invoiceEndDate" style="cursor:pointer;"/>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-sm btn-primary" data-type="form-submit">Create Invoice</button>
                        </div>
                    </div>
                </div>
            </div><!-- /.modal -->
        </div>

        <div class="panel panel-default">
            <div class="panel-body" id="invoiceTableWrapper">
                #set($invoices = $page.children.ofType("invoice"))
                #set($state = $request.params.state)
                #set($draftInvoices = $invoices.ofType('Draft'))
                #set($sentInvoices = $invoices.ofType('Sent'))
                #set($overdueInvoices = $invoices.ofType('Overdue'))
                #set($paidInvoices = $invoices.ofType('Paid'))
                <div class="btn-group" >
                    <a href="#if ($state == 'Draft') ?state= #else ?state=Draft #end" class="btn btn-sm btn-default #isActive('Draft')"><i class="fa fa-pencil-square-o"></i> $draftInvoices.size() Draft</a>
                    <a href="#if ($state == 'Sent') ?state= #else ?state=Sent #end" class="btn btn-sm btn-default #isActive('Sent')"><i class="fa fa-send"></i> $sentInvoices.size() Sent</a>
                    <a href="#if ($state == 'Overdue') ?state= #else ?state=Overdue #end" class="btn btn-sm btn-default #isActive('Overdue')"><i class="fa fa-exclamation-circle"></i> $overdueInvoices.size() Overdue</a>
                    <a href="#if ($state == 'Paid') ?state= #else ?state=Paid #end" class="btn btn-sm btn-default #isActive('Paid')"><i class="fa fa-check"></i> $paidInvoices.size() Paid</a>
                </div>
                <table id="invoice-wrapper" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
                    <colgroup>
                        <col width="60px" />
                        <col width="" />
                        <col width="" />
                        <col width="" />
                        <col width="" />
                        <col width="" />
                        <col width="" />
                        <col width="" />
                        <col width="" />
                        <col width="" />
                        <col width="130px" />
                    </colgroup>
                    <thead>
                        <tr role="row">
                            <th class="text-center">Status</th>
                            <th>Number</th>
                            <th>Title</th>
                            <th>Customer</th>
                            <th>Vendor</th>
                            <th>Sub Total</th>
                            <th>Tax</th>
                            <th>Total</th>
                            <th>Issue Date</th>
                            <th>Due Date</th>
                            <th class="action"></th>
                        </tr>
                    </thead>
                    <tbody id="invoiceTableBody">
                        #if ($state == 'Draft')
                            #set( $invoices = $draftInvoices )
                        #elseif ($state == 'Sent')
                            #set( $invoices = $sentInvoices )
                        #elseif ($state == 'Overdue')
                            #set( $invoices = $overdueInvoices )
                        #elseif ($state == 'Paid')
                            #set( $invoices = $paidInvoices )
                        #end
                
                        #foreach($v in $invoices)
                        <tr>
                            <td title="$v.invoiceState" class="text-center lead">
                                #if($v.invoiceState == "Draft")
                                <i class="fa fa-pencil-square-o text-muted"></i>
                                #elseif($v.invoiceState == "Paid")
                                <i class="fa fa-check-circle text-success"></i>
                                #elseif($v.invoiceState == "Overdue")
                                <i class="fa fa-exclamation-circle text-danger"></i>
                                #elseif($v.invoiceState == "Sent")
                                <i class="fa fa-check-circle text-success"></i>
                                #else
                                <i class="fa fa-exclamation-circle text-danger"></i>
                                #end
                            </td>
                            <td><a href="#">$v.number</a></td>
                            <td>$v.title</td>
                            <td>-</td>
                            <td>-</td>
                            <td>$v.subTotal</td>
                            <td>$v.tax</td>
                            <td>$v.total</td>
                            <td><abbr title="$formatter.formatDateISO8601($v.issuedDate)" class="timeago">$v.issuedDate</abbr></td>
                            #if ($v.dueDate)
                            <td><abbr title="$formatter.formatDateISO8601($v.dueDate)" class="timeago">$v.dueDate</abbr></td>
                            #else
                            <td>-</td>
                            #end
                            <td class="action">
                                <div class="btn-group btn-group-sm">
                                    <a href="$v.name" class="btn btn-sm btn-info"><i class="fa fa-cog"></i> Manage</a>
                                    <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-toggle="dropdown">
                                        <span class="caret"></span>
                                        <span class="sr-only">Toggle Dropdown</span>
                                    </button>
                                    <ul role="menu" class="dropdown-menu pull-right">
                                        <li><a class="XInvoice" href="$v.name"><i class="fa fa-send"></i> Mark as Sent</a></li>
                                        <li><a class="XInvoice" href="$v.name"><i class="glyphicon glyphicon-remove"></i> Delete</a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        #end
                    </tbody>
                </table>
            </div>
        </div>
        #macro(isActive $state)
            #if(!$request.params.state || $request.params.state == '')
                #if($state == 'open')
                active
                #end
            #elseif($request.params.state == $state)
            active            
            #end

        #end
        
        #macro(genGroup $group)
        #set($gc = "label label-info")
        #set($gIcon = "")
        #if( $group.groupType == "P" || !$group.groupType)
        #set($gc = "label label-success")
        #set($gIcon = "clip-users")
        #elseif( $group.groupType == "S" )
        #set($gc = "label label-info")
        #set($gIcon = "fa fa-trophy")
        #elseif( $group.groupType == "M" )
        #set($gc = "label label-info")
        #set($gIcon = "fa fa-envelope")
        #end
        <div class="$gc" style="margin-right: 2.5px; margin-bottom: 5px; display: inline-block;">
            <i class="$gIcon"></i>
            <span class="block-name" title="$group.name">$group.name</span>
        </div>
        #end
        <script src="/theme/apps/payment/manageInvoices.js" type="text/javascript">//</script>
        <script type="text/javascript">
            $(function () {
                initManageInvoices();
            });
        </script>
    </body>
</html>