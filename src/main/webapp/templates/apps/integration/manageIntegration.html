<html xmlns="http://www.w3.org/1999/xhtml">    <head>        <title>Manage Products</title>        <style>            .icon {                width: 60px;                text-align: center;            }            .icon i {                font-size: 30px;            }            .btn-file {                position: relative;                overflow: hidden;            }            .btn-file input[type=file] {                position: absolute;                top: 0;                right: 0;                min-width: 100%;                min-height: 100%;                font-size: 100px;                text-align: right;                filter: alpha(opacity=0);                opacity: 0;                background: red;                cursor: inherit;                display: block;            }            .file-input {                background-color: white !important;                cursor: text !important;            }        </style>    </head>    <body class="">        <div class="tabbable">            <div class="row">                <div class="col-sm-6">                    <ul class="nav nav-tabs tab-bricky" id="myTab">                        <li class="active"><a data-toggle="tab" href="#history"><i class="green fa fa-home"></i> Integration history</a></li>                        <li class=""><a data-toggle="tab" href="#endpoints"><i class="green fa fa-gear"></i> Endpoints</a></li>                        <li class=""><a data-toggle="tab" href="#schedules"><i class="green fa fa-calendar"></i> Schedules</a></li>                    </ul>                </div>                <div class="col-sm-6 text-right">                    #if ($page.currentWebsite)                        <div class="btn-group">                            <a class="btn btn-sm btn-default article-preview" target="_blank" href="$page.href?goto=">                                Website: $page.currentWebsite.parent.name ( $page.currentWebsite.name )                            </a>                            <button type="button" class="btn btn-sm btn-default dropdown-toggle" data-toggle="dropdown">                                <span class="caret"></span>                                <span class="sr-only">Toggle Dropdown</span>                            </button>                            #if( $page.integrationWebsites.isEmpty() )                                <span class="label label-danger">The integration app is not enabled on any sites</span>                            #else                                <ul class="dropdown-menu pull-right" role="menu">                                    <li><a>Select a website and version:</a></li>                                    #foreach($website in $page.integrationWebsites)                                        <li><a href="$page.href?branch=websites/$website.name/$website.repository.liveBranch">$website.name (LIVE)</a></li>                                        #foreach($version in $website.children.ofType.branch)                                            <li><a href="$page.href?branch=websites/$website.name/$version.name">$website.name ($version.name)</a></li>                                        #end                                        <li class="divider"></li>                                    #end                                </ul>                            #end                        </div>                    #else                        <p>                            <a class="btn btn-default" href="/websites/">                                <span class="glyphicon glyphicon-globe"></span>                                Create a Website                            </a>                        </p>                    #end                </div>            </div>            <div class="tab-content">                <div id="history" class="tab-pane active">                    <p class="text-right">                        <a class="btn btn-sm btn-danger btn-delete-exec" href="#">                            <span class="glyphicon glyphicon-trash"></span>                            Delete                        </a>                    </p>                    <div class="table-responsive">                        <table class="table table-striped table-hover">                            <thead>                                <tr>                                    <th>Status</th>                                    <th>ID</th>                                    <th>Pipeline</th>                                    <th>Started</th>                                    <th>Duration</th>                                    <th>Website</th>                                    <th>Source</th>                                    <th>Destination</th>                                    <th><input type="checkbox" class="check-all"/></th>                                </tr>                            </thead>                            <tbody>                                #foreach($exec in $page.executionHistory)                                #set($duration = $exec.endDate.time - $exec.startDate.time)                                <tr>                                    #genStatus($exec)                                    <td><a href="$exec.id">$!exec.executionId</a></td>                                    <td>$exec.pipelinePath</td>                                    <td>$formatter.formatDateTime($exec.startDate, $page.organisation.timezone)</td>                                    <td>                                        #if($exec.status == "S")                                        #set($duration = $formatter.now.time - $exec.startDate.time)                                        #end                                        #if( $duration < 10000 )                                        $duration ms                                        #else                                        #set( $duration = $duration / 1000 )                                        $duration secs                                        #end                                    </td>                                    <td>$exec.websiteBranch.repository.name</td>                                    <td>$!exec.source</td>                                    <td>$formatter.percentDecode($exec.destination)</td>                                    <th><input type="checkbox" data-execid="$exec.id" class="exec-check"/></th>                                </tr>                                #end                            </tbody>                        </table>                    </div>                </div>                <div id="endpoints" class="tab-pane">                    <div class="alert alert-info">                        Create endpoints which receive incoming data, or transmit outgoing data. Endpoints link                        to a pipeline definition, which is an XML file containing a series of steps to execute to                        process or generate data.                        <br/>                        Integration configuration files are stored in a website this will process integration requests.                    </div>                    #if ($page.currentWebsite)                        <div class="row">                            <div class="col-md-6">                                <p>                                    #if( $page.configFile )                                        <a class="btn btn-default" href="${page.configFile.parent.href}texteditor?fileName=$page.configFile.name">                                            <span class="glyphicon glyphicon-pencil"></span>                                            Edit config                                        </a>                                    #else                                        #set($defaultContent = "<integration><endpoint id='first' type='http' address='/inbound/mydata.xlsx' pipelinePath='/first.xml' direction='in' enabled='true'/></integration>")                                        <a class="btn btn-sm btn-default" href="${page.currentWebsite.href}theme/texteditor?fileName=integration.xml&content=$formatter.percentEncode($defaultContent)">                                            <span class="glyphicon glyphicon-pencil"></span>                                            Create config                                        </a>                                    #end                                    <a class="btn btn-sm btn-default" href="/repositories/${page.currentWebsite.parent.name}/#files-tab">                                        <span class="glyphicon glyphicon-file"></span>                                        File manager                                    </a>                                </p>                            </div>                        </div>                    #end                    <div class="table-responsive">                        <table class="table table-striped table-hover">                            <thead>                                <tr>                                    <th>ID</th>                                    <th>Direction</th>                                    <th>Type</th>                                    <th>Address</th>                                    <th>Pipeline Path</th>                                    <th>Action</th>                                </tr>                            </thead>                            <tbody>                                #foreach($endpoint in $page.endPointMappings)                                #set($pipelineFile = $page.currentWebsite.find($endpoint.pipelinePath))                                <tr>                                    <td>$endpoint.id</td>                                    <td>$endpoint.direction</td>                                    <td>$endpoint.type</td>                                    <td>$formatter.htmlAttEncode($endpoint.address)</td>                                    <td>                                        #set( $p = $endpoint.addPath($page.currentWebsite.path)  )                                        #set( $pipelineFile = false )                                        #set( $pipelineFile = $page.getPipelineFile($endpoint) )                                        #if( $pipelineFile )                                        <a href="${p.parent}/texteditor?fileName=$p.name">$endpoint.pipelinePath</a>                                        #else                                        #set($defaultPipelineContent = "<RecordExecutionStep><next class='TransactionStep' alwaysRollback='false'><next class='ExcelInputStep' startRow='1'><nextSheetSteps><NextSheetStep sheetNum='0' startRow='2'><next class='DatabaseUpdateStep' providerId='products' mode='updateOrInsert'></next></NextSheetStep></nextSheetSteps></next></RecordExecutionStep>")                                        <a class="btn btn-default" href="${p.parent}/texteditor?fileName=${p.name}&content=$formatter.percentEncode($defaultPipelineContent)">                                            <span class="glyphicon glyphicon-pencil"></span>                                            Create $p                                        </a>                                        <a class="label label-warning" href="${p.parent}/texteditor?fileName=$p.name">Missing file</a>                                        #end                                    </td>                                    #set($namedGroups = "")                                    #foreach($g in $endpoint.namedGroups)                                    #set($namedGroups = $namedGroups  + $g + ",")                                    #end                                    <td>                                        #if($endpoint.direction == "in")                                        <a class="btn btn-sm btn-success btn-upload-file" data-endpointid="$endpoint.id" data-namedgroups="$namedGroups"><i class="fa fa-file"></i> Upload File</a>                                        #elseif( $endpoint.direction == "out")                                        #if($endpoint.type == "ftp" || $endpoint.type == "email" || $endpoint.type == "sftp" || $endpoint.type.startsWith("http"))                                        <a class="btn btn-sm btn-success btn-trigger-ftp" href="$endpoint.id" ><i class="fa fa-upload"></i> Trigger</a>                                        #end                                        <!--<a class="btn btn-sm btn-success btn-download-file" href="$endpoint.id" ><i class="fa fa-file"></i> Trigger</a>-->                                        #end                                    </td>                                </tr>                                #end                            </tbody>                        </table>                    </div>                </div>                <div id="schedules" class="tab-pane">                    <div class="alert alert-info">                        Create endpoints which receive incoming data, or transmit outgoing data. Endpoints link                        to a pipeline definition, which is an XML file containing a series of steps to execute to                        process or generate data.                        <br/>                        Integration configuration files are stored in a website this will process integration requests.                    </div>                    <div class="row">                        <div class="col-md-6">                            <button class="btn btn-sm btn-default" data-toggle="modal" data-target="#modal-add-schedule">                                <span class="fa fa-plus"></span>                                Add Schedule                            </button>                        </div>                        <div class="col-md-6 text-right">                            <a class="btn btn-sm btn-danger btn-delete-schedule" href="#">                                <span class="glyphicon glyphicon-trash"></span>                                Delete                            </a>                        </div>                    </div>                    <div class="table-responsive">                        <table class="table table-striped table-hover">                            <colgroup>                                <col/>                                <col/>                                <col/>                                <col/>                                <col/>                                <col/>                                <col width="50px"/>                            </colgroup>                            <thead>                                <tr>                                    <th>Pipeline</th>                                    <th>Type</th>                                    <th>Website</th>                                    <th>Start Date</th>                                    <th>Next Due</th>                                    <th>Interval</th>                                    <th><input type="checkbox" class="check-all-schedules"/></th>                                </tr>                            </thead>                            <tbody>                                #foreach($s in $page.child('schedules').children.ofType("schedule"))                                #set($sched = $s.schedule)                                <tr>                                    <td>$sched.pipelineId</td>                                    <td>$sched.scheduleType</td>                                    <td>$sched.branch.repository.name ($sched.branch.name)</td>                                    <td>$formatter.formatDateTime($sched.startDate, $page.organisation.timezone)</td>                                    <td>$formatter.formatDateTime($sched.endDate, $page.organisation.timezone)</td>                                    <td>$s.scheduleInterval</td>                                    <td><input type="checkbox" data-schedhref="schedules/${s.name}" class="sched-check"/></td>                                </tr>                                #end                            </tbody>                        </table>                    </div>                </div>            </div>        </div>        <div id="modal-upload-file" class="modal fade" aria-hidden="true" tabindex="-1">            <div class="modal-header">                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>                <h4 class="modal-title">Upload File</h4>            </div>            <form action="" method="POST" class="form-horizontal" enctype="multipart/form-data">                <div class="modal-body">                    <div class="form-message alert alert-danger" style="display: none;"></div>                    <div class="form-group">                        <input type="hidden" id="uploadPipeline" name="uploadPipeline" value="" />                        <label class="col-md-3 control-label">File</label>                        <div class="col-md-8">                            <div class="input-group">                                <span class="input-group-btn">                                    <span class="btn btn-primary btn-file">                                        Browse&hellip; <input name="file" type="file" />                                    </span>                                </span>                                <input type="text" class="form-control file-input" readonly>                            </div>                        </div>                    </div>                    <div class="extra-params">                        <div class="form-group">                            <label class="col-md-3 control-label" for="baseCost">Base cost</label>                            <div class="col-md-8">                                <input class="form-control numeric" id="baseCost" type="text" name="baseCost" maxlength="20" placeholder="Base cost of the product" />                            </div>                        </div>                    </div>                    <div class="form-group">                        <label class="col-md-3 control-label" for="alwaysRollback">Rollback</label>                        <div class="col-md-8">                            <input title="If selected no data will be saved to the database. Used for testing a file." class="form-control" id="alwaysRollback" type="checkbox" name="alwaysRollback" value="true" />                        </div>                    </div>            </div>            <div class="modal-footer">                <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>                <button class="btn btn-sm btn-primary" type="submit">Upload</button>            </div>            </form>        </div>        <div id="modal-add-schedule" class="modal fade" aria-hidden="true" tabindex="-1">            <div class="modal-header">                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>                <h4 class="modal-title">Add Schedule</h4>            </div>            <form action="." method="POST" class="form-horizontal">                <div class="modal-body">                    <div class="form-message alert alert-danger" style="display: none;"></div>                    <input type="hidden" id="addSchedule" name="addSchedule" value="true" />                    <div class="form-group">                        <label class="col-md-3 control-label" for="pipelineId">Pipeline</label>                        <div class="col-md-8">                            <select name="pipelineId" class="required form-control">                                #foreach($endpoint in $page.endPointMappings)                                $formatter.option($endpoint.id, $endpoint.id, null)                                #end                            </select>                        </div>                    </div>                    <div class="form-group">                        <label class="col-md-3 control-label" for="scheduleType">Schedule type</label>                        <div class="col-md-8">                            <select name="scheduleType" class="required form-control">                                #foreach($type in $page.scheduleTypes)                                $formatter.option($type, $type, null)                                #end                            </select>                        </div>                    </div>                    <div class="form-group">                        <label class="col-md-3 control-label" for="timerUnit">Frequency</label>                        <div class="col-md-8">                            <select name="timerUnit" class="required form-control">                                #foreach($unit in $page.timerUnits)                                $formatter.option($unit, $unit, null)                                #end                            </select>                        </div>                    </div>                    <div class="form-group">                        <label class="col-md-3 control-label" for="dayName">Specific Day</label>                        <div class="col-md-8">                            <select name="dayName" class="required form-control">                                <option>Select one day</option>                                #foreach($day in $page.DaysOfWeek)                                $formatter.option($day, $day, null)                                #end                            </select>                        </div>                    </div>                    <div class="form-group">                        <label class="col-md-3 control-label" for="timerMultiple">Multiplier</label>                        <div class="col-md-8">                            <input class="form-control numeric required" id="timerMultiple" type="text" name="timerMultiple" maxlength="20" placeholder="" />                        </div>                    </div>                    <div class="form-group">                        <label class="col-md-3 control-label" for="startDate">Start Date</label>                        <div class="col-md-8">                            <div class="input-group">                                <input type="text" name="startDate" value="$formatter.formatDate($page.job.startDate)" placeholder="Start date" data-format="DD/MM/YYYY HH:mm" class="form-control date-time-picker required" data-impacted="#endDate" data-impact="startDate" />                                <span class="input-group-addon"> <i class="fa fa-calendar"></i> </span>                            </div>                        </div>                    </div>            </div>            <div class="modal-footer">                <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>                <button class="btn btn-sm btn-primary" type="submit">Add</button>            </div>            </form>        </div>        <form id="downloadForm" class="hide" method="POST" action="$page.href">            <input type="hidden" name="export" />            <input type="hidden" name="branch" value="$request.params.branch"/>        </form>        <script type="text/javascript" src="/static/js/jquery.milton-upload.js"></script>        <script type="text/javascript">            $(function () {                $("form.referral-settings").forms({                    callback: function () {                        Msg.info("Updated settings")                    }                });                $(".btn-download-file").click(function (e) {                    e.preventDefault();                    var link = $(e.target).closest("a");                    var pipelineId = link.attr("href");                    var form = $("#downloadForm");                    form.find("input[name=export]").val(pipelineId);                    form.submit();                });                var fileUploadModal = $("#modal-upload-file");                var fileUploadForm = fileUploadModal.find('form');                $(document.body).on('click', '.btn-upload-file', function (e) {                    fileUploadForm.trigger("reset");                    var extraFields = fileUploadModal.find('.extra-params');                    var uploadPipeline = fileUploadModal.find("#uploadPipeline");                    e.preventDefault();                    var button = $(this);                    var d = button.data("namedgroups");                    if (d.endsWith(",")) {                        d = d.substring(0, d.length - 1);                    }                    var nameGroups = d.split(",");                    var endpointId = button.data("endpointid");                    uploadPipeline.val(endpointId);                    extraFields.empty();                    for (var i = 0; i < nameGroups.length; i++) {                        if (nameGroups[i] !== "") {                            extraFields.append(createExtraFieldElement(nameGroups[i]));                            flog(nameGroups[i]);                        }                    }                    fileUploadModal.modal("show");                });                $(document.body).on('click', '.btn-trigger-ftp', function (e) {                    e.preventDefault();                    var btn = $(this);                    var href = btn.attr('href');                    if (confirm('Are you sure you want to trigger ' + href + '?')) {                        $.ajax({                            type: 'POST',                            dataType: 'json',                            data: {                                action: 'trigger',                                id: href                            },                            success: function (data, textStatus, jqXHR) {                            }                        });                    }                });                fileUploadForm.forms({                    postUrl: window.location.pathname + window.location.search,                    onValid: function () {                        Msg.info("Uploading file...");                    },                    callback: function (resp) {                        flog(resp);                        Msg.info(resp.messages[0]);                        $("#modal-upload-file").modal("hide");                    },                    error: function (resp) {                        flog(resp);                    }                });                $(document).on('change', '.btn-file :file', function () {                    var input = $(this),                            numFiles = input.get(0).files ? input.get(0).files.length : 1,                            label = input.val().replace(/\\/g, '/').replace(/.*\//, '');                    input.trigger('fileselect', [numFiles, label]);                });                $(document).ready(function () {                    $('.btn-file :file').on('fileselect', function (event, numFiles, label) {                        var input = $(this).parents('.input-group').find(':text'),                                log = numFiles > 1 ? numFiles + ' files selected' : label;                        if (input.length) {                            input.val(log);                        } else {                            if (log)                                alert(log);                        }                    });                });                $(document.body).on('change', '.check-all', function (e) {                    var checkedStatus = this.checked;                    $(document.body).find(':checkbox.exec-check').prop('checked', checkedStatus);                });                $(document.body).on('click', '.btn-delete-exec', function (e) {                    e.preventDefault();                    var listToDelete = [];                    $(document.body).find(':checkbox.exec-check:checked').each(function () {                        flog($(this).data("execid"));                        listToDelete.push($(this).data("execid"));                    });                    if (listToDelete.length > 0 && confirm("Are you sure you want to delete " + listToDelete.length + " logs?")) {                        $(document.body).find('.check-all').check(false).change();                        flog(listToDelete.join(','));                        deleteLogs(listToDelete);                    }                });                $(document.body).on('change', '.check-all-schedules', function (e) {                    var checkedStatus = this.checked;                    $(document.body).find(':checkbox.sched-check').prop('checked', checkedStatus);                });                $(document.body).on('click', '.btn-delete-schedule', function (e) {                    e.preventDefault();                    var listToDelete = [];                    $(document.body).find(':checkbox.sched-check:checked').each(function () {                        flog($(this).data("schedhref"));                        listToDelete.push($(this).data("schedhref"));                    });                    if (listToDelete.length > 0 && confirm("Are you sure you want to delete " + listToDelete.length + " schedule" + (listToDelete.length > 1 ? 's' : '') + "?")) {                        $(document.body).find('.check-all-schedules').check(false).change();                        flog(listToDelete.join(','));                        deleteSchedules(listToDelete);                    }                });                var addScheduleModal = $("#modal-add-schedule");                var addScheduleForm = addScheduleModal.find('form');                addScheduleForm.forms({                    onSuccess: function (resp) {                        flog(resp);                        Msg.info(resp.messages[0]);                        addScheduleModal.modal("hide");                        $('#schedules').reloadFragment({                            url: window.location.pathname + window.location.search,                        });                    },                    onError: function (resp) {                        flog(resp);                    },                    beforePostForm: function (form, config, data) {                        var s = window.location.search.substr(1);                        if (s.length > 0) {                            data = data + '&' + s;                        }                        return data;                    }                });            });            function createExtraFieldElement(name) {                var div = $('<div class="form-group">'                        + '<label class="col-md-3 control-label" for="extra_' + name + '">' + name + '</label>'                        + '<div class="col-md-8">'                        + '<input class="form-control required" id="extra_' + name + '" type="text" name="' + name + '" placeholder="' + name + '" />'                        + '</div>'                        + '</div>');                return div;            }            function deleteLogs(listToDelete) {                $.each(listToDelete, function (index, item) {                    var href = window.location.pathname + item;                    var row = $('input[data-execid="' + item + '"]').closest('tr');                    flog("href", href, 'row', row);                    deleteFile(href, function () {                        row.remove();                    });                });            }            function deleteSchedules(listToDelete) {                $.each(listToDelete, function (index, item) {                    var href = window.location.pathname + item;                    var row = $('input[data-schedhref="' + item + '"]').closest('tr');                    flog("href", href, 'row', row);                    deleteFile(href + window.location.search, function () {                        row.remove();                    });                });            }        </script>        #macro(genStatus $exec)        #set($statusClass = false)        #if($exec.status == "P")        #set($statusClass = "fa fa-refresh text-warning")        #set($statusMsg = "Preparing")        #elseif($exec.status == "S")        #set($statusClass = "fa fa-exchange text-info")        #set($statusMsg = "Processing")        #elseif($exec.status == "E")        #set($statusClass = "fa fa-times text-danger")        #set($statusMsg = "Error")        #elseif($exec.status == "C")        #set($statusClass = "fa fa-check-circle text-success")        #set($statusMsg = "Complete")        #else        #set($statusMsg = "No Status")        #end        <td class="icon" title="$statusMsg">            #if($statusClass)            <i class="$statusClass"></i>            #end        </td>        #end    </body></html>