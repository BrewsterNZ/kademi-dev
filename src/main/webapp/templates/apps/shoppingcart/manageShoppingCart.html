<html xmlns="http://www.w3.org/1999/xhtml">    <head>        <title>Manage Shopping Cart</title>        <style>            .icon {                width: 60px;                text-align: center;            }            .icon i {                font-size: 30px;            }        </style>    </head>    <body class="">        <div class="btn-group pull-right">            <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">                <i class="fa fa-copy"></i>                Copy to                <span class="caret"></span>            </button>            <ul class="dropdown-menu">                <li><a class="btn-copyto" href="order">Duplicate order</a></li>                <!--                <li role="separator" class="divider"></li>                <li><a class="btn-copyto" href="quote">Quote</a></li>                <li><a class="btn-copyto" href="invoice">Invoice</a></li>                -->            </ul>        </div>        <h2>Order for <a href="/manageUsers/$page.cart.profile.id" target="_blank">$!page.cart.profile.formattedName</a> for $formatter.formatCurrency($page.totalCost)</h2>        <p class="pull-left">            #if( $page.cart.cartState == "PENDING" )            <span class="btn btn-warning">                <i class="fa fa-exclamation-triangle"></i>                PENDING - <b>not yet submitted</b>, do not ship            </span>            #elseif ( $page.cart.cartState == "COMPLETED" || $page.cart.cartState == $null)            <span class="btn btn-success">                <i class="fa fa-dollar"></i>                Ordered - this order has been submitted            </span>            #elseif ( $page.cart.cartState == "CANCELLED" )            <span class="btn btn-danger">                <i class="fa fa-dollar"></i>                CANCELLED - this order has been cancelled            </span>                       #end        </p>        <div class="btn-group pull-left" role="group" style="margin-left: 20px">            <div class="btn-group" style="margin-left: 15px">                #if( $page.cart.fulfilmentState == "N" )                <span class="btn btn-warning">                    #set( $btnClass = "warning" )                    <i class="fa fa-exclamation-triangle"></i>                    Not fulfilled - please process this order                </span>                #elseif ( $page.cart.fulfilmentState == "C")                <span class="btn btn-success">                    #set( $btnClass = "success" )                                        <i class="fa fa-ship"></i>                    Fulfilled - order has been processed                </span>                #elseif ( $page.cart.fulfilmentState == "D" )                <span class="btn btn-danger">                    #set( $btnClass = "danger" )                                        <i class="fa fa-dollar"></i>                    Deleted - this order has been deleted by an admin                </span>                           #end                                    <button type="button" class="btn btn-$btnClass dropdown-toggle" data-toggle="dropdown">                    <span class="caret"></span>                </button>                <ul class="dropdown-menu pull-right" role="menu">                    <li class="presentation" role="menuitem"><a href="#" class="deleteCart"><i class="glyphicon glyphicon-trash"></i> Delete (no undo)</a></li>                    <li role="separator" class="divider"></li>                    <li><i>Change status</i></li>                    #foreach( $statusEntry in $folder.fulfilmentStatuses.entrySet() )                    <li class="presentation" role="menuitem"><a href="#" data-status="$statusEntry.key" class="markFulfilled">$statusEntry.key - $statusEntry.value</a></li>                    #end                </ul>            </div>        </div>                <p class="clearfix"></p>        <hr/>        <div class="row">            <div class="col-md-6">                <div class="panel panel-default">                    <div class="panel-heading">                        <i class="fa fa-user"></i>                        <div class="panel-title">                            <small>Customer</small>                        </div>                    </div>                    <table class="table table-hover">                        <colgroup>                            <col width="20%"/>                            <col/>                        </colgroup>                        <tbody>                            <tr>                                <th>Profile</th>                                <td><a href="/manageUsers/$page.cart.profile.id" target="_blank">$!page.cart.profile.formattedName</a></td>                            </tr>                            <tr>                                <th>Organisation</th>                                <td>$!page.cart.orderedForOrg.formattedName</td>                            </tr>                            <tr>                                <th>First name</th>                                <td>$!page.cart.firstName</td>                            </tr>                            <tr>                                <th>Surname</th>                                <td>$!page.cart.surName</td>                            </tr>                            <tr>                                <th>Company</th>                                <td>$!page.cart.company</td>                            </tr>                            <tr>                                <th>Phone</th>                                <td>$!page.cart.phone</td>                            </tr>                            <tr>                                <th>Profile created</th>                                <td>                                    <abbr class="timeago" title="$formatter.formatDateISO8601($!page.cart.profile.createdDate)">$!formatter.formatDateTime($!page.cart.profile.createdDate)</abbr>                                </td>                            </tr>                            #if( $page.cart.profile )                            <tr>                                #set( $otherOrders = $services.criteriaBuilders.cart.eq("profile", $page.cart.profile).rowCount("cnt").execute(1) )                                <th>Previous orders</th>                                <td>$otherOrders.get(0)</td>                            </tr>                            <tr>                                <td colspan="2">                                    <b>Most recent: </b>                                    <br/>                                    #set( $otherOrders = $services.criteriaBuilders.cart.eq("profile", $page.cart.profile).sortDesc("orderedDate").execute(10) )                                    #foreach( $otherOrder in $otherOrders )                                    #if( $otherOrder.id != $page.cart.id )                                    <a class="btn btn-default" href="../$otherOrder.id/" style="min-width: 140px">                                        <span class="label label-info">$!otherOrder.fulfilmentState</span>                                        <abbr class="timeago" title="$formatter.formatDateISO8601($otherOrder.orderedDate)">$!formatter.formatDateTime($otherOrder.orderedDate)</abbr>                                    </a>                                    #end                                    #end                                </td>                            </tr>                            #end                        </tbody>                    </table>                </div>            </div>            <div class="col-md-6">                <div class="panel panel-default">                    <div class="panel-heading">                        <i class="fa fa-dollar"></i>                                                <div class="panel-title">                            <small>Order</small>                        </div>                    </div>                    <form class="form-horizontal" method="POST" action="$page.href" id="update-cart-form">                        <table class="table table-hover">                            <colgroup>                                <col width="20%"/>                                <col/>                            </colgroup>                            <tbody>                                <tr>                                    <th>Total Cost</th>                                    <td>$formatter.formatCurrency($page.totalCost)</td>                                </tr>                                <tr>                                    <th>Date</th>                                    <td>                                        $formatter.formatDateTime($page.cart.orderedDate)                                        -                                        <small class="text-muted"><abbr class="timeago" title="$formatter.formatDateISO8601($!page.cart.orderedDate)">$!formatter.formatDateTime($!page.cart.orderedDate)</abbr></small>                                    </td>                                </tr>                                <tr>                                    <th>Cart ID</th>                                    <td>                                        <input type="text" name="cartId" value="$!page.cart.cartId" class="form-control" />                                    </td>                                </tr>                                <tr>                                    <th>Fulfilment state</th>                                    <td>                                        $!page.cart.fulfilmentState                                    </td>                                </tr>                                <tr>                                    <th>Currency</th>                                    <td>#if($!page.cart.productOrders.size() > 0) $!page.cart.productOrders.get(0).currencyId #end</td>                                </tr>                                <tr>                                    <th>Website</th>                                    <td>$!page.cart.website.name</td>                                </tr>                                <tr>                                    <th>Promo codes</th>                                    <td>$!page.cart.promoCodesCsv</td>                                </tr>                                <tr>                                    <th>Vouchers</th>                                    <td>                                        #foreach( $voucher in $page.vouchers )                                        <a href="/voucher-type/$voucher.voucherType.name/$voucher.voucherId" class="btn btn-info">                                            $voucher.voucherId                                            -                                            #if( $voucher.voucherType.cashValue )                                            $$voucher.voucherType.cashValue                                            #end                                        </a>                                        #end                                    </td>                                </tr>                                <tr>                                    <th>Notes</th>                                    <td>                                        <textarea name="orderNotes" class="form-control" style="height: 100px">$!page.cart.orderNotes</textarea>                                    </td>                                </tr>                                <tr>                                    <th>Tracking code</th>                                    <td>                                        <input name="trackingCode" value="$!page.cart.trackingCode" class="form-control" />                                    </td>                                </tr>                                                                <tr>                                    <th></th>                                    <td>                                        <button class="btn btn-info" type="submit">Save</button>                                    </td>                                </tr>                            </tbody>                        </table>                    </form>                </div>            </div>        </div>        <hr/>        <div class="row">            <div class="col-md-6">                <div class="panel panel-default">                    <div class="panel-heading">                        <i class="fa fa-ship"></i>                        <div class="panel-title">                            <small>Shipping address</small>                        </div>                    </div>                    <table class="table table-hover">                        <colgroup>                            <col width="25%"/>                            <col/>                        </colgroup>                        <tbody>                            <tr>                                <th>Map</th>                                <td>                                    <a target="_blank" href="https://www.google.com/maps/place/$!page.cart.addressLine1+$!page.cart.addressLine2+$!page.cart.city,+$!page.cart.postcode,+$!page.cart.addressState/">                                        Search google maps                                    </a>                                </td>                            </tr>                            <tr>                                <th>Address Line 1</th>                                <td>$!page.cart.addressLine1</td>                            </tr>                            <tr>                                <th>Address Line 2</th>                                <td>$!page.cart.addressLine2</td>                            </tr>                            <tr>                                <th>City</th>                                <td>$!page.cart.city</td>                            </tr>                            <tr>                                <th>Post Code</th>                                <td>$!page.cart.postcode</td>                            </tr>                            <tr>                                <th>State</th>                                <td>$!page.cart.addressState</td>                            </tr>                            <tr>                                <th>Country</th>                                <td>$!page.cart.country</td>                            </tr>                            <tr>                                <th>Shipping provider</th>                                <td>$!page.cart.shippingProviderId</td>                            </tr>                        </tbody>                    </table>                </div>            </div>            <div class="col-md-6">                <div class="panel panel-default">                    <div class="panel-heading">                        <i class="fa fa-home"></i>                        <div class="panel-title">                            <small>Billing address</small>                        </div>                    </div>                    <table class="table table-hover">                        <colgroup>                            <col width="25%"/>                            <col/>                        </colgroup>                        <tbody>                            <tr>                                <th>Map</th>                                <td>                                    <a target="_blank" href="https://www.google.com/maps/place/$!page.cart.billingAddress.addressLine1+$!page.cart.billingAddress.addressLine2+$!page.cart.billingAddress.city,+$!page.cart.billingAddress.postcode,+$!page.cart.billingAddress.addressState/">                                        Search google maps                                    </a>                                </td>                            </tr>                            <tr>                                <th>Address Line 1</th>                                <td>$!page.cart.billingAddress.addressLine1</td>                            </tr>                            <tr>                                <th>Address Line 2</th>                                <td>$!page.cart.billingAddress.addressLine2</td>                            </tr>                            <tr>                                <th>City</th>                                <td>$!page.cart.billingAddress.city</td>                            </tr>                            <tr>                                <th>Post Code</th>                                <td>$!page.cart.billingAddress.postcode</td>                            </tr>                            <tr>                                <th>State</th>                                <td>$!page.cart.billingAddress.addressState</td>                            </tr>                            <tr>                                <th>Country</th>                                <td>$!page.cart.billingAddress.country</td>                            </tr>                        </tbody>                    </table>                </div>            </div>        </div>        <div class="panel panel-default">            <div class="panel-heading">                <i class="fa fa-shopping-cart"></i>                <div class="panel-title">                    <small>Purchased items</small>                </div>            </div>            <table id="items" class="table table-hover">                <colgroup>                    <col width="70px"/>                    <col width="15%"/>                    <col/>                    <col/>                    <col/>                    <col/>                    <col/>                    <col/>                    <col width="100px"/>                </colgroup>                <thead>                    <tr>                        <th>ID</th>                        <th>Product</th>                        <th>SKU</th>                        <th>Options</th>                        <th>Quantity</th>                        <th>Unit Cost</th>                        <th>Discount</th>                        <th>Total Cost</th>                        <th></th>                    </tr>                </thead>                <tbody id="itemsBody">                    #foreach($po in $page.productOrders)                    <tr>                        <td>$po.id</td>                        <td>                            <a href="/products/$po.product.id/">$po.product.title</a>                        </td>                        <td>                            #if( $po.productSku )                            <a href="/products/$po.product.id/#skus-tab">$po.productSku.name</a>                            #end                        </td>                        <td>                            #set($productOptions = $formatter.newArrayList())                            #if( $po.productSku )                            #foreach( $opt in $po.productSku.options )                            #set($optString = $opt.productParameter.name + "=" + $opt.name)                            #if($productOptions.add($optString))#end                            #end                            #end                            #foreach($opt in $po.productOrderOptions)                            #set($optString = $opt.answerKey + "=" + $opt.givenAnswer)                            #if($productOptions.add($optString))#end                            #end                            $formatter.toCsv($productOptions)                        </td>                        <td>$!formatter.toDecimal($po.quantity, 0)</td>                        <td>$!formatter.formatCurrency($po.unitCost)</td>                        <td>$!po.discount</td>                        <td>$!formatter.formatCurrency($po.grandTotal)</td>                        <td>                            <div class="btn-group">                                <button class="btn btn-danger btn-delete-item" data-id="$po.id"><i class="fa fa-remove"></i></button>                                <button class="btn btn-primary btn-add-status" data-id="$po.id"><i class="fa fa-clock-o"></i></button>                            </div>                        </td>                    </tr>                    #foreach($status in $page.orderHistory($po.id))                    <tr>                        <td></td>                        <td>$!status.statusCode</td>                        <td colspan="4">$!status.description</td>                        <td colspan="2" class="text-right">                            $formatter.formatDateTime($status.statusDate)                        </td>                    </tr>                    #end                    #end                </tbody>            </table>        </div>        <div id="addStatus" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">            <div class="modal-header">                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>                <h4 class="modal-title">Set current order item status</h4>            </div>            <form action="$page.href" method="POST" class="form-horizontal">                <div class="modal-body">                    <div class="form-message alert alert-danger" style="display: none;"></div>                    <input type="hidden" name="statusOrderId" />                    <div class="form-group">                        <label class="col-md-3 control-label" for="statusCode">Code</label>                        <div class="col-md-8">                            <select name="statusCode" class="form-control">                                <option value="packing">Packing</option>                                <option value="back-order">Back order</option>                                <option value="in-transit">In transit</option>                                <option value="delivered">Delivered</option>                                <option value="cancelled">Cancelled</option>                            </select>                        </div>                    </div>                    <div class="form-group">                        <label class="col-md-3 control-label" for="statusDesc">Description</label>                        <div class="col-md-8">                            <input type='text' name="statusDesc" class="form-control"/>                        </div>                    </div>                </div>                <div class="modal-footer">                    <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>                    <button class="btn btn-sm btn-primary" type="submit">Set status</button>                </div>            </form>        </div>        <script type="text/javascript">            $(function () {                var modal = $("#addStatus");                $(".btn-copyto").click(function (e) {                    e.preventDefault();                    var type = $(e.target).closest("a").attr("href");                    $.ajax({                        url: window.location.pathname,                        type: 'POST',                        dataType: 'JSON',                        data: {                            copyToType: type                        },                        success: function (data, textStatus, jqXHR) {                            if (data.status) {                                Msg.info("Copied");                                window.location = data.nextHref;                            } else {                                flog("err", data);                                Msg.error('Oh No! Something went wrong!');                            }                        },                        error: function (data) {                            flog("err", data);                            Msg.error('Oh No! Something went wrong!');                        }                    });                });                $("#items").on("click", ".btn-add-status", function (e) {                    var btn = $(e.target).closest("button");                    var id = btn.data("id");                    modal.find("input[name=statusOrderId]").val(id);                    modal.modal("show");                });                $("#items").on("click", ".btn-delete-item", function (e) {                    var btn = $(e.target).closest("button");                    var id = btn.data("id");                    Kalert.confirm('You want to delete this order line item? (no undo)', 'Yes', function () {                        $.ajax({                            url: window.location.pathname,                            type: 'POST',                            dataType: 'JSON',                            data: {                                deleteProductOrderId: id                            },                            success: function (data, textStatus, jqXHR) {                                Msg.info("Removed order item");                                $('#itemsBody').reloadFragment();                            },                            error: function () {                                Msg.error('Oh No! Something went wrong!');                                $('#itemsBody').reloadFragment();                            }                        });                    });                });                $("#addStatus form").forms({                    onSuccess: function () {                        Msg.info("added");                        modal.modal("hide");                        $("#itemsBody").reloadFragment();                    }                });                $("#update-cart-form").forms({                    onSuccess: function () {                        Msg.info("Updated");                    }                });                $(document.body).on('click', '.markFulfilled', function (e) {                    e.preventDefault();                    var link = $(e.target).closest("a");                    var statusCode = link.data("status");                    var trackingCode = prompt("Do you want to enter a tracking code?");                    $.ajax({                        type: "POST",                        url: window.location.pathname,                        data: {                            status: statusCode,                            trackingCode: trackingCode                        },                        success: function (content) {                            flog('response', content);                            Msg.info("Fulfilment status changed, reloading..");                            window.location.reload();                        }                    });                });            });        </script>    </body></html>