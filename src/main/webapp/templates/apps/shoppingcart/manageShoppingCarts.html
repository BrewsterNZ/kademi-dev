<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>$view.title</title>
    </head>
    <body>
        <div class="alert alert-info">
            This page shows you recent shopping carts from your customers.
        </div>
        <div class="clearfix">
            <button class="btn btn-danger deleteCart pull-right"><i class="glyphicon glyphicon-trash"></i> Delete Selected</button>
            <div class="input-group date-range col-md-3" style="margin-right: 5px">
                <label for="report-range" class="input-group-addon">Time</label>
                <input type="text" id="report-range" placeholder="Choose a date range" value="" class="form-control" />
            </div>
        </div>
        <hr/>
        <div class="panel panel-default">
            <div class="panel-body">
                <div class="table-responsive">
                    <table id="auction-wrapper" class="table table-striped table-hover">
                        <colgroup>
                            <col width="18%" />
                            <col width="5%" />
                            <col width="15%" />
                            <col width="" />
                            <col width="" />
                            <col width="10px" />
                        </colgroup>
                        <thead>
                            <tr>
                                <th>Cart ID</th>
                                <th>User</th>
                                <th>Date</th>
                                <th class="text-center">Items</th>
                                <th class="text-center">Amount</th>
                                <th><input type="checkbox" class="check-all"/></th>
                            </tr>
                        </thead>
                        <tbody id="shoppingCartList">
                            #foreach($v in $page.children)
                            <tr>
                                <td class="clickable">
                                    <a class="cartLink" href="$v.href">
                                        #if( $v.cart.cartId )
                                        $v.cart.cartId
                                        #else
                                        $v.cart.id
                                        #end
                                    </a>
                                </td>
                                <td><a href="/manageUsers/$v.cart.profile.id" target="_blank">$v.cart.profile.formattedName</a></td>
                                <td>$v.cart.orderedDate</td>
                                <td class="text-center">$formatter.toDecimal($v.totalItems, 0)</td>
                                <td class="text-center">$formatter.formatCurrency($v.totalCost)</td>
                                <th><input type="checkbox" data-cartid="$v.href" class="cart-check"/></th>
                            </tr>
                            #end
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            $(function () {
                $('body').on('click', '.cartLink', function (e) {
                    e.preventDefault();
                });

                $('body').on('click', '.clickable', function (e) {
                    var btn = $(this);
                    var href = btn.find('.cartLink').attr("href");
                    window.location = href;
                });

                $('body').on('change', '.check-all', function (e) {
                    var checkedStatus = this.checked;
                    $('body').find(':checkbox.cart-check').prop('checked', checkedStatus);
                });

                $('body').on('click', '.deleteCart', function (e) {
                    e.preventDefault();
                    var listToDelete = [];
                    $('body').find(':checkbox.cart-check:checked').each(function () {
                        listToDelete.add($(this).data("cartid"));
                    });
                    if (listToDelete.length > 0 && confirm("Are you sure you want to delete " + listToDelete.length + " shopping carts?")) {
                        $('body').find('.check-all').check(false).change();
                        flog(listToDelete.join(','));
                        deleteCarts(listToDelete);
                    }
                });

                initHistorySearch();
            });

            function deleteCarts(listToDelete) {
                for (var i = 0; i < listToDelete.length; i++) {
                    deleteFile(listToDelete[i]);
                    $("input[data-cartid=\"" + listToDelete[i] + "\"]").closest("tr").remove()
                }
                Msg.info("Successfully deleted " + listToDelete.length + " carts");
            }

            function initHistorySearch() {
                var reportRange = $('#report-range');

                reportRange.exist(function () {
                    flog("init report range");
                    reportRange.daterangepicker({
                        format: 'DD/MM/YYYY', // YYYY-MM-DD
                        ranges: {
                            'Last 7 Days': [moment().subtract('days', 6), moment()],
                            'Last 30 Days': [moment().subtract('days', 29), moment()],
                            'This Month': [moment().startOf('month'), moment().endOf('month')],
                            'Last Month': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')],
                            'This Year': [moment().startOf('year'), moment()],
                        },
                    },
                            function (start, end) {
                                flog('onChange', start, end);
                                doHistorySearch(start, end);
                            }
                    );
                });

                function doHistorySearch(startDate, endDate) {
                    flog('doHistorySearch', startDate, endDate);

                    var data = {
                        startDate: formatDate(startDate),
                        finishDate: formatDate(endDate)
                    };
                    flog("data", data);

                    var target = $("#history-table-body");
                    $.ajax({
                        type: "GET",
                        url: window.location.pathname,
                        dataType: 'html',
                        data: data,
                        success: function (content) {
                            flog('response', content);
                            var newBody = $(content).find("#history-table-body");
                            flog("newBody", newBody);
                            target.replaceWith(newBody);
                            jQuery("abbr.timeago").timeago();
                        }
                    });

                }
            }
        </script>
    </body>
</html>