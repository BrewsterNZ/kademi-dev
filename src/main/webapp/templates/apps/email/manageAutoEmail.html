<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>$view.title</title>
        <style>
            .customField-wrapper {
                padding-top: 10px;
            }

            .customField-wrapper .customField {
                margin-top: 5px;
            }

            .customField-wrapper .customField:first-child {
                margin-top: 0;
            }

            .customField-wrapper .customField > * {
                float: left;
                margin-right: 10px;
            }

            .customField-wrapper .customField > .input-group{
                width: 220px;
            }

            .customField-wrapper .customField > .input-group + select {
                width: 200px;
            }
            .email-item{
                cursor:pointer;
            }

            #chart_histogram svg {
                height: 490px;
            }

            .ktile-inner{
                max-height: 400px;
            }

            #javascriptEditor {
                height: 250px;
                border: 1px solid #DDD;
                border-radius: 4px;
                border-bottom-right-radius: 0px;
            }

        </style>
        <script type="text/javascript" src="/static/ace/1.2.0/src-noconflict/ace.js">//</script>
        <script type="text/javascript" src="/static/js/jquery.fileupload.js">//</script>
        <script type="text/javascript" src="/static/js/jquery.milton-upload.js">//</script>
        <script type="text/javascript" src="manageAutoEmail.js">//</script>
        <script type="text/javascript" src="manageEmail.js">//</script>
        <script src="/static/d3/d3.v3.js" type="text/javascript">//</script>
        <link href="/static/nvd3/nv.d3.css" rel="stylesheet" type="text/css"/>
        <script src="/static/nvd3/nv.d3.js" type="text/javascript">//</script>
        <script src="/theme/assets/plugins/x-editable/js/bootstrap-editable.min.js">//</script>
        <script type="text/javascript" src="/static/easy-pie-chart/2.1.7/jquery.easypiechart.min.js">//</script>
        <script type="text/javascript" src="/static/ktile/1.0.0/ktile.js">//</script>
        <link href="/static/ktile/1.0.0/ktile.css?v=6.3.1" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" href="/theme/assets/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css" />
        <link rel="stylesheet" href="/theme/assets/plugins/x-editable/css/bootstrap-editable.css" />
        <script src="/theme/assets/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js">//</script>
        <link href="/templates/apps/admin/dashboard.css" rel="stylesheet" type="text/css"/>
    </head>
    <body class="manageAutoEmail">
        <h2 class="p-b-20">
            <a href="#" id="emailTitle" data-type="text" data-pk="1" data-placement="right" data-placeholder="Title" data-original-title="Enter a title">$!page.job.title</a>
        </h2>
        <form name="frmDetails" action="." method="post" class="form-horizontal">
            <div class="pull-right page-action">
                <div class="row">
                    <div class="col-md-5">
                        <div class="enabledSwitchContainer">
                            $formatter.bsswitch("enabled", "enabled", $page.enabled, "true")
                        </div>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-sm btn-primary" type="submit">
                            <span class="glyphicon glyphicon-floppy-disk"></span>
                            Save changes
                        </button>
                    </div>
                </div>
            </div>

            <div class="tabbable">
                <ul class="nav nav-tabs tab-bricky">
                    <li><a data-toggle="tab" href="#general">General</a></li>
                    <li><a data-toggle="tab" href="#notes">Notes</a></li>
                    <li><a data-toggle="tab" href="#triggers">Triggers</a></li>
                    <li><a data-toggle="tab" href="#action">Actions</a></li>
                    <li><a data-toggle="tab" href="#recipients">Recipients</a></li>
                    <li><a data-toggle="tab" href="#history">Email History</a></li>
                    <li><a data-toggle="tab" href="#smsHistory">SMS History</a></li>
                </ul>
                <div class="tab-content">
                    <!-- Start content of General tab -->
                    <div id="general" class="tab-pane">
                        <div id="descriptionDiv">
                            <p class="lead p-20">
                                $page.description
                            </p>
                        </div>
                        <hr/>
                        <div class="form-group">
                            <div class="col-xl-8 col-lg-8 col-md-8 col-sm-12">
                                <div id="chart_histogram">
                                    <svg></svg>
                                </div>
                            </div>
                            #set($stats = $page.emailStats)
                            <div class="col-md-4">
                                <div class="row p-b-20">
                                    <div class="col-md-12">
                                        <div class="input-group date-range">
                                            <label for="analytics-range" class="input-group-addon">Date</label>
                                            <input type="text" id="analytics-range" placeholder="Choose a date range" value="" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="ktile-wrapper col-sm-4 col-md-6">
                                    <div class="ktile ktile-lg-v">
                                        <div class="ktile-inner">
                                            <div class="ktile-body">
                                                <div class="ktile-front ktile-shadow">
                                                    <div class="row" style="height: 100%; margin: 0">
                                                        <div class="bgm-pink" style="height: 60%;">
                                                            <div class="text-center ktile-content ktile-content-relative">
                                                                <div data-percent="$stats.deliveryRatePerc" class="easy-pie emailsMainPie largePie center-block">
                                                                    <div class="figure">
                                                                        #if( $stats.total )
                                                                        $stats.total
                                                                        #else
                                                                        N/A - $stats
                                                                        #end
                                                                    </div>
                                                                    <div class="pie-title">Total Emails Sent</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div style="height: 38%">
                                                            <div class="row text-center ktile-content ktile-content-relative">
                                                                <div class="col-sm-6" style="padding: 0 3px">
                                                                    <div data-percent="$!stats.openRatePerc" class="easy-pie emailsSubPie smallPie bluePie">
                                                                        <div class="figure">
                                                                            #if( $stats.openRatePerc )
                                                                            $stats.openRatePerc
                                                                            #else
                                                                            N/A
                                                                            #end
                                                                        </div>
                                                                        <div class="pie-title">Open rate</div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-sm-6" style="padding: 0 3px">
                                                                    <div data-percent="$!stats.convertedRatePerc" class="easy-pie emailsSubPie smallPie orangePie">
                                                                        <div class="figure">
                                                                            #if( $stats.convertedRatePerc )
                                                                            $stats.convertedRatePerc
                                                                            #else
                                                                            N/A
                                                                            #end
                                                                        </div>
                                                                        <div class="pie-title">Conversion rate</div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                #set($smsStats = $page.smsStats)
                                <div class="ktile-wrapper col-sm-4 col-md-6">
                                    <div class="ktile ktile-lg-v">
                                        <div class="ktile-inner">
                                            <div class="ktile-body">
                                                <div class="ktile-front ktile-shadow">
                                                    <div class="row" style="height: 100%; margin: 0">
                                                        <div class="bgm-blue" style="height: 60%;">
                                                            <div class="text-center ktile-content ktile-content-relative">
                                                                <div data-percent="$smsStats.deliveryRatePerc" class="easy-pie emailsMainPie largePie center-block">
                                                                    <div class="figure">
                                                                        #if( $smsStats.total )
                                                                        $smsStats.total
                                                                        #else
                                                                        N/A
                                                                        #end
                                                                    </div>
                                                                    <div class="pie-title">Total SMS's Sent</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div style="height: 38%">
                                                            <div class="row text-center ktile-content ktile-content-relative">
                                                                <h4>Total Cost: $!smsStatus.currency$smsStats.totalCost</h4>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End content of General tab -->

                    <!-- Start content of Notes tab -->
                    <div id="notes" class="tab-pane">
                        <div class="form-group">
                            <label class="control-label col-md-3 col-lg-2" for="notes">Notes<small>These notes are for internal purposes only.</small></label>
                            <div class="col-md-9 col-lg-10">
                                <textarea cols="100" name="notes" id="notes" rows="10" placeholder="" class="form-control">$!page.notes</textarea>
                            </div>
                        </div>
                    </div>
                    <!-- End content of Notes tab -->

                    <!-- Start content of Triggers tab -->
                    <div id="triggers" class="tab-pane">
                        <div class="row">
                            #set($mapOfTriggerTypes = $page.emailTriggerTypes)
                            <div class="col-md-9">
                                <div class="form-group">
                                    <label class="control-label col-md-4" for="eventId">Event type</label>
                                    <div class="col-md-8">
                                        <select id="eventId" name="eventId" class="form-control">
                                            <option value="-">[Choose]</option>
                                            #foreach($eventId in $mapOfTriggerTypes.keySet())
                                            $formatter.option($eventId, $eventId, $page.trigger.eventId)
                                            #end
                                        </select>
                                    </div>
                                </div>
                                #foreach($eventId in $mapOfTriggerTypes.keySet())
                                #set($triggerType = $mapOfTriggerTypes.get($eventId))
                                #foreach($optionCode in $triggerType.keySet())
                                <div class="form-group event-type $eventId" style="display: none">
                                    <label class="control-label col-md-4" for="$optionCode">$page.triggerOptionLabel($eventId, $optionCode)</label>
                                    <div class="col-md-8">
                                        $triggerType.get($optionCode).toHtml($optionCode, $page.triggerOptionValue($optionCode) )
                                    </div>
                                </div>
                                #end
                                #end
                                <div class="form-group">
                                    <label class="control-label col-md-4" for="createTimerEnabled">Enable event delay</label>
                                    <div class="col-md-8">
                                        $formatter.checkbox("createTimerEnabled", "createTimerEnabled", $page.createTimerEnabled)
                                        <div class="panel-toggled" data-toggled="display" data-actor="#createTimerEnabled">
                                            <p>
                                                You can set a timer so the event is only fired after a delay. This can be used to send reminder emails a week or so later, for example. Any conditional rules are applied after the delay
                                            </p>
                                            <div class="clearfix">
                                                <div class="input-group pull-left">
                                                    <span class="input-group-addon">Fire the next event after:</span>
                                                    <input type="text" class="text-center form-control" value="$!page.job.timerMultiple" name="timerMultiple" />
                                                    <div class="input-group-btn">
                                                        <button data-toggle="dropdown" class="btn btn-default dropdown-toggle timer-unit" type="button">$!page.job.timerUnit <span class="caret"></span></button>
                                                        <ul role="menu" class="dropdown-menu pull-right timer-units">
                                                            #foreach($unit in $page.timerUnits)
                                                            <li><a href="#">$unit</a></li>
                                                            #end
                                                        </ul>
                                                    </div>
                                                    <input type="hidden" name="timerUnitName" class="timer-unit" value="$!page.job.timerUnit"/>
                                                </div>
                                            </div>
                                            <br/>
                                            <div class="clearfix">
                                                <label class="col-md-4">Specify Timer Time  $formatter.checkbox("useTimerTime","useTimerTime", $page.useTimerTime)</label>
                                            </div>
                                            <br/>
                                            #set( $hideTimerStyle = $formatter.ifTrue( $page.useTimerTime , "", "none" ) )
                                            <div class="clearfix" id="fireAtTime" style="display: ${hideTimerStyle};">
                                                <div class="input-group pull-left">
                                                    <span class="input-group-addon">Fire the next event at: </span>
                                                    <div class="input-group input-append bootstrap-timepicker">
                                                        <input type="text" data-minute-step="1" name="timerTime" data-default-time="$!page.job.timerTime" class="form-control time-picker" />
                                                        <span class="input-group-addon add-on">
                                                            <i class="fa fa-clock-o"></i>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <br/>
                                            <a class="btn btn-info" href="timerTriggers.html">View Queued triggers</a>
                                        </div>
                                    </div>
                                </div>

                                <hr/>

                                <ul class="nav nav-tabs">
                                    <li class="active"><a href="#condition-expr" data-toggle="tab">Expression</a></li>
                                    <li><a href="#condition-xml" data-toggle="tab">XML</a></li>
                                </ul>

                                <!-- Tab panes -->
                                <div class="tab-content">
                                    <div class="tab-pane active" id="condition-expr">
                                        <div class="form-group">
                                            <label class="control-label col-md-2" for="conditionScriptMvel">Advanced</label>
                                            <div class="col-md-10">
                                                <p>You can enter a rule expression below using MVEL syntax, the trigger will only fire if this evaluates to true.</p>
                                                <textarea name="conditionScriptMvel" id="conditionScriptMvel" class="form-control" rows="5">$!page.job.conditionScriptMvel</textarea>

                                                <h3>Example rule</h3>
                                                <pre>event.numAttempts < 3</pre>
                                            </div>
                                        </div>

                                    </div>
                                    <div class="tab-pane" id="condition-xml">
                                        <div class="form-group">
                                            <label class="control-label col-md-4" for="conditionScriptXml">Advanced</label>
                                            <div class="col-md-8">
                                                <p>You can enter XML rules below, the trigger will only fire if this evaluates to true</p>
                                                <p>The XML syntax is deprecated, you should use expressions instead</p>
                                                <textarea name="conditionScriptXml" id="conditionScriptXml" class="form-control" rows="5">$!page.job.conditionScriptXml</textarea>
                                            </div>
                                        </div>

                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    <!-- End content of Triggers tab -->

                    <!-- Start content of Actions tab -->
                    <div id="action" class="tab-pane">
                        <div id="send-preference" class="panel" #if(!$page.emailEnabled || !$page.job.smsEnabled) style="display: none;" #end>
                            <div class="panel-body">
                                <label class="control-label col-sm-2" for="subject">Sending Preference</label>
                                <div class="col-md-8">
                                    <select name="sendPreference" class="form-control required-if-shown">
                                        $formatter.option("both", "Send To Both", $page.job.sendPreference)
                                        $formatter.option("sms", "Prefer SMS", $page.job.sendPreference)
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <i class="clip-chk">$formatter.checkbox("emailEnabled", "emailEnabled", $page.emailEnabled)</i>
                                <label for="emailEnabled">Send an email</label>
                            </div>
                            <div class="panel-body panel-toggled" data-toggled="display" data-actor="#emailEnabled">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="control-label col-md-4" for="themeSiteId">Website</label>
                                            <div class="col-md-8">
                                                <select name="themeSiteId" id="themeSiteId" class="form-control required-if-shown">
                                                    $formatter.option("", "[Please select]", $page.themeSiteId)
                                                    #foreach($website in $rootFolder.websites)
                                                    $formatter.option($website.id, $website.name, $page.themeSiteId)
                                                    #end
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-md-4" for="subject">Email subject</label>
                                            <div class="col-md-8">
                                                <textarea style="height: 70px" name="subject" id="subject" value="" placeholder="Enter the email subject here" class="form-control required-if-shown">$formatter.htmlEncode( $page.subject )</textarea>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-md-4" for="fromAddress">Email from address</label>
                                            <div class="col-md-8">
                                                <input type="text" name="fromAddress" id="fromAddress" value="$!formatter.htmlEncode( $page.fromAddress )" placeholder="admin@mybusinessname.com" class="form-control required-if-shown" />
                                                <small class="text-muted help-block">Eg <i>"Joe Bloggs" &lt;joe@bloggs.com&gt;</i>. You can leave this field blank but <b>Reply to address</b> will be required!</small>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-md-4" for="replyToAddress">Reply to address</label>
                                            <div class="col-md-8">
                                                <input type="text" name="replyToAddress" id="replyToAddress" value="$!formatter.htmlEncode( $page.replyToAddress )" placeholder="admin@mybusinessname.com" class="form-control" />
                                                <small class="text-muted help-block">Eg <i>"Joe Bloggs" &lt;joe@bloggs.com&gt;</i>.</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="pull-right">
                                            <div class="btn-group">
                                                <button class="btn btn-success btn-sent-test" type="button">
                                                    <span class="glyphicon glyphicon-send"></span>
                                                    Send test
                                                </button>
                                                <button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" type="button">
                                                    <span class="caret"></span>
                                                    <span class="sr-only">Toggle Dropdown</span>
                                                </button>
                                                <ul class="dropdown-menu pull-right" role="menu">
                                                    <li><a href="#" class="btn-sent-test-choose">Enter recipient address</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div style="clear: both"></div>
                                        <div class="add-attachment btn-upload"></div>
                                        <div class="article-wrapper article-sm showed-action attachments-list">
                                            #foreach($att in $page.job.attachments)
                                            <article>
                                                <span class="article-name">
                                                    <a target="_blank" href="/_hashes/files/$att.attachmentHash">$att.attachmentFilename</a>
                                                </span>
                                                <aside class="article-action">
                                                    <a class="btn btn-sm btn-xs btn-danger btn-delete-attachment" href="$att.attachmentFilename" title="Remove"><i class="clip-minus-circle"></i></a>
                                                </aside>
                                            </article>
                                            #end
                                        </div>
                                    </div>
                                </div>
                                <hr style="clear: both"/>
                                <div class="row">
                                    <div class="col-lg-12">
                                        <a href="htmleditor?fileName=index.html&useHash=true" target="_blank" class="btn btn-primary" >
                                            <span class="fa fa-globe"></span>
                                            Rich text editor
                                        </a>
                                        <a href="texteditor?fileName=index.html" target="_blank" class="btn btn-primary" >
                                            <span class="fa fa-pencil"></span>
                                            Raw text editor
                                        </a>
                                        <a href="http://docs.kademi.co/howtos/getting-started/6-send-emails.html#templating" target="_blank" class="btn btn-info" >
                                            <span class="glyphicon glyphicon-question-sign"></span>
                                            Help with templating
                                        </a>

                                    </div>
                                </div>
                                <iframe class="well" style="width: 100%; height: 400px; overflow: scroll; margin-top: 15px" src="./?rawBodyHtml" >

                                </iframe>
                            </div>
                        </div>

                        <div class="panel panel-default"> <!-- start Send SMS -->
                            <div class="panel-heading">
                                <i class="clip-chk">$formatter.checkbox("smsEnabled", "smsEnabled", $page.job.smsEnabled)</i>
                                <label for="smsEnabled">Send an sms</label>
                            </div>
                            <div class="panel-body panel-toggled" data-toggled="display" data-actor="#smsEnabled">
                                <p>
                                    Send an SMS to group(s)
                                    |
                                    <a href='#' class='refresh-sms text-success'>Refresh SMS Providers</a>
                                </p>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="control-label col-md-2" for="smsMessage">Message to send</label>
                                            <div class="col-md-8">
                                                <textarea type="text" class="form-control required-if-shown" name="smsMessage" id="smsMessage">$!page.job.smsMessage</textarea>
                                                <span id="sms-char-remaining">160 Characters Remaining</span>
                                            </div>
                                        </div>
                                    </div> <!-- end row -->
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="control-label col-md-2" for="smsMessage">SMS Providers</label>
                                            <div class="col-md-8" id="smsprovider-list">
                                                <select name="smsProvider" id="smsProvider" class="form-control required-if-shown">
                                                    $formatter.option( "", "[Please select]", null )
                                                    #foreach($app in $page.smsProviders )
                                                    $formatter.option( $app.instanceId, $app.getTitle($page.organisation, null), $page.job.smsProvider )
                                                    #end
                                                </select>
                                            </div>
                                        </div>
                                    </div> <!-- end row -->
                                </div>
                            </div>
                        </div> <!-- End sms-->

                        <div class="panel panel-default"> <!-- start add to group -->
                            <div class="panel-heading">
                                <i class="clip-chk">$formatter.checkbox("addToGroupEnabled", "addToGroupEnabled", $page.addToGroupEnabled)</i>
                                <label for="addToGroupEnabled">Add to a group</label>
                            </div>
                            <div class="panel-body panel-toggled" data-toggled="display" data-actor="#addToGroupEnabled">
                                <p>When this trigger fires add the user to a selected group.</p>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="control-label col-md-4" for="groupToJoin">Group to join</label>
                                            <div class="col-md-8">
                                                <select name="groupToJoinName" title="lala Land" id="groupToJoin" class="form-control required-if-shown">
                                                    $formatter.option( "", "[Please select]", $page.job.groupToJoin.name )
                                                    #foreach($group in $page.allGroups)
                                                    $formatter.option( $group.name, $group.name, $page.job.groupToJoin.name )
                                                    #end
                                                </select>
                                                <div class="help-block with-errors"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- End add to group -->

                        <div class="panel panel-default"> <!-- start remove from group -->
                            <div class="panel-heading">
                                <i class="clip-chk">$formatter.checkbox("removeFromGroupEnabled", "removeFromGroupEnabled", $page.removeFromGroupEnabled)</i>
                                <label for="removeFromGroupEnabled">Remove from a group</label>
                            </div>
                            <div class="panel-body panel-toggled" data-toggled="display" data-actor="#removeFromGroupEnabled">
                                <p>When this trigger fires remove the user from a selected group.</p>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="control-label col-md-4" for="removeFromGroup">Group to remove from</label>
                                            <div class="col-md-8">
                                                <select name="removeFromGroupName" id="removeFromGroup" class="form-control required-if-shown">
                                                    $formatter.option( "", "[Please select]", $page.job.removeFromGroup.name )
                                                    #foreach($group in $page.allGroups)
                                                    $formatter.option( $group.name, $group.name, $page.job.removeFromGroup.name )
                                                    #end
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- End remove from group -->

                        <div class="panel panel-default"> <!-- start reward -->
                            <div class="panel-heading">
                                <i class="clip-chk">$formatter.checkbox("rewardEnabled", "rewardEnabled", $page.job.rewardEnabled)</i>
                                <label for="rewardEnabled">Grant rewards</label>
                            </div>
                            <div class="panel-body panel-toggled" data-toggled="display" data-actor="#rewardEnabled">
                                <p>
                                    When this trigger fires grant the user a number of rewards or points.
                                    |
                                    <a target="_blank" href='/rewards'>Go to rewards</a>
                                    |
                                    <a href='#' class='refresh-rewards text-success'>Refresh rewards list</a>
                                </p>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="control-label col-md-4" for="groupToJoin">Reward to grant</label>
                                            <div class="col-md-8" id="rewards-container">
                                                <select name="reward" id="reward" class="form-control required-if-shown">
                                                    $formatter.option( "", "[Please select]", $page.job.reward.name )
                                                    #foreach($reward in $page.allRewards)
                                                    $formatter.option( $reward.name, $reward.title, $page.job.reward.name )
                                                    #end
                                                </select>
                                            </div>
                                        </div>
                                    </div> <!-- end row -->
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="control-label col-md-4" for="numRewards">No. rewards/points</label>
                                            <div class="col-md-8">
                                                <input type="text" name="numRewards" id="numRewards" value="$!page.job.numRewards" class="form-control" />
                                            </div>
                                        </div>
                                    </div> <!-- end row -->
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="control-label col-md-4" for="numRewardsMVEL">Expression</label>
                                            <div class="col-md-8">
                                                <textarea name="numRewardsMVEL" id="numRewardsMVEL" class="form-control" rows="5">$!page.job.numRewardsMVEL</textarea>
                                            </div>
                                        </div>
                                    </div> <!-- end row -->
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="control-label col-md-4" for="groupToJoin">Reason</label>
                                            <div class="col-md-8">
                                                <input type="text" name="rewardReason" id="rewardReason" value="$!page.job.rewardReason" class="form-control required-if-shown" />
                                                <br/>
                                                <i>The reason to show the user why they received the points.</i>
                                            </div>
                                        </div>
                                    </div> <!-- end row -->
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="control-label col-md-4" for="rewardPointsTag">Tag</label>
                                            <div class="col-md-8">
                                                <select name="rewardPointsTag" id="rewardPointsTag" class="form-control">
                                                    $formatter.option( "", "[Please select]", $page.job.rewardPointsTag )
                                                    #foreach($tag in $page.pointsTags)
                                                    $formatter.option( $tag.name, $tag.title, $page.job.rewardPointsTag )
                                                    #end
                                                </select>
                                            </div>
                                        </div>
                                    </div> <!-- end row -->
                                </div>
                            </div>
                        </div> <!-- End reward -->

                        <div class="panel panel-default"> <!-- start activate alert -->
                            <div class="panel-heading">
                                <i class="clip-chk">$formatter.checkbox("activateAlertEnabled", "activateAlertEnabled", $page.job.activateAlertEnabled)</i>
                                <label for="activateAlertEnabled">Activate alert</label>
                            </div>
                            <div class="panel-body panel-toggled" data-toggled="display" data-actor="#activateAlertEnabled">
                                <p>
                                    Activate a dashboard alert for this user.
                                    |
                                    <a target="_blank" href='/manageAlerts'>Go to alerts</a>
                                    |
                                    <a href='#' class='refresh-alerts text-success'>Refresh alerts list</a>
                                </p>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="control-label col-md-2" for="alert">Alert to activate</label>
                                            <div class="col-md-10" id='alerts-list'>
                                                <select name="alert" id="alert" class="form-control required-if-shown">
                                                    $formatter.option( "", "[Please select]", $page.job.alert.id )
                                                    #foreach($alert in $page.allAlerts)
                                                    $formatter.option( $alert.id, $alert.title, $page.job.alert.id )
                                                    #end
                                                </select>
                                            </div>
                                        </div>
                                    </div> <!-- end row -->
                                </div>
                            </div>
                        </div> <!-- End actviate alert -->

                        <div class="panel panel-default"> <!-- start award CPD -->
                            <div class="panel-heading">
                                <i class="clip-chk">$formatter.checkbox("awardCpdEnabled", "awardCpdEnabled", $page.job.awardCpdEnabled)</i>
                                <label for="awardCpdEnabled">Award CPD Points</label>
                            </div>
                            <div class="panel-body panel-toggled" data-toggled="display" data-actor="#awardCpdEnabled">
                                <p>
                                    Award CPD points associated with a certificate.
                                    |
                                    <a target="_blank" href='/certificates'>Go to Certificates</a>
                                    |
                                    <a href='#' class='refresh-certificates text-success'>Refresh certificates list</a>
                                </p>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="control-label col-md-4" for="awardCpdForCert">Certificate to award points against</label>
                                            <div class="col-md-8" id='certs-list'>
                                                <select name="awardCpdForCert" id="awardCpdForCert" class="form-control required-if-shown">
                                                    $formatter.option( "", "[Please select]", $page.job.awardCpdForCert.id )
                                                    #foreach($cert in $page.find("/certificates").children.ofType.certificate )
                                                    $formatter.option( $cert.id, $cert.title, $page.job.awardCpdForCert.id )
                                                    #end
                                                </select>
                                                <small><i>Awarding these points wont issue the certificate, only allocate points/hours towards it</i></small>
                                            </div>
                                        </div>
                                    </div> <!-- end row -->
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="control-label col-md-4" for="awardCpdModulePath">Module path</label>
                                            <div class="col-md-8" >
                                                <input type="text" class="form-control" name="awardCpdModulePath" id="awardCpdModulePath" value="$!page.job.awardCpdModulePath" />
                                                <small><i>If empty we'll try to get the module from the event, ie if its a module progress event</i></small>
                                            </div>
                                        </div>
                                    </div> <!-- end row -->
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="control-label col-md-4" for="awardCpdNumPoints">No. points to award</label>
                                            <div class="col-md-8" >
                                                <input type="text" class="form-control required-if-shown" name="awardCpdNumPoints" id="awardCpdNumPoints" value="$!page.job.awardCpdNumPoints" />
                                                <small><i>How many points to award when this event is triggered</i></small>
                                            </div>
                                        </div>
                                    </div> <!-- end row -->
                                </div>

                            </div>
                        </div> <!-- End award CPD -->

                        <div class="panel panel-default"> <!-- start insert data series -->
                            <div class="panel-heading">
                                <i class="clip-chk">$formatter.checkbox("dataSeriesEnabled", "dataSeriesEnabled", $page.job.dataSeriesEnabled)</i>
                                <label for="dataSeriesEnabled">Insert into a data series</label>
                            </div>
                            <div class="panel-body panel-toggled" data-toggled="display" data-actor="#dataSeriesEnabled">
                                <p>
                                    Add a data point to a data series(s)
                                    |
                                    <a href='#' class='refresh-dataseries text-success'>Refresh Data series</a>
                                </p>
                                <div class="alert alert-info">
                                    Expressions are evaluated using the MVEL language. The event is the source object, so properties of the event can be referenced directly.
                                    <br/>
                                    Please see the <a href="http://docs.kademi.co/ref/templating/TriggerEvent.html">TriggerEvent documentation</a> for available trigger event types and their properties
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="control-label col-md-2" for="dataSeriesAmountMvel">Amount expression</label>
                                            <div class="col-md-8">
                                                <textarea type="text" class="form-control required-if-shown" name="dataSeriesAmountMvel" id="dataSeriesAmountMvel">$!page.job.dataSeriesAmountMvel</textarea>
                                            </div>
                                        </div>
                                    </div> <!-- end row -->
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="control-label col-md-2" for="dataSeriesDateMvel">Date expression</label>
                                            <div class="col-md-8">
                                                <textarea type="text" class="form-control required-if-shown" name="dataSeriesDateMvel" id="dataSeriesDateMvel">$!page.job.dataSeriesDateMvel</textarea>
                                            </div>
                                        </div>
                                    </div> <!-- end row -->
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="control-label col-md-2" for="dataSeriesName">Data Series</label>
                                            <div class="col-md-8" id="dataseries-list">
                                                <select name="dataSeriesName" id="dataSeriesName" class="form-control required-if-shown">
                                                    $formatter.option( "", "[Please select]", null )
                                                    #foreach($series in $page.find("/sales").children )
                                                    $formatter.option( $series.name, $series.title, $page.job.dataSeriesName )
                                                    #end
                                                </select>
                                            </div>
                                        </div>
                                    </div> <!-- end row -->
                                </div>
                                <div class="form-group">
                                    #set($fieldNames = $formatter.newArrayList())
                                    #foreach($a in $page.dataSeriesCustomFields.entrySet())
                                    #if($fieldNames.add($a.key)) #end
                                    #end
                                    #foreach($i in [0..2])
                                    <div class="customField-wrapper">
                                        <div class="customField clearfix">
                                            <label class="control-label col-md-2" for="dataSeriesAmountMvel${i}">Custom Field ${i}</label>
                                            <div class="col-md-8 input-group input-group-sm">
                                                <label for="dataSeriesCustomFieldName${i}" class="input-group-addon">Name</label>
                                                #set($keyName = "")
                                                #set($keyValue = "")
                                                #if($fieldNames.size() > $i)
                                                #set($keyName = $fieldNames[$i])
                                                #set($keyValue = $page.dataSeriesCustomFields.get($keyName))
                                                #end
                                                <input type="text" class="form-control" value="$!keyName" id="dataSeriesCustomFieldName${i}" name="dataSeriesCustomFieldName${i}" data-basename="dataSeriesCustomFieldName"/>
                                            </div>
                                            <div class="input-group input-group-sm">
                                                <label for="dataSeriesCustomFieldMvel${i}" class="input-group-addon">MVEL</label>
                                                <textarea type="text" class="form-control" id="dataSeriesCustomFieldMvel${i}" name="dataSeriesCustomFieldMvel${i}" data-basename="dataSeriesCustomFieldMvel">$!keyValue</textarea>
                                            </div>
                                        </div>
                                    </div>
                                    #end
                                </div>
                            </div>
                        </div> <!-- End actviate alert -->

                        <!-- Start JavaScript -->
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <i class="clip-chk">$formatter.checkbox("javascriptEnabled", "javascriptEnabled", $page.job.javascriptEnabled)</i>
                                <label for="javascriptEnabled">Execute JavaScript</label>
                            </div>
                            <div class="panel-body panel-toggled" data-toggled="display" data-actor="#javascriptEnabled">
                                <p>
                                    Execute JavaScript
                                </p>
                                <div class="alert alert-info">
                                    Please see the <a href="http://docs.kademi.co/ref/templating/TriggerEvent.html">TriggerEvent documentation</a> for available trigger event types and their properties
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="control-label col-md-2" for="javascript">Script</label>
                                            <div class="col-md-8">
                                                <textarea class="hide required-if-shown" name="javascript"></textarea>
                                                <div id="javascriptEditor" style="display:none;">$formatter.htmlEncode($page.job.javascript)</div>
                                            </div>
                                        </div>
                                    </div> <!-- end row -->
                                </div>
                            </div>
                        </div> <!-- End execute JavaScript -->
                    </div> <!-- End content of Actions tab -->


                    <div id="recipients" class="tab-pane"> <!-- Start content of Recipients tab -->
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <i class="clip-chk">$formatter.checkbox("includeUser", "includeUser", $page.trigger.includeUser, "true")</i>
                                <label for="includeUser">Send to the originating user</label>
                            </div>
                            <div class="panel-body">
                                If selected the user who caused the event will receive the email. This is <b>regardless</b> of any selected groups below.
                            </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <i class="fa fa-user-plus"></i>
                                Recipients groups
                            </div>
                            <div class="panel-body">
                                <div class="alert alert-warning">
                                    Warning: ALL members of selected groups will be emailed each time this trigger is fired. <br/>
                                    <b>If you only want a single recipient from an event use the originating user checkbox above</b>
                                </div>

                                <button class="btn btn-sm btn-success btn-add-group" data-toggle="modal" data-target="#modal-choose-group"><i class="fa fa-plus"></i> Add recipient groups</button>
                                <hr class="hr-sm" />

                                <div class="blocks-wrapper recipient">
                                    #foreach($g in $page.groupRecipients)
                                    <span class="block $g.name">
                                        <span class="block-name">$g.name</span>
                                        #if( $page.status == "Draft" )
                                        <a class="btn btn-xs btn-danger btn-remove-role" href="$g.name" title="Remove this role"><i class="clip-minus-circle "></i></a>
                                        #end
                                    </span>
                                    #end
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <i class="fa fa-user-times"></i>
                                Excluded groups
                            </div>
                            <div class="panel-body">
                                <button class="btn btn-sm btn-success btn-add-group" data-toggle="modal" data-target="#modal-choose-group"><i class="fa fa-plus"></i> Add excluded groups</button>
                                <hr class="hr-sm" />

                                <div class="blocks-wrapper excluded">
                                    #foreach($g in $page.excludedGroups)
                                    <span class="block $g.name">
                                        <span class="block-name">$g.name</span>
                                        #if( $page.status == "Draft" )
                                        <a class="btn btn-xs btn-danger btn-remove-role" href="$g.name" title="Remove this role"><i class="clip-minus-circle "></i></a>
                                        #end
                                    </span>
                                    #end
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <i class="clip-chk"><input type="checkbox" id="showAdvanced" /></i>
                                <label for="showAdvanced">Advanced</label>
                            </div>
                            <div class="panel-body panel-toggled" data-toggled="display" data-actor="#showAdvanced">
                                <ul class="nav nav-tabs">
                                    <li class="active"><a href="#filter-expr" data-toggle="tab">Expression</a></li>
                                    <li><a href="#filter-xml" data-toggle="tab">XML</a></li>
                                </ul>

                                <!-- Tab panes -->
                                <div class="tab-content">
                                    <div class="tab-pane active" id="filter-expr">
                                        <div class="form-group">
                                            <label class="control-label col-md-2" for="filterScriptMvel">Advanced</label>
                                            <div class="col-md-10">
                                                <p>You can enter a rule expression below using MVEL syntax, participants will only be included if this evaluates to true.</p>
                                                <textarea name="filterScriptMvel" id="conditionScriptMvel" class="form-control" rows="5">$!page.job.filterScriptMvel</textarea>

                                                <h3>Example filter</h3>
                                                <pre>event.numAttempts < 3</pre>
                                            </div>
                                        </div>

                                    </div>
                                    <div class="tab-pane" id="filter-xml">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p>You can enter XML rules below, to filter out potential recipients</p>
                                                <textarea name="filterScriptXml" class="form-control" rows="20">$!page.job.filterScriptXml</textarea>
                                            </div>
                                            <div class="col-md-6">
                                                <h5>Available Rules</h5>
                                                <div class="rules">
                                                    <ul>
                                                        <li>
                                                            <h6>Expression types</h6>
                                                            <ul>
                                                                <li>
                                                                    <b>const</b>: Constants, eg <br/>&lt;const type='Integer'&gt;1&lt;/const&gt;
                                                                </li>
                                                                <li>
                                                                    <b>comparison</b>:
                                                                    Compare 2 expressions, Eg
                                                                    <br/>
                                                                    &lt;comparison operator='EQUALS'&gt;<br/>
                                                                    &lt;const type='Integer'&gt;1&lt;/const&gt;<br/>
                                                                    &lt;const type='Integer'&gt;1&lt;/const&gt;<br/>
                                                                    &lt;/comparison&gt;<br/>
                                                                </li>
                                                                <li>
                                                                    <b>app-prop</b>: a property from an application. See below for a full list of app-id's and prop-name's. Eg:
                                                                    <br/>
                                                                    &lt;app-prop app-id='userApp' prop-name='firstName' /&gt;
                                                                </li>
                                                            </ul>
                                                        </li>
                                                        #foreach( $app in $applicationManager.getPropertyProviderApps($rootFolder) )
                                                        <li>
                                                            <h6>$app.instanceId</h6>
                                                            <ul>
                                                                #foreach( $expr in $app.allProperties )
                                                                <li>
                                                                    <b>$expr.name</b>:
                                                                    $expr.description
                                                                </li>
                                                                #end
                                                            </ul>
                                                        </li>
                                                        #end
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End content of Recipients tab -->

                    <!-- Start content of History tab -->
                    <div id="history" class="tab-pane">
                        <div class="btn-group pull-right">
                            <a class="btn btn-info history-csv" href="email-history.csv?startDate=$!request.params.startDate&finishDate=$!request.params.finishDate">
                                Export to CSV
                                <span class="glyphicon glyphicon-cloud-download"></span>
                            </a>
                            <button type="button" class="refresh-history btn btn-success">
                                Refresh
                                <span class="glyphicon glyphicon-refresh"></span>
                            </button>
                        </div>

                        <div class="input-group date-range col-md-4">
                            <label for="report-range" class="input-group-addon">Time</label>
                            <input type="text" id="report-range" placeholder="Choose a date range" value="" class="form-control" />
                        </div>
                        <div class="clearfix"></div>
                        <hr/>

                        <div class="table-responsive" id="history-table">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th>Subject</th>
                                        <th colspan="3">Recipient</th>
                                        <th style="text-align: right">Status Date</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table-body">
                                    #foreach($item in $page.history)
                                    <tr href="/emails/$item.id" class="email-item clickable">
                                        <td class="icon" title="$!email.status">
                                            #if($item.sendStatus == "c" )
                                            <i class="fa fa-check-circle text-success"></i>
                                            #else
                                            <i class="fa fa-exclamation-circle text-muted"></i>
                                            #end

                                            <abbr title="EmailItemID: $item.id">
                                                #if( $item.edmConverted )
                                                <span class="label label-success">Converted</span>
                                                #else
                                                <span class="label label-default">$item.statusText</span>
                                                #end
                                            </abbr>
                                            #if( $item.sendStatus == "r" )
                                            <small>( retry at $formatter.formatDateTime( $item.nextAttempt ) )</small>
                                            #elseif( $item.sendStatus == "p" )
                                            #if( $item.numAttempts )
                                            <small>( $item.numAttempts attempts )</small>
                                            #end
                                            #elseif( $item.sendStatus == "f" )
                                            <small>( $item.numAttempts attempts; last error $item.lastAttempt.status )</small>
                                            #end
                                        </td>

                                        <td>$item.subject</td>
                                        <td>$item.recipientAddress</td>
                                        <td>$!item.recipient.firstName</td>
                                        <td>$!item.recipient.surName</td>
                                        <td>
                                            <abbr class="pull-right timeago" title="$formatter.formatDateISO8601($item.sendStatusDate)">$item.sendStatusDate</abbr>
                                        </td>
                                    </tr>
                                    #end
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- End content of History tab -->

                    <!-- Start content of SMS History tab -->
                    <div id="smsHistory" class="tab-pane">
                        <div class="btn-group pull-right">
                            <a class="btn btn-info sms-history-csv" href="sms-history.csv?smsStartDate=$!request.params.smsStartDate&smsFinishDate=$!request.params.smsFinishDate">
                                Export to CSV
                                <span class="glyphicon glyphicon-cloud-download"></span>
                            </a>
                            <button type="button" class="refresh-sms-history btn btn-success">
                                Refresh
                                <span class="glyphicon glyphicon-refresh"></span>
                            </button>
                        </div>

                        <div class="input-group date-range col-md-4">
                            <label for="sms-report-range" class="input-group-addon">Time</label>
                            <input type="text" id="sms-report-range" placeholder="Choose a date range" value="" class="form-control" />
                        </div>
                        <div class="clearfix"></div>
                        <hr/>

                        <div class="table-responsive" id="sms-history-table">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th colspan="3">Recipient</th>
                                        <th style="text-align: right">Status Date</th>
                                    </tr>
                                </thead>
                                <tbody id="sms-history-table-body">
                                    #foreach($sms in $page.smsHistory)
                                    <tr href="/smsHistory/$sms.id" class="sms-item clickable">
                                        <td class="icon" title="$!sms.statusText">
                                            #if($sms.sendStatus == "s" || $sms.sendStatus == "d")
                                            <i class="fa fa-check-circle text-success"></i>
                                            #else
                                            <i class="fa fa-exclamation-circle text-muted"></i>
                                            #end
                                        </td>
                                        <td>$sms.smsRecipient.phone</td>
                                        <td>$!sms.smsRecipient.firstName</td>
                                        <td>$!sms.smsRecipient.surName</td>
                                        <td>
                                            <abbr class="pull-right timeago" title="$formatter.formatDateISO8601($sms.sendStatusDate)">$sms.sendStatusDate</abbr>
                                        </td>
                                    </tr>
                                    #end
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- End content of Sms History tab -->
                </div>
            </div>
        </form>

        <div id="modal-choose-group" class="modal modal-sm fade" aria-hidden="true" tabindex="-1">
            <div class="modal-header">
                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>
                <h4 class="modal-title">Choose groups</h4>
            </div>
            <div class="modal-body">
                <p>
                    Choose whether a groups should be a recipient, excluded, or to not care about. When a group is excluded then members of that group will not receive the email, even if they are in a recipient group
                </p>
                <div class="table-responsive">
                    <table id="table-groups" class="table table-striped table-hover table-condensed">
                        <thead>
                            <tr>
                                <th>Group</th>
                                <th colspan='3'></th>
                            </tr>
                        </thead>
                        <tbody>
                            #foreach($g in $page.allGroups)
                            <tr>
                                <td>$g.name</td>

                                #set($name = $g.name)
                                <td>
                                    #set($id = $name + "-recip")
                                    $formatter.radio($id, $name, $page.isSelected($g), "recipient" )
                                    <label for="$id">Recipient</label>
                                </td>
                                <td>
                                    #set($id = $name + "-excluded")
                                    $formatter.radio($id, $name, $page.isExcluded($g), "excluded" )
                                    <label for="$id">Excluded</label>
                                </td>
                                <td>
                                    #set($id = $name + "-none")
                                    $formatter.radio($id, $name, false, "none" )
                                    <label for="$id">Don't care</label>
                                </td>
                            </tr>
                            #end
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" data-dismiss="modal" type="button">Close</button>
            </div>
        </div>

        <div id="modal-send-test" class="modal modal-sm fade" aria-hidden="true" tabindex="-1">
            <div class="modal-header">
                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>
                <h4 class="modal-title">Send test</h4>
            </div>
            <div class="modal-body">
                <form method="POST" action="$page.path" class="form-horizontal">
                    <input type="hidden" name="sendTest" value="true"/>
                    <div class="form-group">
                        <label class="col-md-2 control-label" for="name">Recipient</label>
                        <div class="col-md-8">
                            <input type="text" name="recipient" value="" placeholder="An email address" class="required email form-control" />
                            <p>A single email will be sent to this address</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-2 control-label" for="name">Target</label>
                        <div class="col-md-8">
                            <input type="text" name="targetProfile" value="" placeholder="Email address of user to generate email for" class="required email form-control" />
                            <p>This profile will be used to generate the content of the email, ie for any dynamic templating</p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>
                <button class="btn btn-sm btn-success" data-type="form-submit" type="button"><i class="glyphicon glyphicon-send"></i> Send</button>
            </div>
        </div>


        <div id="modal-send-test-progress" class="modal modal-lg fade" aria-hidden="true" tabindex="-1">
            <div class="modal-header">
                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>
                <h4 class="modal-title">Test send progress</h4>
            </div>
            <div class="modal-body" id="send-test-body">
            </div>
        </div>

        <script type="text/javascript">
            var emailEnabled = $formatter.format($page.emailEnabled);
            var smsEnabled = $formatter.format($page.smsEnabled);
            $(function () {
                $(".enabledSwitchContainer input").on("switchChange.bootstrapSwitch", function (e, state) {
                    flog("enabled", state.value);
                    var v = state.value;
                    flog("enabled", v);
                    $.ajax({
                        type: "POST",
                        url: window.location.pathname,
                        data: "enabled=" + v,
                        dataType: 'json',
                        success: function (content) {
                            flog('response', content);
                        }
                    });
                });
                setRecentItem(document.title, window.location.pathname);
                initManageAutoEmail();
                $(".refresh-history").click(function (e) {
                    e.preventDefault();
                    $("#history-table").reloadFragment();
                });

                $(".refresh-sms-history").click(function (e) {
                    e.preventDefault();
                    $("#sms-history-table").reloadFragment({
                        whenComplete: function () {
                            $('#sms-history-table').find("abbr.timeago").timeago();
                        }
                    });
                });

                $(".timer-units li").click(function (e) {
                    e.preventDefault();
                    var unit = $(e.target).text();
                    $(".timer-unit").text(unit).val(unit).change();
                });
                jQuery("abbr.timeago").timeago();
                initHistorySearch();
                initSmsHistorySearch();
                $(".refresh-alerts").click(function () {
                    $("#alerts-list").reloadFragment();
                });
                $(".refresh-rewards").click(function () {
                    $("#rewards-container").reloadFragment();
                });
                $(".refresh-dataseries").click(function () {
                    $("#dataseries-list").reloadFragment();
                });

                initSmsField();
                loadData();
                initEmailStats();
                initControls();
                initTitleEditor();

                $("body").on('click', '.email-item', function (e) {
                    e.preventDefault();
                    var item = $(this);
                    var href = item.attr("href")
                    var win = window.open(href, '_blank');
                    if (win) {
                        //Browser has allowed it to be opened
                        win.focus();
                    } else {
                        //Broswer has blocked it
                        alert('Please allow popups for this site');
                    }
                });

                $("body").on('click', '.sms-item', function (e) {
                    e.preventDefault();
                    var item = $(this);
                    var href = item.attr("href")
                    var win = window.open(href, '_blank');
                    if (win) {
                        //Browser has allowed it to be opened
                        win.focus();
                    } else {
                        //Broswer has blocked it
                        alert('Please allow popups for this site');
                    }
                });

                $('body').on('change', '#smsEnabled', function (e) {
                    e.preventDefault();
                    var chk = $(this);
                    smsEnabled = chk.is(":checked");
                    if (emailEnabled && smsEnabled) {
                        $('#send-preference').show();
                    } else {
                        $('#send-preference').hide();
                    }
                });

                $('body').on('change', '#emailEnabled', function (e) {
                    e.preventDefault();
                    var chk = $(this);
                    emailEnabled = chk.is(":checked");
                    if (emailEnabled && smsEnabled) {
                        $('#send-preference').show();
                    } else {
                        $('#send-preference').hide();
                    }
                });
                $('.time-picker').timepicker();
                $('body').on('change', '#useTimerTime', function (e) {
                    var btn = $(this);
                    var isChecked = btn.is(":checked");
                    flog(isChecked);
                    if (isChecked) {
                        $('#fireAtTime').show();
                    } else {
                        $('#fireAtTime').hide();
                        $("input[name=timerTime]").val("");
                    }
                });

                var javascriptEditor = ace.edit('javascriptEditor');
                javascriptEditor.getSession().setMode("ace/mode/javascript");
                javascriptEditor.setOptions({
                    minLines: javascriptEditor.getSession().$rowLengthCache.length
                });
                $('#javascriptEditor').show();

                javascriptEditor.on('input', function () {
                    var javascriptVal = javascriptEditor.getValue();
                    $('textarea[name=javascript]').val(javascriptVal);
                });
            });

            function initHistorySearch() {
                var reportRange = $('#report-range');

                reportRange.exist(function () {
                    flog("init report range");
                    reportRange.daterangepicker({
                        format: 'DD/MM/YYYY', // YYYY-MM-DD
                        ranges: {
                            'Last 7 Days': [moment().subtract('days', 6), moment()],
                            'Last 30 Days': [moment().subtract('days', 29), moment()],
                            'This Month': [moment().startOf('month'), moment().endOf('month')],
                            'Last Month': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')],
                            'This Year': [moment().startOf('year'), moment()],
                        },
                    },
                            function (start, end) {
                                flog('onChange', start, end);
                                doHistorySearch(start, end);
                            });
                });
            }

            function doHistorySearch(startDate, endDate) {
                flog('doHistorySearch', startDate, endDate);

                var data = {
                    startDate: formatDate(startDate),
                    finishDate: formatDate(endDate)
                };
                flog("data", data);

                var target = $("#history-table-body");
                //target.load();

                var dates = "startDate=" + formatDate(startDate) + "&finishDate=" + formatDate(endDate);
                var baseHref = window.location.pathname + "?" + dates;
                var href = baseHref + "#history-tab";
                $("a.history-csv").attr("href", "email-history.csv?" + dates);

                $.ajax({
                    type: "GET",
                    url: href,
                    dataType: 'html',
                    success: function (content) {
                        flog('response', content);
                        var newBody = $(content).find("#history-table-body");
                        flog("newBody", newBody);
                        target.replaceWith(newBody);
                        jQuery("abbr.timeago").timeago();
                        window.history.pushState(null, "Email History", href);
                    }
                });

            }

            function initSmsHistorySearch() {
                var smsReportRange = $('#sms-report-range');

                smsReportRange.exist(function () {
                    flog("init sms report range");
                    smsReportRange.daterangepicker({
                        format: 'DD/MM/YYYY', // YYYY-MM-DD
                        ranges: {
                            'Last 7 Days': [moment().subtract('days', 6), moment()],
                            'Last 30 Days': [moment().subtract('days', 29), moment()],
                            'This Month': [moment().startOf('month'), moment().endOf('month')],
                            'Last Month': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')],
                            'This Year': [moment().startOf('year'), moment()],
                        },
                    },
                            function (start, end) {
                                flog('onChange', start, end);
                                doSMSHistorySearch(start, end);
                            });
                });
            }

            function doSMSHistorySearch(startDate, endDate) {
                flog('doSMSHistorySearch', startDate, endDate);

                var data = {
                    startDate: formatDate(startDate),
                    finishDate: formatDate(endDate)
                };
                flog("data", data);

                var target = $("#sms-history-table-body");

                var dates = "smsStartDate=" + formatDate(startDate) + "&smsFinishDate=" + formatDate(endDate);
                var baseHref = window.location.pathname + "?" + dates;
                var href = baseHref + "#history-tab";
                $("a.sms-history-csv").attr("href", "sms-history.csv?" + dates);

                $.ajax({
                    type: "GET",
                    url: href,
                    dataType: 'html',
                    success: function (content) {
                        flog('response', content);
                        var newBody = $(content).find("#sms-history-table-body");
                        target.replaceWith(newBody);
                        $('#sms-history-table').find("abbr.timeago").timeago();
                        window.history.pushState(null, "SMS History", href);
                    }
                });

            }

            function initSmsField() {
                var sms_txt_max = 160;
                $(".refresh-sms").click(function (e) {
                    e.preventDefault();
                    $("#smsprovider-list").reloadFragment();
                });

                var ln = sms_txt_max - $("#smsMessage").val().length;
                if (ln < 0) {
                    $("#sms-char-remaining").text(Math.abs(ln) + " characters over");
                    $("#sms-char-remaining").css('color', 'red');
                } else {
                    $("#sms-char-remaining").text(ln + " characters remaining");
                    $("#sms-char-remaining").css('color', '');
                }

                $("#smsMessage").keyup(function () {
                    var ln = sms_txt_max - $("#smsMessage").val().length;
                    if (ln < 0) {
                        $("#sms-char-remaining").text(Math.abs(ln) + " characters over");
                        $("#sms-char-remaining").css('color', 'red');
                    } else {
                        $("#sms-char-remaining").text(ln + " characters remaining");
                        $("#sms-char-remaining").css('color', '');
                    }
                });
            }

            var options = {
                startDate: null,
                endDate: null,
                interval: "day"
            };

            function loadData() {
                var href = "?triggerHistory&" + $.param(options);
                $.ajax({
                    type: "GET",
                    url: href,
                    dataType: 'html',
                    success: function (resp) {
                        var json = null;

                        if (resp !== null && resp.length > 0) {
                            json = JSON.parse(resp);
                        }

                        flog('response', json);
                        handleData(json);

                    }
                });
            }

            function handleData(resp) {
                var aggr = (resp !== null ? resp.aggregations : null);

                initHistogram(aggr);
            }

            function initEmailStats() {
                initChart($('.emailsMainPie'), {
                    trackColor: 'rgba(255,255,255,0.2)',
                    scaleColor: 'rgba(255,255,255,0.5)',
                    barColor: 'rgba(255,255,255,0.7)',
                    lineWidth: 7,
                    lineCap: 'butt'
                }, 90);

                initChart($('.emailsSubPie.bluePie'), {
                    trackColor: '#eee',
                    scaleColor: '#ccc',
                    barColor: '#2196F3',
                    lineWidth: 7,
                    lineCap: 'butt'
                }, 8);

                initChart($('.emailsSubPie.orangePie'), {
                    trackColor: '#eee',
                    scaleColor: '#ccc',
                    barColor: '#FFC107',
                    lineWidth: 7,
                    lineCap: 'butt'
                }, 8);
            }

            function initHistogram(aggr) {
                $('#chart_histogram svg').empty();
                nv.addGraph(function () {
                    var chart = nv.models.multiBarChart()
                            .options({
                                showLegend: true,
                                showControls: false,
                                noData: "No Data available for histogram",
                                margin: {
                                    left: 40,
                                    bottom: 60
                                }
                            });

                    chart.xAxis
                            .axisLabel("Date")
                            .rotateLabels(-45)
                            .tickFormat(function (d) {
                                return moment(d).format("DD MMM");
                            });

                    chart.yAxis
                            .axisLabel("Triggered")
                            .tickFormat(d3.format('d'));

                    var myData = [];
                    var conditionsTrue = {
                        values: [],
                        key: "Trigger",
                        color: "#7777ff",
                        area: true
                    };

                    var conditionsFalse = {
                        values: [],
                        key: "Failed Trigger",
                        color: "#d9534f",
                        area: true
                    };

                    var delayedTriggers = {
                        values: [],
                        key: "Delayed Trigger",
                        color: "#5bc0de",
                        area: true
                    };

                    myData.push(conditionsTrue);
                    myData.push(conditionsFalse);
                    myData.push(delayedTriggers);

                    var trueHits = (aggr !== null ? aggr.triggerTrue.firedAt.buckets : []);
                    var falseHits = (aggr !== null ? aggr.triggerFalse.firedAt.buckets : []);
                    var delayedHits = (aggr !== null ? aggr.delayedTriggers.createdAt.buckets : []);

                    for (var i = 0; i < trueHits.length; i++) {
                        var bucket = trueHits[i];
                        conditionsTrue.values.push(
                                {x: bucket.key, y: bucket.doc_count});
                    }

                    for (var i = 0; i < falseHits.length; i++) {
                        var bucket = falseHits[i];
                        conditionsFalse.values.push(
                                {x: bucket.key, y: bucket.doc_count});
                    }

                    for (var i = 0; i < delayedHits.length; i++) {
                        var bucket = delayedHits[i];
                        delayedTriggers.values.push(
                                {x: bucket.key, y: bucket.doc_count});
                    }

                    d3.select('#chart_histogram svg')
                            .datum(myData)
                            .transition().duration(500)
                            .call(chart);

                    nv.utils.windowResize(chart.update);

                    return chart;
                });
            }

            function drawChart(chart, options, padding, isFirstTime) {
                var wrapper = chart.closest('.col-sm-6');
                var canvas = chart.find('canvas');
                var sizeChart = wrapper.width() - padding;
                if (sizeChart < 0) {
                    sizeChart = 100;
                }
                var currentSize = +chart.attr('data-size');
                flog("got size", sizeChart, chart);

                // Hide canvas
                canvas.hide();

                if (currentSize !== sizeChart || isFirstTime) {
                    flog('Render new chart', sizeChart);

                    // Clear data pf easyPieChart
                    if (!isFirstTime) {
                        chart.data('easy-pie-chart', null);
                        chart.data('size', sizeChart);
                    }

                    // Remove the chart
                    canvas.remove();

                    // Render new chart
                    options.size = sizeChart;
                    flog("chart size", sizeChart);
                    chart.easyPieChart(options);
                } else {
                    flog('Re-show current chart');
                    canvas.show();
                }

            }

            function initChart(target, options, padding) {
                drawChart(target, options, padding, true);

                $(window).on('resize', function () {
                    drawChart(target, options, padding);
                });
            }

            function initControls() {
                flog("initControls");
                var reportRange = $('#analytics-range');

                function cb(start, end) {
                    options.startDate = start.format('DD/MM/YYYY');
                    options.endDate = end.format('DD/MM/YYYY');
                    loadData();
                }

                reportRange.exist(function () {
                    flog("init analytics range");
                    reportRange.daterangepicker({
                        format: 'DD/MM/YYYY',
                        startDate: moment().subtract('days', 6),
                        endDate: moment(),
                        ranges: {
                            'Today': [
                                moment().toISOString(),
                                moment().toISOString()
                            ],
                            'Last 7 Days': [
                                moment().subtract('days', 6).toISOString(),
                                moment().toISOString()
                            ],
                            'Last 30 Days': [
                                moment().subtract('days', 29).toISOString(),
                                moment().toISOString()],
                            'This Month': [
                                moment().startOf('month').toISOString(),
                                moment().endOf('month').toISOString()],
                            'Last Month': [
                                moment().subtract('month', 1).startOf('month').toISOString(),
                                moment().subtract('month', 1).endOf('month').toISOString()],
                            'This Year': [
                                moment().startOf('year').toISOString(),
                                moment().toISOString()],
                        },
                    }, cb);
                });
            }

            function initTitleEditor() {
                $('#emailTitle').editable({
                    url: window.location.pathname,
                    name: 'title',
                    validate: function (value) {
                        if ($.trim(value) == '')
                            return 'This field is required';
                    },
                    success: function (response, newValue) {
                        flog(response, newValue);
                        if (response.status) {
                            Msg.info('Successfully saved title');
                        }
                    },
                    params: function (params) {
                        params.title = params.value;
                        return params;
                    }
                });
            }
        </script>
    </body>
</html>
