<html>
    <head>
        <title>$page.title</title>
    </head>
    <body>
        <div style="padding-top: 15px">
            <div class="panel panel-default">
                <div class="panel-heading">

                    <i class="fa fa-bar-chart-o"></i> Reporting
                </div>
                <div class="panel-body">
                    <div class="clearfix">
                        <div class="pull-right">
                            <div class="dropdown">
                                <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown">
                                    Report entity: rootorg
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                                    <li role="presentation" class="odd"><a role="menuitem" tabindex="-1" href="/reporting/groupSignups">This organisation - rootorg</a></li>
                                    <li role="presentation" class="divider even"></li>
                                </ul>
                            </div>
                        </div>

                        <p class="btn-group pull-left">
                            <a class="btn btn-orange dated" href="pointsBalance.csv">Export as CSV</a>
                        </p>
                    </div>


                    <div class="pageMessage alert alert-danger" style="display: block;">No data was found for the given criteria</div>


                    <div id="reportResult" class="row">
                        <div class="col-lg-9">
                            <div id="annual"></div>

                            <div class="details-items-wrapper" style="display: none">
                                <h4>Detailed items</h4>
                                <hr class="hr-sm">
                                <div id="items"></div>
                            </div>

                        </div>
                        <div class="col-lg-3">
                        </div>
                    </div>

                    <div class="clearfix"></div>
                </div>
            </div>


            <div class="hide column-row-template">
                <div class="form-group">
                    <div class="col-md-4">
                        <input type="text" class="form-control required column-title" value="" placeholder="Column label">
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control required column-expr" value="" placeholder="Column expression">
                    </div>
                    <span class="btn btn-default">
                        <span class="glyphicon glyphicon-sort handle"></span>
                    </span>
                    <button class="btn btn-sm btn-danger columns-remove" type="button">
                        <span class="glyphicon glyphicon-remove"></span>
                    </button>
                </div>
            </div>



            <div id="proto" style="position: absolute; visibility: hidden">
                <table>
                    <tbody><tr class="agg-row odd">
                            <td class="first">
                                <div class="">
                                    <a href="?startDate=12%2F07%2F2016&amp;finishDate=14%2F07%2F2016" class="dated term-select"></a>
                                </div>
                            </td>
                            <td align="right" class="last">0</td>
                        </tr>
                    </tbody></table>
            </div>

            <script src="/templates/themes/admin2/assets/plugins/jQuery-File-Upload/js/vendor/jquery.ui.widget.js"></script>
            <script src="/templates/themes/admin2/assets/plugins/jQuery-File-Upload/js/jquery.iframe-transport.js"></script>
            <script src="/templates/themes/admin2/assets/plugins/jQuery-File-Upload/js/jquery.fileupload.js"></script>
            <script>
                $(function () {
                    $("#reportSettingsModal form").forms({
                        validate: function (form) {
                            // renumber inputs
                            form.find(".columns-rows > div").each(function (i, n) {
                                var div = $(n);
                                flog("div", div);
                                div.find(".column-title").attr("name", "columnTitle." + (i + 1));
                                div.find(".column-expr").attr("name", "columnExpression." + (i + 1));
                            });
                            return true;
                        },
                        callback: function () {
                            Msg.info("Saved fields");
                        }
                    });
                    $("#reportSettingsModal").on("click", ".columns-remove", function () {
                        flog("remove", this);
                        $(this).closest(".form-group").remove();
                    });
                    $(".columns-add").click(function (e) {
                        e.preventDefault();
                        var newRow = $(".column-row-template > div").clone();
                        var id = Math.floor(Math.random() * 1000000);
                        newRow.find("input").each(function (i, n) {
                            var inp = $(n);
                            var origName = inp.attr("name");
                            inp.attr("name", origName + id);
                        });
                        $(".columns-rows").append(newRow);
                    });

                    $(".delete-report").click(function (e) {
                        e.preventDefault();
                        var link = $(e.target).closest("a");
                        var href = link.attr("href");
                        flog("href", href, link);
                        var name = getFileName(href);
                        confirmDelete(href, name, function () {
                            window.location = "/reporting/";
                        });
                    });

                    $("#fields-csv-upload").fileupload({
                        dataType: 'json',
                        url: "groupSignups-fields.csv",
                        progressall: function (e, data) {
                            flog("prog", data.loaded, data.total);
                            if (data.loaded == data.total) {
                                flog("finished");
                                Msg.info("Uploaded CSV file ok");
                                $("#fields-container").reloadFragment();
                            }
                        }
                    });
                });
            </script>
        </div>
    </body>
</html>
