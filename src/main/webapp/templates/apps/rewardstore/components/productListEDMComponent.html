#set ($width = $formatter.toInteger($width))

#set( $pointsBucket = $applications.rewardStore.findStore($store).reward )
#set( $userBalance = $applications.rewardStore.pointsBalance($pointsBucket.name, $user) )

#set ($numberOfProducts = $formatter.toInteger($numberOfProducts))
#set( $prods = $applications.rewardStore.productSearch($store, null, $category,$userBalance, 0,$numberOfProducts, 'finalPoints', false) )

#if( $prods.hits.totalHits > 0 )

    #if ($layout == "grid")
        #set ($tableWidth = $width / 2)
        #if ($itemsPerRow == 1)
            #set ($tableWidth = "100%")
        #elseif ($itemsPerRow == 2)
            #set ($tableWidth = $width / 2)
        #elseif ($itemsPerRow == 3)
            #set ($tableWidth = $width / 3)
        #end

        <table cellpadding="0" cellspacing="0" border="0" width="100%">
            <tbody>
                <tr>
                    <td>
                        #foreach($p in $prods.hits.hits )
                            #set ($prodUrl = "http://${rootFolder.domainName}${formatter.portString}/$store/$category/$p.fields.product.value")
                            <table cellpadding="0" cellspacing="0" border="0" width="$tableWidth" align="left" class="col">
                                <tbody>
                                    <tr>
                                        <td style="padding-left: 10px; padding-right: 10px;">
                                            <table cellpadding="0" cellspacing="0" border="0" width="100%">
                                                <tr>
                                                    <td>
                                                        #set($bg = "http://${rootFolder.domainName}${formatter.portString}/static/images/photo_holder.png/alt-600-400.png")
                                                        #if( $p.fields.primaryImageHref.value )
                                                            #set($bg = "http://${rootFolder.domainName}${formatter.portString}${p.fields.primaryImageHref.value}/alt-600-400.png")
                                                        #end
                                                        <a title="$p.fields.title.value" href="${prodUrl}">
                                                            <img src="$bg" width="100%" height="auto" alt="$p.fields.title.value" style="display: block; border: 0;" />
                                                        </a>
                                                        <h4><a href="${prodUrl}">$p.fields.title.value</a></h4>
                                                        <b>Price: $p.fields.finalPoints.value pts</b>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td height="40" valign="top">
                                                        <p>
                                                            $!formatter.truncate( $formatter.toPlain( $p.fields.notes.value), 100)
                                                        </p>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <p><a href="${prodUrl}">View detail</a></p>
                                                    </td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        #end
                    </td>
                </tr>
            </tbody>
        </table>
    #else
        <table cellpadding="0" cellspacing="0" border="0" width="100%">
            <tbody>
                #set ($leftWidth = $width / 3)
                #set ($rightWidth = $width - $leftWidth)

                #foreach($p in $products.hits.hits )
                    #set ($prodUrl = "http://${rootFolder.domainName}${formatter.portString}/$store/$category/$p.fields.product.value")
                    <tr>
                        <td valign="top" style="padding-bottom: 15px;">
                            <table cellpadding="0" cellspacing="0" border="0" width="$leftWidth" align="left" class="col">
                                <tr>
                                    <td class="wrapper" style="padding-right: 15px">
                                        <table cellpadding="0" cellspacing="0" border="0" width="100%">
                                            <tr>
                                                <td>
                                                    #set($bg = "http://${rootFolder.domainName}${formatter.portString}/static/images/photo_holder.png")
                                                    #if( $p.fields.primaryImageHref.value )
                                                        #set($bg = "http://${rootFolder.domainName}${formatter.portString}${p.fields.primaryImageHref.value}")
                                                    #end
                                                    <a title="$p.fields.title.value" href="${prodUrl}">
                                                        <img src="$bg" width="100%" height="auto" alt="$p.fields.title.value" style="display: block; border: 0;" />
                                                    </a>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                            <table cellpadding="0" cellspacing="0" border="0" width="$rightWidth" align="right" class="col">
                                <tr>
                                    <td class="wrapper">
                                        <h4><a href="${prodUrl}">$p.fields.title.value</a></h4>
                                        <p>
                                            <b>Price: $p.fields.finalPoints.value pts</b>
                                        </p>
                                        <p>
                                            $formatter.truncate( $formatter.toPlain( $p.fields.notes.value), 100)
                                        </p>
                                        <p><a href="${prodUrl}">Read more</a></p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                #end
            </tbody>
        </table>
    #end
#else
    <p>Sorry, we couldnt find any products for you</p>
#end