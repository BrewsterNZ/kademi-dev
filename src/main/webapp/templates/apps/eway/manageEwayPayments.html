
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>$view.title</title>
    </head>

    <body>
        <div class="tabbable">
            <ul class="nav nav-tabs tab-bricky" id="myTab">
                <li class="active"><a data-toggle="tab" href="#panel_payments"><i class="green fa fa-home"></i> Transactions</a></li>
                <li class=""><a data-toggle="tab" href="#recurring"><i class="green fa fa-home"></i> Recurring</a></li>
                <li class=""><a data-toggle="tab" href="#panel_pay"><i class="green fa fa-home"></i> eWay Pay</a></li>
            </ul>

            <div class="tab-content">

                <div id="panel_payments" class="tab-pane active">
                    <table id="payments-table" class="table table-striped table-hover">
                        <colgroup>
                            <col width="" />
                            <col width="" />
                            <col width="" />
                            <col width="" />
                            <col width="" />
                            <col width="" />
                            <col width="" />
                            <col width="" />
                        </colgroup>
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th >Card Number</th>
                                <th >Total Amount</th>
                                <th >Currency</th>
                                <th >Purchase Status</th>
                                <th >Created Date</th>
                                <th >Created By</th>
                                <th>Organisation</th>
                            </tr>
                        </thead>
                        <tbody id="payments-body">
                            #foreach($payment in $page.paymentTransactionByOrg)
                            <tr>
                                <td>$!payment.transactionID</td>
                                <td>$!payment.cardNumber</td>
                                <td>$!payment.amount</td>
                                <td>$!payment.currencyCode</td>
                                <td>
                                    <div class="$payment.transactionStatus">
                                        #if($payment.status)
                                        <span class="label label-sm label-success">Successful</span>
                                        #else
                                        <span class="label label-sm label-warning">Failed </span>
                                        #end
                                    </div>
                                </td>
                                <td>$formatter.formatDateTime($payment.createdDate)</td>
                                <td>$payment.createdBy.name</td>
                                <td>$payment.org.title</td>

                            </tr>
                            #end
                        </tbody>
                    </table>
                </div>

                <div id="panel_pay" class="tab-pane" >
                    <div id="paymentDetails">
                        #set( $encKey = $page.getEncryptionKey($request.params.websiteBranch))

                        #if( !$request.params.websiteBranch )
                        <div class="alert alert-warning">Please select a website
                            <div class="btn-group publishing pull-right">

                                <a class="btn btn-sm btn-primary dropdown-toggle" data-toggle="dropdown" href="#">
                                    <b>Send payment to site:</b>
                                    $!request.params.websiteBranch
                                    <span class="caret"></span>
                                </a>
                                <ul role="menu" class="dropdown-menu list branches">
                                    #foreach($w in $page.find("/websites").children.ofType.website)
                                    #foreach($b in $w.children.ofType.branch)
                                    <li role="presentation" class="list-item select-website">
                                        <a href="$page.href?websiteBranch=$b.repository.name/$b.name#panel_pay-tab" class="branch noclear">$b.repository.name/$b.name</a>
                                    </li>
                                    #end
                                    #end
                                </ul>
                            </div>

                        </div>
                        #else
                        #if( $encKey )

                        #else
                        <div class="alert alert-warning">There is no encryption key for this website. Payments will fail unless you are PCI-DSS Compliant</div>
                        #end

                        <div class="btn-group publishing pull-right">

                            <a class="btn btn-sm btn-primary dropdown-toggle" data-toggle="dropdown" href="#">
                                <b>Change payment to site:</b>
                                $!request.params.websiteBranch
                                <span class="caret"></span>
                            </a>
                            <ul role="menu" class="dropdown-menu list branches">
                                #foreach($w in $page.find("/websites").children.ofType.website)
                                #foreach($b in $w.children.ofType.branch)
                                <li role="presentation" class="list-item select-website">
                                    <a href="$page.href?websiteBranch=$b.repository.name/$b.name#panel_pay-tab" class="branch noclear">$b.repository.name/$b.name</a>
                                </li>
                                #end
                                #end
                            </ul>
                        </div>



                        <form class="form-horizontal" data-eway-encrypt-key="$!encKey" id="paymentForm" method="POST">
                            <div class="form-group">
                                <label for="Name" class="col-sm-3 control-label">Website/Version</label>
                                <div class="col-sm-4">
                                    <input  class="form-control required" type="text" id="websiteBranch" name="websiteBranch" value="$!request.params.websiteBranch"/>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="Name" class="col-sm-3 control-label">Card Name</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control required" required="true" id="Name" name="Name" value = "Just A Test"/>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="Number" class="col-sm-3 control-label">Card Number</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control required" required="true" id="Number" name="Number" data-regex="^[0-9]+$" value = "4444333322221111"/>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="ExpiryMonth" class="col-sm-3 control-label">ExpiryMonth</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control required" required="true" id="ExpiryMonth" name="ExpiryMonth" data-regex="^[0-9]+$" value="12"/>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="ExpiryYear" class="col-sm-3 control-label">ExpiryYear</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control required" required="true" id="ExpiryYear" name="ExpiryYear" data-regex="^[0-9]+$" value="23"/>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="CVN" class="col-sm-3 control-label">CVN</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control required" required="true" id="CVN" name="CVN" data-regex="^[0-9]+$" value="567"/>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="TotalAmount" class="col-sm-3 control-label">TotalAmount</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control required" required="true" id="TotalAmount" name="TotalAmount" data-regex="^[0-9]+$" value="897"/>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="CurrencyCode" class="col-sm-3 control-label">CurrencyCode</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control required" required="true" id="CurrencyCode" name="CurrencyCode" value="AUD"/>
                                </div>
                            </div>

                            <hr/>
                            <div class="form-group">
                                <label for="frequency" class="col-sm-3 control-label">Recurring frequency</label>
                                <div class="col-sm-9">
                                    <select name="frequency" id="frequency" class="form-control">
                                        <option value="">Not recurring</option>
                                        <option value="WEEKLY">WEEKLY</option>
                                        <option value="MONTHLY">MONTHLY</option>
                                        <option value="ANNUAL">ANNUAL</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="multiples" class="col-sm-3 control-label">Multiples/Rate</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="multiples" name="multiples" value="1"/>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="countryCode" class="col-sm-3 control-label">Country code</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="countryCode" name="countryCode" value="au"/>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="multiples" class="col-sm-3 control-label">Immediate payment</label>
                                <div class="col-sm-9">
                                    <input type="checkbox" class="form-control" id="immediate" name="immediate" value="true"/>
                                </div>
                            </div>
                        </form>
                        <div class="row">
                            <div class="col-sm-3"></div>
                            <div class="col-sm-9">
                                <button id="paymentBtn" class="btn btn-sm btn-info" type="button">Submit payment</button>
                            </div>
                        </div>
                        <script src="https://secure.ewaypayments.com/scripts/eCrypt.js">//</script>
                        #end
                    </div>
                </div>

                <div id="recurring" class="tab-pane" >
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>
                                    Purchaser
                                </th>
                                <th>Start Date</th>
                                <th>Website</th>
                                <th>Amount</th>
                                <th>Frequency</th>
                                <th>No. payments</th>
                            </tr>
                        </thead>
                        <tbody>
                            #set($recurring = $page.recurringTransactions)
                            #if( $recurring.size() > 0 )
                            #foreach( $r in $recurring)
                            <tr>
                                <td>
                                    <a href="/manageUsers/$r.purchaser.id">$r.purchaser.formattedName</a>
                                </td>
                                <td>$r.startDate</td>
                                <td>$r.website.name</td>
                                <td>$r.amount $r.currencyCode</td>
                                <td>$r.periodMultiples $r.frequency</td>
                                <td>$r.paymentResults.size()</td>
                            </tr>
                            #end
                            #else
                            <tr>
                                <td>There are currently no recurring transactions registered</td>
                            </tr>
                            #end
                        </tbody>
                    </table>
                </div>
                <!-- end recurring -->



            </div>
        </div>

        <script type="text/javascript">
            $(document).ready(function () {
                $("body").on('click', '#paymentBtn', function (e) {
                    e.preventDefault();

                    var num = $('#Number').val();
                    var cvn = $('#CVN').val();
                    flog("payment", num, cvn);
                    $.ajax({
                        url: "/eWayTest",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            name: $('#Name').val(),
                            expiryMonth: $('#ExpiryMonth').val(),
                            expiryYear: $('#ExpiryYear').val(),
                            totalAmount: $('#TotalAmount').val(),
                            currencyCode: $('#CurrencyCode').val(),
                            websiteBranch: $('#websiteBranch').val(),
                            frequency: $('#frequency').val(),
                            multiples: $('#multiples').val(),
                            immediate: $('#immediate').prop("checked"),
                            countryCode: $('#countryCode').val(),
                            number: eCrypt.encryptValue(num),
                            cvn: eCrypt.encryptValue(cvn)

                        },
                        success: function (data) {
                            flog("success", data);
                            if (data.status) {
                                Msg.success("Success", 6000);
                                $('#payments-body').reloadFragment();
                            } else {
                                Msg.error("There was a problem. Please see the transaction history for details");
                                showErrors(data.messages, data.fieldMessages);
                                $('#payments-body').reloadFragment();
                            }
                        },
                        error: function (resp) {
                            flog("errors", resp);
                            alert("Error attempting to process payment: " + resp);
                        }
                    });
                });
            });
            function showErrors(messages, fieldMessages) {
                var s = "";
                for (var i = 0; i < messages.length; i++) {
                    s += messages[i] + "<br/>";
                }
                for (var i = 0; i < fieldMessages.length; i++) {
                    s += fieldMessages[i].field + " - " + fieldMessages[i].message + "<br/>";
                }

                Msg.error("Could not process payment. Please see the transaction history for details.<br/>" + s);
            }
        </script>
    </body>

</html>