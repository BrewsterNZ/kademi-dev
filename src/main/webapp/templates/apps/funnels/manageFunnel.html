<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Manage Funnels</title>
    </head>
    <body>
        <h1>$page.title</h1>
        <p class="lead">Leads = $page.leads.size()</p>

        <div class="well" style="display: none">
            <xmp id="funnelJson">$page.funnelJson</xmp>
        </div>


        <div class="well" id="paper" style="height: 600px; overflow: scroll">
            <button class="btn btn-success pull-right" id="btnSave">Save</button>
        </div>

        <div class="panel panel-default">
            <div class="panel-body">

                <ul>
                    #foreach($node in $page.funnel.nodes)
                    <li><a href="$node.nodeId">$node.nodeId</a></li>
                    #end
                </ul>


            </div>
        </div>

        <a href="/repositories/$page.name/" class="btn btn-primary">Edit funnel</a>

        <a class="btn btn-success btn-sm" href="#" data-toggle="modal" data-target="#modalUploadCsv">
            <span class="glyphicon glyphicon-upload"></span>
            Upload CSV
        </a>
        <a class="btn btn-info btn-sm btn-export-points" href="export-leads.csv">
            <span class="glyphicon glyphicon-download"></span>
            Export to CSV
        </a>



        <table class="table table-responsive">
            <thead>
                <tr>
                    <th>TrackingID</th>
                    <th>Email</th>
                    <th>Last attained</th>
                    <th>Awaiting goal</th>
                    <th>Created date</th>
                    <th>Last attained date</th>
                    <th>Timer</th>
                    <th>Stage</th>
                    <th>Source</th>
                    <th>Funnel version</th>
                    <th>Team</th>
                    <th>Assigned to</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                #foreach( $lead in $page.leads )
                <tr>
                    <td>$!lead.trackingId</td>
                    <td>$!lead.profile.email</td>
                    <td>$!lead.lastAttainedGoal</td>
                    <td>$!lead.currentGoal</td>
                    <td>$lead.createDate</td>
                    <td>$lead.lastAttainedDate</td>
                    <td>$!lead.timerDate</td>
                    <td>$!lead.stageName</td>
                    <td>$!lead.source</td>
                    <td>$!lead.funnelBranch</td>
                    <td>$!lead.assignedToOrg.formattedName</td>
                    <td>$!lead.assignedToProfile.formattedName</td>
                    <td>
                        <button data-leadid="$lead.id" type="button" class="btn btn-danger btn-del-lead"><i class="fa fa-trash"></i></button>
                    </td>
                </tr>
                #end
            </tbody>
        </table>

        <div id="modalUploadCsv" class="modal fade">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Upload Leads CSV</h4>
            </div>
            <div class="modal-body">
                <div class="row upload">
                    <div class="col-sm-12">
                        <div class="btn btn-primary btn-sm input uploadCsv" id="doUploadCsv"></div>
                        <div class="results" style="display: none">
                            <p>
                                <strong>Num inserted:</strong>
                                <span class="numInserted">-</span>
                                <strong>Num updated:</strong>
                                <span class="numUpdated">-</span>
                                <strong>Unmatched rows:</strong>
                                <span class="numUnmatched">-</span>
                            </p>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-condensed">
                                    <thead>
                                        <tr>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">Close</button>
            </div>
        </div>

        <link rel="stylesheet" href="/static/jointjs/0.9.5/joint.min.css" />
        <script src="/static/jointjs/0.9.5/lodash.min.js"></script>
        <script src="/static/jointjs/0.9.5/backbone-min.js"></script>
        <script src="/static/jointjs/0.9.5/joint.min.js"></script>
        <script type="text/javascript" src="/static/js/jquery.milton-upload.js"></script>



        <script type="text/javascript">
            $(function () {
                $('body').on('click', '.btn-del-lead', function (e) {
                    e.preventDefault();

                    var btn = $(this);
                    var tr = btn.closest('tr');
                    var leadId = btn.data('leadid');
                    confirmDelete(leadId, 'this lead', function () {
                        tr.remove();
                    });
                });

                initUpload();
                initJoint();
            });
            function initUpload() {
                $("#doUploadCsv").mupload({
                    buttonText: "<i class=\"clip-folder\"></i> Upload spreadsheet",
                    url: "export-leads.csv",
                    useJsonPut: false,
                    oncomplete: function (data, name, href) {
                        log("oncomplete:", data.result.data, name, href);
                        $(".results .numUpdated").text(data.result.data.numUpdated);
                        $(".results .numInserted").text(data.result.data.numInserted);
                        $(".results .numUnmatched").text(data.result.data.unmatched.length);
                        showUnmatched(data.result.data.unmatched);
                        $(".results").show();
                        Msg.success("Upload completed. Please review any unmatched members below, or refresh the page to see the updated list of members");
                    }
                });
            }

            function formatMins(i) {
                if (i < 120) {
                    return i + " mins";
                } else if (i < 60 * 24) {
                    return i / 60 + " hours";
                } else {
                    return i / (60 * 24) + " days";
                }
            }

            function initJoint() {
                flog("initJoint");
                var graph = new joint.dia.Graph();

                var paper = new joint.dia.Paper({
                    el: $('#paper'),
                    width: 1200,
                    height: 600,
                    gridSize: 1,
                    model: graph
                });



                function state(n, nodeType) {
                    flog("state", n.nodeId, nodeType, n);
                    var x = n.x;
                    var y = n.y;
                    var label = n.nodeId;
                    var cell;
                    if (nodeType === "goal") {
                        var outPorts = ['timeout'];
                        if (n.transitions) {
                            $.each(n.transitions, function (i, tr) {
                                var keys = Object.keys(tr.trigger);
                                tr = tr.trigger[keys[0]];
                                outPorts.push(tr.description);
                            });
                        }
                        cell = new joint.shapes.devs.Atomic({
                            position: {x: x, y: y},
                            size: {width: 150, height: 70},
                            inPorts: ['in'],
                            outPorts: outPorts, // add ports for other transitions
                            attrs: {
                                text: {text: label, fill: '#000000', 'font-weight': 'normal'},
                            }
                        });

                        // rounded corners indicate a state
                        _.each([cell], function (element) {
                            element.attr({'.body': {'rx': 8, 'ry': 26}});
                        });
                    } else {
                        // action
                        var outPorts = ['then'];
                        var props = Object.keys(n);
                        var action = n[props[0]];
                        flog("action", action);
                        if (nodeType === "decision") {
                            for (k in n.choices) {
                                var ch = n.choices[k];
                                var exprType = Object.keys(ch);
                                ch = ch[exprType];
                                outPorts.push(ch.label);
                            }
                        }
                        cell = new joint.shapes.devs.Atomic({
                            position: {x: x, y: y},
                            size: {width: 150, height: 70},
                            inPorts: ['in'],
                            outPorts: outPorts, // add ports for other transitions
                            attrs: {
                                text: {text: label, fill: '#000000', 'font-weight': 'normal'},
                            }
                        });

                    }

                    graph.addCell(cell);

                    cell.on('change:position', function (element) {
                        var pos = element.get('position');
                        n.x = pos.x;
                        n.y = pos.y;
                    });
                    flog("added cell", cell);
                    return cell;
                }

                function link(source, target, label, outPort) {
                    flog("link: ", source, target, label, outPort);
                    var src = {id: source.id};
                    if (outPort) {
                        src.selector = source.getPortSelector(outPort);
                    }

                    var cell = new joint.dia.Link({
                        source: src,
                        target: {id: target.id, selector: target.getPortSelector("in")},
                        router: {name: 'manhattan'},
                        connector: {name: 'rounded'},
                        attrs: {
                            '.connection': {
                                stroke: '#333333',
                                'stroke-width': 3
                            },
                            '.marker-target': {
                                fill: '#333333',
                                d: 'M 10 0 L 0 5 L 10 10 z'
                            }
                        }
                    });

                    graph.addCell(cell);
                    return cell;
                }

                var json = $("#funnelJson").text();
                var funnel = $.parseJSON(json);

                $("#btnSave").click(function (e) {
                    var source = JSON.stringify(funnel, null, '\t');
                    doSave("funnel.json", source);
                });

                flog("funnel", funnel);
                var nodes = {};
                $.each(funnel.nodes, function (i, n) {
                    //flog("node", n);
                    var keys = Object.keys(n);
                    var nodeType = keys[0];
                    n = n[keys[0]];
                    var el;
                    if (nodeType === "begin") {
                        el = new joint.shapes.fsa.StartState({position: {x: n.x, y: n.y}});
                        graph.addCell(el);
                    } else {
                        el = state(n, nodeType); // should be an action symbol, or decision
                    }
                    nodes[n.nodeId] = el;
                });

                // Now link them
                flog("link nodes");
                $.each(funnel.nodes, function (i, n) {
                    flog("node", n);
                    var keys = Object.keys(n);
                    n = n[keys[0]];
                    var source = nodes[n.nodeId];
                    if (keys[0] === "begin") {
                        var dest = nodes[n.transition.nextNodeId];
                        if (dest !== null) {
                            link(source, dest, 'Start');
                        } else {
                            flog("Could not find node ", n.transition.nextNodeId);
                        }
                    } else if (keys[0] === "goal") {
                        flog("link goal timeout source=", source, "dest=", dest);
                        var dest = nodes[n.timeoutNode];
                        if (dest) {
                            link(source, dest, formatMins(n.timeoutMins), "timeout");
                        }
                        if (n.transitions) {
                            $.each(n.transitions, function (i, tr) {
                                dest = nodes[tr.nextNodeId];
                                if (dest !== null) {
                                    var props = Object.keys(tr.trigger);
                                    var triggerType = props[0];
                                    var trigger = tr.trigger[triggerType];
                                    link(source, dest, triggerType, trigger.description);
                                }
                            });
                        }
                    } else {
                        // an action node
                        flog("link action node", n, n.nextNodeId);
                        var dest = nodes[n.nextNodeId];
                        if (dest != null) {
                            link(source, dest, 'then', "then");
                        }
                        if (keys[0] === "decision") {
                            flog("link decision node", n.choices);
                            if (n.choices) {
                                for (k in n.choices) {
                                    var ch = n.choices[k];
                                    var exprType = Object.keys(ch);
                                    ch = ch[exprType];

                                    flog("decision choice1", ch);
                                    dest = nodes[k]
                                    if (dest) {
                                        link(source, dest, ch.label, ch.label);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function doSave(href, fileContent) {
                Msg.info("Saving..");
                $.ajax({
                    url: href,
                    type: 'PUT',
                    data: fileContent,
                    success: function () {
                        Msg.success('File is saved!');
                    },
                    error: function (e) {
                        Msg.error(e.status + ': ' + e.statusText);
                    }
                });
            }
        </script>
    </body>
</html>