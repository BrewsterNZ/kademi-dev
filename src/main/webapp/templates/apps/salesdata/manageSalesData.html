<html xmlns="http://www.w3.org/1999/xhtml">    <head>        <title>Manage Products</title>        <style>            .panel-heading .btn-series {                vertical-align: top;                position: relative;                top: -3px;            }        </style>    </head>    <body class="">        #set($allKPIs = $page.allKpis)        <div class="row">            <div class="col-sm-6">                <a class="btn btn-sm btn-success" href="new"><i class="fa fa-plus"></i> New Sales Data Series</a>                <a class="btn btn-sm btn-info btn-add-category" href="#"><i class="fa fa-plus"></i> Add new category</a>            </div>            <div class="col-sm-6 text-right">                <p>                    <a class="btn btn-sm btn-danger btn-process-select-kpi" href="#"><i class="glyphicon glyphicon-signal"></i> Process Selected KPI's</a>                    <a class="btn btn-sm btn-danger btn-process-rewards" href="#"><i class="glyphicon glyphicon-gift"></i> Allocate KPI Rewards</a>                    <a class="btn btn-sm btn-danger btn-clear-kpi-history" href="#"><i class="fa fa-times"></i> Clear KPI History</a>                </p>            </div>        </div>        <div id="processKpiRewards" style="display:none;" class="well">            <h1 class="job-title"></h1>            <div class="upload">                <div class="alert alert-info">                    <h3>Allocate reward points</h3>                    <img src="/theme/apps/salesdata/danbo-presents.jpg" alt="" width="200px" style='float: left; margin-right: 15px' />                    <div>                        <p>This process will find KPI's which have been processed but which have not had rewards allocated. It will                            use the configured reward rules to <b>allocate rewards points</b></p>                        <p>This will send out email notifications if they have been configured.</p>                    </div>                    <div class="clearfix"></div>                </div>            </div>            <div class="are-you-sure">                <div class="alert alert-warning">                    <h3>Are you sure?</h3>                    <span>                        <a class="btn btn-sm btn-success btnAllocateRewards" href="#"><i class="fa fa-check"></i> Start Processing</a>                        <a class="btn btn-sm btn-danger btn-hide-div" href="#"><i class="fa fa-times"></i> GET ME OUTA HERE!</a>                    </span>                </div>            </div>        </div>        <div id="processSelectKpis" style="display:none;" class="well">            <h1 class="job-title"></h1>            <div class="upload">                <div class="alert alert-info">                    <h3>Processing Select KPI's</h3>                    <img src="/theme/apps/salesdata/Mr-T-mrt-36834265-320-254.png" alt="" width="150px" style='float: left; margin-right: 15px' />                    <div>                        <p class='lead'>Do you know what you're doing?!</p>                        <p>This process will find the most recent finished and un-processed period (eg month or quarter) for each selected KPI. It will                            calculate a KPI value for each profile and compare against levels.</p>                        <p>This will send out email notifications if they have been configured.</p>                    </div>                </div>            </div>            <div class="are-you-sure">                <div class="alert alert-warning">                    <h3>Are you sure?</h3>                    <span>                        <a class="btn btn-sm btn-success btn-start-select-processing" href="#"><i class="fa fa-check"></i> Start Processing</a>                        <a class="btn btn-sm btn-danger btn-hide-div" href="#"><i class="fa fa-times"></i> GET ME OUTA HERE!</a>                    </span>                </div>            </div>            #set( $kpis = $page.allKPIs )            <div id="selectTable">                <div class="table-responsive">                    <table class='table table-bordered table-striped'>                        <colgroup>                            <col />                            <col />                            <col />                            <col />                            <col />                            <col />                            <col />                            <col style="width: 120px" />                        </colgroup>                        <thead>                            <tr>                                <th>Series</th>                                <th>Title <span class="badge">$kpis.size()</span></th>                                <th>Start Date</th>                                <th>Last period ending</th>                                <th>Aggregation</th>                                <th>Aggregation Period</th>                                <th>Reward</th>                                <th class="text-center"><input type="checkbox" class="check-all"/><span class="badge select-count pull-right">0</span></th>                            </tr>                        </thead>                        <tbody id='kpis-table-body'>                            #if( $kpis.isEmpty() )                            <tr>                                <td>No KPI's have been defined for this data series</td>                            </tr>                            #else                            #foreach($kpi in $kpis)                            <tr>                                <td><a href="$kpi.parent.parent.href">$kpi.parent.parent.title</a></td>                                <td><a href="$kpi.href">$kpi.kpi.title</a></td>                                #if($kpi.kpi.startDate)                                <td>$formatter.formatDate($kpi.kpi.startDate)</td>                                #else                                <td>No Date Set</td>                                #end                                <td>                                    #if($kpi.periods && !$kpi.periods.isEmpty())                                    #set($a = $kpi.periods.size() - 1)                                    #set($p = $kpi.periods.get($a))                                    $formatter.formatDate($p.endDate)                                    #else                                    No Periods have been processed                                    #end                                </td>                                #if($kpi.aggregationName)                                <td>$kpi.aggregationName</td>                                #else                                <td>No Aggregation</td>                                #end                                <td>$kpi.period</td>                                #if($kpi.kpi.reward.name)                                <td><a href="/points-buckets/$kpi.kpi.reward.name">$kpi.kpi.reward.title</a></td>                                #else                                <td>No Reward Set</td>                                #end                                <td class="text-center"><input type="checkbox" class="kpi-check" data-kpiid="$kpi.kpi.id" tabindex="$foreach.count"/></td>                            </tr>                            #end                            #end                        </tbody>                    </table>                </div>            </div>            <div class="process-results" style='display:none;'>                <p>                    <strong>Process Status:</strong>                    <strong id='job-status'></strong>                </p>            </div>        </div>        <div id="groups-folders">            <div id="folder-wrapper" class="panel-folder">                #foreach($cat in $page.categories)                #set($seriesInFolder = $page.getChildrenInCategory($cat).ofType("series"))                <div id="$cat.id" class="panel panel-default category">                    <div class="panel-heading" data-toggle="collapse" data-parent="#folder-wrapper" data-target="#cat_${cat.id}">                        <i class="clip-folder"></i>                        <span class="folder-name clickable">$cat.title</span>                        <div class="btn-group btn-group-xs">                            <button data-toggle="dropdown" class="btn btn-sm btn-default btn-squared dropdown-toggle" type="button">                                <span class="caret"></span>                            </button>                            <ul role="menu" class="dropdown-menu">                                <li><a href="$cat.id" data-catname="$cat.title" class="btn-rename-category">Rename this category</a></li>                                <li class="divider"></li>                                <li><a href="$cat.id" data-catname="$cat.title" class="btn-delete-category">Delete this category</a></li>                            </ul>                        </div>                        <div class="panel-tools">                            <div class="btn-series" id="btn-series-$cat.id">                                <a class="btn btn-info btn-sm"><span class="series-count">$seriesInFolder.size()</span> Series </a>                            </div>                        </div>                    </div>                    <div id="cat_${cat.id}" class="collapse">                        <div id="productsTableContainer" class="panel-body">                            <div class="table-responsive">                                <table class="table table-striped table-hover" style='table-layout:fixed'>                                    <colgroup>                                        <col style="width: 50px;"/>                                        <col />                                        <col />                                        <col />                                        <col />                                        <col />                                        <col style="width: 120px;" />                                    </colgroup>                                    <thead>                                        <tr>                                            <th>Status</th>                                            <th>Sales series</th>                                            <th>Group</th>                                            <th>Collection period</th>                                            <th>Attribution</th>                                            <th>No. items</th>                                            <th class="action">Action</th>                                        </tr>                                    </thead>                                    <tbody>                                        #foreach($series in $seriesInFolder)                                        #genRows($series)                                        #end                                    </tbody>                                </table>                            </div>                        </div>                    </div>                </div>                #end            </div>        </div>        <div class="panel panel-default">            <div id="seriesTableContainer" class="panel-body">                <div class="table-responsive">                    <table class="table table-striped table-hover">                        <colgroup>                            <col style="width: 50px;"/>                            <col />                            <col />                            <col />                            <col />                            <col style="width: 120px;" />                        </colgroup>                        <thead>                            <tr class="series-row">                                <th>Status</th>                                <th>Sales series</th>                                <th>Group</th>                                <th>Collection period</th>                                <th>Attribution</th>                                <th>No. items</th>                                <th class="action">Action</th>                            </tr>                        </thead>                        <tbody>                            <!-- tan $page $page.children.ofType $page.children.ofType.series -->                            #foreach($series in $page.children.ofType.series)                            #if(!$series.category)                            #genRows($series)                            #end                            #end                        </tbody>                    </table>                </div>            </div>        </div>        <div id="reloadDiv"></div>        <script type="text/javascript">            $(function () {                var c = {};                $(".series-row").draggable({                    helper: "clone",                    revert: "invalid",                    axis: "y",                    start: function (event, ui) {                        c.helper = ui.helper;                    }                });                $(".category").droppable({                    accept: ".series-row",                    greedy: true,                    drop: function (event, ui) {                        var row = ui.draggable.css({position: "relative", top: "", left: ""});                        var seriesName = row.data("seriesname");                        var categoryID = $(this).attr("id");                        categoryAjax(seriesName, "changeCategory=changeCategory&categoryID=" + categoryID, seriesName, function (name, resp) {                            //window.location.reload();                            $('#reloadDiv').reloadFragment({                                whenComplete: function(newDom){                                    var div = $('<div />').html(newDom);                                    $('.btn-series').each(function(){                                        var id = $(this).attr('id');                                        $(this).html(div.find('#'+id).html());                                    });                                }                            });                        });                        $(this).find("tbody").append(row);                        $(c.helper).remove();                    }                });                $("#seriesTableContainer").droppable({                    accept: ".series-row",                    greedy: true,                    drop: function (event, ui) {                        var row = ui.draggable.css({position: "relative", top: "", left: ""});                        var seriesName = row.data("seriesname");                        categoryAjax(seriesName, "changeCategory=changeCategory", seriesName, function (name, resp) {                            $('#reloadDiv').reloadFragment({                                whenComplete: function(newDom){                                    var div = $('<div />').html(newDom);                                    $('.btn-series').each(function(){                                        var id = $(this).attr('id');                                        $(this).html(div.find('#'+id).html());                                    });                                }                            });                        });                        $(this).find("tbody").append(row);                        $(c.helper).remove();                    }                });                $("body").on('click', '.btn-rename-category', function (e) {                    e.preventDefault();                    var catTitle = $(this).data("catname");                    catID = $(this).attr("href");                    var categoryTitle = prompt("Please enter a category title", catTitle);                    if (categoryTitle != null || categoryTitle != "") {                        categoryAjax(categoryTitle, "updateCategory=updateCategory&categoryTitle=" + categoryTitle + "&categoryID=" + catID, null, function (name, resp) {                            window.location.reload();                        });                    }                });                $("body").on('click', '.btn-delete-category', function (e) {                    e.preventDefault();                    catID = $(this).attr("href");                    var catTitle = $(this).data("catname");                    var categoryTitle = confirm("Are you sure you want to delete " + catTitle);                    if (categoryTitle) {                        categoryAjax(categoryTitle, "deleteCategory=deleteCategory&categoryID=" + catID, null, function (name, resp) {                            window.location.reload();                        });                    }                });                $("body").on('click', '.btn-process-select-kpi', function (e) {                    e.preventDefault();                    $('#processSelectKpis').toggle("show");                });                $("body").on('click', '.btn-process-rewards', function (e) {                    e.preventDefault();                    $('#processKpiRewards').toggle("show");                });                $('body').on('click', '.btn-start-processing', function (e) {                    e.preventDefault();                    flog("Processing All KPI's");                    $(this).closest(".are-you-sure").hide();                    $('#processAllKpis').find('.process-results').show();                    $.ajax({                        type: 'POST',                        url: window.location.pathname,                        data: {                            processAllKPIs: true                        },                        success: function (resp) {                            Msg.info("Processing will start shortly.");                            flog("Success", resp);                            checkProcessStatus();                        },                        error: function (resp) {                            flog('error', resp);                        }                    });                });                $('body').on('click', '.btnAllocateRewards', function (e) {                    e.preventDefault();                    flog("Allocate KPI rewards");                    $(this).closest(".are-you-sure").hide();                    Msg.info("Started processing rewards, please wait...");                    $.ajax({                        type: 'POST',                        url: window.location.pathname,                        data: {                            processAllKPIRewards: true                        },                        success: function (resp) {                            Msg.info("Completed processing rewards");                            flog("Success", resp);                        },                        error: function (resp) {                            flog('error', resp);                            Msg.error("An error occured processing KPI rewards : " + resp);                        }                    });                });                $('body').on('click', '.btn-start-select-processing', function (e) {                    e.preventDefault();                    var listToProcess = [];                    $('body').find(':checkbox.kpi-check:checked').each(function () {                        flog($(this).data("kpiid"));                        listToProcess.push($(this).data("kpiid"));                    });                    if (listToProcess.length > 0 && confirm("Are you sure you want to process " + listToProcess.length + " KPI's?")) {                        $('body').find('.check-all').check(false).change();                        flog(listToProcess.join(','));                        flog("Processing " + listToProcess.length + " KPI's");                        $(this).closest(".are-you-sure").hide("easing");                        $('#selectTable').hide("easing");                        $('#processSelectlKpis').find('.process-results').show("easing");                        $.ajax({                            type: 'POST',                            url: window.location.pathname,                            data: {                                processSelectKPIs: listToProcess.join(',')                            },                            success: function (resp) {                                Msg.info("Processing will start shortly.");                                flog("Success", resp);                                checkProcessStatus();                            },                            error: function (resp) {                                flog('error', resp);                            }                        });                    }                });                $('body').on('click', '.btn-hide-div', function (e) {                    e.preventDefault();                    $('#processSelectKpis').hide("easing");                });                $("body").on('click', '.btn-clear-kpi-history', function (e) {                    e.preventDefault();                    var confirmMsg = confirm("Are you sure you want to delete the history from ALL the KPI's?");                    if (confirmMsg) {                        flog("Clearing All KPI history");                        $.ajax({                            type: 'POST',                            url: window.location.pathname,                            data: {                                clearKPIHistory: true                            },                            success: function (resp) {                                response = JSON.parse(resp)                                flog("Success", response.messages[0]);                                Msg.success(response.messages[0]);                            },                            error: function (resp) {                                flog('error', resp);                                Msg.error("An error occured while clearing KPI history");                            }                        });                    }                });                $("form.referral-settings").forms({                    callback: function () {                        Msg.info("Updated settings")                    }                });                $('body').on('click', '.btn-add-category', function (e) {                    var categoryTitle = prompt("Please enter a category title");                    if (categoryTitle) {                        categoryAjax(categoryTitle, "createCategory=createCategory&categoryTitle=" + categoryTitle, null, function (name, resp) {                            window.location.reload();                        });                    }                });                $('body').on('click', 'a.delete-series', function (e) {                    e.preventDefault();                    var link = $(e.target).closest('a');                    var href = link.attr('href');                    confirmDelete(href, href, function () {                        link.closest('tr').remove();                    });                });                checkProcessStatus();                $('body').on('change', '.check-all', function (e) {                    var checkedStatus = this.checked;                    $('body').find(':checkbox.kpi-check').prop('checked', checkedStatus);                    var selectInt = $('body').find(':checkbox.kpi-check:checked').length;                    flog($(this).is(":checked"), selectInt);                    $('.select-count').text(selectInt)                });                //select-count                $('body').on('change', '.kpi-check', function (e) {                    var checkedStatus = this.checked;                    var selectInt = $('body').find(':checkbox.kpi-check:checked').length;                    flog("Checked", checkedStatus, selectInt);                    $('.select-count').text(selectInt)                });            });            function categoryAjax(name, data, url, callback) {                $.ajax({                    type: 'POST',                    url: window.location.pathname + (url || ""),                    data: data,                    success: function (resp) {                        $('body').trigger('ajaxLoading', {                            loading: false                        });                        if (callback) {                            callback(name, resp);                        }                    },                    error: function (resp) {                        log('error', resp);                        $('body').trigger('ajaxLoading', {                            loading: false                        });                        if (resp.status === 400) {                            alert('Sorry, the category could not be created. Please check if a category with that name already exists');                        } else {                            alert('There was a problem creating the folder');                        }                    }                });            }            function checkProcessStatus() {                flog("checkProcessStatus");                var jobTitle = $(".job-title");                var resultStatus = $('#job-status');                $.ajax({                    type: 'GET',                    dataType: "json",                    url: "/tasks/${page.taskName}",                    success: function (result) {                        flog("success", result);                        flog("Message", result.messages[0]);                        resultStatus.text(result.messages[0]);                        if (result.data) {                            var state = result.data.state;                            flog("state", state);                            if (result.data.statusInfo.complete) {                                // finished                                $('#processSelectKpis').show("easing");                                $('#processSelectKpis').find(".are-you-sure").show("easing");                                $('#selectTable').show("easing")                                $('#processSelectKpis').find('.process-results').hide("easing");                                var dt = result.data.statusInfo.completedDate;                                flog("Process Completed", dt);                                jobTitle.text("Process finished at " + pad2(dt.hours) + ":" + pad2(dt.minutes));                                return; // dont poll again                            } else {                                // running                                $(this).closest(".are-you-sure").hide("easing");                                $('#processSelectKpis').find('.process-results').show("easing");                                $('#selectTable').hide("easing")                                flog("Message", result.messages[0]);                                resultStatus.text(result.messages[0]);                                jobTitle.text("Process running...");                            }                        } else {                            // waiting to start                            jobTitle.text("Waiting for process job to start ...");                        }                        window.setTimeout(checkProcessStatus, 1500);                    },                    error: function (resp) {                        //No job                        $('#processSelectKpis').hide();                    }                });            }        </script>        #macro(genRows $series)        <tr class="series-row" data-seriesname="$series.name">            <td>                #if($series.series.enabled)                <i class="fa fa-check-circle text-success"></i>                #else                <i class="glyphicon glyphicon-pencil text-muted"></i>                #end            </td>            <td><a href='$series.name'>$series.title</a></td>            <td>#if($series.salesGroup) #genGroup($series.salesGroup) #end</td>            <td>$series.period</td>            <td style="align: center">                #if($series.profileAttribution)                <span class="fa fa-user" title="Attributed to a profile"></span>                #else                <span class="fa fa-users" title="Attributed to an organisation"></span>                #end            </td>            <td>$series.numItems</td>            <td class="action">                <div class="btn-group btn-group-sm">                    <a href="$series.name" class="btn btn-sm btn-primary btn-sm"> <i class="fa fa-edit"></i> Edit                    </a>                    <button class="btn btn-sm btn-primary btn-sm dropdown-toggle" data-toggle="dropdown">                        <span class="caret"></span>                    </button>                    <ul class="dropdown-menu pull-right" role="menu">                        <li role="presentation">                            <a role="menuitem" tabindex="-1" href="$series.name" class="delete-series"><i class="fa fa-times"></i> Delete</a>                        </li>                    </ul>                </div>            </td>        </tr>        #end        #macro(genGroup $group)        #set($gc = "label label-info")        #set($gIcon = "")        #if( $group.groupType == "P" || !$group.groupType)        #set($gc = "label label-success")        #set($gIcon = "clip-users")        #elseif( $group.groupType == "S" )        #set($gc = "label label-info")        #set($gIcon = "fa fa-trophy")        #elseif( $group.groupType == "M" )        #set($gc = "label label-info")        #set($gIcon = "fa fa-envelope")        #end        <div class="$gc" style="margin-right: 2.5px; margin-bottom: 5px; display: inline-block;">            <i class="$gIcon"></i>            <span class="block-name" title="$group.name">$group.name</span>        </div>        #end    </body></html>