<html xmlns="http://www.w3.org/1999/xhtml">    <head>        <title>Manage Sales Data Series</title>        <style>            .upload {                position: relative;            }            #do-upload-csv, #do-upload-training-results-csv {                width: 190px;                cursor: pointer;            }            .upload-results {                display: none;            }        </style>    </head>    <body class="">        <form name="frmDetails" action="." method="post" class="form-horizontal series-form">            <div class="pull-right page-action">                <div class="btn-group">                    <button type="submit" role="button" class="btn btn-info btn-sm">Save details</button>                    <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-toggle="dropdown">                        <span class="caret"></span>                    </button>                    <ul class="dropdown-menu" role="menu">                        <li class="presentation" role="menuitem"><a href="#" class="btn-upload-csv">Upload data series CSV</a></li>                        <li class="presentation" role="menuitem"><a role="button" href="records.csv">Open data series CSV</a></li>                    </ul>                </div>                            </div>            <div class="tabbable">                <ul class="nav nav-tabs tab-bricky">                    <li><a data-toggle="tab" href="#general">General</a></li>                    #if( !$page.is("new") )                    <li><a data-toggle="tab" href="#kpis">KPI's</a></li>                    <li><a data-toggle="tab" href="#points">Points</a></li>                    <li><a data-toggle="tab" href="#history">History</a></li>                    #end                </ul>                <div class="tab-content">                    <div id="general" class="tab-pane">                        <div class="form-group">                            <label class="control-label col-md-3" for="title">Title</label>                            <div class="col-md-8">                                <input type="text" name="title" id="title" value="$!page.series.title" placeholder="" class="required form-control"  required="true" />                            </div>                        </div>                        <div class="form-group">                            <label class="control-label col-md-3" for="units">                                Units                                <small>What is the units of the quantity being entered. Eg $ or %</small>                            </label>                            <div class="col-md-4">                                <input type="text" name="units" id="units" value="$!page.series.units" placeholder="" class="required form-control"  required="true" />                                                            </div>                        </div>                                                <div class="form-group">                            <label class="control-label col-md-3" for="salesType">                                Attribution                                <small>Should sales be attributed to the individual or their team</small>                            </label>                            <div class="col-md-4">                                <select name="salesType" id="salesType" class="form-control required"  required="true">                                    <option value="">[None]</option>                                    $formatter.option("SALES_PROFILE", "Individual", $page.series.salesType)                                    $formatter.option("SALES_ORG", "Team / Organisation", $page.series.salesType)                                </select>                                                              </div>                        </div>                                                      <div class="form-group">                            <label class="control-label col-md-3" for="salesType">                                Website                                <small>Select a website to be used for any emails generated from or for this series</small>                            </label>                            <div class="col-md-4">                                <select name="website" id="website" class="form-control">                                    <option value="">[None]</option>                                    #foreach($website in $page.find("/websites").children.ofType.website)                                    $formatter.option($website.name, $website.title, $page.series.website.name)                                    #end                                </select>                                                              </div>                        </div>                                                     <div class="form-group">                            <label class="control-label col-md-3" for="enabled">                                Enabled                                <small>Will only be available if enabled</small>                            </label>                            <div class="col-md-8">                                $formatter.checkbox("enabled", "enabled", $page.series.enabled)<br />                                                            </div>                        </div>                        <div class="form-group">                            <label class="control-label col-md-3" for="salesGroup">                                Group                                <small>The user group to enter sales</small>                            </label>                            <div class="col-md-8">                                <select name="salesGroup" id="salesGroup" class="form-control required"  required="true">                                    <option value="">[None]</option>                                    #foreach($group in $page.organisation.groups)                                    $formatter.option($group.name, $group.name, $page.salesGroupName)                                    #end                                </select>                                                            </div>                        </div>                        <hr/>                        <div class="form-group">                            <div class="col-md-8 col-md-offset-3">                                <i>Select how often you would like users to enter the sales data, or whether to allow information to be collected at any time.</i>                            </div>                        </div>                        <div class="form-group">                            <label class="col-md-3 control-label" for="frequency">Frequency</label>                            <div class="col-md-8">                                <select name="frequency" class="form-control">                                    $formatter.option("", "Anytime", $page.series.frequency)                                     #foreach($f in $page.allFrequencies)                                     $formatter.option($f, $f, $page.series.frequency)                                     #end                                </select>                                                            </div>                        </div>                        <div class="form-group">                            <label class="col-md-3 control-label" for="periodMultiples">Multiples</label>                            <div class="col-md-8">                                <input type="text" name="periodMultiples" value="$!page.series.periodMultiples" placeholder="Eg run every 3 days" class="form-control" />                            </div>                        </div>                        <div class="form-group">                            <label class="control-label col-md-3" for="notes">Notes<small>Shown to users, should explain what is required.</small></label>                            <div class="col-md-8">                                <textarea cols="100" name="notes" id="notes" rows="10" placeholder="" class="form-control">$!page.series.notes</textarea>                            </div>                        </div>                    </div>                    <!-- End content of General tab -->                    <!-- Start KPIs -->                    #if( !$page.is("new") )                    <div id="kpis" class="tab-pane">                        <button data-toggle="modal" data-target="#addKpiModal" class="btn btn-success btn-sm btn-add-kpi"><i class="fa fa-plus"></i> Add new KPI</button>                         <br/>                        <div class='alert alert-info'>                            <p>Use KPI's (Key Performance Indicators) to create achievement levels for this data series. For example, for sales people you might have                                levels corresponding to sales targets. You can choose to allocate reward points for achieving levels.</p>                        </div>                        <table class='table table-bordered table-striped'>                            <thead>                                <th>Title</th>                            </thead>                            <tbody id='kpis-table-body'>                                #set( $kpis = $page.child("kpis").children.ofType.kpi )                                #if( $kpis.isEmpty() )                                <tr>                                    <td>No KPI's have been defined for this data series</td>                                </tr>                                #else                                #foreach($kpi in $kpis)                                <tr>                                    <td>$kpi.link</td>                                </tr>                                #end                                #end                            </tbody>                        </table>                    </div>                    #end                    <!-- End KPIs -->                    <!-- Start Points Allocation Sources -->                    #if( !$page.is("new") )                    <div id="points" class="tab-pane">                        <div class='alert alert-info'>                            <p>Use point allocation sources to award reward points based on the values of the data series. For example you can                                choose to award 1 point for each dollar in sales.</p>                        </div>                        <button data-toggle="modal" data-target="#addSourceModal" class="btn btn-success btn-sm btn-add-kpi"><i class="fa fa-plus"></i> Add new points allocation</button>                         <hr/>                                                <table class='table table-bordered table-striped'>                            <thead>                                <th>Points allocation rules</th>                            </thead>                            <tbody id='sources-table-body'>                                #set( $sources = $page.child("sources").children.ofType.source )                                #if( $sources.isEmpty() )                                <tr>                                    <td>No points sources have been defined for this data series</td>                                </tr>                                #else                                #foreach($source in $sources)                                <tr>                                    <td>$source.link</td>                                </tr>                                #end                                #end                            </tbody>                        </table>                    </div>                    #end                    <!-- End Points Allocation Sources -->                    <!-- Start content of History tab -->                    <div id="history" class="tab-pane">                        <div class="input-group date-range col-md-6">                            <label for="report-range" class="input-group-addon">Time</label>                            <input type="text" id="report-range" placeholder="Choose a date range" value="" class="form-control" />                        </div>                                             <button type="button" class="btn-remove-history btn btn-danger btn-sm pull-right">Remove</button>                        <button type="button" class="refresh-history btn btn-success btn-sm pull-right" style="margin-right: 5px">Refresh</button>                        <div class="clearfix"></div>                        <hr/>                        <p class="lead-text">This shows records which have been entered during the filter period</p>                        <div class="table-responsive" id="history-table">                            <table class="table table-striped table-hover">                                <thead>                                    <tr>                                        <th>Amount</th>                                        <th>Sales by</th>                                        <th>Entered</th>                                                                                <th>By</th>                                        <th colspan="2">Sales Period</th>                                        <th><input type="checkbox" name="toRemoveId" class="chk-all" /></th>                                    </tr>                                </thead>                                <tbody id="history-table-body">                                    #foreach($item in $page.history)                                    <tr>                                        <td>$item.amount</td>                                        <td>                                            <!-- either a profilebean or orgdata -->                                            #if( $item.salesBy.name ) <!-- is individual -->                                            <a href="/manageUsers/$item.salesBy.userId">$item.salesBy.name</a>                                            #else                                            <a href="/manageOrgs/$item.salesBy.orgId">$item.salesBy.title</a>                                            #end                                        </td>                                        <td>                                            <abbr title="$formatter.formatDateISO8601($item.enteredDate)" class="timeago">$!item.enteredDate</abbr>                                        </td>                                        <td><a href="/manageUsers/$item.enteredBy.userId">$item.enteredBy.name</a></td>                                        <td>$formatter.formatDate($item.periodFrom)</td>                                        <td>$formatter.formatDate($item.periodTo)</td>                                        <td><input type="checkbox" name="toRemoveId" value="$item.id" /></td>                                                                        </tr>                                    #end                                </tbody>                            </table>                        </div>                    </div>                    <!-- End content of History tab -->                </div>            </div>        </form>        <div id="addKpiModal" class="modal fade" tabindex="-1" data-focus-on="input:first" role="dialog" aria-hidden="true">            <div class="modal-header">                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>                <h4 class="modal-title">Add KPI</h4>            </div>            <div class="modal-body">                <p>KPI's allow you to categorise performance in levels, and then take action based on what levels are achieved.</p>                <p>For example,                    you might have a data series "Customer Service Index" which you would add a KPI for, and reward users who achieve 95-100%</p>                <p>You can have multiple KPI's for a data series, but you will usually only have one.</p>                <div class='alert alert-info'>Enter a descriptive title for the KPI below. You can then add levels and actions for each level.</div>                <form action="." method="POST" class="form-horizontal">                          <div class="form-group">                        <label class="col-md-3 control-label" for="websiteName">Title</label>                        <div class="col-md-8">                            <input type='text' name="newKpiTitle" class="form-control"/>                        </div>                    </div>                </form>            </div>            <div class="modal-footer">                <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>                <button type="button" class="btn btn-sm btn-primary" data-type="form-submit">Create KPI</button>            </div>        </div>        <div id="addSourceModal" class="modal fade" tabindex="-1" data-focus-on="input:first" role="dialog" aria-hidden="true">            <div class="modal-header">                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>                <h4 class="modal-title">Add Points Allocation Source</h4>            </div>            <div class="modal-body">                <form action="." method="POST" class="form-horizontal">                          <div class="form-group">                        <label class="col-md-3 control-label" for="websiteName">Title</label>                        <div class="col-md-8">                            <input type='text' name="newSourceTitle" class="form-control"/>                        </div>                    </div>                    <div class="form-group">                        <label class="col-md-3 control-label" for="websiteName">Reward program</label>                        <div class="col-md-8">                            <select name="reward" id="reward" class="form-control" >                                <option value="">[No points]</option>                                #foreach($reward in $page.rewards)                                $formatter.option($reward.name, $reward.name, $page.kpi.reward.name)                                #end                            </select>                                                       </div>                    </div>                </form>            </div>            <div class="modal-footer">                <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>                <button type="button" class="btn btn-sm btn-primary" data-type="form-submit">Create allocation source</button>            </div>        </div>        <div id="modal-upload-csv" class="modal modal-lg fade" aria-hidden="true" tabindex="-1">            <div class="modal-header">                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>                <h4 class="modal-title">Upload Users CSV</h4>            </div>            <div class="modal-body">                <div class="upload">                    <div class="btn-upload" id='do-upload-csv'></div>                    <br />                    <!--                    <div class="allow-inserts">                        <input type="checkbox" id="allow-inserts" /> <label for="allow-inserts">Allow inserts</label>                    </div>                    -->                </div>                <br />                <div class="upload-results">                    <p>                        <strong>No. inserted:</strong>                         <span class="badge badge-success num-inserted">-</span>                         <strong>No. updated:</strong>                         <span class="badge badge-success num-updated">-</span>                         <strong>Unmatched rows:</strong>                         <span class="badge badge-danger num-unmatched">-</span>                    </p>                    <div class="table-responsive">                        <table class="table table-striped table-hover table-condensed">                            <tbody>                                <tr>                                    <td></td>                                </tr>                            </tbody>                        </table>                    </div>                </div>            </div>            <div class="modal-footer">                <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>            </div>        </div>                <script type="text/javascript" src="/static/js/jquery.milton-upload.js"></script>        <script type="text/javascript">            $(function () {                flog("timeago", $(".timeago"));                $(".timeago").timeago();                $("form.series-form").forms({                    callback: function (resp) {                        if (resp.status) {                            Msg.info("Saved ok");                            if (resp.nextHref) {                                window.location = "../" + resp.nextHref;                            }                        } else {                            Msg.error("An error occured saving: " + resp);                        }                    }                });                initHistorySearch();                initRemoveSalesData();                initSelectAll();                initUploads();                $("#addKpiModal").find("form").forms({                    callback: function (resp, form) {                        flog("form", form);                        form.find("input").val("");                        $("#kpis-table-body").reloadFragment();                        $("#addKpiModal").modal("hide");                    }                });                $("#addSourceModal").find("form").forms({                    callback: function (resp, form) {                        form.find("input, select").val("");                        $("#sources-table-body").reloadFragment();                        $("#addSourceModal").modal("hide");                    }                });            });            function initHistorySearch() {                var reportRange = $('#report-range');                reportRange.exist(function () {                    flog("init report range");                    reportRange.daterangepicker({                        format: 'DD/MM/YYYY', // YYYY-MM-DD                        ranges: {                            'Last 7 Days': [moment().subtract('days', 6), moment()],                            'Last 30 Days': [moment().subtract('days', 29), moment()],                            'This Month': [moment().startOf('month'), moment().endOf('month')],                            'Last Month': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')],                            'This Year': [moment().startOf('year'), moment()],                        },                    },                            function (start, end) {                                flog('onChange', start, end);                                doHistorySearch(start, end);                            }                    );                });            }            function initRemoveSalesData() {                $(".btn-remove-history").click(function (e) {                    var node = $(e.target);                    flog("initRemoveSalesData", node, node.is(":checked"));                    var checkBoxes = $('#table-users').find('tbody input[name=toRemoveId]:checked');                    if (checkBoxes.length == 0) {                        Msg.error("Please select the sales data you want to remove by clicking the checkboxs to the right");                    } else {                        if (confirm("Are you sure you want to remove " + checkBoxes.length + " sales data?")) {                            doRemoveSalesData(checkBoxes);                        }                    }                });            }            function doRemoveSalesData(checkBoxes) {                $.ajax({                    type: 'POST',                    data: checkBoxes,                    dataType: "json",                    url: "",                    success: function (data) {                        flog("success", data);                        if (data.status) {                            $("#history-table").reloadFragment();                            Msg.success("Removed sales data ok");                        } else {                            Msg.error("There was a problem removing sales data. Please try again and contact the administrator if you still have problems");                        }                    },                    error: function (resp) {                        Msg.error("An error occurred removing sales data. You might not have permission to do this");                    }                });            }            function doHistorySearch(startDate, endDate) {                flog('doHistorySearch', startDate, endDate);                var data = {                    startDate: formatDate(startDate),                    finishDate: formatDate(endDate)                };                flog("data", data);                var target = $("#history-table-body");                target.load();                $.ajax({                    type: "GET",                    url: window.location.pathname,                    dataType: 'html',                    data: data,                    success: function (content) {                        flog('response', content);                        var newBody = $(content).find("#history-table-body");                        target.replaceWith(newBody);                        $("abbr.timeago").timeago();                        flog("done insert and timeago", $("abbr.timeago"));                    }                });            }            function initUploads() {                var modalUploadCsv = $("#modal-upload-csv");                $(".btn-upload-csv").click(function (e) {                    e.preventDefault();                    modalUploadCsv.modal('show');                });                var resultUploadCsv = modalUploadCsv.find('.upload-results');                $("#do-upload-csv").mupload({                    buttonText: "<i class=\"clip-folder\"></i> Upload spreadsheet",                    url: "records.csv",                    useJsonPut: false,                    oncomplete: function (data, name, href) {                        flog("oncomplete:", data.result.data, name, href);                        resultUploadCsv.find('.num-updated').text(data.result.data.numUpdated);                        resultUploadCsv.find('.num-inserted').text(data.result.data.numInserted);                        resultUploadCsv.find('.num-unmatched').text(data.result.data.unmatched.length);                        showUnmatched(resultUploadCsv, data.result.data.unmatched);                        resultUploadCsv.show();                        Msg.success("Upload completed. Please review any unmatched members below, or refresh the page to see the updated list of members");                    }                });            }            function showUnmatched(resultUploadCsv, unmatched) {                var unmatchedTable = resultUploadCsv.find("table");                var tbody = unmatchedTable.find("tbody");                tbody.html("");                $.each(unmatched, function (i, row) {                    flog("unmatched", row);                    var tr = $("<tr>");                    $.each(row, function (ii, field) {                        tr.append("<td>" + field + "</td>");                    });                    tbody.append(tr);                });            }        </script>    </body></html>