<html xmlns="http://www.w3.org/1999/xhtml">    <head>        <title>Manage Sales Data Series</title>        <style>            .DateTimeIcon {                display: none;            }                    </style>            </head>    <body class="">        <form name="frmDetails" action="." method="post" class="form-horizontal kpi-form">            <div class="pull-right page-action">                <button class="btn btn-sm btn-danger kpi-process" type="button">                    <span class="glyphicon glyphicon-signal"></span>                    Process KPIs                </button>                <button class="btn btn-sm btn-danger kpi-rewards" type="button">                    <span class="fa fa-dollar"></span>                    Allocate rewards                </button>                <button class="btn btn-sm btn-primary" type="submit">Save changes</button>            </div>            <div class="tabbable">                <ul class="nav nav-tabs tab-bricky">                    <li><a data-toggle="tab" href="#general">General</a></li>                    <li><a data-toggle="tab" href="#levels">Levels</a></li>                    <li><a data-toggle="tab" href="#history">History</a></li>                    <li><a data-toggle="tab" href="#results">Results</a></li>                </ul>                <div class="tab-content">                    <div id="general" class="tab-pane">                        <div class="form-group">                            <label class="control-label col-md-3" for="title">Title</label>                            <div class="col-md-8">                                <input type="text" name="title" id="title" value="$!page.kpi.title" placeholder="" class="required form-control"  required="true" />                            </div>                        </div>                        <div class="form-group">                            <label class="control-label col-md-3" for="reward">                                Reward                                <small>Allocate points to this reward</small>                            </label>                            <div class="col-md-8">                                <select name="reward" id="reward" class="form-control" >                                    <option value="">[No points]</option>                                    #foreach($reward in $page.rewards)                                    $formatter.option($reward.name, $reward.name, $page.kpi.reward.name)                                    #end                                </select>                                <p><small>To allocate points for achieving levels, select the reward here</small></p>                            </div>                        </div>                        <div class="form-group">                            <label class="control-label col-md-3" for="aggregation">                                Aggregation                                <small>How should values be merged over the KPI period</small>                            </label>                            <div class="col-md-8">                                <select name="aggregation" id="aggregation" class="form-control required" required="true" >                                    <option value="">[Not selected]</option>                                    #foreach($agg in $page.aggregationTypes.entrySet() )                                    $formatter.option($agg.key, $agg.value, $page.kpi.aggregation)                                    #end                                </select>                                                            </div>                        </div>                        <div class="form-group">                            <label class="control-label col-md-3" for="notes">                                Aggregation period                                <small>Over what period should criteria be assessed?</small></label>                            <div class="col-md-3 col-sm-4 col-xs-12">                                <div class="input-group pull-left">                                    <input type="text" class="text-center form-control" value="$!page.kpi.periodMultiples" name="periodMultiples" />                                    <div class="input-group-btn">                                        <button data-toggle="dropdown" class="btn btn-default dropdown-toggle timer-unit" type="button">$!page.kpi.frequency <span class="caret"></span></button>                                        <ul role="menu" class="dropdown-menu pull-right timer-units">                                            #foreach($unit in $page.allFrequencies)                                            <li><a href="#">$unit</a></li>                                            #end                                                                                                    </ul>                                    </div>                                           <input type="hidden" name="timerUnitName" class="timer-unit" value="$!page.job.frequency"/>                                </div>                            </div>                        </div>                        <div class="form-group">                            <label class="control-label col-md-3" for="aggregation">                                Start date                                <small>Date of the first assessment period</small>                            </label>                            <div class="col-md-8">                                <div class="col-sm-5">                                    <div class="input-group">                                        <input type="text" name="startDate" placeholder="Start date" data-format="DD/MM/YYYY" value="$!page.startDate" class="form-control DateTime" />                                        <span class="input-group-addon"> <i class="fa fa-calendar"></i> </span>                                    </div>                                </div>                            </div>                        </div>                                                <div class="form-group">                            <label class="control-label col-md-3" for="notes">Notes<small>For internal use.</small></label>                            <div class="col-md-8">                                <textarea cols="100" name="notes" id="notes" rows="10" placeholder="" class="form-control">$!page.kpi.notes</textarea>                            </div>                        </div>                    </div>                    <!-- End content of General tab -->                    <!-- levels -->                    <div id="levels" class="tab-pane">                        <div class="alert alert-info">                            <p>Create levels for this data series to reward your users when they achieve certain threshholds.</p>                        </div>                        <div>                            <button data-toggle="modal" data-target="#addLevelModal" class="btn btn-success btn-sm btn-add-level"><i class="fa fa-plus"></i> Add new Level</button>                         </div>                        <table class="table table-bordered table-striped">                            <colgroup>                                <col />                                <col />                                <col style="width: 100px" />                            </colgroup>                            <thead>                                <tr>                                    <th>Threshold</th>                                    <th>Reward points</th>                                </tr>                            </thead>                            <tbody id="levels-table-body">                                #if( $page.kpi.levels.size() > 0 )                                #foreach( $level in $page.kpi.levels )                                <tr>                                    <td>$level.minorBound</td>                                    <td>$level.awardAmount</td>                                    <td>                                        <a title="Remove this role" href="$level.id" class="btn btn-xs btn-danger btn-remove-level"><i class="glyphicon glyphicon-remove "></i></a>                                    </td>                                </tr>                                #end                                #else                                <tr>                                    <td colspan="3">There are no KPI levels defined yet</td>                                </tr>                                #end                                                            </tbody>                        </table>                    </div>                    <!-- end levels -->                    <div id="history" class="tab-pane">                        <div class="pull-right">                            <button type="button" class="btn btn-sm btn-default periods-delete">                                <span class="glyphicon glyphicon-remove"></span>                                Delete                            </button>                        </div>                        <br/>                        <p>Shows KPI periods which have been processed</p>                        <table class="table table-bordered table-striped" id="table-periods">                            <colgroup>                                <col width="" />                                <col width="" />                                <col width="" />                                <col data-sort="false" width="30px" />                            </colgroup>                                                        <thead>                                <tr>                                    <th>Start</th>                                    <th>End</th>                                    <th>Processed date</th>                                    <th><input type="checkbox" name="deletePeriodId" class="chk-all" /></th>                                </tr>                            </thead>                            <tbody>                                #foreach($period in $page.periods)                                <tr>                                    <td>$period.startDate</td>                                    <td>$period.endDate</td>                                    <td>$period.createdDate</td>                                    <td>                                        <input type="checkbox" name="deletePeriodId" value="$period.id"/>                                    </td>                                </tr>                                #end                            </tbody>                        </table>                    </div>                    <div id="results" class="tab-pane">                        <p>Review participants assessed results</p>                        <table class="table table-bordered table-striped">                            <thead>                                <tr>                                    <th>Start</th>                                    <th>End</th>                                    <th>Processed date</th>                                </tr>                            </thead>                            <tbody>                                #foreach($result in $page.results)                                <tr>                                    <td>$result.period.startDate</td>                                                                        <td>$!result.level.minorBound</td>                                    <td>$result.participant.name</td>                                </tr>                                #end                            </tbody>                        </table>                    </div>                </div>            </div>        </form>        <div id="addLevelModal" class="modal fade" tabindex="-1" data-focus-on="input:first" role="dialog" aria-hidden="true">            <div class="modal-header">                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>                <h4 class="modal-title">Add KPI Level</h4>            </div>            <div class="modal-body">                <p>                    Choose a threshhold level at which your users have reached this level. You can also specify how                    many points to award                </p>                <form action="$page.href" method="POST" class="form-horizontal">                          <div class="form-group">                        <label class="col-md-3 control-label" for="newLevelAmount">Level</label>                        <div class="col-md-8">                            <input type='text' name="newLevelAmount" class="form-control required" required="true" />                        </div>                    </div>                    <div class="form-group">                        <label class="col-md-3 control-label" for="newRewardPoints">Reward points</label>                        <div class="col-md-8">                            <input type='text' name="newRewardPoints" class="form-control"/>                        </div>                    </div>                </form>            </div>            <div class="modal-footer">                <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>                <button type="button" class="btn btn-sm btn-primary" data-type="form-submit">Create level</button>            </div>        </div>                <script type="text/javascript">            $(function () {                $(".timeago").timeago();                $(".timer-units li").click(function (e) {                    e.preventDefault();                    var unit = $(e.target).text();                    $(".timer-unit").text(unit).val(unit);                });                $("form.kpi-form").forms({                    callback: function (resp) {                        if (resp.status) {                            Msg.info("Saved ok");                        } else {                            Msg.error("An error occured saving: " + resp);                        }                    }                });                $(".kpi-process").click(function (e) {                    e.preventDefault();                    if( confirm("This will generate assessed levels for each un-processed period. Are you sure you want to continue?") ) {                        submitProcess("processKpis");                    }                });                $(".kpi-rewards").click(function (e) {                    e.preventDefault();                    if( confirm("This will allocate rewards based on KPI achievements for results which have not already had rewards processing. Would you like to continue?") ) {                        submitProcess("processRewards");                    }                });                var addLevelModal = $("#addLevelModal");                addLevelModal.find("form").forms({                    callback: function (resp) {                        if (resp.status) {                            Msg.info("Added new level");                            $("#levels-table-body").reloadFragment();                            addLevelModal.find("input").val("");                            addLevelModal.modal("hide");                        } else {                            Msg.error("An error occured saving: " + resp);                        }                    }                });                flog("levels", $("#levels-table-body .btn-remove-level"));                $("#levels-table-body").on("click", ".btn-remove-level", function (e) {                    e.preventDefault();                    if (confirm("Are you sure you want to delete this level?")) {                        var id = $(e.target).closest("a").attr("href");                        doDeleteLevel(id);                    }                });                                initRemovePeriods();            });            function doDeleteLevel(id) {                flog("delete", id);                $.ajax({                    type: 'POST',                    data: {                        deleteLevelId: id                    },                    dataType: "json",                    url: window.location.pathname,                    success: function (data) {                        if (data.status) {                            Msg.success("Removed ok");                            $("#levels-table-body").reloadFragment();                        } else {                            Msg.error("There was a problem removing the level. Please try again and contact the administrator if you still have problems");                        }                    },                    error: function (resp) {                        Msg.error("There was a problem removing the level. Please try again and contact the administrator if you still have problems");                    }                });            }            function submitProcess(processName) {                flog("submitProcess", processName);                $.ajax({                    type: 'POST',                    data: {                        process: processName                    },                    dataType: "json",                    url: window.location.pathname,                    success: function (data) {                        if (data.status) {                            Msg.success("Submitted for processing");                        } else {                            Msg.error("Could not start processing: " + data.messages);                        }                    },                    error: function (resp) {                        Msg.error("There was a problem submitting the process. Please try again and contact the administrator if you still have problems");                    }                });            }            function initRemovePeriods() {                $(".periods-delete").click(function (e) {                    var node = $(e.target);                    flog("initRemovePeriods", $("#periods-table"));                    var checkBoxes = $("#table-periods").find('tbody input[name=deletePeriodId]:checked');                    if (checkBoxes.length === 0) {                        Msg.error("Please select the periods you want to remove by clicking the checkboxs to the right");                    } else {                        if (confirm("Are you sure you want to remove " + checkBoxes.length + " periods?")) {                            doRemovePeriods(checkBoxes);                        }                    }                });            }            function doRemovePeriods(checkBoxes) {                $.ajax({                    type: 'POST',                    data: checkBoxes,                    dataType: "json",                    url: window.location.pathname,                    success: function (data) {                        flog("success", data);                        if (data.status) {                            $("#table-periods").reloadFragment();                            Msg.success("Removed periods ok");                        } else {                            Msg.error("There was a problem removing periods. Please try again and contact the administrator if you still have problems");                        }                    },                    error: function (resp) {                        Msg.error("An error occurred removing periods. You might not have permission to do this");                    }                });            }        </script>    </body></html>