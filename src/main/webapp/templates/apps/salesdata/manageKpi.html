<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Manage Sales Data Series</title>
        <style>
            .DateTimeIcon {
                display: none;
            }
            .upload-results {
                display: none;
            }
        </style>
    </head>
    <body class="">

        <form name="frmDetails" action="." method="post" class="form-horizontal kpi-form">
            <div class="pull-right page-action">
                <button class="btn btn-sm btn-danger kpi-process" type="button">
                    <span class="glyphicon glyphicon-signal"></span>
                    Process KPIs
                </button>
                <button class="btn btn-sm btn-danger kpi-rewards" type="button">
                    <span class="fa fa-dollar"></span>
                    Allocate rewards
                </button>
                <button class="btn btn-sm btn-success" type="submit">
                    <span class="fa fa-save"></span>
                    Save changes
                </button>
            </div>

            <div class="tabbable">
                <ul class="nav nav-tabs tab-bricky">
                    <li><a data-toggle="tab" href="#general">General</a></li>
                    <li><a data-toggle="tab" href="#groups">Groups</a></li>
                    <li><a data-toggle="tab" href="#levels">Rewards & Levels</a></li>
                    <li><a data-toggle="tab" href="#criteria">Criteria</a></li>
                    <li><a data-toggle="tab" href="#notes">Notes</a></li>
                    <li><a data-toggle="tab" href="#history">History</a></li>
                    <li><a data-toggle="tab" href="#results">Results</a></li>
                    <li><a data-toggle="tab" href="#query">Query</a></li>
                    <li><a data-toggle="tab" href="#leaderboard">Leaderboard</a></li>
                </ul>
                <div class="tab-content">
                    <div id="general" class="tab-pane">
                        <div class="form-group">
                            <label class="control-label col-md-3" for="title">Name</label>
                            <div class="col-md-8">
                                <input type="text" name="name" id="name" value="$!page.kpi.name" placeholder="" class="required form-control"  required="true" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3" for="title">Title</label>
                            <div class="col-md-8">
                                <input type="text" name="title" id="title" value="$!page.kpi.title" placeholder="" class="required form-control"  required="true" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-3" for="aggregation">
                                Aggregation
                                <small>How should values be merged over the KPI period</small>
                            </label>
                            <div class="col-md-8">
                                <select name="aggregation" id="aggregation" class="form-control required" required="true" >
                                    <option value="">[Not selected]</option>
                                    #foreach($agg in $page.aggregationTypes.entrySet() )
                                    $formatter.option($agg.key, $agg.value, $page.kpi.aggregation)
                                    #end
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-3" for="notes">
                                Aggregation period
                                <small>Over what period should criteria be assessed?</small></label>
                            <div class="col-md-3 col-sm-4 col-xs-12">
                                <div class="input-group pull-left">
                                    <input type="text" class="text-center form-control" value="$!page.kpi.periodMultiples" name="periodMultiples" />
                                    <div class="input-group-btn">
                                        <button data-toggle="dropdown" class="btn btn-default dropdown-toggle timer-unit" type="button">$!page.kpi.frequency <span class="caret"></span></button>
                                        <ul role="menu" class="dropdown-menu pull-right timer-units">
                                            #foreach($unit in $page.allFrequencies)
                                            <li><a href="#">$unit</a></li>
                                            #end
                                        </ul>
                                    </div>
                                    <input type="hidden" name="frequency" class="timer-unit" value="$!page.kpi.frequency"/>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-3" for="searchUp">
                                Search Up
                                <small>Select true for data where more is better (ie sales), and select false when less is better (ie num complaints)</small>
                            </label>
                            <div class="col-md-8">
                                <select name="searchUp" id="searchUp" class="form-control required" >
                                    $formatter.option("false", "No - search down because less is better", $page.searchUp)
                                    $formatter.option("true", "Yes - search up because more is better", $page.searchUp)
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-3" for="orderingField">
                                Ordering
                                <small>In what order should the KPI's be listed</small>
                            </label>
                            <div class="col-md-8">
                                <input type="text" name="orderingField" placeholder="Ordering" value="$!page.orderingField" class="form-control numeric" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-3" for="aggregation">
                                Start date
                                <small>Date of the first assessment period</small>
                            </label>
                            <div class="col-md-8">
                                <div class="col-sm-5">
                                    <div class="input-group">
                                        <input type="text" name="startDate" placeholder="Start date" data-format="DD/MM/YYYY" value="$formatter.formatDate($!page.kpi.startDate)" class="form-control DateTime" />
                                        <span class="input-group-addon"> <i class="fa fa-calendar"></i> </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End content of General tab -->
                    <div id="groups" class="tab-pane">  <!-- groups -->
                        <div class="alert alert-info">
                            <p>The KPI will only users who belong to ALL of the selected groups</p>
                        </div>
                        <table class="">
                            #foreach($g in $page.allGroups)
                            <tr>
                                <td>
                                    <div class="col-sm-offset-3">
                                        <label class="checkbox-inline">
                                            $formatter.checkbox("appliesToGroupIds", "appliesToGroupIds", $page.isSelected($g), $g.id ) $g.name
                                        </label>
                                    </div>
                                </td>
                            </tr>
                            #end
                        </table>
                    </div> <!-- end groups -->

                    <div id="notes" class="tab-pane">  <!-- notes -->
                        <small>For internal use.</small>
                        <textarea cols="100" name="notes" id="notes" rows="20" placeholder="" class="form-control">$!page.kpi.notes</textarea>
                    </div> <!-- end notes -->

                    <div id="criteria" class="tab-pane">  <!-- criteria -->
                        <small>Advanced: additional criteria rules as XML</small>
                        <textarea cols="100" name="extraCriteria" id="extraCriteria" rows="20" placeholder="" class="form-control">$!page.kpi.extraCriteria</textarea>
                    </div> <!-- end criteria -->

                    <div id="levels" class="tab-pane"> <!-- levels -->
                        <div class="form-group">
                            <label class="control-label col-md-3" for="reward">
                                Reward
                            </label>
                            <div class="col-md-8">
                                <select name="reward" id="reward" class="form-control" >
                                    <option value="">[No points]</option>
                                    #foreach($reward in $page.rewards)
                                    $formatter.option($reward.name, $reward.title, $page.kpi.reward.name)
                                    #end
                                </select>
                                <p><small>To allocate points for achieving levels, select the reward here</small></p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-3" for="pointsTag">
                                Tag
                                <small>Tag the allocated points</small>
                            </label>
                            <div class="col-md-8">
                                <select name="pointsTag" id="pointsTag" class="form-control" >
                                    <option value="">[No tag]</option>
                                    #foreach($tag in $page.pointsTag)
                                    $formatter.option($tag.name, $tag.title, $page.kpi.pointsTag.name)
                                    #end
                                </select>
                                <p><small>To tag the allocated points, select a tag here</small></p>
                            </div>
                        </div>

                        <div class="well">
                            <div class="form-group">
                                <label class="control-label col-md-3" for="reward">
                                    Top achievers
                                    <small>Allocate points to the top achievers in this KPI</small>
                                </label>
                                <div class="col-md-8">
                                    <input type="text" name="numTopAchievers" id="numTopAchievers" value="$!page.kpi.numTopAchievers" placeholder="How many of the top achievers" class="form-control"  />
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="control-label col-md-3" for="reward">
                                    Points
                                    <small>MVEL expression for how many points to award top achievers</small>
                                </label>
                                <div class="col-md-8">
                                    <input type="text" name="topAchieverPointsExpr" id="topAchieverPointsExpr" value="$!page.kpi.topAchieverPointsExpr" placeholder="A number or expression for the number of points to award" class="form-control"  />
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <p>Create levels for this data series to reward your users when they achieve certain threshholds.</p>
                        </div>

                        <div>
                            <div class="btn-group btn-group-sm">
                                <a href="#"  class="btn btn-sm btn-success btn-sm btn-add-level">
                                    <i class="fa fa-plus"></i> Add new Level
                                </a>
                                <button class="btn btn-sm btn-success btn-sm dropdown-toggle" data-toggle="dropdown">
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu pull-right" role="menu">
                                    <li><a href="#" title="importCSV" id="uploadKpiCsv"><i class="glyphicon glyphicon-upload"></i> Upload CSV</a></li>
                                    <li class="divider"></li>
                                    <li><a href="kpiLevels.csv" title="exportCSV"><i class="glyphicon glyphicon-download"></i> Export CSV</a></li>
                                </ul>
                            </div>
                        </div>
                        <hr/>
                        <table class="table table-bordered table-striped">
                            <colgroup>
                                <col />
                                <col />
                                <col />
                                <col />
                                <col style="width: 120px" />
                            </colgroup>
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Title</td>
                                    <th>Threshold</th>
                                    <th>Reward points</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="levels-table-body">
                                #if( $page.kpi.levels.size() > 0 )
                                #foreach( $level in $page.kpi.levels)
                                <tr id="level-${level.id}">
                                    <td>$level.name</td>
                                    <td>$level.title</td>
                                    <td>
                                        #if($level.minorBoundFromSeries)
                                        #if($level.minorBound)
                                        <b>$level.minorBound%</b> of
                                        participants value in <b><a href="../../../$level.minorBoundFromSeries.name">$level.minorBoundFromSeries.title</a></b>
                                        #else
                                        Find Participants value in <b><a href="../../../$level.minorBoundFromSeries.name">$level.minorBoundFromSeries.title</a></b>
                                        #end

                                        #elseif($level.minorBound)
                                        $level.minorBound
                                        #else
                                        <span class="label label-danger">No threshhold set</span>
                                        #end
                                    </td>
                                    <td>
                                        $!level.awardAmount
                                        $!level.awardAmountExpr
                                    </td>
                                    <td class="action">
                                        <div class="btn-group btn-group-sm">
                                            <a href="$level.id .edit-form" class="btn btn-sm btn-info btn-edit-level" data-toggle="modal" data-target="#editLevelModal"  ><i class="fa fa-cog"></i> Edit</a>
                                            <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-toggle="dropdown">
                                                <span class="caret"></span>
                                                <span class="sr-only">Toggle Dropdown</span>
                                            </button>
                                            <ul role="menu" class="dropdown-menu pull-right">
                                                <li><a class="btn-remove-level" href="$level.id"><i class="glyphicon glyphicon-remove"></i> Delete</a></li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                #end
                                #else
                                <tr>
                                    <td colspan="3">There are no KPI levels defined yet</td>
                                </tr>
                                #end
                            </tbody>
                        </table>
                    </div>
                    <!-- end levels -->


                    <div id="history" class="tab-pane">

                        <div class="pull-right">
                            <button type="button" class="btn btn-sm btn-default periods-delete">
                                <span class="glyphicon glyphicon-remove"></span>
                                Delete
                            </button>
                        </div>
                        <br/>

                        <p>Shows KPI periods which have been processed</p>

                        <table class="table table-bordered table-striped" id="table-periods">
                            <colgroup>
                                <col width="" />
                                <col width="" />
                                <col width="" />
                                <col width="" />
                                <col data-sort="false" width="30px" />
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>Start</th>
                                    <th>End</th>
                                    <th>Processed date</th>
                                    <th>Rewards issued date</th>
                                    <th><input type="checkbox" name="deletePeriodId" class="chk-all" /></th>
                                </tr>
                            </thead>
                            <tbody>
                                #foreach($period in $page.periods)
                                <tr>
                                    <td>$period.startDate</td>
                                    <td>$period.endDate</td>
                                    <td>$period.createdDate</td>
                                    <td>
                                        #if( $period.rewardsIssuedDate )
                                        $period.rewardsIssuedDate
                                        #else
                                        <span class="label label-danger">Rewards not issued</span>
                                        #end
                                    </td>
                                    <td>
                                        <input type="checkbox" class="deletePeriodId" value="$period.id"/>
                                    </td>
                                </tr>
                                #end
                            </tbody>
                        </table>
                    </div>

                    <div id="results" class="tab-pane">
                        <p>Review the assessed results for participants</p>
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Period start</th>
                                    <th>Achievement Level</th>
                                    <th>Achievement Amount</th>
                                    <th>Points Awarded</th>
                                    <th>Participant</th>
                                </tr>
                            </thead>
                            <tbody>
                                #foreach($result in $page.results)
                                <tr>
                                    <td>$result.period.startDate</td>
                                    <td>$!result.level.title</td>
                                    <td>$!result.amount</td>
                                    <td>$!result.awardedPoints</td>
                                    <td>$result.participant.name</td>
                                </tr>
                                #end
                            </tbody>
                        </table>
                    </div>
                    <div id="query" class="tab-pane">
                        <p>Query for progress results for a participant for a given date period</p>

                        <div class="input-group date-range col-md-4 pull-left">
                            <label for="report-range" class="input-group-addon">Time</label>
                            <input type="text" id="report-range" placeholder="Choose a date range" value="" class="form-control" />
                        </div>

                        <div class="input-group col-md-4">
                            <label for="data-query" class="input-group-addon">Search</label>
                            <input type="text" id="data-query" placeholder="Search" value="" class="form-control" />
                        </div>

                        <div class="clearfix"></div>
                        <hr/>

                        <div id="queryResults">
                            #if( $page.queryMessage )
                            <div class="alert alert-info">
                                $page.queryMessage
                            </div>
                            #end

                            #if( $page.queryRecords )
                            <table class="table table-striped">
                                <tr>
                                    <th>Partipiant</th>
                                    <td colspan="2">
                                        <a href="/manageUsers/$page.queryProfile.userId">$page.queryProfile.userName</a>
                                    </td>
                                </tr>

                                <tr>
                                    <th>Progress</th>
                                    <td colspan="2">
                                        #set( $prog = $page.getProgress( $page.queryProfile, $page.queryStart, $page.queryFinish ) )
                                        #if( $prog )
                                        $formatter.formatNumeric($prog)
                                        #else
                                        Could not locate a progress value
                                        #end
                                    </td>
                                </tr>
                                <tr>
                                    <th>Period start</th>
                                    <td colspan="2">$page.queryStart</td>
                                </tr>
                                <tr>
                                    <th>Period end</th>
                                    <td colspan="2">
                                        #set($periodEndDate = $page.getPeriodEndDate( $page.queryStart ))
                                        $periodEndDate
                                    </td>
                                </tr>
                                <tr>
                                    <th>Progress end</th>
                                    <td colspan="2">
                                        $page.queryFinish
                                    </td>
                                </tr>
                                <tr>
                                    <th>Elapsed duration</th>
                                    <td colspan="2">
                                        #set( $perc = $page.getPeriodElapsedPerc( $page.queryStart, $periodEndDate, $page.queryFinish ) )
                                        $formatter.formatNumeric( $perc )
                                    </td>
                                </tr>
                                <tr>
                                    <th>Level</th>
                                    <td colspan="2">
                                        #set( $level = false)
                                        #set( $level = $page.progressLevel( $page.queryProfile, $page.queryStart, $page.queryFinish ) )
                                        #if( $level )
                                        <span class="badge badge-info">$level.levelName</span>
                                        Actual = $formatter.formatNumeric($level.actual) vs target $formatter.formatNumeric($level.target)
                                        #else
                                        Did not meet any levels
                                        #end
                                    </td>

                                </tr>
                            </table>

                            <p class="lead">Level thresholds</p>
                            <table class="table table-striped">
                                #foreach($levelName in $page.levelNames)
                                <tr>
                                    <th>$levelName</th>
                                    <td>
                                        #set( $l = $page.getTargetForLevel( $page.queryProfile, $levelName, $page.queryStart, $page.queryFinish ))
                                        #if( $l )
                                        $formatter.formatNumeric($l)
                                        #else
                                        Could not locate a target for this level
                                        #end

                                    </td>
                                    <td>
                                        #set( $level = false)
                                        #set( $level = $page.getProgressOfLevelPerc( $page.queryProfile, $levelName, $page.queryStart, $page.queryFinish ) )
                                        $formatter.formatNumeric($level) %
                                    </td>

                                </tr>
                                #end
                            </table>

                            <hr/>

                            <h2>Matched records</h2>
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Amount</th>
                                        <th>Sales by</th>
                                        <th>Entered</th>
                                        <th>By</th>
                                        <th colspan="2">Sales Period</th>
                                        #foreach($field in $page.extraFieldNames)
                                        <th>$field</th>
                                        #end
                                        <th><input   type="checkbox" name="toRemoveId" class="chk-all" value="" /></th>
                                    </tr>
                                </thead>
                                <tbody id="history-table-body">
                                    #foreach($item in $page.queryRecords)
                                    <tr>
                                        <td>
                                            #if( $item.amount )
                                            $item.amount
                                            #else
                                            No value
                                            #end
                                        </td>
                                        <td>
                                            <!-- either a profilebean or orgdata -->
                                            #if( $item.salesBy.name ) <!-- is individual -->
                                            <a href="/manageUsers/$item.salesBy.userId">$item.salesBy.name ($item.salesBy.userName)</a>
                                            #else
                                            <a href="/manageOrgs/$item.salesBy.orgId">$item.salesBy.title</a>
                                            #end
                                        </td>
                                        <td>
                                            <abbr title="$formatter.formatDateISO8601($item.enteredDate)" class="timeago">$!item.enteredDate</abbr>
                                        </td>
                                        <td><a href="/manageUsers/$item.enteredBy.userId">$item.enteredBy.name</a></td>
                                        <td title="$formatter.formatDateISO8601($item.periodTo)">$formatter.formatDateTime($item.periodFrom, $page.organisation.timezone)</td>
                                        <td title="$formatter.formatDateISO8601($item.periodTo)">$formatter.formatDateTime($item.periodTo, $page.organisation.timezone)</td>
                                        #foreach($field in $page.extraFieldNames)
                                        <td>$!item.extraFields.get( $field )</td>
                                        #end
                                        <td><input type="checkbox" name="toRemoveId" value="$item.id" /></td>
                                    </tr>
                                    #end
                                </tbody>
                            </table>
                            #else
                            <div class="alert alert-info">Query did not match any records</div>
                            #end
                        </div>
                    </div>
                    <div id="leaderboard" class="tab-pane">
                        <p>Generate a leaderboard for this KPI over a specified date range</p>

                        <div class="input-group date-range col-md-4 pull-left">
                            <label for="report-range" class="input-group-addon">Time</label>
                            <input type="text" id="leaderboardDateRange" placeholder="Choose a date range" value="" class="form-control" />
                        </div>

                        <button class="btn btn-info" id="runLeaderboard">
                            <span class="glyphicon glyphicon-play-circle"></span>
                            Query
                        </button>

                        <div class="clearfix"></div>
                        <hr/>

                        <div id="leaderboardResults">
                            #if( $request.params.leaderboard )
                            #set( $startDate = $formatter.toDate( $request.params.startDate ) )
                            #set( $endDate = $formatter.toDate( $request.params.endDate ) )
                            #set( $lb = $page.getLeaderboard($startDate, $endDate))
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Amount</th>
                                        <th>Participant</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboardBody">
                                    #foreach($item in $lb.highestResults )
                                    #set( $plusOne = $item.rank + 1 )
                                    <tr>
                                        <td>$plusOne</td>
                                        <td>
                                            #if( $item.amount )
                                            $item.amount
                                            #else
                                            No value
                                            #end
                                        </td>
                                        <td>
                                            <!-- either a profilebean or orgdata -->
                                            #if( $item.profile) <!-- is individual -->
                                            <a href="/manageUsers/$item.profile.userId">$item.profile.name ($item.profile.userName)</a>
                                            #else
                                            <a href="/manageOrgs/$item.org.orgId">$item.org.title</a>
                                            #end
                                        </td>
                                        <td>
                                            #if( $item.profile)
                                            #foreach($orgAndGroup in $item.profile.primaryMemberships().groupByOrg.entrySet() )
                                            <span class="label label-success">
                                                <b>$orgAndGroup.value.first.groupName</b>
                                                in
                                                $orgAndGroup.key.title
                                            </span>
                                            #end
                                            #end
                                        </td>
                                    </tr>
                                    #end
                                </tbody>
                            </table>
                            #else
                            <p>Press the query button above to generate the leaderboard<p>
                            #end
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div id="editLevelModal" class="modal modal-lg fade level-modal" tabindex="-1" data-focus-on="input:first" role="dialog" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">KPI Level</h4>
            </div>
            <div class="modal-body">


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-sm btn-success" data-type="form-submit">Save level</button>
            </div>
        </div>


        <div id="modal-upload-csv" class="modal modal-lg fade" aria-hidden="true" tabindex="-1">
            <div class="modal-header">
                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>
                <h4 class="modal-title">Upload KPI Level CSV</h4>
            </div>
            <div class="modal-body">
                <div class="upload">
                    <div class="btn-upload" id='do-upload-csv'></div>
                    <br />
                    <!--
                    <div class="allow-inserts">
                        <input type="checkbox" id="allow-inserts" /> <label for="allow-inserts">Allow inserts</label>
                    </div>
                    -->
                </div>
                <br />
                <div class="upload-results">
                    <p>
                        <strong>No. inserted:</strong>
                        <span class="badge badge-success num-inserted">-</span>
                        <strong>No. updated:</strong>
                        <span class="badge badge-success num-updated">-</span>
                        <strong>Unmatched rows:</strong>
                        <span class="badge badge-danger num-unmatched">-</span>
                    </p>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-condensed">
                            <tbody>
                                <tr>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>
            </div>
        </div>

        <script type="text/javascript" src="/static/js/jquery.milton-upload.js"></script>
        <script type="text/javascript">
            var startDate = null;
            var endDate = null;
            var searchQ = null;

            $(function () {
                var pageName = getFileName(window.location.pathname);
                setRecentItem(document.title + " (" + pageName + ")", window.location.pathname);
                var kpiName = "$page.kpi.name";
                $(".timeago").timeago();
                $(".timer-units li").click(function (e) {
                    e.preventDefault();
                    var unit = $(e.target).text();
                    $(".timer-unit").text(unit).val(unit);
                });
                var kpiForm = $("form.kpi-form");
                kpiForm.forms({
                    callback: function (resp) {
                        if (resp.status) {
                            Msg.info("Saved ok");
                            if (kpiForm.find("#name").val() != kpiName) {
                                window.location.href = "../" + kpiForm.find("#name").val();
                            }
                        } else {
                            Msg.error("An error occured saving: " + resp);
                        }
                    }
                });

                $(".kpi-process").click(function (e) {
                    e.preventDefault();
                    if (confirm("This will generate assessed levels for each un-processed period. Are you sure you want to continue?")) {
                        submitProcess("processKpis");
                    }
                });
                $(".kpi-rewards").click(function (e) {
                    e.preventDefault();
                    if (confirm("This will allocate rewards based on KPI achievements for results which have not already had rewards processing. Would you like to continue?")) {
                        submitProcess("processRewards");
                    }
                });

                var editLevelModal = $("#editLevelModal");

                $(".btn-add-level").click(function (e) {
                    e.preventDefault();
                    var newName = prompt("Please enter a name for the new level, you can then edit the details");
                    if (newName != null) {
                        createLevel(newName);
                    }
                });

                $(document).on('loaded.bs.modal', ".level-modal", function (e) {
                    flog("loaded");
                    editLevelModal.find("form").forms({
                        callback: function (resp) {
                            if (resp.status) {
                                Msg.info("Saved level");
                                $("#levels-table-body").reloadFragment();
                                editLevelModal.modal("hide");
                            } else {
                                Msg.error("An error occured saving: " + resp);
                            }
                        }
                    });
                    editLevelModal.find(".selectVal").on('click', function (e) {
                        var type = $(this).val();
                        var fixed = $(".fixed-value");
                        var series = $(".series-value");
                        if (type === "fixed") {
                            fixed.show();
                            fixed.find("input").prop('disabled', false);
                            series.hide();
                            series.find("input").prop('disabled', true);
                            series.find("select").prop('disabled', true);
                            series.find("select").removeClass("required");
                        } else if (type === "series") {
                            series.show();
                            series.find("input").prop('disabled', false);
                            series.find("select").prop('disabled', false);
                            series.find("select").addClass("required");
                            fixed.hide();
                            fixed.find("input").prop('disabled', true);
                        }
                    });
                })

                flog("levels", $("#levels-table-body .btn-remove-level"));
                $("#levels-table-body").on("click", ".btn-remove-level", function (e) {
                    e.preventDefault();
                    var id = $(e.target).closest("a").attr("href");
                    doDeleteLevel(id);
                });

                initRemovePeriods();

                initKpiLevelCsv();
                initQuery();
                initLeaderboard();
            });

            function initLeaderboard() {
                var leaderboardRange = $('#leaderboardDateRange');
                flog("initLeaderboard", leaderboardRange);
                leaderboardRange.daterangepicker(
                        {
                            format: 'DD/MM/YYYY', // YYYY-MM-DD
                            ranges: {
                                'Last 7 Days': [moment().subtract('days', 6), moment()],
                                'Last 30 Days': [moment().subtract('days', 29), moment()],
                                'This Month': [moment().startOf('month'), moment().endOf('month')],
                                'Last Month': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')],
                                'This Year': [moment().startOf('year'), moment()],
                            },
                        },
                        function (start, end) {
                            flog('onChange', start, end);
                            startDate = start;
                            endDate = end;
                        }
                );

                var drp = leaderboardRange.data('daterangepicker');
                flog("drp", drp);
                $("#runLeaderboard").click(function (e) {
                    e.preventDefault();
                    var startDate = drp.startDate;
                    var endDate = drp.endDate;
                    flog("drp", drp);
                    var val = leaderboardRange.val();
                    var url;
                    if( val != "") {
                        url = window.location.pathname + "?startDate=" + formatDate(startDate) + "&endDate=" + formatDate(endDate) + "&leaderboard=true";
                    }else {
                        url = window.location.pathname + "?leaderboard=true";
                    }
                    $("#leaderboardResults").reloadFragment({
                        url: url,
                        whenComplete: function () {
                            Msg.info("Loaded leaderboard");
                        }
                    });

                });
            }

            function initQuery() {
                $('body').on('keypress', '#data-query', function (e) {
                    var code = e.keyCode || e.which;
                    if (code == 13) {
                        e.preventDefault();
                        $(this).change();
                        return false;
                    }
                });

                $('body').on('change', '#data-query', function (e) {
                    e.preventDefault();
                    var inp = $(this);
                    searchQ = inp.val();
                    flog(searchQ);
                    doQuery();
                });

                var reportRange = $('#report-range');

                reportRange.exist(function () {
                    flog("init report range");
                    reportRange.daterangepicker({
                        format: 'DD/MM/YYYY', // YYYY-MM-DD
                        ranges: {
                            'Last 7 Days': [moment().subtract('days', 6), moment()],
                            'Last 30 Days': [moment().subtract('days', 29), moment()],
                            'This Month': [moment().startOf('month'), moment().endOf('month')],
                            'Last Month': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')],
                            'This Year': [moment().startOf('year'), moment()],
                        },
                    },
                            function (start, end) {
                                flog('onChange', start, end);
                                startDate = start;
                                endDate = end;
                                doQuery();
                            }
                    );
                });
            }

            function doQuery() {
                flog('doHistorySearch', startDate, endDate, searchQ);
                Msg.info("Doing search...", 2000);

                var data = {
                    startDate: formatDate(startDate),
                    finishDate: formatDate(endDate),
                    dataQuery: searchQ
                };
                flog("data", data);

                var target = $("#queryResults");
//                target.load();

                $.ajax({
                    type: "GET",
                    url: window.location.pathname,
                    dataType: 'html',
                    data: data,
                    success: function (content) {
                        flog('response', content);
                        Msg.success("Search complete", 2000);
                        var newBody = $(content).find("#queryResults");
                        flog("replacing ", target);
                        target.replaceWith(newBody);

                        $("abbr.timeago").timeago();

                    }
                });
            }

            function createLevel(name) {
                flog("createLevel", name);
                $.ajax({
                    type: 'POST',
                    data: {
                        newLevelTitle: name
                    },
                    dataType: "json",
                    url: window.location.pathname,
                    success: function (data) {
                        if (data.status) {
                            Msg.success("Created new level ok");
                            $("#levels-table-body").reloadFragment();
                        } else {
                            Msg.error("There was a problem creating the level. Please try again and contact the administrator if you still have problems");
                        }
                    },
                    error: function (resp) {
                        Msg.error("There was a problem removing the level. Please try again and contact the administrator if you still have problems");
                    }
                });
            }

            function doDeleteLevel(id) {
                flog("delete", id);
                var level = $("#level-" + id);
                confirmDelete(id, "this level", function () {
                    flog('deleted', level);
                    level.remove();
                    Msg.success('Deleted level');
                });
            }

            function submitProcess(processName) {
                flog("submitProcess", processName);
                $.ajax({
                    type: 'POST',
                    data: {
                        process: processName
                    },
                    dataType: "json",
                    url: window.location.pathname,
                    success: function (data) {
                        if (data.status) {
                            Msg.success("Submitted for processing");
                        } else {
                            Msg.error("Could not start processing: " + data.messages);
                        }
                    },
                    error: function (resp) {
                        Msg.error("There was a problem submitting the process. Please try again and contact the administrator if you still have problems");
                    }
                });
            }

            function initRemovePeriods() {
                $(".periods-delete").click(function (e) {
                    var node = $(e.target);
                    flog("initRemovePeriods", $("#periods-table"));
                    var checkBoxes = $("#table-periods").find('tbody input.deletePeriodId:checked');
                    if (checkBoxes.length === 0) {
                        Msg.error("Please select the periods you want to remove by clicking the checkboxs to the right");
                    } else {
                        if (confirm("Are you sure you want to remove " + checkBoxes.length + " periods?")) {
                            doRemovePeriods(checkBoxes);
                        }
                    }
                });
            }

            function doRemovePeriods(checkBoxes) {
                var vals = "";
                checkBoxes.each(function (i, n) {
                    vals += $(n).val() + ",";
                });
                var data = {
                    deletePeriodId: vals
                };
                flog("periodis", data);
                $.ajax({
                    type: 'POST',
                    data: data,
                    dataType: "json",
                    url: window.location.pathname,
                    success: function (data) {
                        flog("success", data);
                        if (data.status) {
                            $("#table-periods").reloadFragment();
                            Msg.success("Removed periods ok");
                        } else {
                            Msg.error("There was a problem removing periods. Please try again and contact the administrator if you still have problems");
                        }
                    },
                    error: function (resp) {
                        Msg.error("An error occurred removing periods. You might not have permission to do this");
                    }
                });
            }

            function initKpiLevelCsv() {
                var modalUploadCsv = $("#modal-upload-csv");
                $("#uploadKpiCsv").click(function (e) {
                    e.preventDefault();

                    modalUploadCsv.modal('show');
                });

                var resultUploadCsv = modalUploadCsv.find('.upload-results');
                $("#do-upload-csv").mupload({
                    buttonText: "<i class=\"clip-folder\"></i> Upload spreadsheet",
                    url: "kpiLevels.csv",
                    useJsonPut: false,
                    oncomplete: function (data, name, href) {
                        flog("oncomplete:", data.result.data, name, href);
                        resultUploadCsv.find('.num-updated').text(data.result.data.numUpdated);
                        resultUploadCsv.find('.num-inserted').text(data.result.data.numInserted);
                        resultUploadCsv.find('.num-unmatched').text(data.result.data.unmatched.length);
                        showUnmatched(resultUploadCsv, data.result.data.unmatched);
                        resultUploadCsv.show();
                        Msg.success("Upload completed. Please review any unmatched members below, or refresh the page to see the updated list of members");
                        $("#levels-table-body").reloadFragment({
                            onComplete: function () {
                                $("#levels-table-body").on("click", ".btn-remove-level", function (e) {
                                    e.preventDefault();
                                    if (confirm("Are you sure you want to delete this level?")) {
                                        var id = $(e.target).closest("a").attr("href");
                                        doDeleteLevel(id);
                                    }
                                });
                            }
                        });
                    }
                });
            }

            function showUnmatched(resultUploadCsv, unmatched) {
                var unmatchedTable = resultUploadCsv.find("table");
                var tbody = unmatchedTable.find("tbody");
                tbody.html("");
                $.each(unmatched, function (i, row) {
                    flog("unmatched", row);
                    var tr = $("<tr>");
                    $.each(row, function (ii, field) {
                        tr.append("<td>" + field + "</td>");
                    });
                    tbody.append(tr);
                });
            }
        </script>
    </body>
</html>
