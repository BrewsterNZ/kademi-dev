<html xmlns="http://www.w3.org/1999/xhtml">    <head>        <title>Manage Sales Data Series</title>    </head>    <body class="">        <form name="frmDetails" action="." method="post" class="form-horizontal kpi-form">            <div class="pull-right page-action">                <button class="btn btn-sm btn-primary" type="submit">Save changes</button>            </div>            <div class="tabbable">                <ul class="nav nav-tabs tab-bricky">                    <li><a data-toggle="tab" href="#general">General</a></li>                    <li><a data-toggle="tab" href="#levels">Levels</a></li>                </ul>                <div class="tab-content">                    <div id="general" class="tab-pane">                        <div class="form-group">                            <label class="control-label col-md-3" for="title">Title</label>                            <div class="col-md-8">                                <input type="text" name="title" id="title" value="$!page.kpi.title" placeholder="" class="required form-control"  required="true" />                            </div>                        </div>                        <div class="form-group">                            <label class="control-label col-md-3" for="reward">                                Reward                                <small>Allocate points to this reward</small>                            </label>                            <div class="col-md-8">                                <select name="reward" id="salesGroup" class="form-control" >                                    <option value="">[No points]</option>                                    #foreach($reward in $page.rewards)                                    $formatter.option($reward.name, $reward.name, $page.kpi.reward.name)                                    #end                                </select>                                                            </div>                        </div>                        <div class="form-group">                            <label class="control-label col-md-3" for="aggregation">                                Aggregation                                <small>How should values be merged over the KPI period</small>                            </label>                            <div class="col-md-8">                                <select name="aggregation" id="aggregation" class="form-control required" required="true" >                                    <option value="">[Not selected]</option>                                    #foreach($agg in $page.aggregationTypes.entrySet() )                                    $formatter.option($agg.key, $agg.value, $page.kpi.aggregation)                                    #end                                </select>                                                            </div>                        </div>                        <div class="form-group">                            <label class="control-label col-md-3" for="notes">                                Aggregation period                                <small>Over what period should criteria be assessed?</small></label>                            <div class="col-md-2 col-sm-4 col-xs-12">                                <div class="input-group pull-left">                                    <input type="text" class="text-center form-control" value="$!page.kpi.periodMultiples" name="periodMultiples" />                                    <div class="input-group-btn">                                        <button data-toggle="dropdown" class="btn btn-default dropdown-toggle timer-unit" type="button">$!page.kpi.frequency <span class="caret"></span></button>                                        <ul role="menu" class="dropdown-menu pull-right timer-units">                                            #foreach($unit in $page.allFrequencies)                                            <li><a href="#">$unit</a></li>                                            #end                                                                                                    </ul>                                    </div>                                           <input type="hidden" name="timerUnitName" class="timer-unit" value="$!page.job.frequency"/>                                </div>                            </div>                        </div>                        <div class="form-group">                            <label class="control-label col-md-3" for="notes">Notes<small>For internal use.</small></label>                            <div class="col-md-8">                                <textarea cols="100" name="notes" id="notes" rows="10" placeholder="" class="form-control">$!page.key.notes</textarea>                            </div>                        </div>                    </div>                    <!-- End content of General tab -->                    <!-- levels -->                    <div id="levels" class="tab-pane">                        <div class="alert alert-info">                            <p>Create levels for this data series to reward your users when they achieve certain threshholds.</p>                        </div>                                                <div>                            <button data-toggle="modal" data-target="#addLevelModal" class="btn btn-success btn-sm btn-add-level"><i class="fa fa-plus"></i> Add new Level</button>                         </div>                                                <table class="table table-bordered table-striped">                            <colgroup>                                <col />                                <col />                                <col style="width: 100px" />                            </colgroup>                            <thead>                                <tr>                                    <th>Threshold</th>                                    <th>Reward points</th>                                </tr>                            </thead>                            <tbody id="levels-table-body">                                #if( $page.kpi.levels.size() > 0 )                                #foreach( $level in $page.kpi.levels )                                <tr>                                    <td>$level.minorBound</td>                                    <td>$level.awardAmount</td>                                    <td>                                        <a title="Remove this role" href="$level.id" class="btn btn-xs btn-danger btn-remove-level"><i class="glyphicon glyphicon-remove "></i></a>                                    </td>                                </tr>                                #end                                #else                                <tr>                                    <td colspan="3">There are no KPI levels defined yet</td>                                </tr>                                #end                                                            </tbody>                        </table>                    </div>                    <!-- end levels -->                </div>            </div>        </form>        <div id="addLevelModal" class="modal fade" tabindex="-1" data-focus-on="input:first" role="dialog" aria-hidden="true">            <div class="modal-header">                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>                <h4 class="modal-title">Add KPI Level</h4>            </div>            <div class="modal-body">                <p>                    Choose a threshhold level at which your users have reached this level. You can also specify how                    many points to award                </p>                <form action="$page.href" method="POST" class="form-horizontal">                          <div class="form-group">                        <label class="col-md-3 control-label" for="newLevelAmount">Level</label>                        <div class="col-md-8">                            <input type='text' name="newLevelAmount" class="form-control required" required="true" />                        </div>                    </div>                    <div class="form-group">                        <label class="col-md-3 control-label" for="newRewardPoints">Reward points</label>                        <div class="col-md-8">                            <input type='text' name="newRewardPoints" class="form-control"/>                        </div>                    </div>                                    </form>            </div>            <div class="modal-footer">                <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>                <button type="button" class="btn btn-sm btn-primary" data-type="form-submit">Create level</button>            </div>        </div>                <script type="text/javascript">            $(function () {                $(".timeago").timeago();                $(".timer-units li").click(function (e) {                    e.preventDefault();                    var unit = $(e.target).text();                    $(".timer-unit").text(unit).val(unit);                });                $("form.kpi-form").forms({                    callback: function (resp) {                        if (resp.status) {                            Msg.info("Saved ok");                        } else {                            Msg.error("An error occured saving: " + resp);                        }                    }                });                                var addLevelModal = $("#addLevelModal");                addLevelModal.find("form").forms({                    callback: function (resp) {                        if (resp.status) {                            Msg.info("Added new level");                            $("#levels-table-body").reloadFragment();                            addLevelModal.find("input").val("");                            addLevelModal.modal("hide");                        } else {                            Msg.error("An error occured saving: " + resp);                        }                    }                });                                flog("levels", $("#levels-table-body .btn-remove-level"));                $("#levels-table-body").on("click", ".btn-remove-level", function(e){                    e.preventDefault();                    if( confirm("Are you sure you want to delete this level?")) {                        var id =  $(e.target).closest("a").attr("href");                        doDeleteLevel( id );                    }                });            });            function doDeleteLevel(id) {                flog("delete", id);                $.ajax({                    type: 'POST',                    data: {                        deleteLevelId: id                    },                    dataType: "json",                    url: window.location.pathname,                    success: function (data) {                        if (data.status) {                            Msg.success("Removed ok");                            $("#levels-table-body").reloadFragment();                        } else {                            Msg.error("There was a problem removing the level. Please try again and contact the administrator if you still have problems");                        }                    },                    error: function (resp) {                        Msg.error("There was a problem removing the level. Please try again and contact the administrator if you still have problems");                    }                });            }                    </script>    </body></html>