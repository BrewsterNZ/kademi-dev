<html xmlns="http://www.w3.org/1999/xhtml">    <head>        <title>Manage Categories</title>        <style>            .cat-image {                max-height: 50px;                max-width: 50px;            }        </style>    </head>    <body class="">        <p>            <button type="button" class="btn btn-sm btn-danger deleteCat pull-right"><i class="glyphicon glyphicon-trash"></i> Delete</button>        <div class="btn-group" role="group">            <button type="button" class="btn btn-sm btn-success newCategory" data-toggle="modal" data-target="#addCategoryModal"><i class="fa fa-plus"></i> Add New Category            </button>            <button type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-expanded="false">                <span class="caret"></span>            </button>            <ul class="dropdown-menu" role="menu">                <li>                    <a href="#" title="Upload categories CSV" id="uploadCatsCsv" data-toggle="modal" data-target="#modalUploadCsv"><i class="glyphicon glyphicon-upload"></i> Upload CSV</a>                </li>                <li><a href="categories.csv" title="Export categories CSV"><i class="glyphicon glyphicon-download"></i> Export CSV</a></li>                <li class="divider"></li>                <li>                    <a href="#" title="Upload product categories CSV" id="uploadProductCategoriesCsv" data-toggle="modal" data-target="#modalUploadProdCatsCsv"><i class="glyphicon glyphicon-upload"></i> Upload product in categories CSV</a>                </li>                <li><a href="product-categories.csv" title="Export product categories CSV"><i class="glyphicon glyphicon-download"></i> Export product in categories CSV</a></li>            </ul>        </div>        </p>        <div class="panel panel-default">            <div id="productsTableContainer" class="panel-body">                <div class="table-responsive">                    <table class="table table-striped table-hover">                        <colgroup>                            <col width="15%" />                            <col width="15%" />                            <col width="15%" />                            <col width="45%" />                            <col width="30%" />                            <col width="180px" />                            <col width="180px" />                        </colgroup>                        <thead>                            <tr>                                <th></th>                                <th>Code</th>                                <th>Parent</th>                                <th>Title</th>                                <th>No. products</th>                                <th><input type="checkbox" class="check-all" /></th>                            </tr>                        </thead>                        <tbody id="categoriesTableBody">                            #foreach($cat in $page.children.ofType.category)                                <tr>                                    <td>                                        <a href="$cat.name">                                            #if( $cat.imageHref )                                                <img src="$cat.imageHref" class="cat-image" />                                            #else                                            #end                                        </a>                                    </td>                                    <td><a href="$cat.name">$cat.name</a></td>                                    <td>$!cat.category.parentCategory.title</td>                                    <td>$cat.title</td>                                    <td>$cat.numProducts</td>                                    <th><input type="checkbox" data-catid="$cat.category.id" class="cat-check" /></th>                                    <th>                                        <button type="button" data-origname="$cat.name" data-title="$cat.title" class="btn btn-sm btn-info renameCat pull-right">                                            <i class="glyphicon glyphicon-pencil"></i> Rename                                        </button>                                    </th>                                </tr>                            #end                        </tbody>                    </table>                </div>            </div>        </div>        <div id="addCategoryModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">            <div class="modal-dialog">                <div class="modal-content">                    <div class="modal-header">                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>                        <h4 class="modal-title">Category Details</h4>                    </div>                    <form action="." method="POST" class="form-horizontal createCategory">                        <div class="modal-body">                            <div class="form-message alert alert-danger" style="display: none;"></div>                            <input type="hidden" name="action" value="create" />                            <div class="form-group">                                <label class="col-md-3 control-label" for="name">Name/Code</label>                                <div class="col-md-8">                                    <input class="form-control required" type="text" id="name" name="name" maxlength="30" placeholder="Category code, Eg MEK-123" />                                </div>                            </div>                            <div class="form-group">                                <label class="col-md-3 control-label" for="newTitle">Title</label>                                <div class="col-md-8">                                    <input class="form-control required" id="newTitle" type="text" name="newTitle" maxlength="250" placeholder="Category title" />                                </div>                            </div>                    </div>                    <div class="modal-footer">                        <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>                        <button class="btn btn-sm btn-primary" type="submit">Create category</button>                    </div>                    </form>                </div>            </div>        </div>        <div id="renameCategoryModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">            <div class="modal-dialog">                <div class="modal-content">                    <div class="modal-header">                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>                        <h4 class="modal-title">Category Details</h4>                    </div>                    <form action="." method="POST" class="form-horizontal renameCategory">                        <div class="modal-body">                            <div class="form-message alert alert-danger" style="display: none;"></div>                            <input type="hidden" name="action" value="rename" />                            <input type="hidden" name="origName" value="" />                            <div class="form-group">                                <label class="col-md-3 control-label" for="name">Name/Code</label>                                <div class="col-md-8">                                    <input class="form-control required" type="text" id="name" name="name" maxlength="30" placeholder="Category code, Eg MEK-123" />                                </div>                            </div>                            <div class="form-group">                                <label class="col-md-3 control-label" for="title">Title</label>                                <div class="col-md-8">                                    <input class="form-control required" id="title" type="text" name="title" maxlength="250" placeholder="Category title" />                                </div>                            </div>                    </div>                    <div class="modal-footer">                        <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>                        <button class="btn btn-sm btn-primary" type="submit">Rename category</button>                    </div>                    </form>                </div>            </div>        </div>        <div id="modalUploadCsv" class="modal fade" aria-hidden="true" tabindex="-1">            <div class="modal-dialog modal-lg">                <div class="modal-content">                    <div class="modal-header">                        <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>                        <h4 class="modal-title">Upload Categories CSV</h4>                    </div>                    <div class="modal-body">                        <div class="upload">                            <div class="btn-upload" id='doUploadCsv'></div>                            <br />                        </div>                        <br />                        <div class="upload-results">                            <p>                                <strong>No. inserted:</strong>                                <span class="badge badge-success num-inserted">-</span>                                <strong>No. updated:</strong>                                <span class="badge badge-success num-updated">-</span>                                <strong>Failed rows:</strong>                                <span class="badge badge-danger num-unmatched">-</span>                            </p>                            <div class="table-responsive">                                <table class="table table-striped table-hover table-condensed">                                    <tbody>                                        <tr>                                            <td></td>                                        </tr>                                    </tbody>                                </table>                            </div>                        </div>                    </div>                    <div class="modal-footer">                        <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>                    </div>                </div>            </div>        </div>        <div id="modalUploadProdCatsCsv" class="modal fade" aria-hidden="true" tabindex="-1">            <div class="modal-dialog modal-lg">                <div class="modal-content">                    <div class="modal-header">                        <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>                        <h4 class="modal-title">Upload Product in Categories CSV</h4>                    </div>                    <div class="modal-body">                        <div class="upload">                            <div class="btn-upload" id='doUploadPiCCsv'></div>                            <br />                        </div>                        <br />                        <div class="upload-results">                            <p>                                <strong>No. updated:</strong>                                <span class="badge badge-success num-updated">-</span>                                <strong>Failed rows:</strong>                                <span class="badge badge-danger num-unmatched">-</span>                            </p>                            <div class="table-responsive">                                <table class="table table-striped table-hover table-condensed">                                    <tbody>                                        <tr>                                            <td></td>                                        </tr>                                    </tbody>                                </table>                            </div>                        </div>                    </div>                    <div class="modal-footer">                        <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>                    </div>                </div>            </div>        </div>        <script type="text/javascript" src="/static/js/jquery.milton-upload.js"></script>        <script type="text/javascript">            $(function () {                $(".newCategory").click(function (event) {                    event.preventDefault();                    // Reset fields in the create product form                    $("#addCategoryModal").find("input[type=text], textarea,input[name=pageName]").val("");                });                $("form.createCategory").forms({                    callback: function () {                        $("#categoriesTableBody").reloadFragment();                        $("#addCategoryModal").modal('hide');                    }                });                $("body").on("click", ".deleteCat", function (e) {                    e.preventDefault();                    var listToDelete = [];                    $('body').find(':checkbox.cat-check:checked').each(function () {                        listToDelete.push($(this).data("catid"));                    });                    if (listToDelete.length > 0 && confirm("Are you sure you want to delete " + listToDelete.length + " categories?")) {                        flog(listToDelete.join(','));                        deleteCategories(listToDelete.join(','));                        $('body').find('.check-all').check(false).change();                    }                });                $('body').on('change', '.check-all', function (e) {                    var checkedStatus = this.checked;                    $('body').find(':checkbox.cat-check').prop('checked', checkedStatus);                });                var renameModal = $('#renameCategoryModal');                $('body').on('click', '.renameCat', function (e) {                    e.preventDefault();                    var btn = $(this);                    var origName = btn.data('origname');                    var title = btn.data('title');                    renameModal.find('input[name=origName]').val(origName);                    renameModal.find('input[name=name]').val(origName);                    renameModal.find('input[name=title]').val(title);                    renameModal.modal('show');                });                renameModal.find('form').forms({                    callback: function (resp) {                        if (resp.status) {                            Msg.success(resp.messages);                            $('#categoriesTableBody').reloadFragment();                            renameModal.modal('hide');                        } else {                            Msg.warning(resp.messages)                        }                    }                });                initCategoriesCsv();                initProductInCategoriesCsv();            });            function deleteCategories(listToDelete) {                $.ajax({                    url: window.location.pathname,                    type: 'POST',                    dataType: 'json',                    data: {                        deleteCat: listToDelete                    },                    success: function (resp) {                        flog("success", resp);                        if (resp.status) {                            Msg.info(resp.messages[0]);                            $("#categoriesTableBody").reloadFragment();                        } else {                            Msg.error("An error occured delete categories");                        }                    },                    error: function () {                        alert('An error occured delete categories');                    }                });            }            function initCategoriesCsv() {                var modalUploadCsv = $("#modalUploadCsv");                var resultUploadCsv = modalUploadCsv.find('.upload-results');                $("#doUploadCsv").mupload({                    buttonText: "<i class=\"clip-folder\"></i> Upload spreadsheet",                    url: "categories.csv",                    useJsonPut: false,                    oncomplete: function (data, name, href) {                        flog("oncomplete:", data.result.data, name, href);                        resultUploadCsv.find('.num-updated').text(data.result.data.numUpdated);                        resultUploadCsv.find('.num-inserted').text(data.result.data.numInserted);                        resultUploadCsv.find('.num-unmatched').text(data.result.data.unmatched.length);                        showUnmatched(resultUploadCsv, data.result.data.unmatched);                        resultUploadCsv.show();                        Msg.success("Upload completed. Please review any unmatched members below, or refresh the page to see the updated list of products");                        $("#categoriesTableBody").reloadFragment();                    }                });                function showUnmatched(resultUploadCsv, unmatched) {                    var unmatchedTable = resultUploadCsv.find("table");                    var tbody = unmatchedTable.find("tbody");                    tbody.html("");                    $.each(unmatched, function (i, row) {                        var tr = $("<tr>");                        $.each(row, function (ii, field) {                            tr.append("<td>" + field + "</td>");                        });                        tbody.append(tr);                    });                }            }            function initProductInCategoriesCsv() {                var modalUploadCsv = $("#modalUploadProdCatsCsv");                var resultUploadCsv = modalUploadCsv.find('.upload-results');                $("#doUploadPiCCsv").mupload({                    buttonText: "<i class=\"clip-folder\"></i> Upload spreadsheet",                    url: "product-categories.csv",                    useJsonPut: false,                    oncomplete: function (data, name, href) {                        flog("oncomplete:", data.result.data, name, href);                        resultUploadCsv.find('.num-updated').text(data.result.data.numUpdated);                        resultUploadCsv.find('.num-unmatched').text(data.result.data.unmatched.length);                        showUnmatched(resultUploadCsv, data.result.data.unmatched);                        resultUploadCsv.show();                        Msg.success("Upload completed. Please review any unmatched members below");                        $("#categoriesTableBody").reloadFragment();                    }                });                function showUnmatched(resultUploadCsv, unmatched) {                    var unmatchedTable = resultUploadCsv.find("table");                    var tbody = unmatchedTable.find("tbody");                    tbody.html("");                    $.each(unmatched, function (i, row) {                        var tr = $("<tr>");                        $.each(row, function (ii, field) {                            tr.append("<td>" + field + "</td>");                        });                        tbody.append(tr);                    });                }            }        </script>    </body></html>