<html xmlns="http://www.w3.org/1999/xhtml">    <head>        <title>Manage Products</title>        <style>            .upload-results {                display: none;            }        </style>    </head>    <body class="">        <p>            <div class="btn-group" role="group">                <a href="/product-images/" class="btn btn-sm btn-info" role="button"><i class="fa fa-picture-o"></i> Product images</a>                <button id="newProduct" type="button" class="btn btn-sm btn-success newProduct" data-toggle="modal" data-target="#addProductModal"><i class="fa fa-plus"></i> Add New Product</button>                <button type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-expanded="false">                    <span class="caret"></span>                </button>                <ul class="dropdown-menu pull-right" role="menu">                    <li><a href="#" title="Upload products CSV" id="uploadProductsCsv" data-toggle="modal" data-target="#modal-upload-csv"><i class="glyphicon glyphicon-upload"></i> Upload CSV</a></li>                    <li><a href="products.csv" title="Export products CSV"><i class="glyphicon glyphicon-download"></i> Export CSV</a></li>                    <li class="divider"></li>                    <li><a href="#" title="Upload variants CSV" id="uploadVariantsCsv" data-toggle="modal" data-target="#modal-upload-variants-csv"><i class="glyphicon glyphicon-upload"></i> Upload Variants CSV</a></li>                    <li><a href="variants.csv" title="Export product variants CSV"><i class="glyphicon glyphicon-download"></i> Export Variants CSV</a></li>                </ul>            </div>            <div class="btn-group pull-right" role="group">                <a href="#" class="btn btn-danger btn-delete-products" role="button"><i class="fa fa-times"></i> Delete</a>                <button type="button" class="btn btn-danger dropdown-toggle" data-toggle="dropdown" aria-expanded="false">                    <span class="caret"></span>                </button>                <ul class="dropdown-menu pull-right" role="menu">                    <li>                        <a href="#" title="Upload products CSV" id="bulkDeleteProducts" data-toggle="modal" data-target="#modalBulkDelete"><i class="glyphicon glyphicon-remove-circle"></i> Bulk delete...</a>                    </li>                </ul>            </div>        </p>        <div class="panel panel-default">            <div id="productsTableContainer" class="panel-body">                <div class="table-responsive">                    <table class="table table-striped table-hover" style="table-layout: fixed">                        <colgroup>                            <col width="100px" />                            <col width="20%" />                            <col width="35%" />                            <col width="15%" />                            <col width="10%" />                            <col width="10%"/>                            <col width="50px"/>                        </colgroup>                        <thead>                            <tr>                                <th></th>                                <th>Code</th>                                <th>Title</th>                                <th>Supplier</th>                                <th>No. variants</th>                                <th>Base Cost</th>                                <th><input type="checkbox" class="check-all"/></th>                            </tr>                        </thead>                        <tbody id="productTableBody">                            #foreach($product in $page.children.ofType.product)                            <tr>                                <td>                                    #if( $product.imageHrefs.size() > 0 )                                    <a href='$product.imageHrefs.get(0)' class='product-image'>                                        <span class='fa fa-picture-o'></span>                                    </a>                                    #end                                </td>                                <td><a href="$product.name">$product.product.name</a></td>                                <td>$product.title</td>                                <td>$!product.product.supplier.formattedName</td>                                <td>$product.numVariants</td>                                <td>$!product.baseCost</td>                                <td><input type="checkbox" data-productname="$product.product.id" class="product-check"/></td>                            </tr>                            #end                        </tbody>                    </table>                </div>            </div>        </div>        <div id="addProductModal" class="modal fade" tabindex="-1" data-focus-on="input:first" role="dialog" aria-hidden="true">            <div class="modal-dialog">                <div class="modal-content">                    <div class="modal-header">                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>                        <h4 class="modal-title">Product Details</h4>                    </div>                    <div class="modal-body">                        <form action="." method="POST" class="form-horizontal createProduct">                            <input type="hidden" name="action" value="create"/>                            <div class="form-group">                                <label class="col-md-3 control-label" for="name">Name/Code</label>                                <div class="col-md-8">                                    <input class="form-control required" type="text" id="name" name="name" maxlength="30" placeholder="Produce code, Eg MEK-123"  />                                </div>                            </div>                            <div class="form-group">                                <label class="col-md-3 control-label" for="title">Title</label>                                <div class="col-md-8">                                    <input class="form-control required" id="title" type="text" name="title" maxlength="250" placeholder="Product title" />                                </div>                            </div>                            <div class="form-group">                                <label class="col-md-3 control-label" for="baseCost">Base cost</label>                                <div class="col-md-8">                                    <input class="form-control numeric" id="baseCost" type="text" name="baseCost" maxlength="20" placeholder="Base cost of the product" />                                </div>                            </div>                        </form>                    </div>                    <div class="modal-footer">                        <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>                        <button type="button" class="btn btn-sm btn-primary" data-type="form-submit">Create product</button>                    </div>                </div>            </div>        </div>        <div id="modal-upload-csv" class="modal fade" aria-hidden="true" tabindex="-1">            <div class="modal-dialog modal-lg">                <div class="modal-content">                    <div class="modal-header">                        <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>                        <h4 class="modal-title">Upload Product CSV</h4>                    </div>                    <div class="modal-body">                        <div class="upload">                            <div class="btn-upload" id='do-upload-csv'></div>                            <br />                            <!--                            <div class="allow-inserts">                                <input type="checkbox" id="allow-inserts" /> <label for="allow-inserts">Allow inserts</label>                            </div>                            -->                        </div>                        <br />                        <div class="upload-results">                            <p>                                <strong>No. inserted:</strong>                                <span class="badge badge-success num-inserted">-</span>                                <strong>No. updated:</strong>                                <span class="badge badge-success num-updated">-</span>                                <strong>Unmatched rows:</strong>                                <span class="badge badge-danger num-unmatched">-</span>                            </p>                            <div class="table-responsive">                                <table class="table table-striped table-hover table-condensed">                                    <tbody>                                        <tr>                                            <td></td>                                        </tr>                                    </tbody>                                </table>                            </div>                        </div>                    </div>                    <div class="modal-footer">                        <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>                    </div>                </div>            </div>        </div>        <div id="modal-upload-variants-csv" class="modal fade" aria-hidden="true" tabindex="-1">            <div class="modal-dialog modal-lg">                <div class="modal-content">                    <div class="modal-header">                        <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>                        <h4 class="modal-title">Upload Product Variants CSV</h4>                    </div>                    <div class="modal-body">                        <div class="upload">                            <div class="btn-upload" id='do-upload-variants-csv'></div>                            <br />                        </div>                        <br />                        <div class="upload-results">                            <p>                                <strong>No. inserted:</strong>                                <span class="badge badge-success num-inserted">-</span>                                <strong>No. updated:</strong>                                <span class="badge badge-success num-updated">-</span>                                <strong>Unmatched rows:</strong>                                <span class="badge badge-danger num-unmatched">-</span>                            </p>                            <div class="table-responsive">                                <table class="table table-striped table-hover table-condensed">                                    <tbody>                                        <tr>                                            <td></td>                                        </tr>                                    </tbody>                                </table>                            </div>                        </div>                    </div>                    <div class="modal-footer">                        <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>                    </div>                </div>            </div>        </div>        <div id="modalBulkDelete" class="modal fade" aria-hidden="true" tabindex="-1">           <div class="modal-dialog modal-lg">               <div class="modal-content">                   <div class="modal-header">                       <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>                       <h4 class="modal-title">Bulk delete products</h4>                   </div>                   <div class="modal-body">                       <p>Enter a list of product codes/SKU's below. These can be seperated by commas, semi-colons or new lines</p>                       <form action="$page.href" method="POST">                           <textarea name="deleteBulkProducts" class="form-control" style='height: 400px'></textarea>                       </form>                   </div>                   <div class="modal-footer">                       <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>                       <button class="btn btn-danger" data-type="form-submit">Delete products</button>                   </div>               </div>           </div>        </div>        <script type="text/javascript" src="/static/js/jquery.milton-upload.js"></script>        <script type="text/javascript">            $(function () {                $("#newProduct").click(function (event) {                    event.preventDefault();                    // Reset fields in the create product form                    $("#addProductModal").find("input[type=text], textarea,input[name=pageName]").val("");                });                $("#modalBulkDelete form").forms({                    callback: function (resp) {                        flog("Done", resp);                        if (resp.status) {                            if (resp.data.numDeleted > 0) {                                $("#productTableBody").reloadFragment();                                alert("Deleted " + resp.data.numDeleted + " products");                                $("#modalBulkDelete").modal("hide");                            } else {                                alert("Did not find any matching products. Nothing deleted");                            }                        } else {                            alert("There was a problem deleting products")                        }                    }                });                jQuery("form.createProduct").forms({                    callback: function () {                        $.ajax({                            type: 'GET',                            url: window.location.href,                            dataType: "html",                            success: function (resp) {                                var page = $(resp);                                var table = page.find("#productsTableContainer table");                                $("#productsTableContainer").html(table);                            },                            error: function (resp) {                                log('There was a problem logging you out', resp);                            },                            complete: function (jqXHR, textStatus) {                                $("#addProductModal").modal('hide');                            }                        });                    }                });                initProductsCsv();                initVariantsCsv();                $('body').on('click', '.btn-delete-products', function (e) {                    e.preventDefault();                    var listToDelete = [];                    $('body').find(':checkbox.product-check:checked').each(function () {                        var p = $(this);                        flog(p.data("productname"));                        listToDelete.push(p.data("productname"));                    });                    if (listToDelete.length > 0 && confirm("Are you sure you want to delete " + listToDelete.length + " products?")) {                        $('body').find('.check-all').check(false).change();                        flog(listToDelete.join(','));                        deleteProducts(listToDelete.join(','));                    }                });                $('body').on('change', '.check-all', function (e) {                    flog($(this).is(":checked"));                    //$("body").find(":checkbox.product-check").check($(this).is(":checked"));                    var checkedStatus = this.checked;                    $('body').find(':checkbox.product-check').each(function () {                        $(this).prop('checked', checkedStatus);                    });                });            });            function initProductsCsv() {                var modalUploadCsv = $("#modal-upload-csv");                var resultUploadCsv = modalUploadCsv.find('.upload-results');                $("#do-upload-csv").mupload({                    buttonText: "<i class=\"clip-folder\"></i> Upload spreadsheet",                    url: "products.csv",                    useJsonPut: false,                    oncomplete: function (data, name, href) {                        flog("oncomplete:", data.result.data, name, href);                        resultUploadCsv.find('.num-updated').text(data.result.data.numUpdated);                        resultUploadCsv.find('.num-inserted').text(data.result.data.numInserted);                        resultUploadCsv.find('.num-unmatched').text(data.result.data.unmatched.length);                        showUnmatched(resultUploadCsv, data.result.data.unmatched);                        resultUploadCsv.show();                        Msg.success("Upload completed. Please review any unmatched members below, or refresh the page to see the updated list of products");                        $("#productsTableContainer").reloadFragment();                    }                });            }            function initVariantsCsv() {                var modalUploadCsv = $("#modal-upload-variants-csv");                var resultUploadCsv = modalUploadCsv.find('.upload-results');                $("#do-upload-variants-csv").mupload({                    buttonText: "<i class=\"clip-folder\"></i> Upload spreadsheet",                    url: "variants.csv",                    useJsonPut: false,                    oncomplete: function (data, name, href) {                        flog("oncomplete:", data.result.data, name, href);                        resultUploadCsv.find('.num-updated').text(data.result.data.numUpdated);                        resultUploadCsv.find('.num-inserted').text(data.result.data.numInserted);                        resultUploadCsv.find('.num-unmatched').text(data.result.data.unmatched.length);                        showUnmatched(resultUploadCsv, data.result.data.unmatched);                        resultUploadCsv.show();                        Msg.success("Upload completed. Please review any unmatched members below, or refresh the page to see the updated list of products");                        $("#productsTableContainer").reloadFragment();                    }                });            }            function showUnmatched(resultUploadCsv, unmatched) {                var unmatchedTable = resultUploadCsv.find("table");                var tbody = unmatchedTable.find("tbody");                tbody.html("");                $.each(unmatched, function (i, row) {                    flog("unmatched", row);                    var tr = $("<tr>");                    $.each(row, function (ii, field) {                        tr.append("<td>" + field + "</td>");                    });                    tbody.append(tr);                });            }            function deleteProducts(listToDelete) {                $.ajax({                    type: 'POST',                    dataType: 'json',                    url: window.location.pathname,                    data: {                        deleteProducts: listToDelete,                    },                    success: function (data) {                        if (data.status) {                            Msg.info(data.messages);                            $("#productTableBody").reloadFragment();                        } else {                            Msg.error("An error occured deleting the products. Please check your internet connection");                        }                    },                    error: function (resp) {                        Msg.error("An error occured deleting the products");                    }                });            }        </script>    </body></html>