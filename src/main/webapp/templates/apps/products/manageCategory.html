<html xmlns="http://www.w3.org/1999/xhtml">    <head>        <title>Manage Sales Data Series</title>        <style>            .search, .search-group {                float: left;            }            .avatar {                max-width: 250px;            }        </style>        <script type="text/javascript" src="/static/bootstrap-upcrop-image/1.0/bootstrap-upcrop-image.js">//</script>        <link href="https://gitcdn.github.io/bootstrap-toggle/2.1.0/css/bootstrap-toggle.min.css" rel="stylesheet"/>        <script src="https://gitcdn.github.io/bootstrap-toggle/2.1.0/js/bootstrap-toggle.min.js">//</script>    </head>    <body class="">        <form name="frmDetails" action="." method="post" class="form-horizontal category-form">            <div class="row">                <div class="col-md-7">                    <div class="form-group">                        <label class="control-label col-md-3" for="title">Title</label>                        <div class="col-md-9">                            <input type="text" name="title" id="title" value="$page.category.title" placeholder="" class="required form-control"  required="true" />                        </div>                    </div>                    <div class="form-group">                        <label class="control-label col-md-3" for="parentCategory">Parent Category</label>                        <div class="col-md-9">                            <select class="form-control" name="parentCategory">                                <option value="">None</option>                                #foreach($cat in $page.categories)                                #if($page.category.id != $cat.id)                                $formatter.option($cat.id, $cat.title, $page.category.parentCategory.id)                                #end                                #end                            </select>                        </div>                    </div>                    <div class="form-group">                        <label class="control-label col-md-3" for="multiplier">Multiplier</label>                        <div class="col-md-9">                            <input type="text" name="multiplier" id="multiplier"                                   value="$!page.category.multiplier" placeholder=""                                   class="form-control" />                        </div>                    </div>                    <div class="form-group">                        <label class="control-label col-md-3" for="title">Hidden<small>Won't be displayed in the reward stores</small></label>                        <div class="col-md-1">                            $formatter.checkbox("hidden", "hidden", $!page.category.hidden)                        </div>                    </div>                    <div class="form-group">                        <label class="control-label col-md-3" for="notes">Notes<small>For internal use only</small></label>                        <div class="col-md-9">                            <textarea cols="100" name="notes" id="notes" rows="10" placeholder="" class="form-control">$!page.category.notes</textarea>                        </div>                    </div>                    <div class="form-group">                        <div class="col-md-offset-3 col-md-9">                            <button class="btn btn-sm btn-success" type="submit">                            <i class="fa fa-save"></i>                            Save                            </button>                        </div>                    </div>                </div>                <div class="col-md-5">                    <div>                        <p>                        <a href="/products/?dataQuery=category" class="btn btn-info">                            <i class="fa fa-list"></i>                            $page.numProducts products                        </a>                        </p>                    </div>                    <div class="well well-avatar">                        <div id="cat-image">                            #set($image = $page.imageHref )                            #if( $image )                            <img src="$image" class="avatar" />                            #else                            <div style="width: 100%; height: 200px; border: solid lightgray 1px"></div>                            #end                        </div>                        <br/>                        <button id="btn-change-ava" class="btn btn-success">Change photo</button>                    </div>                </div>            </div>        </form>        <script type="text/javascript">            $(function () {                $("form.category-form").forms({                    onSuccess: function (resp) {                        if (resp.status) {                            Msg.info("Saved ok");                            if (resp.nextHref) {                                window.location = "../" + resp.nextHref;                            }                        } else {                            Msg.error("An error occured saving: " + resp);                        }                    }                });                initSearchProduct();                $("#table-products").on("change", ".product-toggle", function (e) {                    var target = $(e.target);                    var product = target.closest("tr").find("a");                    var productName = product.attr("href");                    productName = getFileName(productName);                    var v = target.prop("checked");                    updateProductIncluded(productName, product.html(), v);                });                initCropping();                $('body').on('change', '.product-all-toggle', function (e) {                    e.preventDefault();                    var btn = $(this);                    Msg.info('Updating all products');                    var isChecked = btn.is(':checked');                    var ids = [];                    var allIds = $('.product-toggle');                    allIds.each(function (count, item) {                        ids.push($(item).data('pid'));                    });                    updateProductSelected(ids.join(','), isChecked);                });            });            function initCropping() {                $('#btn-change-ava').upcropImage({                    url: window.location.pathname, // this is actually the default value anyway                    onCropComplete: function (resp) {                        flog("onCropComplete:", resp, resp.nextHref);                        $(".profile-photo img, img.avatar").attr("src", resp.nextHref);                        $(".modal").modal("hide");                    },                    onContinue: function (resp) {                        flog("onContinue1:", resp);                        $.ajax({                            url: window.location.pathname,                            type: 'POST',                            dataType: 'json',                            data: {                                uploadedHref: resp.result.nextHref,                                applyImage: true                            },                            success: function (resp) {                                flog("success");                                if (resp.status) {                                    Msg.info("Done");                                    $("#cat-image").reloadFragment();                                } else {                                    Msg.error("An error occured processing the product image");                                }                            },                            error: function () {                                alert('Sorry, we couldn\'t save your profile image.');                            }                        });                        flog("done ajax");                    }                });            }            function initSearchProduct() {                $("#product-query").keyup(function () {                    typewatch(function () {                        flog("do search");                        doProductSearch();                    }, 500);                });                $('body').on('change', '.filterType', function (e) {                    doProductSearch();                });                $("#search-group").change(function () {                    doProductSearch();                });            }            function doProductSearch() {                flog("doProductSearch");                var query = $("#product-query").val();                var orgId = $("#search-library").val();                var all = $('.filterType').val();                flog("doSearch", query, orgId);                var newUrl = window.location.pathname + "?q=" + query + "&l=" + orgId + "&incl=" + all + "#products-tab";                window.history.replaceState("", "", newUrl);                $.ajax({                    type: 'GET',                    url: newUrl,                    success: function (data) {                        flog("success", data);                        var fragment = $(data).find("#products-list");                        flog("frag", fragment, $("#products-list"));                        $("#products-list").replaceWith(fragment);                    },                    error: function (resp) {                        Msg.error("An error occured doing the user search. Please check your internet connection and try again");                    }                });            }            function updateProductIncluded(productId, productCode, included) {                $.ajax({                    type: "POST",                    url: window.location.pathname,                    datatype: "json",                    data: {                        productId: productId,                        included: included                    },                    success: function (response) {                        flog("response", response, response.status);                        if (response.status) {                            if (included) {                                Msg.info("Added " + productCode);                            } else {                                Msg.info("Removed " + productCode);                            }                        } else {                            Msg.error("There was an error changing the product inclusion status");                        }                    },                    error: function (event, XMLHttpRequest, ajaxOptions, thrownError) {                        flog('error saving moduleStatus', event, XMLHttpRequest, ajaxOptions, thrownError);                        Msg.error("There was an error changing the product inclusion status");                    }                });            }            function updateProductSelected(productIds, included) {                var data = {};                if (included) {                    data['addProductIds'] = productIds;                } else {                    data['removeProductIds'] = productIds;                }                $.ajax({                    type: "POST",                    url: window.location.pathname,                    datatype: "json",                    data: data,                    success: function (response) {                        flog("response", response, response.status);                        if (response.status) {                            Msg.info(response.messages[0]);                            var ids = productIds.split(',');                            $.each(ids, function (val) {                                $('.product-toggle[data-pid=' + val + ']').prop('checked', included);                            });                        } else {                            Msg.error("There was an error changing the product status");                        }                    },                    error: function (event, XMLHttpRequest, ajaxOptions, thrownError) {                        flog('error saving moduleStatus', event, XMLHttpRequest, ajaxOptions, thrownError);                        Msg.error("There was an error changing the product inclusion status");                    }                });            }        </script>    </body></html>