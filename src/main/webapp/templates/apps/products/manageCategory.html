<html xmlns="http://www.w3.org/1999/xhtml">    <head>        <title>Manage Sales Data Series</title>        <style>            .search, .search-group {                float: left;            }            .avatar {                max-width: 250px;            }        </style>        <script type="text/javascript" src="/static/bootstrap-upcrop-image/1.0/bootstrap-upcrop-image.js">//</script>        <link href="https://gitcdn.github.io/bootstrap-toggle/2.1.0/css/bootstrap-toggle.min.css" rel="stylesheet"/>        <script src="https://gitcdn.github.io/bootstrap-toggle/2.1.0/js/bootstrap-toggle.min.js">//</script>    </head>    <body class="">        <form name="frmDetails" action="." method="post" class="form-horizontal category-form">            <div class="pull-right page-action">                <button class="btn btn-sm btn-primary" type="submit">Save changes</button>            </div>            <div class="tabbable">                <ul class="nav nav-tabs tab-bricky">                    <li><a data-toggle="tab" href="#general">General</a></li>                    <li><a data-toggle="tab" href="#products">Products</a></li>                </ul>                <div class="tab-content">                    <div id="general" class="tab-pane">                        <div class="row">                            <div class="col-md-7">                                <div class="form-group">                                    <label class="control-label col-md-3" for="title">Title</label>                                    <div class="col-md-9">                                        <input type="text" name="title" id="title" value="$page.category.title" placeholder="" class="required form-control"  required="true" />                                    </div>                                </div>                                <div class="form-group">                                    <label class="control-label col-md-3" for="parentCategory">Parent Category</label>                                    <div class="col-md-9">                                        <select class="form-control" name="parentCategory">                                            <option value="">None</option>                                            #foreach($cat in $page.categories)                                                #if($page.category.id != $cat.id)                                                    $formatter.option($cat.id, $cat.title, $page.category.parentCategory.id)                                                #end                                            #end                                        </select>                                    </div>                                </div>							<div class="form-group">								<label class="control-label col-md-3" for="title">Multiplier</label>								<div class="col-md-9">									<input type="text" name="multiplier" id="multiplier"										value="$!page.category.multiplier" placeholder=""										class="form-control" />								</div>							</div>							<div class="form-group">                                    <label class="control-label col-md-3" for="notes">Notes<small>For internal use only</small></label>                                    <div class="col-md-9">                                        <textarea cols="100" name="notes" id="notes" rows="10" placeholder="" class="form-control">$!page.category.notes</textarea>                                    </div>                                </div>                            </div>                            <div class="col-md-5">                                <div class="well well-avatar">                                    <div id="cat-image">                                        #set($image = $page.imageHref )                                        #if( $image )                                        <img src="$image" class="avatar" />                                        #else                                        <div style="width: 100%; height: 200px; border: solid lightgray 1px"></div>                                        #end                                    </div>                                    <br/>                                    <button id="btn-change-ava" class="btn btn-success">Change photo</button>                                </div>                            </div>                        </div>                    </div>                    <!-- End content of General tab -->                    <div id="products" class="tab-pane">                        <div class="panel panel-default">                            <div class="panel-heading">                                <i class="fa fa-cog"></i> Products                            </div>                            <div class="panel-body">                                <div class="clearfix form-horizontal">                                    <div class="row">                                        <div class="col-sm-3">                                            <p class="input-group search input-group-sm col-sm-12">                                                <input type="text" id="product-query" class="form-control" placeholder="Search for products here" value="" />                                                <span class="input-group-btn">                                                    <button class="btn btn-sm btn-default" type="button" data-type="clearer" data-target="#product-query">                                                        <i class="fa fa-times"></i>                                                    </button>                                                </span>                                            </p>                                        </div>                                        <div class="col-md-3">                                            <div class="form-group">                                                <label for="search-group" class="col-sm-2 control-label">Products:</label>                                                <div class="col-sm-10">                                                    <select name="filterType" class="filterType form-control input-sm">                                                        <option value="false">Included</option>                                                        <option value="true">All</option>                                                        <option value="notAllocated">Not Allocated</option>                                                    </select>                                                </div>                                            </div>                                        </div>                                        <div class="col-md-3">                                            <div class="form-group">                                                <label for="search-group" class="col-sm-2 control-label">Library:</label>                                                <div class="col-sm-10">                                                    <select name="searchOrg" id="search-library" class="form-control input-sm">                                                        <option value="">My library</option>                                                        #foreach($org in $page.parentOrgsWithProducts)                                                        <option value="$org.id">$org.title</option>                                                        #end                                                    </select>                                                </div>                                            </div>                                        </div>                                    </div>                                </div>                                <div class="table-responsive">                                    <table id="table-products" class="table table-striped table-hover">                                        <colgroup>                                            <col width="15%" />                                            <col width="" />                                            <col width="" />                                            <col width="15%" />                                            <col width="16%" />                                            <col data-sort="false" width="100px" />                                        </colgroup>                                        <thead>                                            <tr>                                                <th>Code</th>                                                <th>Title</th>                                                <th></th>                                                <th></th>                                                <th></th>                                                <th class="text-center">                                                    <input class="product-all-toggle" type="checkbox" />                                                </th>                                            </tr>                                        </thead>                                        <tbody id="products-list">                                            #foreach($p in $page.searchProducts( $request.params.q, $request.params.incl, $request.params.l ) )                                            <tr>                                                <td><a href='/products/$p.productId'>$p.name</a></td>                                                <td>$formatter.htmlEncode($p.title)</td>                                                <td></td>                                                <td></td>                                                <td></td>                                                <td class="text-center">                                                    <input $formatter.ifTrue( $p.inCat, "checked", "" ) data-pid="$p.productId" class="product-toggle" type="checkbox" value="true" />                                                </td>                                            </tr>                                            #end                                        </tbody>                                    </table>                                </div>                            </div>                        </div>                    </div>                </div>            </div>        </form>        <script type="text/javascript">            $(function () {                $("form.category-form").forms({                    onSuccess: function (resp) {                        if (resp.status) {                            Msg.info("Saved ok");                            if (resp.nextHref) {                                window.location = "../" + resp.nextHref;                            }                        } else {                            Msg.error("An error occured saving: " + resp);                        }                    }                });                initSearchProduct();                $("#table-products").on("change", ".product-toggle", function (e) {                    var target = $(e.target);                    var product = target.closest("tr").find("a");                    var productName = product.attr("href");                    productName = getFileName(productName);                    var v = target.prop("checked");                    updateProductIncluded(productName, product.html(), v);                });                initCropping();                $('body').on('change', '.product-all-toggle', function (e) {                    e.preventDefault();                    var btn = $(this);                    Msg.info('Updating all products');                    var isChecked = btn.is(':checked');                    var ids = [];                    var allIds = $('.product-toggle');                    allIds.each(function (count, item) {                        ids.push($(item).data('pid'));                    });                    updateProductSelected(ids.join(','), isChecked);                });            });            function initCropping() {                $('#btn-change-ava').upcropImage({                    url: window.location.pathname, // this is actually the default value anyway                    onCropComplete: function (resp) {                        flog("onCropComplete:", resp, resp.nextHref);                        $(".profile-photo img, img.avatar").attr("src", resp.nextHref);                        $(".modal").modal("hide");                    },                    onContinue: function (resp) {                        flog("onContinue1:", resp);                        $.ajax({                            url: window.location.pathname,                            type: 'POST',                            dataType: 'json',                            data: {                                uploadedHref: resp.result.nextHref,                                applyImage: true                            },                            success: function (resp) {                                flog("success");                                if (resp.status) {                                    Msg.info("Done");                                    $("#cat-image").reloadFragment();                                } else {                                    Msg.error("An error occured processing the product image");                                }                            },                            error: function () {                                alert('Sorry, we couldn\'t save your profile image.');                            }                        });                        flog("done ajax");                    }                });            }            function initSearchProduct() {                $("#product-query").keyup(function () {                    typewatch(function () {                        flog("do search");                        doProductSearch();                    }, 500);                });                $('body').on('change', '.filterType', function (e) {                    doProductSearch();                });                $("#search-group").change(function () {                    doProductSearch();                });            }            function doProductSearch() {                flog("doProductSearch");                var query = $("#product-query").val();                var orgId = $("#search-library").val();                var all = $('.filterType').val();                flog("doSearch", query, orgId);                var newUrl = window.location.pathname + "?q=" + query + "&l=" + orgId + "&incl=" + all + "#products-tab";                window.history.replaceState("", "", newUrl);                $.ajax({                    type: 'GET',                    url: newUrl,                    success: function (data) {                        flog("success", data);                        var fragment = $(data).find("#products-list");                        flog("frag", fragment, $("#products-list"));                        $("#products-list").replaceWith(fragment);                    },                    error: function (resp) {                        Msg.error("An error occured doing the user search. Please check your internet connection and try again");                    }                });            }            function updateProductIncluded(productId, productCode, included) {                $.ajax({                    type: "POST",                    url: window.location.pathname,                    datatype: "json",                    data: {                        productId: productId,                        included: included                    },                    success: function (response) {                        flog("response", response, response.status);                        if (response.status) {                            if (included) {                                Msg.info("Added " + productCode);                            } else {                                Msg.info("Removed " + productCode);                            }                        } else {                            Msg.error("There was an error changing the product inclusion status");                        }                    },                    error: function (event, XMLHttpRequest, ajaxOptions, thrownError) {                        flog('error saving moduleStatus', event, XMLHttpRequest, ajaxOptions, thrownError);                        Msg.error("There was an error changing the product inclusion status");                    }                });            }            function updateProductSelected(productIds, included) {                var data = {};                if (included) {                    data['addProductIds'] = productIds;                } else {                    data['removeProductIds'] = productIds;                }                $.ajax({                    type: "POST",                    url: window.location.pathname,                    datatype: "json",                    data: data,                    success: function (response) {                        flog("response", response, response.status);                        if (response.status) {                            Msg.info(response.messages[0]);                            var ids = productIds.split(',');                            $.each(ids, function (val) {                                $('.product-toggle[data-pid=' + val + ']').prop('checked', included);                            });                        } else {                            Msg.error("There was an error changing the product status");                        }                    },                    error: function (event, XMLHttpRequest, ajaxOptions, thrownError) {                        flog('error saving moduleStatus', event, XMLHttpRequest, ajaxOptions, thrownError);                        Msg.error("There was an error changing the product inclusion status");                    }                });            }        </script>    </body></html>