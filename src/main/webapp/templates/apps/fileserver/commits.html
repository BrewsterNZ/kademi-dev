<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Commit History</title>
        <link href="manageRepos.css" rel="stylesheet" type="text/css" />
        <script type="text/javascript" src="manageRepos.js">//</script>
        <link href="/static/history/jquery.history.css" rel="stylesheet" type="text/css" />
        <script type="text/javascript" src="/static/history/jquery.history.js">//</script>
    </head>
    <body>
        <section id="manageRepos" class="MainContent">
            <div style="border: solid lightgray 1px; padding: 20px; background: #EEE" class="pull-right">
                <p>You can update the hash directly</p>
                <a href="./" class="Btn set-hash">Set hash</a>
            </div>            
            <p>Here is a list of changes made to this branch. You can restore the branch
                to the state of any of the commits below by clicking the Restore icon. The current state wont be lost, it will
                just become the previous version</p>
            <p>Click on the commit number to view the branch in that state without restoring it.</p>
            <br/>
            <table class="" style="width: 80%; text-align: left">
                <thead>
                    <tr>
                        <th>Restore</th>
                        <th>Link</th>
                        <th>Hash</th>
                        <th>User</th>
                        <th>Edited</th>
                    </tr>
                </thead>
                #foreach($c in $page.commits)
                <tr>
                    <td><button class='history' title='Restore this version' rel="$c.commit.itemHash">Rollback</button></td>
                    <td>$c.link</td>
                    <td>$c.commit.itemHash</td>
                    <td>$c.commit.editor.name</td>
                    <td><abbr title="$formatter.formatDateISO8601($c.commit.createdDate)" class="info timeago">$c.commit.createdDate</abbr></td>
                </tr>
                #end

            </table>
        </section>
        <script type="text/javascript">
            jQuery(function() {
                jQuery("abbr.timeago").timeago();
                $("button.history").click(function(e) {
                    var node = $(e.target);
                    var hash = node.attr("rel");
                    confirmRevert(hash, null, {
                        getPageUrl: function() {
                            return "."
                        },
                        afterRevertFn: function() {
                            window.location.reload();
                        }
                    });
                });
                $(".set-hash").click(function(e) {
                    e.preventDefault();
                    var link = $(e.target).closest("a");
                    var newHash = prompt("Please enter a new hash");
                    if (newHash != null && newHash.trim().length > 0) {
                        setHash(link, newHash);
                    }
                });
            });
            function setHash(link, newHash) {
                log("setHash", link, newHash, link);
                $.ajax({
                    type: 'POST',
                    data: {newHash: newHash},
                    url: link.attr("href"),
                    dataType: "json",
                    success: function(data) {
                        log("done", data);
                        if (data.status) {
                            window.location.reload();
                        } else {
                            alert("An error occured updating the branch: " + data.messages);
                        }
                    },
                    error: function(resp) {
                        alert("Sorry, couldnt update public access: " + resp);
                    }
                });
            }
        </script>
    </body>
</html>