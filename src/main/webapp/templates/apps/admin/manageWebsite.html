<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>$view.title</title>
        <link href="manageApps.css" rel="stylesheet" type="text/css" />
        <link href="manageWebsite.css" rel="stylesheet" type="text/css" />
        <!-- <link rel="stylesheet" href="/theme/assets/plugins/bootstrap-switch/static/stylesheets/bootstrap-switch.css"/> -->
        <script type="text/javascript" src="manageWebsite.js">//</script>
        <script type="text/javascript" src="manageMenu.js">//</script>
        <script type="text/javascript" src="manageApps.js">//</script>
        <script type="text/javascript" src="/static/js/managePublishing.js">//</script>
        <script type="text/javascript" src="/static/bootstrap-upcrop-image/1.0/bootstrap-upcrop-image.js">//</script>
        <script type="text/javascript" src="/static/js/jquery.milton-upload.js">//</script>

        <!-- <script src="/theme/assets/plugins/bootstrap-switch/static/js/bootstrap-switch.min.js">//</script> -->
        <!-- <script type="text/javascript" src="/templates/themes/admin/prompt.js">//</script> -->
        <style>
            .btn-file {
                position: relative;
                overflow: hidden;
            }
            .btn-file input[type=file] {
                position: absolute;
                top: 0;
                right: 0;
                min-width: 100%;
                min-height: 100%;
                font-size: 100px;
                text-align: right;
                filter: alpha(opacity=0);
                opacity: 0;
                background: red;
                cursor: inherit;
                display: block;
            }
            .file-input {
                background-color: white !important;
                cursor: text !important;
            }
        </style>
    </head>

    <body class="manageWebsite">
        #set($currentBranch = $page.closest("branch"))
        <div class="btn-group publishing pull-right">
            #if( $currentBranch.live )
            <a href="../manageBranches" class="islive btn btn-sm btn-danger">
                <i class="fa fa-gear"></i>
                LIVE
            </a>
            #else
            <a href="${currentBranch.href}publish" class="publish btn btn-sm btn-success">
                <i class="glyphicon glyphicon-ok-sign"></i>
                PUBLISH
            </a>
            <a href="../manageBranches" class="btn btn-primary btn-sm">
                <i class="fa fa-gear"></i>
                Manage versions
            </a>
            #end

            <a class="btn btn-primary btn-sm dropdown-toggle" data-toggle="dropdown" href="#">
                <b>Editing version:</b>
                $currentBranch.name
                <span class="caret"></span>
            </a>
            <ul role="menu" class="dropdown-menu list branches">
                #foreach($b in $page.closest("branch").parent.children.ofType.branch)
                <li role="presentation" class="list-item">
                    <aside class="list-item-controller">
                        <a href="#" class="copy btn btn-xs btn-primary pull-right" title="Copy this to a new version"><i class="fa fa-copy"></i></a>
                        #if( $b.live )

                        #else
                        <a href="${b.href}" class="hide-branch pull-right btn-xs btn btn-warning" title="Hide this version. Can be restored from the manage versions screen"><i class="clip-eye"></i></a>
                        #end
                    </aside>
                    <a href="${b.href}" class="branch noclear">
                        $b.name
                    </a>
                </li>
                #end
            </ul>
        </div>

        <div class="btn-group">
            <a target='_blank' href='$page.href?goto=' class="btn btn-sm btn-success">
                <i class="fa fa-arrow-circle-right"></i> View website
            </a>
            <a href='/repositories/$page.closest("website").name/$page.name' class="btn btn-sm btn-success">
                <i class="fa fa-edit"></i> Edit pages
            </a>
            <div class="btn-group">
                <a class="btn btn-primary btn-sm dropdown-toggle" data-toggle="dropdown" href="#">
                    <b>Change website:</b> $page.closest("website").name
                    <span class="caret"></span>
                </a>
                <ul role="menu" class="dropdown-menu list">
                    #foreach($w in $page.closest("website").parent.children)
                    <li class="list-item"><a href="${w.href}">$w.name</a></li>
                    #end
                </ul>
            </div>
        </div>

        <div class="clearfix"></div>
        <br />
        <div class="tabbable">
            <ul class="nav nav-tabs tab-bricky" id="myTab">
                <li class="active"><a data-toggle="tab" href="#panel_details"><i class="green fa fa-home"></i> Details</a></li>
                <li class=""><a data-toggle="tab" href="#panel_theme"><i class="green fa fa-home"></i> Theme</a></li>
                <li class=""><a data-toggle="tab" href="#panel_groups"><i class="green fa fa-home"></i> Group access</a></li>
                <li class=""><a data-toggle="tab" href="#panel_mailserver"><i class="green fa fa-home"></i> Mail server</a></li>
                <li class=""><a data-toggle="tab" href="#panel_sslserver"><i class="green fa fa-home"></i> HTTPS server</a></li>
                <li class=""><a data-toggle="tab" href="#panel_apps"><i class="green fa fa-home"></i> Apps</a></li>
            </ul>

            <div class="tab-content">
                <div id="panel_details" class="tab-pane active">
                    <form name="frmDetails" action="." method="post" class="form-horizontal details" role="form">
                        <div class="alert alert-danger pageMessage">.</div>
                        <p class="clearfix text-center">
                            <span class="label label-danger"> NOTE</span>
                            <span><i>Changes in this section apply immediately to all versions of the website, including the live version</i></span>
                            <br/><br/>
                        </p>

                        <!--<div class="form-group">
                            <label for="websiteName" class="col-sm-3 control-label">Website ID</label>
                            <div class="col-sm-2">
                                <input type="text" name="name" id="websiteName" value="$!page.website.name" class="required simpleChars form-control" required="true" />
                            </div>
                            <div class="col-sm-4">
                                <small>This is a code which forms part of the address to your site ie <b>id</b>.olhub.com. It must be unique.</small>
                            </div>
                        </div>-->

                        <div class="form-group">
                            <label for="websiteTitle" class="col-sm-3 control-label">Display name</label>
                            <div class="col-sm-6">
                                <input type="text" name="title" id="websiteTitle" value="$!page.website.title" class="required form-control" required="true" />
                                <small>This is the publicly visible name of your website</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="domainName" class="col-sm-3 control-label">Domain name</label>
                            <div class="col-sm-6">
                                <input type="text" name="domainName" id="domainName" value="$!page.website.domainName" class="simpleChars form-control" />
                                <small>If you have your own domain enter it here - eg www.mycompany.com. Update your DNS settings with a CNAME record pointing to www.olhub.com</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="aliasTo" class="col-sm-3 control-label">Alias for</label>
                            <div class="col-sm-6">
                                <select name="aliasTo" id="aliasTo" class="form-control">
                                    <option value="">[None]</option>
                                    #foreach($w in $page.otherWebsites)
                                    $formatter.option($w.name, $w.name, $!page.website.aliasTo.name)
                                    #end
                                </select>
                                <small>If selected this website will be an alias for accessing the selected site.</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="redirectTo" class="col-sm-3 control-label">Redirect to</label>
                            <div class="col-sm-6">
                                <input type="url" name="redirectTo" value="$!page.website.redirectTo" class="href form-control"/>
                                <small>If you want visitors to this site to be immediately redirected elsewhere, enter the full address to redirect to here.</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="forceHttps" class="col-sm-3 control-label">Force HTTPS</label>
                            <div class="col-sm-6">
                                <select name="forceHttps" id="aliasTo" class="form-control">
                                    $formatter.option(false, "No", $page.forceHttps)
                                    $formatter.option(true, "Yes", $page.forceHttps)
                                </select>
                                <small>If you want visitors to this site to be forced to use HTTPS.</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-offset-3 col-sm-6">
                                <button type="submit" class="btn btn-sm btn-success">Save details</button>
                            </div>
                        </div>
                    </form>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <i class="clip-pictures"></i>Website image
                        </div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-xs-4 col-md-2">
                                    <button id="btn-change-ava" class="btn btn-success">Select image</button>
                                </div>
                                <div id="websiteImage">
                                    #if( $page.imageHash )
                                    <div class="col-xs-6 col-md-3 product-image-thumb">
                                        <div class="thumbnail"><img src="/_hashes/files/$page.imageHash/alt-150-150.png"/></div>
                                    </div>
                                    #end
                                </div>
                            </div>
                        </div>
                    </div>

                </div> <!-- End Details -->

                <div id="panel_theme" class="tab-pane">
                    <form name="frmDetails" action="." method="post" class="form-horizontal details" role="form">
                        <div class="alert alert-danger pageMessage">.</div>
                        <div class="form-group">
                            <label for="" class="col-sm-3 control-label">Theme</label>
                            <div class="col-sm-9">
                                <a class="btn btn-blue btn-sm" href="themeSelect">
                                    #set($theme = $page.currentTheme)
                                    #set($publicTheme = "")
                                    #if( $theme )
                                    #if( $theme.previewImage )
                                    #set($publicTheme = $theme.name)
                                    <img style="width: 150px" src="/templates/themes/$theme.name/$theme.previewImage" />
                                    #else
                                    #set($publicTheme = $theme.name)
                                    $theme.title
                                    #end
                                    #else
                                    No selected theme
                                    #end
                                    <i class="fa fa-arrow-circle-right"></i>
                                </a>
                                <input type="hidden" name="publicTheme" value="$publicTheme"/>
                                <a class="btn btn-blue btn-sm pull-right" href="themeSelect">Browse the theme library <i class="fa fa-arrow-circle-right"></i></a>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="logo" class="col-sm-3 control-label">Logo</label>
                            <div class="col-sm-6">
                                <input type="text" class="form-control toolbar-Logo" name="logo" id="logo" value="$formatter.htmlAttEncode($page.themeAttributes.logo)" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="menu" class="col-sm-3 control-label">Menu</label>
                            <div class="col-sm-6">
                                <textarea id="menu" name="menu" class="form-control limited" rows="5">$!page.themeAttributes.menu</textarea>
                            </div>
                        </div>
                        #foreach( $customField in $page.customFields )
                        <div class="form-group">
                            <label for="menu" class="col-sm-3 control-label">$customField.text</label>
                            <div class="col-sm-6">
                                $customField.html( $page.themeAttributes.get($customField.name) )
                            </div>
                        </div>
                        #end
                        <div class="form-group">
                            <div class="col-sm-offset-3 col-sm-6">
                                <button type="submit" class="btn btn-sm btn-success">Save Changes</button>
                            </div>
                        </div>
                    </form>
                </div> <!-- End theme -->

                <div id="panel_groups" class="tab-pane">
                    <div class="Content Recipient">
                        <button class="btn btn-sm btn-default AddGroup" data-toggle="modal" data-target="#modalGroup"><i class="fa fa-plus"></i> Add/remove groups</button>
                        <p class="clearfix"></p>
                        <br />
                        <div id="group-list" class="clearfix GroupList">
                            #foreach($g in $page.selectedGroups)
                            <div class="alert alert-info">
                                <span class="fa fa-users"></span>
                                <a href="/groups/$g.name/members">$g.name</a>
                                #if( $g.groupType == "P" )
                                - Primary group
                                #elseif( $g.groupType == "M" )
                                - Mailing list
                                #elseif( $g.groupType == "S" )
                                - Subscription
                                #end
                                -
                                #if( $g.registrationMode == "o" )
                                Open group
                                #elseif( $g.registrationMode == "c" )
                                Closed group
                                #elseif( $g.registrationMode == "a" )
                                Administrator approval group
                                #else
                                No registration mode has been set
                                #end
                            </div>
                            #end
                        </div>
                    </div>
                </div> <!-- End groups -->

                <div id="panel_mailserver" class="tab-pane">
                    <div class="alert alert-danger pageMessage">.</div>

                    <h3>Setting up DNS for email</h3>
                    <p>Spam is a big problem, and most email applications and servers try to prevent it. There are several
                        ways for email senders increase the level of trust with email receivers, to increase the number of emails
                        that get through. The main ones are:
                    </p>
                    <h4>SPF</h4>
                    <p>
                        Add a line like this to your DNS records:
                    </p>
                    <pre class="prettyprint">mydomain.com. 600 IN TXT "v=spf1 include:_spf.olhub.com ~all"</pre>

                    <h4>DKIM</h4>
                    <p class="">DKIM is a way to increase the number of emails which reach your recipients, by
                        reducing your spam score. It does this by adding a digital signature to each email signed
                        signed and verified by your DNS.</p>
                    <p>
                        To use DKIM you need to generate public and private keys as below ,and add the public key to your DNS, and then insert
                        your private key below.
                    </p>
                    <p>To get a DKIM certificate and <a href="http://docs.kademi.co/howtos/devs/setting-up-dkim.html" target="_blank">setup your domain for DKIM please see here</a></p>
                    #set($hasDkim = false)
                    #if($page.dkimPrivateKey && $page.dkimSelector)
                    #set($hasDkim = true)
                    <table class="table table-bordered">
                        <tr>
                            <th colspan="2">Current DKIM Settings</th>
                        </tr>
                        <tr>
                            <th>Selector</th>
                            <td>${page.dkimSelector}</td>
                        </tr>
                        <tr>
                            <th>Private key</th>
                            <td>
                                $formatter.truncate($page.dkimPrivateKey, 40)
                            </td>
                        </tr>
                    </table>

                    <p>Add a TXT record to your DNS server or zone file as follows:</p>

                    <table class="table table-bordered" >
                        <tr>
                            <th colspan="2">Create a DNS TXT record</th>
                        </tr>

                        <tr>
                            <td>
                                ${page.dkimSelector}._domainKey
                            </td>
                            <td>
                                <textarea class="form-control" style="width: 100%; height: 120px">$page.dKimDnsTxt</textarea>
                            </td>
                        </tr>

                    </table>

                    #end
                    <div class='row'>
                        <div class="col-sm-6">
                            #if($hasDkim)
                            #set($btnText = "Generate new DKIM key")
                            #else
                            #set($btnText = "Generate DKIM key")
                            #end
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-success newCategory" data-toggle="modal" data-target="#modal-gen-dkim"><i class="fa fa-plus"></i> $btnText</button>
                                <button type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu pull-right" role="menu">
                                    <li><a href="#" title="Upload categories CSV" data-toggle="modal" data-target="#modalUploadPrivateKey"><i class="glyphicon glyphicon-upload"></i> Upload Private Key</a></li>
                                </ul>
                            </div>
                            #if($hasDkim)
                            <a href="#" class="btn btn-sm btn-danger btn-delete-dkim"><i class="fa fa-times"></i> Delete DKIM Key</a>
                            #end
                            <a href="#" class="btn btn-sm btn-info" data-toggle="modal" data-target="#modal-send-test"><i class="fa fa-envelope"></i> Send Test Email</a>
                        </div>
                    </div>
                </div>

                <div id="panel_sslserver" class="tab-pane">
                    <p>
                        <a href="#" class="btn btn-sm btn-success" data-toggle="modal" data-target="#addWebsiteHttpsModal" ><i class="fa fa-plus"></i> Configure New HTTPS Certificate</a>
                    </p>

                    <div class="modal fade" id="addWebsiteHttpsModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="myModalLabel">Create new HTTPS Configuration </h4>
                        </div>
                        <div class="modal-body">
                            <form class="form-horizontal" method="POST" action=".">
                                <div id="certificate-body">
                                    <div class="form-group">
                                        <label for="title" class="col-sm-3 control-label">Title</label>
                                        <div class="col-sm-8">
                                            <input type="text" class="form-control regex required" required="true" id="title" name="title"  data-regex="^[a-zA-Z0-9-]+$" />
                                            <span class="help-block"><small>Simple characters only, no punctuation, dots, etc, all lower case, not a domain name</small></span>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-sm btn-primary" data-type="form-submit">Create</button>
                        </div>
                    </div><!-- /.modal -->

                    <table id="certificate-types-table" class="table table-striped table-hover">
                        <colgroup>
                            <col width="" />
                            <col width="" />
                            <col width="" />
                            <col width="" />
                            <col width="" />
                            <col width="" />
                            <col width="100px" />
                            <col width="180px" />
                        </colgroup>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Start Date</th>
                                <th>Expiry Date</th>
                                <th class="text-center">Certificate</th>
                                <th class="text-center">Private Key</th>
                                <th>Created By</th>
                                <th>Status</th>
                                <th>Chain Certificates</th>
                                <th class="action">Action</th>
                            </tr>
                        </thead>
                        <tbody id="certificates-body">
                            #foreach($cer in $page.certificates)
                            <tr>
                                <td>$cer.title</td>
                                <td>$formatter.formatDate($cer.startDate)</td>
                                <td>$formatter.formatDate($cer.expiryDate)</td>
                                #set($certS = $page.getCertificateStatus($cer))
                                #if($certS == "notvalid")
                                <td class="text-center lead"><i title="This certificate is not valid for the current domain name." style="color:red" class="fa fa-times-circle text-muted"></i></td>
                                #elseif($certS == "selfsigned-notvalid")
                                <td class="text-center lead"><i title="This certificate is not valid for the current domain name. This certificate if self-signed." style="color:red" class="fa fa-times-circle text-muted"></i></td>
                                #elseif($certS == "valid")
                                <td class="text-center lead"><i title="This certificate is valid for the current domain name." style="color:green" class="fa fa-check-circle text-muted"></i></td>
                                #elseif($certS == "selfsigned-valid")
                                <td class="text-center lead"><i title="This certificate is valid for the current domain name. This certificate if self-signed." style="color:orange" class="fa fa-check-circle text-muted"></i></td>
                                #elseif($certS == "none")
                                <td class="text-center lead"><i title="No certificate has been uploaded." class="fa fa-exclamation-circle text-muted"></i></td>
                                #end
                                #set($pkS = $page.getPrivateKeyStatus($cer))
                                #if($pkS == "none")
                                <td class="text-center lead"><i title="No private key has been uploaded" class="fa fa-exclamation-circle text-muted"></i></td>
                                #elseif($pkS == "no-certificate")
                                <td class="text-center lead"><i title="Private key present but no certificate has been uploaded" style="color:green" class="fa fa-exclamation-circle text-muted"></i></td>
                                #elseif($pkS == "valid")
                                <td class="text-center lead"><i title="Private key is valid for current certificate" style="color:green" class="fa fa-check-circle text-muted"></i></td>
                                #elseif($pkS == "not-valid")
                                <td class="text-center lead"><i title="This private is not valid for the current certificate" style="color:red" class="fa fa-times-circle text-muted"></i></td>
                                #end
                                <td>$cer.createdBy.name</td>
                                <td>
                                    <div class="$cer.status">
                                        #if($cer.status == "A")
                                        <span class="label label-sm label-success">&nbspActive&nbsp</span>
                                        #else
                                        <span class="label label-sm label-warning">Inactive</span>
                                        #end
                                    </div>
                                </td>

                                <td>
                                    <a class= "btn btn-sm btn-info" data-toggle="collapse" href="#rootCert-$cer.id" aria-expanded="false" aria-controls="rootCert-$cer.id"><span class="badge rootCertCount">$cer.rootCertificates.size()</span> Modify</a>
                                </td>

                                <td class="action">
                                    <div class="btn-group btn-group-sm">
                                        <a href="#" class= "btn btn-sm btn-info pull-left" data-toggle="dropdown" ><i class="fa fa-cog"></i>&nbsp&nbspMenu</a>
                                        <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-toggle="dropdown">
                                            <span class="caret"></span>
                                            <span class="sr-only">Toggle Dropdown</span>
                                        </button>
                                        <ul role="menu" class="dropdown-menu pull-right">
                                            <li><a href="$cer.id" class="update_cert" data-toggle="modal" data-target="#modalUpdateCert">
                                                    <span class="glyphicon glyphicon-certificate"></span>
                                                    Certificate
                                                </a></li>
                                            <li><a href="$cer.id" class="update_pk" data-toggle="modal" data-target="#modalUpdatePK">
                                                    <span class="fa fa-key"></span>
                                                    Private Key
                                                </a></li>
                                            <li class="divider"></li>
                                            <li><a href="#" data-certid="$cer.id" class="viewCreateCsr" data-toggle="modal" data-target="#genCsrModal">
                                                    <span class="fa fa-ticket"></span>
                                                    Create/View CSR
                                                </a></li>
                                            <li class="divider"></li>
                                            #if($cer.status == "A")
                                            <li><a href="$cer.id" class="cert-passivate" ><i class="glyphicon glyphicon-adjust"></i> Passivate</a></li>
                                            #else
                                            <li><a href="$cer.id" class="cert-activate"><i class="glyphicon glyphicon-fire"></i> Activate</a></li>
                                            #end

                                            <li><a href="$cer.id" class="cert-delete" ><i class="glyphicon glyphicon-remove"></i> Delete</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="14">
                                    <div class="collapse accordian-body" id="rootCert-$cer.id">
                                        <div class="panel panel-default">
                                            <!-- Default panel contents -->
                                            <div class="panel-heading">Root & Intermediate Certificates</div>
                                            <div class="panel-body">
                                                <button type="button" class="btn btn-sm btn-info btn-add-root-cert" data-certid="$cer.id"><i class="fa fa-plus"></i> Upload a new certificate</button>
                                            </div>
                                            <!-- Table -->
                                            <table class="table table-striped">
                                                <colgroup>
                                                    <col width="100px" />
                                                    <col/>
                                                    <col/>
                                                    <col/>
                                                    <col/>
                                                    <col width="180px" />
                                                </colgroup>
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Title</th>
                                                        <th>Start Date</th>
                                                        <th>Expiry Date</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    #if($cer.rootCertificates.size() > 0)
                                                    #foreach($rootCert in $cer.rootCertificates)
                                                    <tr>
                                                        <td>$foreach.count</td>
                                                        <td>$!rootCert.title</td>
                                                        <td>$formatter.formatDate($rootCert.startDate)</td>
                                                        <td>$formatter.formatDate($rootCert.expiryDate)</td>
                                                        <td><a href="$rootCert.id" data-certid="$cer.id" class= "btn btn-sm btn-danger btn-delete-rootCert"><i class="fa fa-times"></i> Delete</a></td>
                                                    </tr>
                                                    #end
                                                    #else
                                                    <tr>
                                                        <td colspan="3">You have no root/intermediate certificates</td>
                                                    </tr>
                                                    #end
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            #end
                        </tbody>
                    </table>
                </div>

                <div id="panel_apps" class="tab-pane appsContainer">
                    <div class="well">
                        <p>Applications control large chunks of functionality, like forums or emails. You can add them to websites</p>
                        <p>Applications are made available for websites by activating them on your organisation's Manage Applications page. Available apps are then shown on the website apps list where they can be turned on or off as required.</p>
                    </div>

                    #set($apps = $page.apps)
                    #if( $apps.isEmpty() )
                    <div class="well">
                        <p>No applications are available. This means that the parent organisation has disabled them</p>
                    </div>
                    #end
                    <div class="appsContainer">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                #foreach($app in $apps )
                                <tr>
                                    <td class="CheckBoxWrapper">
                                        $formatter.bsswitch("chk_${app.appId}", $app.appId, $app.enabled, $app.appId)
                                        <label for="chk_${app.appId}"></label>
                                    </td>
                                    <td>
                                        <h4>$page.getTitle($app.appId)</h4>
                                        <p>$page.getSummary($app.appId)</p>
                                    </td>
                                    <td>
                                        #if( $page.hasSettings($app) )
                                        <button class="btn btn-primary btn-sm settings" data-toggle="modal" data-target="#settings_${app.appId}"><i class="fa fa-cog"></i> Settings</button>
                                        #end
                                    </td>
                                </tr>
                                #end
                            </table>
                        </div>
                    </div>

                    #foreach($app in $page.apps)
                    #if($page.hasSettings($app))
                    <div class="modal fade settings" id="settings_${app.appId}" tabindex="-1" data-focus-on="input:first" role="dialog" aria-hidden="true">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title">Edit Application: $app.appId</h4>
                        </div>
                        <div class="modal-body ModalContent">
                            <form method="POST" action="." class="form-horizontal" role="form">
                                <input type="hidden" name="settingsAppId" value="$app.appId"/>
                                #if($app.enabled)
                                #appSettings($app.appId)
                                #end
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary btn-sm" data-type="form-submit">Save</button>
                        </div>
                    </div>
                    #end
                    #end
                </div> <!-- End apps -->
            </div>
        </div>

        <div id="modalGroup" class="modal fade" tabindex="-1" data-focus-on="input:first" role="dialog" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Choose groups</h4>
            </div>
            <div class="modal-body">
                <table class="" style="width: 100%">
                    #foreach($g in $page.allGroups)
                    <tr>
                        <td>
                            <div class="col-sm-offset-3">
                                <label class="checkbox-inline">
                                    $formatter.checkbox($g.name, $page.isSelected($g) ) $g.name
                                </label>
                            </div>
                        </td>
                    </tr>
                    #end
                </table>
            </div>
        </div>

        <div id="modal-menu" class="modal fade" tabindex="-1" data-focus-on="input:first" role="dialog" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Add/edit menu</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label for="menu-text" class="control-label col-md-4">Text:</label>
                        <div class="col-md-8">
                            <input id="menu-text" class="form-control required" placeholder="Menu text" value="" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="menu-link" class="control-label col-md-4">Link:</label>
                        <div class="col-md-8">
                            <input id="menu-link" class="form-control required" placeholder="Menu link" value="" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary btn-sm btn-save-menu" data-type="form-submit">Save</button>
            </div>
        </div>

        <div class="modal fade" id="modalUpdateCert" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Upload Certificate (X.509)</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" method="POST" action="." enctype="multipart/form-data">
                    <h4>Upload a File</h4>
                    <div class="form-group">
                        <div class="col-sm-12">
                            <div class="input-group">
                                <span class="input-group-btn">
                                    <span class="btn btn-primary btn-file">
                                        Browse&hellip; <input name="file" type="file" />
                                    </span>
                                </span>
                                <input type="text" class="form-control file-input" readonly>
                            </div>
                        </div>
                    </div>
                    <hr/>
                    <h4>Upload raw text</h4>
                    <div class="form-group">
                        <input type="hidden" id = "updateCertId" name="updateCertId" value="updateCertId" />
                        <div class="col-sm-12">
                            <textarea id = "certificateTextUpdate" name="certificateTextUpdate" rows="10" class="form-control"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-sm btn-primary" data-type="form-submit">Upload</button>
            </div>
        </div><!-- /.modal -->

        <div class="modal fade" id="genCsrModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Certificate Signing Request</h4>
            </div>
            <div class="modal-body">
                <p class="well csrForm">Please fill in the details below</p>
                <form method="POST" action="." class="form-horizontal">
                    <div class="csrForm">
                        <div class="form-group">
                            <input type="hidden" name="generateCsr" value="true" />
                            <input type="hidden" name="certId" id="certId" value="" />
                            <label class="control-label col-md-4" for="csr_cn">Common Name</label>
                            <div class="col-md-8">
                                <input type="text" name="csr_cn" id="csr_cn" placeholder="Common Name" class="required form-control" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-4" for="csr_san">Subject Alternative Names
                                <small>One domain per line.</small>
                            </label>
                            <div class="col-md-8">
                                <textarea name="csr_san" id="csr_san" class="form-control" ></textarea>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-4" for="csr_ou">Organizational Unit</label>
                            <div class="col-md-8">
                                <input type="text" name="csr_ou" id="csr_ou" placeholder="Organizational Unit" class="required form-control" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-4" for="csr_o">Organization Name</label>
                            <div class="col-md-8">
                                <input type="text" name="csr_o" id="csr_o" placeholder="Organization Name" class="required form-control" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-4" for="csr_l">Location</label>
                            <div class="col-md-8">
                                <input type="text" name="csr_l" id="csr_l" placeholder="Location" class="required form-control" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-4" for="csr_st">State</label>
                            <div class="col-md-8">
                                <input type="text" name="csr_st" id="csr_st" placeholder="State" class="required form-control" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-4" for="csr_c">Country</label>
                            <div class="col-md-8">
                                <select name="csr_c" id="csr_c" class="required form-control">
                                    #set($countryCodes = $formatter.countryCodes)
                                    #foreach($cc in $countryCodes.list)
                                    $formatter.option($cc.alpha2Code, $cc.englishShortName, false)
                                    #end
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-4" for="csr_email">Email</label>
                            <div class="col-md-8">
                                <input type="text" name="csr_email" id="csr_email" placeholder="Email" class="email form-control" />
                            </div>
                        </div>
                        <div class="form-group checkbox">
                            <label class="control-label col-md-4" for="regenpk">New Private Key</label>
                            <div class="col-md-8">
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox" name="regenpk" id="regenpk" value="true" />
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="viewCsr">
                        <div>
                            <p>
                                <a href="#" class="btn btn-sm btn-success btn-gen-new-csr" ><i class="fa fa-plus"></i> Generate a new CSR</a>
                            </p>
                        </div>
                        <div id="csrTextGroup" class="form-group">
                            <div class="col-md-12">
                                <textarea id = "csrText" name="csrText" rows="12" class="form-control" readonly style="cursor: text; resize: none;"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-sm btn-primary btn-create" data-type="form-submit">Create</button>
            </div>
        </div><!-- /.modal -->

        <div class="modal fade" id="modalUpdateRootCert" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Upload Certificate (X.509)</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" method="POST" action="." enctype="multipart/form-data">
                    <h4>Upload Files</h4>
                    <div class="form-group">
                        <div class="col-sm-12">
                            <div class="input-group">
                                <span class="input-group-btn">
                                    <span class="btn btn-primary btn-file">
                                        Browse&hellip; <input name="file" type="file" multiple="true"/>
                                    </span>
                                </span>
                                <input type="text" class="form-control file-input" readonly>
                            </div>
                        </div>
                    </div>
                    <hr/>
                    <h4>Upload raw text</h4>
                    <div class="form-group">
                        <input type="hidden" name="createRootCert" value="true" />
                        <input type="hidden" class="certId" id = "certId" name="certId" value="" />
                        <div class="col-sm-12">
                            <label for="certTitle">Certificate Title</label>
                            <input type="text" id = "certTitle" name="certTitle" class="form-control"></input>
                        </div>
                        <div class="col-sm-12">
                            <label for="certText">Certificate Text</label>
                            <textarea id="certText" name="certText" rows="10" class="form-control"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-sm btn-primary" data-type="form-submit">Upload</button>
            </div>
        </div><!-- /.modal -->

        <div class="modal fade" id="modalUpdatePK" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Upload Private Key (RSA/PEM Encoded)</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" method="" action="." enctype="multipart/form-data">
                    <h4>Upload a File</h4>
                    <div class="form-group">
                        <div class="col-sm-12">
                            <div class="input-group">
                                <span class="input-group-btn">
                                    <span class="btn btn-primary btn-file">
                                        Browse&hellip; <input name="file" type="file" multiple="true"/>
                                    </span>
                                </span>
                                <input type="text" class="form-control file-input" readonly>
                            </div>
                        </div>
                    </div>
                    <hr/>
                    <h4>Upload raw text</h4>
                    <div class="form-group">
                        <input type="hidden" id = "updatePKid" name="updatePKid" value="true" />
                        <div class="col-sm-12">
                            <textarea id = "privateKeyTextUpdate" name="privateKeyTextUpdate" rows="10" class="form-control"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-sm btn-primary" data-type="form-submit">Update</button>
            </div>
        </div><!-- /.modal -->

        <div id="modal-gen-dkim" class="modal modal-sm fade" aria-hidden="true" tabindex="-1">
            <div class="modal-header">
                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>
                <h4 class="modal-title">Generate DKIM Key</h4>
            </div>
            <div class="modal-body">
                <form method="POST" action="." class="form-horizontal">
                    <div class="alert alert-danger" role="alert">
                        If you are currently authenticating email from this domain, generating a new TXT record might cause email's to fail until the DNS record has been updated.
                    </div>
                    <input type="hidden" name="genDkim" value="true"/>
                    <div class="form-group">
                        <label class="col-md-3 control-label" for="dkimsel">DKIM Selector</label>
                        <div class="col-md-8">
                            <input type="text" name="dkimsel" value="" placeholder="DomainKey Selector (e.g. key1)" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 control-label" for="dkimKeySize">Key Size</label>
                        <div class="col-md-8">
                            <label class="radio-inline">
                                <input type="radio" name="dkimKeySize" value="1024" checked="true"> 1024
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="dkimKeySize" value="2048"> 2048
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>
                <button class="btn btn-sm btn-success" data-type="form-submit" type="button"><i class="fa fa-plus"></i> Generate</button>
            </div>
        </div>

        <div id="modalUploadPrivateKey" class="modal modal-sm fade" aria-hidden="true" tabindex="-1">
            <div class="modal-header">
                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>
                <h4 class="modal-title">Upload a DKIM Private Key</h4>
            </div>
            <div class="modal-body">
                <form method="POST" action="." class="form-horizontal">
                    <input type="hidden" name="uploadDkimKey" value="true"/>
                    <div class="form-group">
                        <label class="col-md-3 control-label" for="dkimsel">DKIM Selector</label>
                        <div class="col-md-8">
                            <input type="text" name="dkimsel" value="" placeholder="DomainKey Selector (e.g. key1)" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 control-label" for="dkimpk">DKIM Private Key</label>
                        <div class="col-md-8">
                            <textarea type="text" name="dkimpk" value="" placeholder="PEM Encoded private key" class="form-control" ></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>
                <button class="btn btn-sm btn-success" data-type="form-submit" type="button"><i class="fa fa-plus"></i> Upload</button>
            </div>
        </div>


        <div id="modal-send-test" class="modal modal-sm fade" aria-hidden="true" tabindex="-1">
            <div class="modal-header">
                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>
                <h4 class="modal-title">Send test</h4>
            </div>
            <div class="modal-body">
                <form method="POST" action="." class="form-horizontal">
                    <input type="hidden" name="dkimTestEmail" value="true"/>
                    <div class="form-group">
                        <label class="col-md-3 control-label" for="name">Recipient</label>
                        <div class="col-md-8">
                            <input type="text" name="emailRecip" value="" placeholder="An email address" class="required email form-control" />
                            <p>The email address to send the report to.</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 control-label" for="name">From Address</label>
                        <div class="col-md-8">
                            <input type="text" name="senderEmail" value="" placeholder="Email from address" class="required email form-control" />
                            <p>The address to be sending from eg. noreply@yourdomain.com</p>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>
                <button class="btn btn-sm btn-success" data-type="form-submit" type="button"><i class="glyphicon glyphicon-send"></i> Send</button>
            </div>
        </div>

        <div id="modal-send-test-progress" class="modal modal-lg fade" aria-hidden="true" tabindex="-1">
            <div class="modal-header">
                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>
                <h4 class="modal-title">Test send progress</h4>
            </div>
            <div class="modal-body" id="send-test-body">
            </div>
        </div>

        <script type="text/javascript">
            var csr = {};
            $(function () {
                flog("page init initManageWebsite");
                initManageWebsite();
                initPublishingMenu("");
                initHtmlEditors($(".htmleditor"), "60px", "200px", 'embed_video,modal', 'resize,elementspath');
                initCerts();

                $("form.details").forms({
                    callback: function (resp) {
                        flog("Saved Ok!");
                        Msg.info("Saved");
                    }
                });

                var modal = $("#addWebsiteHttpsModal");
                var form = modal.find(" form");

                form.forms({
                    callback: function (resp) {
                        flog("done", resp);
                        modal.modal('hide');
                        Msg.success(form.find('[name=title]').val() + ' has been created!');
                        $('#certificate-types-table').reloadFragment();
                    }
                });

                var updatePKmodal = $("#modalUpdatePK");
                var updatePKform = updatePKmodal.find(" form");

                updatePKform.forms({
                    callback: function (resp) {
                        flog("done", resp);
                        updatePKmodal.modal('hide');
                        Msg.success(resp.messages, 6000);
                        $('#certificate-types-table').reloadFragment();
                    }
                });

                var sendTestDkimModal = $("#modal-send-test");
                var sendTestDkimForm = sendTestDkimModal.find("form");

                sendTestDkimForm.forms({
                    callback: function (resp) {
                        flog("Sent DKIM Test", resp);
                        sendTestDkimModal.modal("hide");
                        Msg.info("DKIM Successfully generated");
                        onTestResponse(resp);
                    }
                });

                var genDkimModal = $("#modal-gen-dkim");
                var genDkimForm = genDkimModal.find(" form");

                genDkimForm.forms({
                    callback: function (resp) {
                        flog("done", resp);
                        genDkimModal.modal('hide');
                        Msg.success(resp.messages, 6000);
                        $('#panel_mailserver').reloadFragment();
                    }
                });

                var uploadDkimKeyModal = $('#modalUploadPrivateKey');
                var uploadDkimKeyForm = uploadDkimKeyModal.find('form');

                uploadDkimKeyForm.forms({
                    callback: function (resp) {
                        flog("done", resp);
                        uploadDkimKeyModal.modal('hide');
                        Msg.success(resp.messages, 6000);
                        $('#panel_mailserver').reloadFragment();
                    }
                });

                var updateCertModal = $("#modalUpdateCert");
                var updateCertform = updateCertModal.find(" form");

                updateCertform.forms({
                    callback: function (resp) {
                        flog("done", resp);
                        updateCertModal.modal('hide');
                        Msg.success(resp.messages, 6000);
                        $('#certificate-types-table').reloadFragment();
                    }
                });

                $("body").on('click', '.btn-add-root-cert', function (e) {
                    e.preventDefault();
                    var certid = $(this).data("certid");
                    var modal = $('#modalUpdateRootCert');

                    modal.find(".certId").val(certid);

                    modal.modal("show");
                });
                var createRootCertModal = $('#modalUpdateRootCert');
                createRootCertModal.find("form").forms({
                    callback: function (resp) {
                        flog("done", resp);
                        createRootCertModal.modal('hide');
                        Msg.success(resp.messages, 6000);
                        $('#certificate-types-table').reloadFragment();
                    }
                });

                $("body").on('click', '.btn-delete-rootCert', function (e) {
                    e.preventDefault();
                    var href = $(this).attr("href");
                    var certId = $(this).data("certid");
                    flog("rootCertId", href, "certId", certId);
                    if (confirm("Are you sure you want to delete this certificate?")) {
                        deleteRootCert(certId, href, $(this).closest("tr"));
                    }
                });

                $("body").on('click', '.viewCreateCsr', function (e) {
                    e.preventDefault();
                    var certId = $(this).data("certid");
                    viewCsr(certId);
                });

                var genCSRModal = $("#genCsrModal");

                $('body').on('click', '.btn-gen-new-csr', function (e) {
                    e.preventDefault();
                    if (confirm("Are you sure you want to create a new CSR? Please note this will also replace the current Private Key")) {
                        $("#csrTextGroup").hide();
                        genCSRModal.find('.viewCsr').hide();
                        genCSRModal.find('.csrForm').show();
                        genCSRModal.find('.btn-create').show("fade");
                    }
                });

                genCSRModal.find("form").forms({
                    validate: function () {
                        Msg.info("Sending CSR Request...");
                        return true;
                    },
                    callback: function (resp) {
                        flog("Saved Ok!");
                        Msg.info(resp.messages[0]);
                        var csrGroup = $("#csrTextGroup");
                        var csr = csrGroup.find("#csrText");
                        if (resp.data.csrText === "") {
                            csrGroup.hide();
                            genCSRModal.find('.viewCsr').hide();
                            genCSRModal.find('.csrForm').show();
                            genCSRModal.find('.btn-create').show("fade");
                        } else {
                            genCSRModal.find('.viewCsr').show();
                            genCSRModal.find('.csrForm').hide();
                            genCSRModal.find('.btn-create').hide("fade");
                            csrGroup.show();
                            csr.val(resp.data.csrText);
                        }
                    }
                });

                $(document).on('change', '.btn-file :file', function () {
                    var input = $(this),
                            numFiles = input.get(0).files ? input.get(0).files.length : 1,
                            label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
                    input.trigger('fileselect', [numFiles, label]);
                });

                $(document).ready(function () {
                    $('.btn-file :file').on('fileselect', function (event, numFiles, label) {
                        var input = $(this).parents('.input-group').find(':text'),
                                log = numFiles > 1 ? numFiles + ' files selected' : label;

                        if (input.length) {
                            input.val(log);
                        } else {
                            if (log)
                                alert(log);
                        }

                    });
                });

                $('body').on('click', '.btn-delete-dkim', function (e) {
                    e.preventDefault();

                    if (confirm('Are you sure you want to clear the DKIM Key?')) {
                        $.ajax({
                            type: 'POST',
                            dataType: 'json',
                            url: window.location.pathname,
                            data: {
                                clearDKIM: true
                            },
                            success: function (resp) {
                                flog("success", resp);
                                $('#panel_mailserver').reloadFragment();
                            },
                            error: function (resp) {
                                Msg.error("An error occured viewing the certificate");
                            }
                        });
                    }
                });
            });

            function initCerts() {
                $("#certificate-types-table").on("click", ".cert-delete", function (e) {
                    e.preventDefault();
                    var id = $(e.target).closest("a").attr("href");
                    if (confirm("Are you sure you want to delete this certificate?")) {
                        deleteCert(id, $(e.target).closest("tr"));
                    }
                });
                $("#certificate-types-table").on("click", ".cert-activate", function (e) {
                    e.preventDefault();
                    var id = $(e.target).closest("a").attr("href");
                    updateCertStatus(id, "A");
                });
                $("#certificate-types-table").on("click", ".cert-passivate", function (e) {
                    e.preventDefault();
                    var id = $(e.target).closest("a").attr("href");
                    updateCertStatus(id, "");
                });

                $("#certificate-types-table").on("click", ".update_pk", function (e) {
                    e.preventDefault();

                    var id = $(e.target).closest("a").attr("href");
                    $("#updatePKid").val(id);
                    $("#privateKeyTextUpdate").text();

                });

                $("#certificate-types-table").on("click", ".update_cert", function (e) {
                    e.preventDefault();

                    var id = $(e.target).closest("a").attr("href");
                    $("#updateCertId").val(id);
                    $("#certificateTextUpdate").text();
                });
            }

            function updateCertStatus(id, status) {
                $.ajax({
                    type: 'POST',
                    dataType: 'json',
                    url: window.location.pathname,
                    data: {
                        certId: id,
                        updateCertStatus: status
                    },
                    success: function (data) {
                        Msg.info("Updated certificate");
                        $("#certificates-body").reloadFragment();
                    },
                    error: function (resp) {
                        Msg.error("An error occured updating the certificate");
                    }
                });
            }

            function viewCsr(id) {
                var certID = $("#certId");
                var csr = $("#csrText");
                var csrGroup = $("#csrTextGroup");
                certID.val(id);
                csr.val("");

                $.ajax({
                    type: 'POST',
                    dataType: 'json',
                    url: window.location.pathname,
                    data: {
                        viewCsrId: id
                    },
                    success: function (resp) {
                        flog("success", resp);
                        if (resp.data.csrText == "") {
                            csrGroup.hide();
                            $("#genCsrModal").find('.viewCsr').hide("fade");
                            $("#genCsrModal").find('.csrForm').show("fade");
                            $("#genCsrModal").find('.btn-create').show("fade");
                        } else {
                            $("#genCsrModal").find('.viewCsr').show("fade");
                            $("#genCsrModal").find('.csrForm').hide("fade");
                            $("#genCsrModal").find('.btn-create').hide("fade");
                            csrGroup.show();
                            csr.val(resp.data.csrText);
                        }
                        $("#genCsrModal").modal('show');
                    },
                    error: function (resp) {
                        Msg.error("An error occured viewing the certificate");
                    }
                });

            }

            function deleteCert(id, tr) {
                $.ajax({
                    type: 'POST',
                    dataType: 'json',
                    url: window.location.pathname,
                    data: {
                        deleteCertId: id
                    },
                    success: function (data) {
                        Msg.info("Deleted certificate");
                        tr.remove();
                        //$("#certificates-body").reloadFragment();
                    },
                    error: function (resp) {
                        Msg.error("An error occured deleting the certificate");
                    }
                });
            }

            function deleteRootCert(certId, rootCertid, tr) {
                $.ajax({
                    type: 'POST',
                    dataType: 'json',
                    url: window.location.pathname,
                    data: {
                        deleteRootCertId: rootCertid,
                        certId: certId
                    },
                    success: function (data) {
                        Msg.info("Deleted certificate");
                        var tbody = tr.closest("tbody");
                        tr.remove();
                        var rows = tbody.find("tr");
                        $(".rootCertCount").text(rows.size());
                        if (rows.size() > 0) {
                            rows.each(function (index, item) {
                                $(item).find("td.first").text(index + 1);
                            });
                        } else {
                            tbody.append('<tr>'
                                    + '<td colspan="3">You have no root/intermediate certificates</td>'
                                    + '</tr>');
                        }
                    },
                    error: function (resp) {
                        Msg.error("An error occured deleting the certificate");
                    }
                });
            }
        </script>
    </body>
</html>
