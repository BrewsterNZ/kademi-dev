<html>    <head>        <title>Profile</title>        <link href="profile.css" rel="stylesheet" type="text/css" />        <link href="manageUser.css" rel="stylesheet" type="text/css" />        <script type="text/javascript" src="/theme/apps/admin/profile.js">//</script>        <script type="text/javascript" src="manageUser.js">//</script>        <script type="text/javascript" src="/static/bootstrap-upcrop-image/1.0/bootstrap-upcrop-image.js">//</script>        <style>            .summary-panel {                height: 200px;            }            .fluidLabel {                height: 30px;                float: left;                margin-bottom: 10px            }            .fluidLabel span {                line-height: 20px;            }            .fluidLabel a {                color: white;            }            .membershipsDiv {                margin-left: 100px;                max-height: 100px;                overflow-y: auto;            }        </style>    </head>    <body class="profile">        <div class="pull-right">            <button type="button" class="btn btn-default btn-login-as">                <span class="fa fa-user"></span>                Login as..            </button>        </div>        <div style="float: left; margin-right: 15px; margin-top: 20px;" class="main-profile-photo">            <img class="img img-circle" style="height: 80px" src="/users/${page.profile.name}/pic" alt="">        </div>        <div style="margin-bottom: 15px">            <h2>$page.profile.formattedName</h2>            <div class="membershipsDiv">                #foreach($m in $page.children.ofType.membership)                #if( $m.groupType == "P" )                <div class="fluidLabel label label-success" style="margin-right: 5px">                    <i class="clip-users"></i>                    <span class="block-name">                        <a href="/groups/$m.groupName">$m.groupName</a> in $m.orgName                    </span>                </div>                #elseif( $m.groupType == "S" )                <div class="fluidLabel label label-info" style="margin-right: 5px">                    <i class="fa fa-trophy"></i>                    <span class="block-name" title="$m.groupName in $m.orgName"><a href="/groups/$m.groupName">$m.groupName</a></span>                </div>                #elseif( $m.groupType == "M" )                <div class="fluidLabel label label-info" style="margin-right: 5px">                    <i class="fa fa-envelope"></i>                    <span class="block-name" title="$m.groupName in $m.orgName"><a href="/groups/$m.groupName">$m.groupName</a></span>                </div>                #else                <div class="fluidLabel label label-info" style="margin-right: 5px">                    <span class="block-name" title="$m.groupName in $m.orgName"><a href="/groups/$m.groupName">$m.groupName</a></span>                </div>                #end                #end                <div style="clear: both"></div>            </div>            <div style="clear: both"></div>        </div>        #set($groups = $page.groups)        <div class="tabbable">            <ul class="nav nav-tabs tab-bricky">                <li><a data-toggle="tab" href="#summary">Summary</a></li>                <li><a data-toggle="tab" href="#general">Profile</a></li>                #foreach( $pair in $page.appTabs)                <li><a data-toggle="tab" href="#${pair.portletId}">$pair.title</a></li>                #end            </ul>            <div class="tab-content">                <div id="summary" class="tab-pane">                    <div class="row " id="profile-panels">                        #foreach( $pair in $page.appPanels)                        <div class="col-lg-3 col-md-6">                            <div class="panel panel-primary statCard">                                <div class="panel-heading">                                    <div class="row">                                        #portlets( $pair.portletId )                                    </div>                                </div>                                #if($pair.profileTab)                                <a href="#$pair.profileTab.portletId">                                    <div class="panel-footer">                                        <span class="pull-left">View Details</span>                                        <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>                                        <div class="clearfix"></div>                                    </div>                                </a>                                #end                            </div>                        </div>                        #end                    </div>                    <div class="row">                        <div class="container">                            <hr/>                            <ul class="timeline">                                #set( $month = "" )                                #set( $lastMonth = "" )                                #foreach( $action in $page.timelineItems )                                #set( $month = $formatter.getMonthName($action.actionDate) )                                #if( $month != $lastMonth )                                <li class="tldateLi"><div class="tldate"><span>$month $formatter.getYear($action.actionDate)</span></div></li>                                #end                                #set( $lastMonth = $month )                                <li class="$formatter.ifTrue($action.inbound, '', 'timeline-inverted')">                                    <div class="timeline-badge $action.category"><i class="fa $action.itemType"></i></div>                                    <div class="timeline-panel">                                        <div class="timeline-heading">                                            #if( $action.actionDate)                                            <small class="text-muted pull-right"><i class="glyphicon glyphicon-time"></i> <abbr title="$formatter.formatDateISO8601($action.actionDate)" class="info timeago">$action.actionDate</abbr></small>                                            #end                                            <h4 class="timeline-title">$action.itemTitle</h4>                                        </div>                                        <div class="timeline-body">                                            <p>$!action.actionDesc</p>                                            #if($action.path)                                            <p>                                                <a href="$action.path" class="btn btn-sm btn-info pull-right">                                                    View <i class="fa fa-arrow-circle-right"></i>                                                </a>                                            </p>                                            #end                                        </div>                                    </div>                                </li>                                #end                            </ul>                        </div>                    </div>                </div>                <div id="general" class="tab-pane">                    <div class="row ">                        <div class="col-md-6">                            <div class="panel panel-default">                                <div class="panel-heading">                                    <i class="clip-file-2"></i>                                    Update profile details                                </div>                                <div class="panel-body">                                    <fieldset class="name">                                        <div><b>Please update your details below then click the 'Save' button.</b></div>                                        <hr />                                        <form action="." method="POST" enctype="multipart/form-data" class="form-horizontal initProfileForm">                                            <div class="form-group">                                                <label for="" class="control-label col-md-3">UserId:</label>                                                <div class="col-md-9">                                                    <div class="input-group">                                                        <input type="text" class="form-control" disabled="disabled" value="$page.profile.name" />                                                        <span class="input-group-btn">                                                            <button class="btn btn-default change-userid" type="button">Change</button>                                                        </span>                                                    </div>                                                </div>                                            </div>                                            <div class="form-group">                                                <label for="nickName" class="control-label col-md-3">Nickname:</label>                                                <div class="col-md-9">                                                    <input type="text" name="nickName" id="nickName" class="form-control required" value="$!page.profile.nickName" />                                                </div>                                            </div>                                            <div class="form-group">                                                <label for="email" class="control-label col-md-3">Email:</label>                                                <div class="col-md-9">                                                    <input type="text" name="email" id="email" class="form-control required" value="$!page.profile.email" />                                                </div>                                            </div>                                            <div class="form-group">                                                <label for="phone" class="control-label col-md-3">Phone</label>                                                <div class="col-md-9">                                                    <input type="text" class="form-control" name="phone" id="phone" value="$!page.profile.phone" />                                                </div>                                            </div>                                            <div class="form-group">                                                <label for="firstName" class="control-label col-md-3">First name</label>                                                <div class="col-md-9">                                                    <input type="text" name="firstName" id="firstName" class="form-control" value="$!page.profile.firstName" />                                                </div>                                            </div>                                            <div class="form-group">                                                <label for="surName" class="control-label col-md-3">Surname</label>                                                <div class="col-md-9">                                                    <input type="text" name="surName" id="surName" class="form-control" value="$!page.profile.surName" />                                                </div>                                            </div>                                            <div class="form-group">                                                <label for="birthDate" class="control-label col-md-3">Birth Date</label>                                                <div class="col-md-9">                                                    <div class="input-group">                                                        <input type="text" name="birthDate" id="birthDate" placeholder="Birth Date" data-format="DD/MM/YYYY" value="$!formatter.formatDate($page.profile.birthDate)" class="form-control DateTime" />                                                        <span class="input-group-addon"> <i class="fa fa-calendar"></i> </span>                                                    </div>                                                </div>                                            </div>                                            #set($fields = $page.extraFields)                                            #foreach($field in $fields.keySet())                                            <div class="form-group">                                                <label for="surName" title="From group $!field.group.name" class="control-label col-md-3">$!field.text</label>                                                <div class="col-md-9">                                                    <div class="input-group">                                                        <span class="input-group-addon"> <i class="fa fa-star-o"></i> </span>                                                        $field.html( $fields[$field] )                                                    </div>                                                </div>                                            </div>                                            #end                                            <div class="form-group">                                                <div class="col-md-12">                                                    <button class="btn btn-sm btn-primary pull-right" type="submit">Save</button>                                                </div>                                            </div>                                        </form>                                    </fieldset>                                </div>                            </div>                            <div class="panel panel-default">                                <div class="panel-heading">                                    <i class="clip-pictures"></i>Update photo                                </div>                                <div class="panel-body profile-photo">                                    <div class="clearfix">                                        <img src="$page.photoHref" class="img-thumbnail profile-photo" />                                        <div>                                            <p>Update your profile image below. This must be less then 10Mb</p>                                            <button id="btn-change-ava" class="btn btn-success">Change avatar</button>                                            <button id="btn-remove-ava" class="btn btn-danger">Remove avatar</button>                                        </div>                                    </div>                                </div>                            </div>                        </div>                        <div class="col-md-6">                            <div class="panel panel-default">                                <div class="panel-heading">                                    #if( $page.hasPassword )                                    <i class="clip-key"></i>Update password                                    #else                                    <i class="clip-key"></i>Create password                                    #end                                </div>                                <div class="panel-body">                                    <div class="changePassword">                                        <fieldset>                                            <div>Enter a new and confirmed password below and click the 'Save' button.</div>                                            <hr />                                            <form action="." method="POST" class="form-horizontal initProfileForm">                                                <div class="form-group">                                                    <label for="password" class="control-label col-md-3">New password:</label>                                                    <div class="col-md-9">                                                        <input type="password" name="password" id="password" class="form-control required allow-dodgy-password" value="" />                                                    </div>                                                </div>                                                <div class="form-group">                                                    <label for="confirmPassword" class="control-label col-md-3">Confirm password:</label>                                                    <div class="col-md-9">                                                        <input type="password" name="confirmPassword" id="confirmPassword" class="form-control required allow-dodgy-password" value="" />                                                    </div>                                                </div>                                                <div class="form-group">                                                    <div class="col-md-12">                                                        <button class="btn btn-sm btn-primary pull-right" type="submit">Save</button>                                                    </div>                                                </div>                                            </form>                                        </fieldset>                                        #if( $page.passwordSetDate )                                        <p>                                            <span class='label label-default'>Password was set at: $formatter.formatDateTime($page.passwordSetDate, $page.organisation.timezone)</span>                                        </p>                                        #end                                    </div>                                </div>                            </div>                            #if($page.hasPassword)                            <div class="panel panel-default">                                <div class="panel-heading">                                    <i class="clip-key"></i>Remove password                                </div>                                <div class="panel-body">                                    <div class="changePassword">                                        <fieldset>                                            <div>Clear the user's password. This will completely and permanently remove all credentials.</div>                                            <hr />                                            <p class="clearfix">                                                <button type="button" class="btn btn-sm btn-danger btn-remove-creds">                                                    <i class="fa fa-times"></i> Clear password                                                </button>                                            </p>                                        </fieldset>                                    </div>                                </div>                            </div>                            #end                            #set($providers = $applications.oauth.loginProviders)                            #if($providers && !$providers.isEmpty())                            <div class="panel panel-default" id="oauthLogins">                                <div class="panel-heading">                                    <i class="clip-key"></i> Social media logins                                </div>                                <div class="panel-body">                                    #foreach($p in $providers)                                    #set( $connected = false)                                    #set( $connected = $applications.oauth.oAuthDetails.get( $p.providerId ) )                                    #if( $connected )                                    <div class="alert alert-info">                                        <i class="fa fa-${p.providerId}"></i> Connected with $p.providerId as $formatter.propertyOfObject($connected.details, $connected.displayNamePath)                                        <button class="btn btn-danger btn-sm btnDisconnect pull-right" data-provider="$p.providerId" type="button">                                            <i class="fa fa-times"></i>                                        </button>                                    </div>                                    #else                                    <a href="$applications.oauth.getAuthoriseHref($p)" class="btn btn-success btn-${p.providerId}"><i class="fa fa-${p.providerId}"></i> | Connect with $p.providerId</a>                                    #end                                    #end                                </div>                            </div>                            #end                            <div class="panel panel-default">                                <div class="panel-heading">                                    <i class="clip-users"></i>Group memberships                                </div>                                <div class="panel-body">                                    <p class="clearfix">                                        <button type="button" class="btn btn-sm btn-success btn-add-group"><i class="fa fa-plus"></i> New membership</button>                                    </p>                                    <div>Group memberships convey permissions, and apply to a user within organisation. A user may have many                                        different group memberships in many different organisations                                    </div>                                    <hr />                                    <div class="memberships-wrapper">                                        <div id="user-membership" class="blocks-wrapper memberships-list">                                            #foreach($m in $page.children.ofType.membership)                                            #if( $m.groupType == "P" )                                            <span class="block membership alert alert-success">                                                <i class="clip-users"></i>                                                <span class="block-name" title="$m.groupName in $m.orgName, created $formatter.formatDateTime($m.createdDate)"><b>$m.groupName</b> in $m.orgName</span>                                                <a href="$m.name" class="btn btn-xs btn-danger btn-delete-membership" title="Delete membership for group $m.groupName in $m.orgName"><i href="$m.name" class="fa fa-times"></i></a>                                            </span>                                            #elseif( $m.groupType == "S" )                                            <span class="block membership">                                                <i class="fa fa-trophy"></i>                                                <span class="block-name" title="$m.groupName in $m.orgName, created $formatter.formatDateTime($m.createdDate)">$m.groupName</span>                                                <a href="$m.name" class="btn btn-xs btn-danger btn-delete-membership" title="Delete membership for group $m.groupName in $m.orgName"><i href="$m.name" class="fa fa-times"></i></a>                                            </span>                                            #elseif( $m.groupType == "M" )                                            <span class="block membership">                                                <i class="fa fa-envelope"></i>                                                <span class="block-name" title="$m.groupName in $m.orgName, created $formatter.formatDateTime($m.createdDate)">$m.groupName</span>                                                <a href="$m.name" class="btn btn-xs btn-danger btn-delete-membership" title="Delete membership for group $m.groupName in $m.orgName"><i href="$m.name" class="fa fa-times"></i></a>                                            </span>                                            #end                                            #end                                        </div>                                    </div>                                </div>                            </div>                            <div class="well well-unsubscribe">                                <form action="$request.absolutePath" method="POST" class="form-inline form-unsubscribe">                                    <h4>Unsubscribe</h4>                                    <p>Unsubscribe the user from this account. They will no longer receive any email communications, and you will not be able to login.</p>                                    <input type="hidden" name="unsubscribe" value="true"/>                                    <button class="btn btn-danger">Unsubscribe - $page.profile.email</button>                                </form>                            </div>                        </div>                    </div>                    <div class="row">                        <div class="col-md-8">                            #portlets("adminProfile")                        </div>                        <div class="col-md-4">                        </div>                    </div>                </div>                #foreach( $pair in $page.appTabs)                <!-- start $pair.portletId -->                <div id="$pair.portletId" class="tab-pane">                    #portlets( $pair.portletId )                </div>                <!-- end $pair.portletId -->                #end            </div>        </div>        <div class="modal modal-md fade" id="modal-membership" tabindex="-1" aria-hidden="true">            <div class="modal-header">                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>                <h4 class="modal-title">Group membership</h4>            </div>            <div class="modal-body">                #if($groups.isEmpty())                <p class="alert alert-error">                    <a class="close" data-dismiss="alert" role="button">&times;</a>                    You must create at least one group in this or a parent organisation before you can add users.                </p>                #else                <form method="POST" action="." class="form-horizontal">                    <div class="groups">                        <p>Please select a group and an organisation to make this user a member of</p>                        <div class="form-group">                            <div class="col-md-12">                                <input type="text" class="form-control required" autocomplete="off" name="orgTitle" id="orgTitle" value="$page.organisation.formattedName" />                                <input type="hidden" class="required" autocomplete="off" name="orgId" id="orgId" value="$page.organisation.id" />                            </div>                            <div id="org-search">                                <div class="table-responsive">                                    <table class="table table-striped table-hover table-condensed">                                        #if( $page.orgSearchResults.isEmpty() )                                        <tbody>                                            <tr>                                                <td>No matching organisations found</td>                                            </tr>                                        </tbody>                                        #else                                        <thead>                                            <tr>                                                <th>Id</th>                                                <th>Title</th>                                            </tr>                                        </thead>                                        <tbody>                                            #foreach($org in $page.orgSearchResults)                                            <tr>                                                <td><a href="$org.id">$org.orgId</a></td>                                                <td><a href="$org.id">$!org.title</a></td>                                            </tr>                                            #end                                        <tbody>                                            #end                                    </table>                                </div>                            </div>                        </div>                        <div class="memberships-wrapper">                            <div class="row blocks-wrapper memberships-list">                                #foreach($group in $groups)                                #set($id = "radGroup_" + $group.name)                                <div class="col-md-3">                                    <span class="block membership" title="$group.name">                                        <label class="block-name" for="$id">$formatter.radio($id, "group", false, $group.name) $group.name</label>                                    </span>                                </div>                                #end                            </div>                        </div>                    </div>                </form>                #end            </div>            <div class="modal-footer">                <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>                #if(!$groups.isEmpty())                <button type="button" data-type="form-submit" class="btn btn-sm btn-primary">Save</button>                #end            </div>        </div>        <div id="modal-login-as" class="modal modal-sm fade" aria-hidden="true" tabindex="-1">            <div class="modal-header">                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>                <h4 class="modal-title">Login as User</h4>            </div>            <div class="modal-body">                <p>Below is the list of websites this user has access to:</p>                <ul>                    <li>Please wait...</li>                </ul>            </div>            <div class="modal-footer">                <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>            </div>        </div>        <script type="text/javascript" src="/static/js/jquery.milton-upload.js"></script>        <script type="text/javascript">            $(function () {                setRecentItem(document.title, window.location.pathname);                initProfile();                initChangeUserId();                initRemoveCreds();                initRemoveOAuthCred();                $(".form-unsubscribe").forms({                    validate: function () {                        return confirm("Are you sure you want to unsubscribe this user? They will no longer be able to access this site");                    },                    callback: function (resp, form) {                        Msg.info("Unsubscribed. Now going to manage users page");                        window.location = "/manageUsers";                    },                    confirmMessage: "The user has been unsubscribed"                });                jQuery("abbr.timeago").timeago();                $('#btn-change-ava').upcropImage({                    buttonContinueText: 'Save',                    url: window.location.pathname, // this is actually the default value anyway                    onCropComplete: function (resp) {                        flog("onCropComplete:", resp, resp.nextHref);                        $(".profile-photo img").attr("src", resp.nextHref);                    },                    onContinue: function (resp) {                        flog("onContinue:", resp, resp.result.nextHref);                        $.ajax({                            url: window.location.pathname,                            type: 'POST',                            dataType: 'json',                            data: {                                uploadedHref: resp.result.nextHref,                                applyImage: true                            },                            success: function (resp) {                                if (resp.status) {                                    $(".profile-photo img").attr("src", resp.nextHref);                                    $(".main-profile-photo img").attr("src", resp.nextHref);                                } else {                                    alert("Sorry, an error occured updating your profile image");                                }                            },                            error: function () {                                alert('Sorry, we couldn\'t save your profile image.');                            }                        });                    }                });                $('body').on('click', '#btn-remove-ava', function (e) {                    e.preventDefault();                    if (confirm('Are you sure you want to clear the avatar?')) {                        $.ajax({                            url: window.location.pathname,                            type: 'POST',                            dataType: 'json',                            data: {                                clearAvatar: true                            },                            success: function (resp) {                                if (resp.status) {                                    $(".profile-photo img").attr("src", "pic");                                    $(".main-profile-photo img").attr("src", "pic");                                } else {                                    alert("Sorry, an error occured updating your profile image");                                }                            },                            error: function () {                                alert('Sorry, we couldn\'t save your profile image.');                            }                        });                    }                });            });        </script>    </body></html>