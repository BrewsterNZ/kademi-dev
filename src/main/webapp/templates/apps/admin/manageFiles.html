<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Manage modules</title>
        <link href="manageFiles.css" rel="stylesheet" type="text/css" />
        <link href="/static/history/jquery.history.css" rel="stylesheet" type="text/css" />
        <link href="/static/js/milton-image-select.css" rel="stylesheet" type="text/css" />
        <link href="/static/css/jquery.lightbox-0.5.css" rel="stylesheet" type="text/css" media="screen" />

        <script type="text/javascript" src="/static/history/jquery.history.js">//</script>
        <script type="text/javascript" src="/static/js/jquery.milton-image-select.js">//</script>
        <script type="text/javascript" src="/static/js/jquery.milton-tree.js">//</script>
        <script type="text/javascript" src="/static/js/managePublishing.js">//</script>
        <script type="text/javascript" src="/templates/themes/admin/prompt.js">//</script>
        <script type="text/javascript" src="/templates/apps/admin/manageFiles.js">//</script>
        <script type="text/javascript" src="/static/js/types.js">// </script>
        <script type="text/javascript" src="/static/js/jquery.fileupload.js">//</script>
        <script type="text/javascript" src="/static/js/jquery.timeago.js">//</script>       
    </head>
    <body class="manage-files">
        #set($currentBranch = $page.closest("branch"))
        <div class="btn-group publishing pull-right">
            #if( $currentBranch.live )
            <a href="../manageBranches" class="islive btn btn-danger">
                <i class="fa fa-gear"></i>
                LIVE
            </a>
            #else
            <a href="${currentBranch.href}publish" class="publish btn btn-success">
                <i class="glyphicon glyphicon-ok-sign"></i>
                PUBLISH
            </a>
            <a href="../manageBranches" class="btn btn-primary">
                <i class="fa fa-gear"></i>
                Manage versions
            </a>
            #end

            <a class="btn btn-primary dropdown-toggle" data-toggle="dropdown" href="#">
                <b>Editing version:</b>
                $currentBranch.name
                <span class="caret"></span>
            </a>
            <ul role="menu" class="dropdown-menu list branches">
                #foreach($b in $page.closest("branch").parent.children.ofType.branch)
                <li role="presentation" class="list-item">
                    <aside class="list-item-controller">
                        <a href="#" class="copy btn btn-xs btn-primary pull-right" title="Copy this to a new version"><i class="fa fa-copy"></i></a>
                        #if( $b.live )

                        #else
                        <a href="${b.href}" class="hide-branch pull-right btn-xs btn btn-warning" title="Hide this version. Can be restored from the manage versions screen"><i class="clip-eye"></i></a>
                        #end
                    </aside>                    
                    <a href="${b.href}" class="branch noclear">
                        $b.name
                    </a>
                </li>
                #end
            </ul>
        </div>
        
        <div class="btn-group">
            <a target='_blank' href='${page.externalUrl}' class='btn btn-success'>
                <i class="fa fa-arrow-circle-right"></i>
                View website
            </a>
            <div class="btn-group">
                <a class="btn btn-primary dropdown-toggle" data-toggle="dropdown" href="#">
                    <b>Change website:</b> $page.closest("website").name
                    <span class="caret"></span>
                </a>            
                <ul role="menu" class="dropdown-menu list">
                    #foreach($w in $page.closest("website").parent.children)
                    <li class="list-item"><a href="${w.href}">$w.name</a></li>
                    #end                               
                </ul>            
            </div>
        </div>          

        <hr class="clearfix"/>
        
        <section id="manageFiles" class="MainContent">
            <header>                
                <div class="DropdownControl">
                    <div class="DropdownWrapper">
                        <span><b>Repository:</b> $page.closest("repository").name</span> 
                        <a href="#" class="Control"><span class="Hidden">Change</span></a>
                    </div>
                    <div class="DropdownContent Rows3 Hidden">
                        <div class="Content ClearFix">
                            <section rel="program">
                                #foreach($w in $page.closest("repository").parent.children)
                                <a href="${w.href}">$w.name</a>
                                #end
                            </section>
                        </div>
                    </div>
                </div>                
            </header>

            <div class="pull-right">
                <button class="Btn showImportModal" >Import</button>
            </div>            

            <nav class="TabNav ClearFix">
                <a href="#pages">Pages</a>
                <a href="#files">Files &amp; Folders</a>
            </nav>
            <div class="Content TabContent" rel="#pages" style="position: relative">
                <h4>$page.title</h4>
                <a title="Add Page" class="SmallBtn Add NoText AddModulePage" href=""><span>Add</span></a>
                <form method="POST" action="" class="">
                    <div id='pagesList' class="MainContent filesList">
                        #set($order = 0)

                        #foreach($page in $page.children.ofType.html)
                        <article class="modulePage">
                            <span>$page.title</span>
                            <aside class="Hidden">
                                <a href="${page.name}" class="Edit" title="Edit page"><span class="Hidden">Edit page</span></a>
                                <a href="${page.name}?goto" target="_blank" class="View" title="View page"><span class="Hidden">View page</span></a>
                                <a href="${page.path}" class="Delete" title="Delete page"><span class="Hidden">Delete page</span></a>
                            </aside>    
                        </article>

                        #end

                    </div>                
                </form>
            </div>
            <div class="Content TabContent" rel="#files" id='filesContainer'>
                <table id="fileList" class="filesList table table-striped vcenter">
                    <thead>
                        <tr>
                            <th colspan="2">Files: $page.name</th>
                            <th>Modified</th>
                            <th>Size</th>
                            <th>
                                <a style="float: right" title="Upload files" class="SmallBtn Add NoText uploadFiles" href=""><span>Add</span></a>
                                <a style="float: right" title="Create a folder" class="SmallBtn Add NoText createFolder" href=""><span>Quiz</span></a>
                            </th>
                        </tr>
                        <tr class="seperator">
                            <td colspan="4"></td>
                        </tr>
                    </thead>
                    <tbody id='filesListBody'>                
                        #foreach($f in $page.subFolders)
                        <tr class="folder">
                            <td style="width: 70px">
                                <a href="$f.href#files"><span class="Hidden">folder</span></a>
                            </td>
                            <td class="left">
                                <a href="${f.href}#files">$f.name</a>
                            </td>
                            <td><abbr title="$formatter.formatDateISO8601($f.modifiedDate)" class="timeago">$!f.modifiedDate</abbr></td>
                            <td></td>
                            <td>
                                <aside class="Hidden">
                                    <a href="${f.path}" class='rename' title="Rename file"><span>Rename</span></a>
                                    <a href="${f.path}" class="Delete" title="Delete folder"><span class="Hidden">Delete folder</span></a>
                                </aside> 
                            </td>
                        </tr>
                        #end

                        #foreach($f in $page.files)                
                        #set($lightBoxClass = "lightbox")
                        #if( $f.contentLength < 100000 )
                        #set($lightBoxClass = "")
                        #end
                        <tr class="file $lightBoxClass">
                            #set($imgClass = $formatter.ifTrue($f.is("image"), "image", "" ) )
                            <td style="width: 70px">
                                <a href="$f.href" class="$imgClass"><span class="Hidden">file</span></a>
                            </td>
                            <td class="left">
                                <a href="$f.href" class="$imgClass">$f.name</a>
                            </td>
                            <td><abbr title="$formatter.formatDateISO8601($!f.modifiedDate)" class="timeago">$!f.modifiedDate</abbr></td>
                            <td>$f.contentLength</td>
                            <td>
                                <aside class="Hidden">
                                    <a href="${f.path}" class='history' title="Show history"><span>History</span></a>
                                    <a href="${f.path}" class="Delete" title="Delete file"><span>Delete file</span></a>
                                    <a href="${f.path}" class='rename' title="Rename file"><span>Rename</span></a>
                                    <a href="${f.path}" target="_blank" class="View" title="Download file"><span>Download file</span></a>                                                                                                            
                                </aside> 
                            </td>
                        </tr>
                        #end                 
                    </tbody>
                </table>                
            </div>

        </section>

        <div id="modalCreatePage" class="Modal wide">
            <header>
                <h3>Add/edit module page</h3>                
                <a class="Close" href="#" title="Close"><span class="Hidden">Close</span></a>
            </header>
            <div class="ModalContent new-page-modal-content">
                <form method="POST" action=".">
                    <input type="hidden" name="pageName" />
                    <div class="pageMessage">.</div>
                    <table class=''>
                        <tr>
                            <th><label for="name">Page title</label></th>
                            <td>
                                <input type="text" name="title" id="pageTitle" class="required" value="" placeholder="A title for the new page" />                                
                            </td>
                            <th>Page template</th>
                            <td>                                
                                <select name="template">
                                    <option value="">None</option>
                                    #foreach($templateEntry in $page.closest("branch").getTemplates($page).entrySet() )
                                    <option value="$templateEntry.key">$templateEntry.value</option>
                                    #end
                                </select>
                            </td>
                            <td style='width: 300px'>
                                <button class="Btn pageBtn" type="submit">
                                    Save page
                                    <img class='ajax-loader' src='/static/common/loading.gif'/>
                                </button>
                                <button class="Btn historyBtn" type="button">History</button>

                            </td>
                        </tr>
                        <tr>
                            <td colspan="5">
                                <textarea name="body" id="body" class="htmleditor toolbar-Full" style="width: 800px"></textarea>
                            </td>
                        </tr>                        
                    </table>
                </form>
            </div>
        </div>          

        <div id="modalUpload" class="Modal wide">
            <header>
                <h3>Upload files</h3>                
                <a class="Close" href="#" title="Close"><span class="Hidden">Close</span></a>
            </header>
            <div class="ModalContent new-page-modal-content">
                <div class="input" id='myUploaded' style="width: 150px"></div>        
            </div>
        </div>             

        <div id="importModal" class="Modal">
            <header>
                <h3>Import from server</h3>                
                <a class="Close" href="#" title="Close"><span class="Hidden">Close</span></a>
            </header>
            <div class="ModalContent">
                <p>This will import files and folders from another webdav enabled website<br/></p>
                <form>
                    <div class="inputs">
                        <label for="importFromUrl">Server URL</label>
                        <input type="text" name="importFromUrl" id="importFromUrl" />

                        <label for="remoteUser">Remote username</label>
                        <input type="text" name="user" id="remoteUser" />

                        <label for="remotePassword">Remote password</label>
                        <input type="password" name="password" id="remotePassword" />
                    </div>
                    <button type="submit" class="Btn">Import</button>
                </form>
                <hr/>
                <br/><br/>
                <h3><a href="#" class="import-status">Import status - click to refresh</a></h3>
                <textarea id="import-status-result" style="display: none"></textarea>
            </div>
        </div>  

        <script type="text/javascript" >
            var themePath = "${page.themePath}";
            jQuery(function() {
                initPublishingMenu("");
                //initManageModule("../../..", themePath);
                $(".showImportModal").click(function() {
                    showModal($("#importModal"));
                });
                $("#importModal form").forms({
                    callback: function(resp) {
                        log("resp", resp);
                        alert("The importer is running")
                    }
                });
                $(".import-status").click(function(e) {
                    e.preventDefault();
                    $.getJSON(window.location.pathname + "?importStatus", function(data) {
                        $("#import-status-result").val(data.messages).show(300);
                    });
                });
            });
        </script>        
    </body>
</html>