<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Manage Databse</title>
    </head>
    <body class="">

        <form name="frmDetails" action="." method="post" class="form-horizontal database-form">
            <div class="pull-right page-action">
                <button class="btn btn-sm btn-success" type="submit">
                    <span class="fa fa-save"></span>
                    Save changes
                </button>
            </div>

            <div class="tabbable">
                <ul class="nav nav-tabs tab-bricky">
                    <li><a data-toggle="tab" href="#general">Details</a></li>
                    <li><a data-toggle="tab" href="#notes">Notes</a></li>
                    <li><a data-toggle="tab" href="#records">Records</a></li>
                    <li><a data-toggle="tab" href="#query">Query</a></li>
                </ul>
                <div class="tab-content">
                    <div id="general" class="tab-pane">
                        <div class="form-group">
                            <label class="control-label col-md-3" for="title">Name</label>
                            <div class="col-md-8">
                                <input type="text" name="name" id="name" value="$page.name" placeholder="" class="required form-control"  required="true" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-3" for="title">Title</label>
                            <div class="col-md-8">
                                <input type="text" name="title" id="title" value="$page.title" placeholder="" class="required form-control"  required="true" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-3" for="template">Template</label>
                            <div class="col-md-8">
                                <input type="text" name="template" id="template" value="$!page.template" placeholder="" class="required form-control"  required="true" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-3" for="title">Website</label>
                            <div class="col-md-8">
                                <select name="website" class="form-control">
                                    <option value="">[NONE]</option>
                                    #foreach($website in $page.find("/websites").children.ofType.website)
                                    $formatter.option($website.name, $website.name, $page.websiteName)
                                    <option value="$website.name">$website.name</option>
                                    #end
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="notes" class="tab-pane">  <!-- notes -->
                        <small>For internal use.</small>
                        <textarea cols="100" name="notes" id="notes" rows="20" placeholder="" class="form-control">$!page.notes</textarea>
                    </div> <!-- end notes -->



                    <div id="records" class="tab-pane">

                        <div class="pull-right">
                            <a type="button" class="btn btn-sm btn-success" href="#addModal" data-toggle="modal">
                                <span class="glyphicon glyphicon-plus"></span>
                                Add record
                            </a>

                            <button type="button" class="btn btn-sm btn-danger deleteDocsBtn">
                                <span class="glyphicon glyphicon-remove"></span>
                                Delete
                            </button>
                        </div>

                        <br/>

                        <table class="table table-bordered table-striped" id="table-periods">
                            <colgroup>
                                <col width="" />
                                <col width="" />
                                <col width="" />
                                <col data-sort="false" width="30px" />
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Processed date</th>
                                    <th><input type="checkbox" name="deletePeriodId" class="chk-all" /></th>
                                </tr>
                            </thead>
                            <tbody id="records-body">
                                #foreach($doc in $page.listDocs())
                                <tr>
                                    <td><a href="$doc.name">$doc.name</a></td>
                                    <td>$doc.docType</td>
                                    <td>$doc.createdDate</td>
                                    <td><input class="deleteDoc" type="checkbox" name="toRemoveId" value="$doc.name" /></td>
                                </tr>
                                #end
                            </tbody>
                        </table>
                    </div>
                    <div id="query" class="tab-pane">
                        #set($items = $page.searchResponse)


                        <textarea name="source" id="queryText" style="height: 250px" class="form-control" placeholder="JSON source">$!request.params.source</textarea>
                        <br/>
                        <button type="button" id="queryBtn" class="btn btn-info col-md-4">Query</button>

                        <br style="clear: both"/>
                        <hr style="clearfix"/>
                        <div id="searchResults">
                            #if( $page.error )
                            <div class="alert alert-warning">$page.error</div>
                            #end

                            #if( $items )
                            <h2>Search items</h2>
                            <table class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <td>Item</td>
                                        <td>Fields</td>
                                    </tr>
                                </thead>
                                <tbody>
                                    #foreach($hit in $items.hits.hits)
                                    <tr>
                                        <td>$hit.id</td>
                                        <td>
                                            $hit.sourceAsString
                                        </td>
                                    </tr>
                                    #end
                                </tbody>
                            </table>

                            #if( $items )
                            <pre>$items
                            </pre>
                            #end

                            #if( $items.aggregations )
                            <h2>Aggregations</h2>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <td>Item</td>
                                        <td>Fields</td>
                                    </tr>
                                </thead>
                                <tbody>
                                    #foreach($entry in $items.aggregations.asMap.entrySet())
                                    <tr>
                                        <th>$entry.key</th>
                                        <th></th>
                                    </tr>
                                    #if( $entry.value.buckets )
                                    #foreach($bucket in $entry.value.buckets)
                                    <tr>
                                        <td>$bucket.key</td>
                                        <td>$bucket.docCount</td>
                                    </tr>
                                    #end
                                    #else
                                    #end

                                    #end
                                </tbody>
                            </table>

                            #end
                            #end
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div id="addModal" class="modal fade level-modal" tabindex="-1" data-focus-on="input:first" role="dialog" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Add Record</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" method="POST" action="." id="addRecordForm">
                    <div class="form-group">
                        <label for="newName" class="col-sm-3 control-label">Simple name</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control regex required" required="true" id="newName" name="newName" data-regex="^[a-zA-Z0-9-]+$" />
                            <span class="help-block"><small>Simple characters only, no punctuation, dots, etc, all lower case, not a domain name</small></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="docType" class="col-sm-3 control-label">Type</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" required="true" id="docType" name="docType" />
                        </div>
                    </div>

                    <textarea name="json" class="form-control"></textarea>


                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-sm btn-success" data-type="form-submit">Save</button>
            </div>
        </div>




        <script type="text/javascript">
            $(function () {
                $(".database-form").forms({
                    callback: function (resp) {
                        if (resp.status) {
                            if (resp.nextHref !== getFileName(window.location.pathname)) {
                                Msg.info("Renamed db, redirecting..");
                                window.location.href = "../" + resp.nextHref;
                            } else {
                                Msg.info("Updated db");
                            }
                        } else {
                            Msg.error("Failed to update db");
                        }

                    }
                });
                $("body").on("click", ".deleteDocsBtn", function (e) {
                    e.preventDefault();
                    var checkBoxes = $('.deleteDoc:checked');
                    if (checkBoxes.length == 0) {
                        Msg.error("Please select the documents you want to remove by clicking the checkboxs to the right");
                    } else {
                        if (confirm("Are you sure you want to remove " + checkBoxes.length + " documents?")) {
                            doRemoveDocs(checkBoxes);
                        }
                    }
                });
                $("#addRecordForm").forms({
                    callback: function () {
                        Msg.info("Done");
                        $("#records-body").reloadFragment();
                    }
                });
                $("#queryBtn").click(function (e) {
                    e.preventDefault();
                    var q = $("#queryText").val();
                    flog("query", q, $("#query"));
                    $.ajax({
                        url: window.location.pathname,
                        method: "POST",
                        data: {
                            source: q
                        },
                        success: function (resp) {
                            flog("resp", resp);
                            var html = $(resp);
                            $("#searchResults").html(html.find("#searchResults > *"));
                        }
                    });
                });
                function doRemoveDocs(checkBoxes) {
                    $.ajax({
                        type: 'POST',
                        data: checkBoxes,
                        dataType: "json",
                        url: "",
                        success: function (data) {
                            flog("success", data);
                            if (data.status) {
                                $("#records-body").reloadFragment();
                                Msg.success("Removed users ok");
                            } else {
                                Msg.error("There was a problem removing users. Please try again and contact the administrator if you still have problems");
                            }
                        },
                        error: function (resp) {
                            Msg.error("An error occurred removing users. You might not have permission to do this");
                        }
                    });
                }
            });
        </script>
    </body>
</html>
