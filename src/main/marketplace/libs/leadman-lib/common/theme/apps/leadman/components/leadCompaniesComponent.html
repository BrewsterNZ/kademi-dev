<div class="row">
    <div class="col-md-4 right">
        <div class="input-group">
            <span class="input-group-btn">
                <button class="btn btn-default" type="button" >
                    <i class="fa fa-search"></i>
                </button>
            </span>
            <input type="text" id="org-query" class="form-control" placeholder="Search for organisations here" value="" />
            <span class="input-group-btn">
                <button class="btn btn-default clear" type="button" >
                    <i class="fa fa-times"></i>
                </button>
            </span>
        </div>
    </div>
    <div class="col-md-8 text-right">
        <button class="btn btn-danger"><i class="fa fa-trash"></i></button>
    </div>
</div>
<br>
<div class="panel panel-default">
    <table id="leadCompaniesTable" class="table table-striped table-hover kcrm-table">
        <thead>
        <tr>
            <th>Title</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Address</th>
            <th width="90">Members</th>
            <th><input type="checkbox" class="select-all-companies"></th>
        </tr>
        </thead>
        <tbody id="searchResults">
        #foreach($com in $page.paginator.records)
        <tr>
            <td><a href="./$com.id">$com.title</a></td>
            <td>$!com.email</td>
            <td>$!com.phone</td>
            <td>
                $!com.address, $!com.addressLine2
            </td>
            <td>$com.members.size()</td>
            <td><input type="checkbox" name="companyId" value="$com.id"></td>
        </tr>
        #end
        </tbody>
        #if ($page.paginator.html)
        <tfoot id="pointsFooter">
        <tr>
            <td colspan="6">
                $!page.paginator.html
            </td>
        </tr>
        </tfoot>
        #end
    </table>
</div>
<script>
    $("#org-query").on({
        keyup: function () {
            typewatch(function () {
                flog("initSearchOrg: do search");
                doSearch();
            }, 500);
        },
        change: function () {
            flog("do search");
            doSearch();
        }
    });
    
    $(".clear").on("click", function(){
        $("#org-query").val("");
        doSearch();
    });
    
    function doSearch() {
        flog("doSearch");
        var newUrl = window.location.pathname + "?q=" + $("#org-query").val();
        $.ajax({
            type: 'GET',
            url: newUrl,
            success: function (data) {
                window.history.pushState("", document.title, newUrl);
                var $fragment = $(data).find("#searchResults");
                flog("replace", $("#se"));
                flog("frag", $fragment);
                $("#searchResults").replaceWith($fragment);
            },
            error: function (resp) {
                Msg.error("err");
            }
        });
    }
</script>