#if (!$rowHeight)
    #set ($rowHeight = 25)
#end

#if (!$numUsers)
    #set ($numUsers = 5)
#end
#set ($numUsers = $formatter.toInteger($numUsers))

#set( $kpi = $services.dataSeriesManager.findKpi($salesDataSeries, $kpi)  )
#set( $period = $kpi.findCurrentPeriodStart( $services.queryManager.commonStartDate )  )
#set( $lb = $services.dataSeriesManager.kpiLeaderboard($kpi, $period))
#set( $results = $lb.highestResults($numUsers) )


<table cellpadding="0" cellspacing="0" width="100%" bgcolor="$!bodyBgColor">
    <thead>
        <tr bgcolor="$!headerBgColor">
            <th style="$baseStyles; ${cellStyles}; text-align: left"><strong>Rank</strong></th>
            <th style="$baseStyles; ${cellStyles}; text-align: left"><strong>Participant</strong></th>
        </tr>
    </thead>
    <tbody id="leaderboardBody">
        #if ($lb)
            #set( $thisUserRanking = $lb.firstRankingForUser )
            #set( $foundUser = false )

            #foreach($item in $results )
                #set( $plusOne = $item.rank + 1 )
                #if($plusOne > $numUsers)
                    #break
                #end


                #if( $item.profile) <!-- is individual -->
                    #set ($itemName = $item.profile.formattedName())
                    #if( $item.profile.userId == $thisUserRanking.participant.userId )
                        #set( $foundUser = true )
                    #end
                #elseif( $item.org  )
                    #set ($itemName = $item.org.title)
                    #if( $item.org.id == $thisUserRanking.participant.id )
                        #set( $foundUser = true )
                    #end
                #else
                    #set ($itemName = "NA")
                #end

                #if( !$foundUser )
                #renderLeaderboardRecord($plusOne $itemName)
                #end
            #end

            <!-- todo: only if not already shown -->
            #renderLeaderboardRecord($thisUserRanking.rank $thisUserRanking.participant.formattedName() )
        #else
            #renderLeaderboardRecord("1" "[Please select data series and KPI]")
            #renderLeaderboardRecord("2" "[Please select data series and KPI]")
            #renderLeaderboardRecord("3" "[Please select data series and KPI]")
        #end
    </tbody>
</table>



#macro (renderLeaderboardRecord $rank $name)
    <tr bgcolor="$!bodyBgColor">
        <td height="$rowHeight" valign="top" style="$baseStyles; ${cellStyles}">$rank</td>
        <td valign="top" style="$baseStyles; ${cellStyles}">
            $name
        </td>
    </tr>
#end